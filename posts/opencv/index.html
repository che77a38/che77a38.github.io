<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>opencv | ZEROKO14的个人博客</title><meta name="keywords" content="C++"><meta name="author" content="ZEROKO14"><meta name="copyright" content="ZEROKO14"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="opencv"><meta name="application-name" content="opencv"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="opencv"><meta property="og:url" content="https://che77a38.github.io/posts/opencv/index.html"><meta property="og:site_name" content="ZEROKO14的个人博客"><meta property="og:description" content="opencv相关知识   计算机图像颜色基础理论用一个巧妙的实验来给你讲清楚什么是 Gamma,还未记录总结 RGB颜色空间基本知识 RGB三原色起源于上世纪初1809年Thomas Young提出视觉的三原色学说，随后Helmholtz在1824年也提出了三原色学说：即：视网膜存在三种视锥细胞，分"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4"><meta property="article:author" content="ZEROKO14"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4"><meta name="description" content="opencv相关知识   计算机图像颜色基础理论用一个巧妙的实验来给你讲清楚什么是 Gamma,还未记录总结 RGB颜色空间基本知识 RGB三原色起源于上世纪初1809年Thomas Young提出视觉的三原色学说，随后Helmholtz在1824年也提出了三原色学说：即：视网膜存在三种视锥细胞，分"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://che77a38.github.io/posts/opencv/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":true,"limitCount":50,"languages":{"author":"作者: ZEROKO14","link":"链接: ","source":"来源: ZEROKO14的个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'ZEROKO14的个人博客',
  title: 'opencv',
  postAI: '',
  pageFillDescription: '计算机图像颜色基础理论, RGB颜色空间, 基本知识, HSV颜色空间, 图像的基本类型, 图像的大小、深度和通道, 图像在计算机中的坐标, opencv环境配置, mac配置, Windows配置, CSharp Opencv, 简单代码案例, Mat类, Mat能存储的数据, OpenCV中规定的数据类型, Mat类的赋值, 创建时赋值, 利用已有的Mat类创建新的Mat类, 利用矩阵Size()结构和数据类型参数创建Mat类, Mat类方法赋值, 枚举法赋值, Mat类元素的读取, 常用属性, at方法读取, 矩阵元素地址定位方式访问元素, Mat支持的运算, 两个矩阵相乘, 相关函数, 基本图像处理操作, 灰度x2F高斯模糊x2F边缘x2F扩张x2F侵蚀, 亮度与对比度, ConvertTo, ConvertScaleAbs, 总结, 调整图像大小x2F裁剪图像, 绘制, 仿射变换, 颜色检测, 直方图均衡化, 工作原理, python案例, 自适应直方图均衡化, 原理, 案例, 视频加载与摄像头调用, 视频x2F摄像头加载, 视频属性获取, 相关方法, 视频图像逐帧获取, VideoWriter, fourcc, 相关函数, isOpened函数, Write函数, operator ltlt, 析构函数, 实例技巧, 优化帧率控制, CSharp案例, 音频库, C音频库, 均匀分窗体算法相关知识计算机图像颜色基础理论用一个巧妙的实验来给你讲清楚什么是还未记录总结颜色空间基本知识三原色起源于上世纪初年提出视觉的三原色学说随后在年也提出了三原色学说即视网膜存在三种视锥细胞分别含有对红绿蓝三种光线敏感的视色素当一定波长的光线作用于视网膜时以一定的比例使三种视锥细胞分别产生不同程度的兴奋这样的信息传至大脑中枢就产生某一种颜色的感觉在显示器发明之后从黑白显示器发展到彩色显示器人们开始使用发出不同颜色的光的荧光粉等离子体显示器或者不同颜色的滤色片或者不同颜色的半导体发光器件和大型全彩显示牌来形成色彩无一例外的选择了这种颜色的发光体作为基本的发光单元通过控制他们发光强度组合出了人眼睛能够感受到的大多数的自然色彩计算机显示彩色图像的时候也不例外最终显示的时候要控制一个像素中的值来确定这个像素的颜色计算机中无法模拟连续的存储从最暗到最亮的量值而只能以数字的方式表示于是结合人眼睛的敏感程度使用个字节位来分别表示一个像素里面的和的发光强度数值这就是常见的格式我们可以打开画图板在自定义颜色工具框中输入值得到不同的颜色颜色空间以红绿蓝三种基本色为基础进行不同程度的叠加产生丰富而广泛的颜色所以俗称三基色模式空间是生活中最常用的一个颜色显示模型电视机电脑的显示器等大部分都是采用这种模型自然界中的任何一种颜色都可以由红绿蓝三种色光混合而成现实生活中人们见到的颜色大多是混合而成的色彩组合方法是通过互补光的形式来组合成任意颜色的三通道想要组合成黑白灰必须三原色值相同当某一方的值不相同时就会产生其他颜色灰度图不一定是单通道但是单通道一定是灰度图将图像转变为灰度图像遵循下面的公式仅需了解颜色空间颜色空间的分量与亮度密切相关即只要改变亮度个分量都会随之相应地改变因此颜色空间适合于显示系统却并不适合于图像处理色调表示观察者感知的主要颜色饱和度指的是相对的纯净度或一种颜色混合白光的数量如深红色红加白和淡紫色紫加白这样的色彩是欠饱和的饱和度与所加的白光的数量成反比亮度表达了无色的强度概念因为色调饱和度色度所以颜色色调饱和度亮度色度亮度图像的基本类型在计算机中我们常见的图像类型有以下几种二值化图像一幅二值图像的二维矩阵仅由两个值构成代表黑色代白色由于每一像素矩阵中每一元素取值仅有两种可能所以计算机中二值图像的数据类型通常为个二进制位二值图像通常用于文字线条图的扫描识别和掩膜图像的存储灰度图像灰度图像矩阵元素的取值范围通常为因此其数据类型一般为位无符号整数的这就是人们经常提到的灰度图像表示纯黑色表示纯白色中间的数字从小到大表示由黑到白的过渡色在某些软件中灰度图像也可以用双精度数据类型表示像素的值域为代表黑色代表白色到之间的小数表示不同的灰度等级二值图像可以看成是灰度图像的一个特例索引图像索引图像的文件结构比较复杂除了存放图像的二维矩阵外还包括一个称之为颜色索引矩阵的二维数组的大小由存放图像的矩阵元素值域决定如矩阵元素值域为则矩阵的大小为用表示中每一行的三个元素分别指定该行对应颜色的红绿蓝单色值中每一行对应图像矩阵像素的一个灰度值如某一像素的灰度值为则该像素就与中的第行建立了映射关系该像素在屏幕上的实际颜色由第行的组合决定也就是说图像在屏幕上显示时每一像素的颜色由存放在矩阵中该像素的灰度值作为索引通过检索颜色索引矩阵得到索引图像的数据类型一般为位无符号整形相应索引矩阵的大小为因此一般索引图像只能同时显示种颜色但通过改变索引矩阵颜色的类型可以调整索引图像的数据类型也可采用双精度浮点型索引图像一般用于存放色彩要求比较简单的图像如中色彩构成比较简单的壁纸多采用索引图像存放如果图像的色彩比较复杂就要用到真彩色图像真彩色图像图像与索引图像一样都可以用来表示彩色图像与索引图像一样它分别用红绿蓝三原色的组合来表示每个像素的颜色但与索引图像不同的是图像每一个像素的颜色值由三原色表示直接存放在图像矩阵中由于每一像素的颜色需由三个分量来表示分别表示图像的行列数三个的二维矩阵分别表示各个像素的三个颜色分量图像的数据类型一般为位无符号整形通常用于表示和存放真彩色图像当然也可以存放灰度图像图像的大小深度和通道在中定义的图像一般会包含图像的大小深度和通道等几个元素一般我们是用去定义一个图像例如上面这一语句实例化了一个的对象其大小为像素像素类型为位无符号整型三通道颜色为纯白色中表示表示无符号整型数符号整型浮点型表示通道同理即表示带符号整型单通道类型的图像是指一个位浮点型双通道矩阵这两个例子中的数字就代表了位深度数字越大单个通道能表示的颜色就越细可以理解位调节的粒度位深度取值范围无符号位整型有符号位整型无符号位整型有符号位整型有符号位整型单精度浮点数双精度浮点数那么单通道和多通道有啥区别呢例如单通道图像由一字节就可以表示一个像素的色彩明暗而三通道则需要个字节才能表示一个像素的色彩彩色图一般就是三通道每个通道表示一个颜色通道通常为在某些处理中可能会用到通道图像不常见通常在程序处理中会用到如傅里叶变换可能会用到一个通道为实数一个通道为虚数主要是编程方便还有一种情况就是位图像本来是通道但是为了减少数据量压缩为位刚好两个通道常见格式有或也就是说占位占或位占位也有格式图像在计算机中的坐标图像像素的坐标不同于我们常见的直角坐标它的坐标原点是在图像的左上角向右为的正方向向下为轴的正方向灰度图像从对于彩色图像有三个灰度图像分别代表红色绿色和蓝色的强度将他们合在一起就是完整的彩色图像环境配置配置或是记录时的最新版基础如何使用第三方库参考此处了解应该如何使用常用的头文件头文件功能核心功能包括基本数据结构和函数图像处理功能如滤波变换颜色空间转换等图形用户界面功能如等图像读写功能如等特征检测和描述功能计算机视觉功能如相机标定三维重建等视频分析功能如光流背景建模等对象检测功能如人脸检测行人检测等机器学习功能深度学习功能快速近似最近邻搜索功能图像处理功能如去噪美化等图像拼接功能视频功能最基本常用配置下载位置使用包如果是上开发需要运行时包要与安装同一个版本用于在上使用简单代码案例读取图片并窗口显示堵塞直到键入读取视频并窗口显示测试视频捕获延迟毫秒此代码视频播放完了会有异常因为视频播放完了读不到了读取摄像头并窗口显示表示摄像头编号是引入的矩阵类型类官方参考文档结构构成能存储的数据任何类型双浮点单浮点无符号字符等等中规定的数据类型数据类型具体类型取值范围位无符号整数位符号整数位无符号整数位符号整数位无符号整数位符号整数位浮点整数位浮点整数类的赋值创建时赋值矩阵的行数矩阵的列数存储数据的类型矩阵中存储的数据类型此处除了等从到通道以外还提供了更多通道的参数通过中的来构建多通道矩阵其中最大可以取到给矩阵中每个像素赋值的参数变量如利用已有的类创建新的类已经构建完成的类矩阵数据在已有矩阵中需要截取的行数范围是一个变量例如从第行到第行不包括第行与第行可以表示为在已有矩阵中需要截取的列数范围是一个变量例如从第列到第列不包括第列与第列可以表示为在不输入任何值时表示所有列都会被截取利用矩阵结构和数据类型参数创建类数组变量尺寸通过进行赋值如存储数据的类型类方法赋值单位矩阵对角矩阵元素全为的矩阵元素全为的矩阵枚举法赋值类元素的读取数据在内存中存放形式常用属性属性作用矩阵的列数以像素个数为单位矩阵的行数以像素个数为单位以字节为单位的矩阵的有效宽度每个元素的字节数矩阵中元素的个数总像素个数矩阵的通道数方法读取单通道多通道罗列一些预设数据类型的命名规则三个通道字节字节型两个通道字节型四个通道型矩阵元素地址定位方式访问元素单通道支持的运算直接利用数学符号表示矩阵的运算矩阵与数字的运算都是将运算应用于每个元素类减数字是中每个元素都减去这个数字两个矩阵相乘矩阵乘积向量内积对应位元素乘积数学乘法意义盘点上述各种乘法的现实意义参考此处相关函数函数名作用两个矩阵对应元素差的绝对值两个矩阵求和两个矩阵线性求和矩阵除法矩阵求逆矩阵求对数两个矩阵计算最大值最小值会返回一个新的矩阵其中每个元素都是和中对应位置元素的最小值矩阵的线性求和是指将多个矩阵按一定的权重进行求和具体来说线性求和涉及到对每个矩阵的元素乘以一个标量权重然后再进行求和矩阵求和是指将两个相同维度的矩阵对应位置的元素相加得到一个新的矩阵矩阵除法实际上是的逆矩阵意义求解线性方程组矩阵可以用来表示线性变换矩阵的除法可以理解为反向应用这种变换矩阵对数略也非常重要矩阵运算的理解基本图像处理操作灰度高斯模糊边缘扩张侵蚀转换为灰度图像添加高斯模糊边缘检测图像扩张图像侵蚀转为灰度图像中将称为添加高斯模糊边缘检测边缘检测前通常需要做些模糊处理图像扩张增加厚度有尽量使用奇数的说法似乎是会导致图像偏移图像侵蚀减少厚度亮度与对比度和是中用于图像处理的两个函数它们的主要区别在于功能和用途功能用于将图像从一种数据类型转换为另一种数据类型同时可以应用缩放因子和偏移量用法其中是输入图像是输出图像是目标数据类型是缩放因子是偏移量示例可以将图像从转换为并且可以在转换时调整亮度和对比度功能用于将图像转换为绝对值并缩放同时将结果转换为类型用法其中是输入图像是输出图像是缩放因子是偏移量示例通常用于将浮点图像转换为位图像适合于显示和保存对于输入图像中的每个像素函数执行如下转换对比度如果图像的对比度会增加图像更加清晰如果图像的对比度会减小亮度控制增加或减少像素的亮度值总结更加灵活支持多种数据类型的转换和调整专注于将图像转换为位无符号整数并且自动处理绝对值通常用于将处理后的图像准备好进行显示调整图像大小裁剪图像调整大小打印图像原本大小缩放为大小无视宽高比调整倍等比例缩小裁切裁切区间必须小于图像本身大小不然会报错绘制新建空白图片参数解释如下中表示的次方表示无符号结合前面就是表示三通道表示白色画圆圈从坐标做半斤为的圆圈颜色为线条粗细为若为表示实心圆注意这个线条粗细是往两边同时扩张的画矩形画线画文本不支持中文将会是乱码仿射变换仿射变换是线性变换和平移的组合仿射变换保持直线的性质但不保持原点不变仿射变换可以用矩阵乘法和向量加法来表示分别用于存储透视变换的矩阵用于存储变换后的图像定义变换前的矩形定义变换后的矩形计算透视变换矩阵使用函数将中的图像应用透视变换结果存储在中参数是变换矩阵指定输出图像的大小画上一些标记点颜色检测直方图均衡化直方图均衡化是一种用于图像处理的技术目的是增强图像的对比度使得图像的亮度分布更加均匀这种方法尤其适合提升灰度图像的对比度但也可以扩展到彩色图像像的直方图表示图像中不同灰度级亮度的像素分布情况例如假设一个灰度图像的像素值在黑色到白色之间那么直方图就展示了每个灰度级出现的次数通过分析直方图可以判断图像是否过亮过暗或对比度过低直方图均衡化的核心思想是通过重新分布图像的灰度值使得像素在所有灰度级上的分布更为均匀从而增加图像的整体对比度工作原理通过累积分布函数重新分配图像的灰度级从而均衡亮度并提升细节计算直方图首先计算图像中每个灰度值的像素数量得到图像的直方图计算累积分布函数累积分布函数表示某个灰度级及其以下的所有像素值在图像中所占的总比例计算每个灰度值的累积概率分布公式如下其中是第灰度值出现的概率灰度值映射根据累积分布函数将每个灰度值映射到一个新的灰度值区间新的灰度值会是原始值的线性扩展从而平衡亮度分布公式为其中是灰度级数例如对于位图像为生成均衡化后的图像将所有像素点的灰度值通过映射转换为新的值得到对比度增强的图像实际计算案例参考如下假设有一个简单的直方图灰度值为到频率如下灰度值频率计算直方图直方图已经给出计算归一化假设总像素数映射到新的灰度值变为取整变为变为变为生成新的图像替换原始灰度值为新灰度值得到增强后的图像经过直方图均衡化处理的图像通常会显得更加清晰对比度更强对于暗淡或亮度不均的图像这种方法非常有效直方图均衡化可以让更多的细节显现出来尤其是在光照不足的情况下直方图均衡化处理使得整个图像的亮度分布更加均匀提升图像的可视性局限性过度增强在某些情况下直方图均衡化可能会导致图像的噪声也被增强从而影响图像质量色彩失真在处理彩色图像时若直接对每个颜色通道单独进行均衡化可能会导致色彩失真因此处理彩色图像时通常采用类似的技术比如自适应直方图均衡化或对亮度通道进行均衡化案例在中直方图均衡化可以通过函数实现读取灰度图像进行直方图均衡化显示原图与均衡化后的图像对于彩色图像可以先将其转换到颜色空间对亮度通道进行均衡化然后再转换回颜色空间读取彩色图像转换为颜色空间对亮度通道进行直方图均衡化转回颜色空间显示结果自适应直方图均衡化全面替代直方图均衡化自适应直方图均衡化简称是一种改进的直方图均衡化技术主要用于提升图像局部区域的对比度在普通的直方图均衡化中整个图像使用全局直方图进行处理这可能导致对比度过度增强或者细节丢失尤其是在对比度变化较大的图像中自适应直方图均衡化通过对图像的不同区域分别进行均衡化来解决这些问题在中使用可以通过对比度限制的自适应直方图均衡化来实现这种效果是的一种改进它通过限制对比度增强的强度防止过度增强原理分块处理将图像分成多个小块通常称为网格或区块并对每个小块分别进行直方图均衡化每个小块的对比度都根据其局部直方图来调整插值为了避免块与块之间出现明显的边界块效应会对相邻块的均衡化结果进行算法插值算法双线性插值使图像变得更平滑对比度限制在中会限制直方图中某个灰度值的最大频率像素数量这样可以防止局部区域对比度过高避免过亮或过暗的区域产生噪声案例读取灰度图像判断图像是否成功加载图像加载失败创建一个对象是对比度限制阈值是分块的大小存储均衡化后的结果应用显示原图和处理后的图像等待按键创建对象使用函数创建一个对象这个函数的两个参数分别是限制对比度的阈值通常值在到之间较大的值会允许更强的对比度增强控制分块的大小较小的块会对局部区域增强更多细节应用方法用于对图像进行自适应直方图均衡化结果存储在中附一个案例应用转换到颜色空间分离通道对通道应用创建一个与原始通道大小相同的使用双线性插值混合原始通道和增强后的通道用混合后的通道替换原始通道合并通道转换回颜色空间在方法中仍然将图像转换到颜色空间并分离通道对通道应用但结果保存在一个新的中使用方法将增强后的通道调整回原始大小使用双线性插值使用方法将原始通道和增强后的通道混合这里使用了的权重您可以根据需要调整这个值用混合后的通道替换原始通道最后合并通道并转换回颜色空间这种方法应该能显著减少块状效果使结果更加平滑自然您可以调整以下参数来进一步优化结果的对比度限制当前为的网格大小当前为混合时原始和增强通道的权重当前各为视频加载与摄像头调用视频摄像头加载读取的视频文件或图像序列名称读取数据时设置的属性例如编码格式是否调用等支持的摄像头类型摄像头这是最常见的摄像头类型您可以通过类直接访问摄像头通常情况下您可以使用设备索引例如等来打开摄像头网络摄像头也支持通过网络协议如或访问网络摄像头只需提供网络摄像头的您就可以使用来打开和读取视频流例如流或者流摄像头许多现代摄像头提供或流您可以使用相同的方法通过访问它们打开视频文件视频文件路径未成功打开等待每帧的时间没输入就等算出来的帧间隔那么长时间按退出视频属性获取通过函数可以获取下面的属性如标志参数简记作用视频文件的当前位置以毫秒为单位视频流中图像的宽度视频流中图像的高度视频流中图像的帧率每秒帧数编解码器的字符代码视频流中图像的帧数返回的对象的格式图像的亮度仅适用于支持的相机图像对比度仅适用于相机图像饱和度仅适用于相机图像的色调仅适用于相机图像的增益仅适用于支持的相机如果使用的是以前的版本属性名前还要加相关方法检查视频是否成功打开读取视频中的一帧并将其存储在对象中释放对象所占用的资源获取视频属性如帧率宽度高度等设置视频属性如帧率宽度高度等调用函数之后后续捕获的帧或写入的视频将会应用新的属性设置视频图像逐帧获取为了减缓内存消耗会将数据直接保存到外存这样就可以保证在内存极小的情况下进行长时间录制故嵌入式设备如果发现内存不足应将注意力放在其他地方大部分时候都是实例调用函数进行克隆但未即使释放内存保存视频的地址和文件名包含视频格式压缩帧的字符编解码器代码保存视频的帧率即视频中每秒图像的张数这个数字若小于原视频帧率则是快放否则是慢放视频帧的尺寸是一个对象包含两个整数分别表示视频帧的宽度和高度这里的视频帧尺寸必须是和图像的大小一致如果想要更改分辨率大小必须将图像调整使用函数之后再次进行保存才可以保存视频是否为彩色视频例子用于在构造时设置编码格式具体的设置需要有硬件提供支持常见的有以下几种这个选项是一个未压缩的编码色度子采样这种编码广泛兼容但会产生大文件文件扩展名应为此选项为文件扩展名应为此选项是一个相对较旧的编码如果要限制结果视频的大小这是一个很好的选择文件扩展名应为此选项是另一个相对较旧的编码如果要限制结果视频的大小这是一个很好的选择文件扩展名应为这个选项是一种比较新的编码方式如果你想限制结果视频的大小这可能是最好的选择文件扩展名应为这个选项是传统的编码方式如果你想限制结果视频的大小这可能是很好的选择文件扩展名应为这个选项是文件扩展名应为此选项为视频文件扩展名应为此选项为视频文件扩展名应为经验证为压缩效率最高的编码格式可以做到的视频次之为最大为在嵌入式开发板内建议使用相关函数函数函数该函数用于将一帧图片保存到文件里面为了方便处理也可用流控制符来完成写入操作如析构函数实例技巧优化帧率控制使用进行精确计时计算每帧所需的时间间隔不使用自旋等待来实现更精确的帧率控制在精细调整的自旋等待循环中我们使用代替了这种方法可以在保持较好的帧率控制精度的同时显著减少负载会让出当前线程的时间片但不会导致线程进入长时间的睡眠状态从而在降低使用率和保持精确计时之间取得平衡请注意这种方法可能会略微降低帧率控制的精确度但对于大多数应用来说这种微小的差异是可以接受的尤其是考虑到使用率的显著降低动态调整等待时间以补偿处理时间的变化刷新帧无法读取帧帧为空捕获帧时发生错误案例摄像头视频显示并录制案例打开默认摄像头设置宽度设置高度绑定计时器事件设置为自动重置创建一个对象来存储帧从摄像头读取一帧检查帧是否为空将当前帧写入视频文件使用异步方式更新避免卡顿显示原始视频帧窗口关闭事件处理停止计时器释放摄像头资源释放视频写入对象调用基类的方法这样保存出来的视频文件特别大可以采取下面几种做法采用编码格式获得更好的压缩率智能码率控制根据画面内容的复杂度和运动情况动态调整码率画面简单静止时降低码率画面复杂运动剧烈时适当提高码率以在保证画质的同时减小文件大小运动检测与区域编码通过运动检测算法区分静止区域和运动区域对静止区域采用更高效的压缩方式而对运动区域保证足够的编码精度多分辨率编码结合不同的分辨率进行编码例如在画面静止时使用较低分辨率编码运动时切换到较高分辨率利用硬件编码加速借助专门的硬件编码器如中的编码器来加速编码过程提高效率和压缩性能使用了光流算法来计算帧间的运动并只更新变化的部分这样可以减少每帧的更新量提高视频流畅性完整交互库案例是否退出捕获线程是否保存帧对外开放读取默认分钟保存一次保存视频的目录委托与事件原始数据格式估算码率比特秒估算比特率开始捕获摄像获取视频本身的各种数据启动摄像头时发生错误刷新帧的线程使用控制是否跳出循环跳出循环时执行关闭写入并压缩覆盖无法读取帧帧为空捕获帧时发生错误跳出循环的时候压缩视频文件启动进程执行失败错误文件压缩并替换成功临时输出文件未找到压缩视频设置分辨率设置帧率验证设置是否成功设置的分辨率实际分辨率设置的帧率实际帧率重新打开摄像头失败添加时间文字信息设置文本参数计算文本大小计算文本位置右上角留出像素的边距创建一个与原始帧相同大小和类型的覆盖层完全透明绘制半透明背景将背景叠加到原始帧上绘制透明背景文本但必须在带有的图像上绘制文本压缩视频音频库音频库开源开源地址音频视频录制后合并音视频案例均匀分窗体算法',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-19 14:42:44',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://th.bing.com/th/id/OIP.wtmjepfWPBvn26uz7s18dgHaHa?rs=1&amp;pid=ImgDetMain"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">ZEROKO14的个人博客</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 1.05rem;">C#<sup>3</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C++<sup>5</sup></a><a href="/tags/CSS/" style="font-size: 1.05rem;">CSS<sup>1</sup></a><a href="/tags/CSharp/" style="font-size: 1.05rem;">CSharp<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">C语言<sup>1</sup></a><a href="/tags/FPS/" style="font-size: 1.05rem;">FPS<sup>1</sup></a><a href="/tags/HTML/" style="font-size: 1.05rem;">HTML<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem;">JavaScript<sup>1</sup></a><a href="/tags/MFC/" style="font-size: 1.05rem;">MFC<sup>1</sup></a><a href="/tags/PE/" style="font-size: 1.05rem;">PE<sup>1</sup></a><a href="/tags/QT/" style="font-size: 1.05rem;">QT<sup>1</sup></a><a href="/tags/WPF/" style="font-size: 1.05rem;">WPF<sup>3</sup></a><a href="/tags/ai/" style="font-size: 1.05rem;">ai<sup>1</sup></a><a href="/tags/cmake/" style="font-size: 1.05rem;">cmake<sup>1</sup></a><a href="/tags/doxygen/" style="font-size: 1.05rem;">doxygen<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>1</sup></a><a href="/tags/json/" style="font-size: 1.05rem;">json<sup>1</sup></a><a href="/tags/linux/" style="font-size: 1.05rem;">linux<sup>1</sup></a><a href="/tags/next/" style="font-size: 1.05rem;">next<sup>1</sup></a><a href="/tags/ppt/" style="font-size: 1.05rem;">ppt<sup>1</sup></a><a href="/tags/slidev/" style="font-size: 1.05rem;">slidev<sup>1</sup></a><a href="/tags/vue/" style="font-size: 1.05rem;">vue<sup>1</sup></a><a href="/tags/xml/" style="font-size: 1.05rem;">xml<sup>1</sup></a><a href="/tags/yaml/" style="font-size: 1.05rem;">yaml<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 1.05rem;">代码规范<sup>1</sup></a><a href="/tags/%E5%86%85%E6%A0%B8/" style="font-size: 1.05rem;">内核<sup>2</sup></a><a href="/tags/%E5%86%85%E6%A0%B8%E7%9B%B8%E5%85%B3/" style="font-size: 1.05rem;">内核相关<sup>5</sup></a><a href="/tags/%E5%8A%A0%E8%A7%A3%E5%AF%86/" style="font-size: 1.05rem;">加解密<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">多线程<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">开发<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 1.05rem;">数学<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.05rem;">数据库<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 1.05rem;">架构<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 1.05rem;">正则表达式<sup>1</sup></a><a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 1.05rem;">监控<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>1</sup></a><a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">管理<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>2</sup></a><a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 1.05rem;">逆向<sup>2</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">13</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">27</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/12/"><span class="card-archive-list-date">十二月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/10/"><span class="card-archive-list-date">十月 2021</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/12/"><span class="card-archive-list-date">十二月 2020</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url">技术</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/C/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>C++</span></a></span></div></div><h1 class="post-title" itemprop="name headline">opencv</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-04-29T05:51:08.842Z" title="发表于 2024-04-29 13:51:08">2024-04-29</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-10-19T06:42:44.499Z" title="更新于 2024-10-19 14:42:44">2024-10-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="opencv"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为新加坡"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>新加坡</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://che77a38.github.io/posts/opencv/"><header><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url">技术</a><a href="/tags/C/" tabindex="-1" itemprop="url">C++</a><h1 id="CrawlerTitle" itemprop="name headline">opencv</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">ZEROKO14</span><time itemprop="dateCreated datePublished" datetime="2024-04-29T05:51:08.842Z" title="发表于 2024-04-29 13:51:08">2024-04-29</time><time itemprop="dateCreated datePublished" datetime="2024-10-19T06:42:44.499Z" title="更新于 2024-10-19 14:42:44">2024-10-19</time></header><p>opencv相关知识</p>
<span id="more"></span>

<h1 id="计算机图像颜色基础理论"><a href="#计算机图像颜色基础理论" class="headerlink" title="计算机图像颜色基础理论"></a>计算机图像颜色基础理论</h1><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19A4m1F7zw/">用一个巧妙的实验来给你讲清楚什么是 Gamma,还未记录总结</a></p>
<h2 id="RGB颜色空间"><a href="#RGB颜色空间" class="headerlink" title="RGB颜色空间"></a>RGB颜色空间</h2><h3 id="基本知识"><a href="#基本知识" class="headerlink" title="基本知识"></a>基本知识</h3><blockquote>
<p>RGB三原色起源于上世纪初1809年Thomas Young提出视觉的三原色学说，随后Helmholtz在1824年也提出了三原色学说：即：视网膜存在三种视锥细胞，分别含有对红、绿、蓝三种光线敏感的视色素，当一定波长的光线作用于视网膜时，以一定的比例使三种视锥细胞分别产生不同程度的兴奋，这样的信息传至大脑中枢，就产生某一种颜色的感觉。</p>
<p>在显示器发明之后，从黑白显示器发展到彩色显示器，人们开始使用发出不同颜色的光的荧光粉（CRT，等离子体显示器），或者不同颜色的滤色片（LCD），或者不同颜色的半导体发光器件（OLED和LED大型全彩显示牌）来形成色彩，无一例外的选择了Red,Green,Blue这3种颜色的发光体作为基本的发光单元。通过控制他们发光强度，组合出了人眼睛能够感受到的大多数的自然色彩。     </p>
<p>计算机显示彩色图像的时候也不例外，最终显示的时候，要控制一个像素中Red,Green,Blue的值，来确定这个像素的颜色。计算机中无法模拟连续的存储从最暗到最亮的量值，而只能以数字的方式表示。于是，结合人眼睛的敏感程度，使用3个字节（3*8位）来分别表示一个像素里面的Red,Green 和Blue的发光强度数值，这就是常见的RGB格式。我们可以打开画图板，在自定义颜色工具框中，输入r,g,b值，得到不同的颜色。</p>
</blockquote>
<p>RGB颜色空间以R(Red:红)、G(Green:绿)、B(Blue:蓝)三种基本色为基础，进行不同程度的叠加，产生丰富而广泛的颜色，所以俗称三基色模式。</p>
<p>RGB空间是生活中最常用的一个颜色显示模型，电视机、电脑的CRT显示器等大部分都是采用这种模型。自然界中的任何一种颜色都可以由红、绿、蓝三种色光混合而成，现实生活中人们见到的颜色大多是混合而成的色彩。</p>
<p>组合方法是通过互补光的形式来组合成任意颜色的</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051453201.png" alt="image-20240505145338856" style="zoom:50%;" />

<blockquote>
<p><strong>三通道想要组合成黑白灰,必须三原色值相同</strong>,当某一方的值不相同时就会产生其他颜色。</p>
<p><strong>灰度图不一定是单通道，但是单通道一定是灰度图</strong></p>
<p>将RGB图像转变为灰度图像遵循下面的公式:(仅需了解)<br>$$<br>gray  &#x3D; B<em>0.114+G</em>0.587+R*0.299<br>$$</p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051458202.png" alt="img"  />

<h2 id="HSV颜色空间"><a href="#HSV颜色空间" class="headerlink" title="HSV颜色空间"></a>HSV颜色空间</h2><blockquote>
<p>RGB颜色空间的分量与亮度密切相关,即只要改变亮度,3个分量都会随之相应地改变.因此,RGB颜色空间适合于显示系统,却并不适合于图像处理</p>
</blockquote>
<ul>
<li><p>色调: 表示观察者感知的主要颜色</p>
</li>
<li><p>饱和度: 指的是相对的纯净度,或一种颜色混合白光的数量</p>
<p>如深红色(红加白)和淡紫色(紫加白)这样的色彩是欠饱和的,饱和度与所加的白光的数量成反比</p>
</li>
<li><p>亮度: 表达了无色的强度概念</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051948074.png" alt="image-20240505194825626" style="zoom:50%;" /><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051958255.png" alt="image-20240505195849731" style="zoom: 33%;" /></p>
<p>因为,色调+饱和度 &#x3D; 色度,所以:<br>$$<br>颜色 &#x3D; 色调+饱和度+亮度 &#x3D; 色度+亮度<br>$$<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051959148.png" alt="image-20240505195921691" style="zoom:33%;" /></p>
<h2 id="图像的基本类型"><a href="#图像的基本类型" class="headerlink" title="图像的基本类型"></a>图像的基本类型</h2><p>在计算机中，我们常见的图像类型有以下几种：</p>
<ol>
<li><strong>二值化图像</strong>: 一幅二值图像的二维矩阵仅由0、1两个值构成，“0”代表黑色，“1”代白色。由于每一像素（矩阵中每一元素）取值仅有0、1两种可能，所以计算机中二值图像的数据类型通常为1个二进制位。二值图像通常用于文字、线条图的扫描识别（OCR）和掩膜图像的存储。</li>
<li><strong>灰度图像:</strong> 灰度图像矩阵元素的取值范围通常为[0，255]。因此其数据类型一般为8位无符号整数的（int8），这就是人们经常提到的256灰度图像。“0”表示纯黑色，“255”表示纯白色，中间的数字从小到大表示由黑到白的过渡色。在某些软件中，灰度图像也可以用双精度数据类型（double）表示，像素的值域为[0，1]，0代表黑色，1代表白色，0到1之间的小数表示不同的灰度等级。二值图像可以看成是灰度图像的一个特例。</li>
<li>**索引图像:**索引图像的文件结构比较复杂，除了存放图像的二维矩阵外，还包括一个称之为颜色索引矩阵MAP的二维数组。MAP的大小由存放图像的矩阵元素值域决定，如矩阵元素值域为[0，255]，则MAP矩阵的大小为256Ⅹ3，用MAP&#x3D;[RGB]表示。MAP中每一行的三个元素分别指定该行对应颜色的红、绿、蓝单色值，MAP中每一行对应图像矩阵像素的一个灰度值，如某一像素的灰度值为64，则该像素就与MAP中的第64行建立了映射关系，该像素在屏幕上的实际颜色由第64行的[RGB]组合决定。也就是说，图像在屏幕上显示时，每一像素的颜色由存放在矩阵中该像素的灰度值作为索引通过检索颜色索引矩阵MAP得到。索引图像的数据类型一般为8位无符号整形（int8），相应索引矩阵MAP的大小为256Ⅹ3，因此一般索引图像只能同时显示256种颜色，但通过改变索引矩阵，颜色的类型可以调整。索引图像的数据类型也可采用双精度浮点型（double）。索引图像一般用于存放色彩要求比较简单的图像，如Windows中色彩构成比较简单的壁纸多采用索引图像存放，如果图像的色彩比较复杂，就要用到RGB真彩色图像。</li>
<li>**真彩色RGB图像:**RGB图像与索引图像一样都可以用来表示彩色图像。与索引图像一样，它分别用红（R）、绿（G）、蓝（B）三原色的组合来表示每个像素的颜色。但与索引图像不同的是，RGB图像每一个像素的颜色值（由RGB三原色表示）直接存放在图像矩阵中，由于每一像素的颜色需由R、G、B三个分量来表示，M、N分别表示图像的行列数，三个M x N的二维矩阵分别表示各个像素的R、G、B三个颜色分量。RGB图像的数据类型一般为8位无符号整形，通常用于表示和存放真彩色图像，当然也可以存放灰度图像。</li>
</ol>
<h3 id="图像的大小、深度和通道"><a href="#图像的大小、深度和通道" class="headerlink" title="图像的大小、深度和通道"></a>图像的大小、深度和通道</h3><p>在OpenCV中，定义的图像一般会包含图像的大小、深度和通道等几个元素。一般我们是用 <code>cv::Mat</code> 去定义一个图像，例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">img</span><span class="params">(<span class="number">512</span>, <span class="number">512</span>, CV_8UC3, Scalar(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</span></span>;</span><br></pre></td></tr></table></figure>

<p>上面这一语句实例化了一个Mat 的对象img；其大小为512像素*512像素，类型为8位无符号整型三通道；颜色为纯白色<code>（Scalar(255,255,255) B= 255 G= 255 R=255）</code></p>
<p><strong>CV_8UC3</strong> 中 8表示 8bit； U表示无符号整型数 S &#x3D; 符号整型 F &#x3D; 浮点型； C3 表示3通道；</p>
<p>同理，<strong>CV_8SC1</strong> 即表示8bit带符号整型单通道类型的图像；<strong>CV_32FC2</strong>是指一个32位浮点型双通道矩阵，这两个例子中的数字就代表了位深度，数字越大单个通道能表示的颜色就越细，可以理解位调节的粒度。</p>
<table>
<thead>
<tr>
<th align="left"><strong>位深度</strong></th>
<th align="left"><strong>取值范围</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">IPL_DEPTH_8U - 无符号8位整型</td>
<td align="left">0–255</td>
</tr>
<tr>
<td align="left">IPL_DEPTH_8S - 有符号8位整型</td>
<td align="left">-128–127</td>
</tr>
<tr>
<td align="left">IPL_DEPTH_16U - 无符号16位整型</td>
<td align="left">0–65535</td>
</tr>
<tr>
<td align="left">IPL_DEPTH_16S - 有符号16位整型</td>
<td align="left">-32768–32767</td>
</tr>
<tr>
<td align="left">IPL_DEPTH_32S - 有符号32位整型</td>
<td align="left">0–65535</td>
</tr>
<tr>
<td align="left">IPL_DEPTH_32F - 单精度浮点数</td>
<td align="left">0.0–1.0</td>
</tr>
<tr>
<td align="left">IPL_DEPTH_64F - 双精度浮点数</td>
<td align="left">0.0–1.0</td>
</tr>
</tbody></table>
<p>那么，单通道和多通道有啥区别呢，例如，单通道图像由一字节就可以表示一个像素的色彩（明暗），而三通道则需要3个字节才能表示一个像素的色彩，RGB彩色图一般就是三通道，每个通道表示一个颜色。4通道通常为RGBA，在某些处理中可能会用到。2通道图像不常见，通常在程序处理中会用到，如傅里叶变换，可能会用到，一个通道为实数，一个通道为虚数，主要是编程方便。还有一种情况就是16位图像，本来是3通道，但是为了减少数据量，压缩为16位，刚好两个通道，常见格式有RGB555或RGB565，也就是说R占5位，G占5或6位，B占5位，也有RGBA5551格式。</p>
<h3 id="图像在计算机中的坐标"><a href="#图像在计算机中的坐标" class="headerlink" title="图像在计算机中的坐标"></a>图像在计算机中的坐标</h3><p>图像像素的坐标不同于我们常见的直角坐标，它的坐标原点是在图像的左上角，向右为x的正方向，向下为y轴的正方向；</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051450131.png" alt="image-20240505145055851" style="zoom:33%;" />

<ul>
<li>VGA &#x3D; 640 x 480</li>
<li>HD &#x3D; 1280 ×720</li>
<li>FHD &#x3D; 1920 x 1080</li>
<li>4K &#x3D; 3840 ×2160</li>
</ul>
<p>灰度图像:从0~256($2^8$)</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405031613889.png" alt="image-20240503161327947" style="zoom: 25%;" />

<p>对于彩色图像,有三个灰度图像,分别代表红色,绿色和蓝色的强度.将他们合在一起就是完整的彩色图像</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405031617515.png" alt="image-20240503161719931" style="zoom: 33%;" />







<h1 id="opencv环境配置"><a href="#opencv环境配置" class="headerlink" title="opencv环境配置"></a>opencv环境配置</h1><h2 id="mac配置"><a href="#mac配置" class="headerlink" title="mac配置"></a>mac配置</h2><p><code>brew install opencv</code> 或<code>vcpkg install opencv4</code> (opencv4是记录时的最新版)</p>
<p>[[C++基础#C++如何使用第三方库|参考此处了解cmake应该如何使用]]</p>
<p>opencv常用的头文件</p>
<table>
<thead>
<tr>
<th>头文件</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;opencv2/core.hpp&gt;</code></td>
<td>OpenCV 核心功能,包括基本数据结构和函数</td>
</tr>
<tr>
<td><code>&lt;opencv2/imgproc.hpp&gt;</code></td>
<td>图像处理功能,如滤波、变换、颜色空间转换等</td>
</tr>
<tr>
<td><code>&lt;opencv2/highgui.hpp&gt;</code></td>
<td>图形用户界面功能,如 <code>imshow()</code>、<code>waitKey()</code> 等</td>
</tr>
<tr>
<td><code>&lt;opencv2/imgcodecs.hpp&gt;</code></td>
<td>图像读写功能,如 <code>imread()</code>、<code>imwrite()</code> 等</td>
</tr>
<tr>
<td><code>&lt;opencv2/features2d.hpp&gt;</code></td>
<td>特征检测和描述功能</td>
</tr>
<tr>
<td><code>&lt;opencv2/calib3d.hpp&gt;</code></td>
<td>3D 计算机视觉功能,如相机标定、三维重建等</td>
</tr>
<tr>
<td><code>&lt;opencv2/video.hpp&gt;</code></td>
<td>视频分析功能,如光流、背景建模等</td>
</tr>
<tr>
<td><code>&lt;opencv2/objdetect.hpp&gt;</code></td>
<td>对象检测功能,如人脸检测、行人检测等</td>
</tr>
<tr>
<td><code>&lt;opencv2/ml.hpp&gt;</code></td>
<td>机器学习功能</td>
</tr>
<tr>
<td><code>&lt;opencv2/dnn.hpp&gt;</code></td>
<td>深度学习功能</td>
</tr>
<tr>
<td><code>&lt;opencv2/flann.hpp&gt;</code></td>
<td>快速近似最近邻搜索功能</td>
</tr>
<tr>
<td><code>&lt;opencv2/photo.hpp&gt;</code></td>
<td>图像处理功能,如去噪、美化等</td>
</tr>
<tr>
<td><code>&lt;opencv2/stitching.hpp&gt;</code></td>
<td>图像拼接功能</td>
</tr>
<tr>
<td><code>&lt;opencv2/videoio.hpp&gt;</code></td>
<td>视频 I&#x2F;O 功能</td>
</tr>
</tbody></table>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//最基本,常用:</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/imgcodecs.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/imgproc.hpp&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="Windows配置"><a href="#Windows配置" class="headerlink" title="Windows配置"></a>Windows配置</h2><p><a target="_blank" rel="noopener" href="https://opencv.org/releases/">下载位置</a></p>
<h2 id="CSharp-Opencv"><a href="#CSharp-Opencv" class="headerlink" title="CSharp Opencv"></a>CSharp Opencv</h2><p>使用nuget包<a target="_blank" rel="noopener" href="https://github.com/shimat/opencvsharp">OpenCvSharp4</a></p>
<p>如果是windows上开发,需要运行时包:OpenCvSharp4.runtime.win,要与OpenCvSharp4安装同一个版本</p>
<p>OpenCvSharp4.WpfExtensions:用于在wpf上使用</p>
<h2 id="简单代码案例"><a href="#简单代码案例" class="headerlink" title="简单代码案例"></a>简单代码案例</h2><p>读取图片并窗口显示</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string path = <span class="string">&quot;../../Resources/str.jpeg&quot;</span>;</span><br><span class="line">Mat img = <span class="built_in">imread</span>(path);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image&quot;</span>,img);</span><br><span class="line"><span class="built_in">waitKey</span>(<span class="number">0</span>);<span class="comment">//堵塞直到键入</span></span><br></pre></td></tr></table></figure>

<p>读取视频并窗口显示</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试视频捕获</span></span><br><span class="line">string path = <span class="string">&quot;../../Resources/3s.ts&quot;</span>;</span><br><span class="line"><span class="function">VideoCapture <span class="title">cap</span><span class="params">(path)</span></span>;</span><br><span class="line">Mat img;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">  cap.<span class="built_in">read</span>(img);</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">&quot;Image&quot;</span>,img);</span><br><span class="line">  <span class="built_in">waitKey</span>(<span class="number">20</span>); <span class="comment">//延迟20毫秒</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//此代码,视频播放完了会有异常,因为视频播放完了,读不到了</span></span><br></pre></td></tr></table></figure>

<p>读取摄像头并窗口显示</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VideoCapture <span class="title">cap</span><span class="params">(<span class="number">0</span>)</span></span>;<span class="comment">//0表示摄像头编号</span></span><br><span class="line">Mat img;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">  cap.<span class="built_in">read</span>(img);</span><br><span class="line">  <span class="built_in">imshow</span>(<span class="string">&quot;Image&quot;</span>,img);</span><br><span class="line">  <span class="built_in">waitKey</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Mat是opencv引入的矩阵类型(Matrix)</p>
</blockquote>
<h1 id="Mat类"><a href="#Mat类" class="headerlink" title="Mat类"></a>Mat类</h1><p><a target="_blank" rel="noopener" href="https://docs.opencv.org/4.10.0/">OpenCV官方参考文档</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202409100923620.png" alt="image-20240910092328125"></p>
<p>结构构成</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202409100846016.png" alt="image-20240910084627340"></p>
<h2 id="Mat能存储的数据"><a href="#Mat能存储的数据" class="headerlink" title="Mat能存储的数据"></a>Mat能存储的数据</h2><p>cv::Mat</p>
<ul>
<li><code>cv::Mat_&lt;_TP&gt;</code>  任何类型</li>
<li><code>cv::Mat_&lt;double&gt;</code> 双浮点</li>
<li><code>cv::Mat_&lt;float&gt;</code>  单浮点</li>
<li><code>cv::Mat_&lt;uchar&gt;</code>  <code>cv::Mat_&lt;unsigned char&gt;</code>  无符号字符 </li>
<li>等等</li>
</ul>
<h2 id="OpenCV中规定的数据类型"><a href="#OpenCV中规定的数据类型" class="headerlink" title="OpenCV中规定的数据类型"></a>OpenCV中规定的数据类型</h2><table>
<thead>
<tr>
<th>数据类型</th>
<th>具体类型</th>
<th>取值范围</th>
</tr>
</thead>
<tbody><tr>
<td>CV_8U</td>
<td>8位无符号整数</td>
<td>0—255</td>
</tr>
<tr>
<td>CV_8S</td>
<td>8位符号整数</td>
<td>-128—127</td>
</tr>
<tr>
<td>CV_16U</td>
<td>16位无符号整数</td>
<td>0—65535</td>
</tr>
<tr>
<td>CV_16S</td>
<td>16位符号整数</td>
<td>-32768—32767</td>
</tr>
<tr>
<td>CV_32U</td>
<td>32位无符号整数</td>
<td>0—4294967295</td>
</tr>
<tr>
<td>CV_32S</td>
<td>32位符号整数</td>
<td>-2147483648—2147483647</td>
</tr>
<tr>
<td>CV_32F</td>
<td>32位浮点整数</td>
<td>-FLT_MAX—FLT_MAX, INF, NAN</td>
</tr>
<tr>
<td>CV_64F</td>
<td>64位浮点整数</td>
<td>-DBL_MAX—DBL_MAX, INF, NAN</td>
</tr>
</tbody></table>
<h2 id="Mat类的赋值"><a href="#Mat类的赋值" class="headerlink" title="Mat类的赋值"></a>Mat类的赋值</h2><h3 id="创建时赋值"><a href="#创建时赋值" class="headerlink" title="创建时赋值"></a>创建时赋值</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv::Mat::<span class="built_in">Mat</span>(<span class="type">int</span> rows,<span class="type">int</span> cols,<span class="type">int</span> type,<span class="type">const</span> Scalar&amp; s)</span><br></pre></td></tr></table></figure>

<ul>
<li>rows: 矩阵的行数</li>
<li>cols: 矩阵的列数</li>
<li>type: 存储数据的类型,矩阵中存储的数据类型,此处除了CV_8UC1,CV_64FC4等从1到4通道以外,还提供了更多通道的参数,通过CV_8UC(n)中的n来构建多通道矩阵,其中n最大可以取到512</li>
<li>s: 给矩阵中每个像素赋值的参数变量,如<code>Scalar(0,0,255)</code></li>
</ul>
<h3 id="利用已有的Mat类创建新的Mat类"><a href="#利用已有的Mat类创建新的Mat类" class="headerlink" title="利用已有的Mat类创建新的Mat类"></a>利用已有的Mat类创建新的Mat类</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv::Mat::<span class="built_in">Mat</span>(<span class="type">const</span> Mat&amp; m,<span class="type">const</span> Range&amp; rowRange,<span class="type">const</span> Range&amp; colRange=Range::<span class="built_in">all</span>())</span><br></pre></td></tr></table></figure>

<ul>
<li>m: 已经构建完成的Mat类矩阵数据</li>
<li>rowRange: 在已有矩阵中需要截取的行数范围,是一个Range变量,例如从第2行到第5行(不包括第2行与第5行)可以表示为<code>Range(2,5)</code></li>
<li>colRange: 在已有矩阵中需要截取的列数范围,是一个Range变量,例如从第2列到第5列(不包括第2列与第5列)可以表示为<code>Range(2,5)</code>,在不输入任何值时表示所有列都会被截取</li>
</ul>
<h3 id="利用矩阵Size-结构和数据类型参数创建Mat类"><a href="#利用矩阵Size-结构和数据类型参数创建Mat类" class="headerlink" title="利用矩阵Size()结构和数据类型参数创建Mat类"></a>利用矩阵Size()结构和数据类型参数创建Mat类</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv::Mat::<span class="built_in">Mat</span>(Size size,<span class="type">int</span> type)</span><br></pre></td></tr></table></figure>

<ul>
<li>size: 2D数组变量尺寸,通过Size(cols,rows)进行赋值,如<code>Size(3,3)</code></li>
<li>type: 存储数据的类型</li>
</ul>
<h3 id="Mat类方法赋值"><a href="#Mat类方法赋值" class="headerlink" title="Mat类方法赋值"></a>Mat类方法赋值</h3><ul>
<li>eye: 单位矩阵</li>
<li>diag: 对角矩阵</li>
<li>ones: 元素全为1的矩阵</li>
<li>zeros: 元素全为0的矩阵</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv::Mat a=cv::Mat::<span class="built_in">eye</span>(<span class="number">3</span>,<span class="number">3</span>,type);</span><br></pre></td></tr></table></figure>

<h3 id="枚举法赋值"><a href="#枚举法赋值" class="headerlink" title="枚举法赋值"></a>枚举法赋值</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cv::Mat a=(cv::<span class="built_in">Mat_</span>&lt;<span class="type">int</span>&gt;(<span class="number">3</span>,<span class="number">3</span>)&lt;&lt;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>);</span><br><span class="line">cv::Mat b=(cv::<span class="built_in">Mat_</span>&lt;<span class="type">double</span>&gt;(<span class="number">2</span>,<span class="number">3</span>)&lt;&lt;<span class="number">1.0</span>,<span class="number">2.1</span>,<span class="number">3.2</span>,<span class="number">4.0</span>,<span class="number">5.1</span>,<span class="number">6.2</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Mat类元素的读取"><a href="#Mat类元素的读取" class="headerlink" title="Mat类元素的读取"></a>Mat类元素的读取</h2><p>Mat数据在内存中存放形式</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202409100927679.png" alt="image-20240910092715148" style="zoom: 25%;" />

<h3 id="常用属性"><a href="#常用属性" class="headerlink" title="常用属性"></a>常用属性</h3><table>
<thead>
<tr>
<th>属性</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>cols</td>
<td>矩阵的列数(以像素个数为单位)</td>
</tr>
<tr>
<td>rows</td>
<td>矩阵的行数(以像素个数为单位)</td>
</tr>
<tr>
<td>step</td>
<td>以字节为单位的矩阵的有效宽度</td>
</tr>
<tr>
<td>elemSize()</td>
<td>每个元素的字节数</td>
</tr>
<tr>
<td>total()</td>
<td>矩阵中元素的个数(总像素个数)</td>
</tr>
<tr>
<td>channels()</td>
<td>矩阵的通道数</td>
</tr>
</tbody></table>
<h3 id="at方法读取"><a href="#at方法读取" class="headerlink" title="at方法读取"></a>at方法读取</h3><p><code>at(int row,int col)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单通道</span></span><br><span class="line"><span class="type">int</span> value = (<span class="type">int</span>)a.<span class="built_in">at</span>&lt;uchar&gt;(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">//多通道</span></span><br><span class="line">cv::Vec3b vc3 = b.<span class="built_in">at</span>&lt;cv::Vec3b&gt;(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="type">int</span> first = (<span class="type">int</span>)vc<span class="number">3.</span>val[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>

<blockquote>
<p>罗列一些预设数据类型的命名规则</p>
<ul>
<li>Vec3b  三个通道字节字节型</li>
<li>Vec2b  两个通道字节型</li>
<li>Vec4i  四个通道int型</li>
</ul>
</blockquote>
<h3 id="矩阵元素地址定位方式访问元素"><a href="#矩阵元素地址定位方式访问元素" class="headerlink" title="矩阵元素地址定位方式访问元素"></a>矩阵元素地址定位方式访问元素</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单通道</span></span><br><span class="line">(<span class="type">int</span>)(*(b.data+b.step[<span class="number">0</span>]*row +b.step[<span class="number">1</span>]*col+channel));</span><br></pre></td></tr></table></figure>

<h2 id="Mat支持的运算"><a href="#Mat支持的运算" class="headerlink" title="Mat支持的运算"></a>Mat支持的运算</h2><p>直接利用数学符号表示矩阵的运算</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//矩阵与数字的运算,都是将运算应用于每个元素</span></span><br><span class="line">e=a+b;</span><br><span class="line">f=c-d;</span><br><span class="line">g=<span class="number">2</span>*a;</span><br><span class="line">h=d/<span class="number">2.0</span>;</span><br><span class="line">i=a<span class="number">-1</span>;<span class="comment">//Mat类减数字,是Mat中每个元素都减去这个数字</span></span><br></pre></td></tr></table></figure>

<h3 id="两个矩阵相乘"><a href="#两个矩阵相乘" class="headerlink" title="两个矩阵相乘"></a>两个矩阵相乘</h3><ul>
<li>矩阵乘积   <code>*</code>  <code>a = b*c;</code></li>
<li>向量内积   <code>.dot</code>   <code>a.dot(b)</code></li>
<li>对应位元素乘积  <code>.mul()</code>   <code>a.mul(b)</code></li>
</ul>
<p>[[数学#乘法意义盘点|上述各种乘法的现实意义参考此处]]</p>
<h3 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h3><table>
<thead>
<tr>
<th>函数名</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>absdiff()</td>
<td>两个矩阵对应元素差的绝对值</td>
</tr>
<tr>
<td>add()</td>
<td>两个矩阵求和</td>
</tr>
<tr>
<td>addWeighted()</td>
<td>两个矩阵线性求和</td>
</tr>
<tr>
<td>divide()</td>
<td>矩阵除法</td>
</tr>
<tr>
<td>invert()</td>
<td>矩阵求逆</td>
</tr>
<tr>
<td>log()</td>
<td>矩阵求对数</td>
</tr>
<tr>
<td>max()&#x2F;min()</td>
<td>两个矩阵计算最大值&#x2F;最小值.<code>min(a, b)</code> 会返回一个新的矩阵，其中每个元素都是 <code>a</code> 和 <code>b</code> 中对应位置元素的最小值</td>
</tr>
</tbody></table>
<blockquote>
<ul>
<li><p>矩阵的线性求和: 是指将多个矩阵按一定的权重进行求和。具体来说，线性求和涉及到对每个矩阵的元素乘以一个标量（权重），然后再进行求和。</p>
</li>
<li><p>矩阵求和: 是指将两个相同维度的矩阵对应位置的元素相加，得到一个新的矩阵。</p>
</li>
<li><p>矩阵除法: 实际上是A&#x2F;B &#x3D; A * B的逆矩阵</p>
<p>意义</p>
<ul>
<li>求解线性方程组</li>
<li>矩阵可以用来表示线性变换。矩阵的“除法”可以理解为反向应用这种变换</li>
</ul>
</li>
<li><p>矩阵对数   略,也非常重要</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ZG4y1a7RQ/">矩阵运算的理解</a></p>
</blockquote>
<h1 id="基本图像处理操作"><a href="#基本图像处理操作" class="headerlink" title="基本图像处理操作"></a>基本图像处理操作</h1><h2 id="灰度-高斯模糊-边缘-扩张-侵蚀"><a href="#灰度-高斯模糊-边缘-扩张-侵蚀" class="headerlink" title="灰度&#x2F;高斯模糊&#x2F;边缘&#x2F;扩张&#x2F;侵蚀"></a>灰度&#x2F;高斯模糊&#x2F;边缘&#x2F;扩张&#x2F;侵蚀</h2><ul>
<li>转换为灰度图像</li>
<li>添加高斯模糊</li>
<li>canny边缘检测</li>
<li>图像扩张</li>
<li>图像侵蚀</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">string path = <span class="string">&quot;../../Resources/str.jpeg&quot;</span>;</span><br><span class="line">Mat img = <span class="built_in">imread</span>(path);</span><br><span class="line"><span class="comment">//转为灰度图像</span></span><br><span class="line">Mat imgGray;</span><br><span class="line"><span class="built_in">cvtColor</span>(img,imgGray,COLOR_BGR2GRAY);<span class="comment">//opencv中将RGB称为BGR</span></span><br><span class="line"><span class="comment">//添加高斯模糊</span></span><br><span class="line">Mat imgBlur;</span><br><span class="line"><span class="built_in">GaussianBlur</span>(img,imgBlur,<span class="built_in">Size</span>(<span class="number">3</span>,<span class="number">3</span>),<span class="number">3</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">//canny边缘检测,边缘检测前,通常需要做些模糊处理</span></span><br><span class="line">Mat imgCanny;</span><br><span class="line"><span class="built_in">Canny</span>(imgBlur,imgCanny,<span class="number">25</span>,<span class="number">75</span>);</span><br><span class="line"><span class="comment">//图像扩张(增加厚度)</span></span><br><span class="line">Mat imgDil;</span><br><span class="line">Mat kernel = <span class="built_in">getStructuringElement</span>(MORPH_RECT,<span class="built_in">Size</span>(<span class="number">5</span>,<span class="number">5</span>));<span class="comment">//有尽量使用奇数的说法,似乎是会导致图像偏移?</span></span><br><span class="line"><span class="built_in">dilate</span>(imgCanny,imgDil,kernel);</span><br><span class="line"><span class="comment">//图像侵蚀(减少厚度)</span></span><br><span class="line">Mat imgErode;</span><br><span class="line"><span class="built_in">erode</span>(imgDil,imgErode,kernel);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image&quot;</span>,img);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Gray&quot;</span>,imgGray);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Blur&quot;</span>,imgBlur);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Canny&quot;</span>,imgCanny);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Dilation&quot;</span>,imgDil);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Erode&quot;</span>,imgErode);</span><br><span class="line"><span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">DestroyAllWindows</span>();</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051346016.png" alt="image-20240505134628409" style="zoom:50%;" />

<h2 id="亮度与对比度"><a href="#亮度与对比度" class="headerlink" title="亮度与对比度"></a>亮度与对比度</h2><p><code>ConvertTo</code> 和 <code>ConvertScaleAbs</code> 是 OpenCV 中用于图像处理的两个函数，它们的主要区别在于功能和用途。</p>
<h3 id="ConvertTo"><a href="#ConvertTo" class="headerlink" title="ConvertTo"></a>ConvertTo</h3><ul>
<li><p><strong>功能</strong>：用于将图像从一种数据类型转换为另一种数据类型，同时可以应用缩放因子和偏移量。</p>
</li>
<li><p><strong>用法</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv::<span class="built_in">convertTo</span>(src, dst, dtype, alpha, beta)</span><br></pre></td></tr></table></figure>
<p>其中 <code>src</code> 是输入图像，<code>dst</code> 是输出图像，<code>dtype</code> 是目标数据类型，<code>alpha</code> 是缩放因子，<code>beta</code> 是偏移量。</p>
</li>
<li><p><strong>示例</strong>：可以将图像从 <code>CV_8U</code> 转换为 <code>CV_32F</code>，并且可以在转换时调整亮度和对比度。</p>
</li>
</ul>
<h3 id="ConvertScaleAbs"><a href="#ConvertScaleAbs" class="headerlink" title="ConvertScaleAbs"></a>ConvertScaleAbs</h3><ul>
<li><p><strong>功能</strong>：用于将图像转换为绝对值并缩放，同时将结果转换为 <code>CV_8U</code> 类型。</p>
</li>
<li><p><strong>用法</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv::<span class="built_in">convertScaleAbs</span>(src, dst, alpha, beta)</span><br></pre></td></tr></table></figure>
<p>其中 <code>src</code> 是输入图像，<code>dst</code> 是输出图像，<code>alpha</code> 是缩放因子，<code>beta</code> 是偏移量。</p>
</li>
<li><p><strong>示例</strong>：通常用于将浮点图像转换为 8 位图像，适合于显示和保存。</p>
</li>
</ul>
<p>对于输入图像中的每个像素，函数执行如下转换：<br>$$<br> \text{dst}(x, y) &#x3D; \text{abs}(\alpha \cdot \text{src}(x, y) + \beta)<br>$$</p>
<ul>
<li>alpha<strong>（对比度）</strong>：如果 alpha &gt; 1，图像的对比度会增加（图像更加清晰）；如果 alpha &lt; 1，图像的对比度会减小。</li>
<li>beta<strong>（亮度）</strong>：控制增加或减少像素的亮度值。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><code>ConvertTo</code> 更加灵活，支持多种数据类型的转换和调整。</li>
<li><code>ConvertScaleAbs</code> 专注于将图像转换为 8 位无符号整数，并且自动处理绝对值，通常用于将处理后的图像准备好进行显示。</li>
</ul>
<h2 id="调整图像大小-裁剪图像"><a href="#调整图像大小-裁剪图像" class="headerlink" title="调整图像大小&#x2F;裁剪图像"></a>调整图像大小&#x2F;裁剪图像</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">string path = <span class="string">&quot;../../Resources/str.jpeg&quot;</span>;</span><br><span class="line">Mat img = <span class="built_in">imread</span>(path);</span><br><span class="line"><span class="comment">//调整大小</span></span><br><span class="line">Mat imgResize,imgResize2;</span><br><span class="line">std::cout&lt;&lt;img.<span class="built_in">size</span>()&lt;&lt;std::endl;<span class="comment">//打印图像原本大小  [468 x 265]</span></span><br><span class="line"><span class="built_in">resize</span>(img,imgResize,<span class="built_in">Size</span>(<span class="number">400</span>,<span class="number">200</span>));<span class="comment">//缩放为大小:400,200(无视宽高比调整)</span></span><br><span class="line"><span class="built_in">resize</span>(img,imgResize2,<span class="built_in">Size</span>(),<span class="number">0.5</span>,<span class="number">0.5</span>);<span class="comment">//0,5倍等比例缩小</span></span><br><span class="line"><span class="comment">//裁切</span></span><br><span class="line">Mat imgCrop;</span><br><span class="line"><span class="function">Rect <span class="title">roi</span><span class="params">(<span class="number">100</span>,<span class="number">100</span>,<span class="number">200</span>,<span class="number">50</span>)</span></span>;</span><br><span class="line">imgCrop = <span class="built_in">img</span>(roi);<span class="comment">//裁切区间必须小于图像本身大小,不然会报错</span></span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image&quot;</span>,img);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Resize&quot;</span>,imgResize);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Resize2&quot;</span>,imgResize2);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Crop&quot;</span>,imgCrop);</span><br><span class="line"><span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">DestroyAllWindows</span>();</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051402051.png" alt="image-20240505140243693" style="zoom: 50%;" />

<h2 id="绘制"><a href="#绘制" class="headerlink" title="绘制"></a>绘制</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新建空白图片,参数解释如下:</span></span><br><span class="line"><span class="comment">//CV_8UC3中 8表示2的8次方,U表示无符号(结合前面就是0~255),C3表示三通道(3 channels)</span></span><br><span class="line"><span class="comment">//Scalar(255,255,255)表示白色</span></span><br><span class="line"><span class="function">Mat <span class="title">img</span><span class="params">(<span class="number">512</span>,<span class="number">512</span>,CV_8UC3,Scalar(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>))</span></span>;</span><br><span class="line"><span class="comment">//画圆圈  从坐标(256,256)做半斤为155的圆圈,颜色为(0,69,255),线条粗细为10(若为FILLED表示实心圆)(注意这个线条粗细是往两边同时扩张的)</span></span><br><span class="line"><span class="built_in">circle</span>(img,<span class="built_in">Point</span>(<span class="number">256</span>,<span class="number">256</span>),<span class="number">155</span>,<span class="built_in">Scalar</span>(<span class="number">0</span>,<span class="number">69</span>,<span class="number">255</span>),<span class="number">50</span>);</span><br><span class="line"><span class="comment">//画矩形</span></span><br><span class="line"><span class="built_in">rectangle</span>(img,<span class="built_in">Point</span>(<span class="number">101</span>,<span class="number">101</span>),<span class="built_in">Point</span>(<span class="number">411</span>,<span class="number">411</span>),<span class="built_in">Scalar</span>(<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>),<span class="number">3</span>);</span><br><span class="line"><span class="comment">//画线</span></span><br><span class="line"><span class="built_in">line</span>(img,<span class="built_in">Point</span>(<span class="number">130</span>,<span class="number">296</span>),<span class="built_in">Point</span>(<span class="number">382</span>,<span class="number">296</span>),<span class="built_in">Scalar</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),<span class="number">2</span>);</span><br><span class="line"><span class="comment">//画文本(不支持中文,将会是乱码)</span></span><br><span class="line"><span class="built_in">putText</span>(img,<span class="string">&quot;hello world!&quot;</span>,<span class="built_in">Point</span>(<span class="number">20</span>,<span class="number">262</span>),FONT_HERSHEY_DUPLEX,<span class="number">0.7</span>,<span class="built_in">Scalar</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),<span class="number">2</span>);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image&quot;</span>,img);</span><br><span class="line"><span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">DestroyAllWindows</span>();</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051437596.png" alt="image-20240505143710291" style="zoom:33%;" />

<h2 id="仿射变换"><a href="#仿射变换" class="headerlink" title="仿射变换"></a>仿射变换</h2><ul>
<li>仿射变换是线性变换和平移的组合。</li>
<li>仿射变换保持直线的性质,但不保持原点不变。</li>
<li>仿射变换可以用矩阵乘法和向量加法来表示</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">string path = <span class="string">&quot;../../Resources/cards.jpg&quot;</span>;</span><br><span class="line">Mat img = <span class="built_in">imread</span>(path);</span><br><span class="line"><span class="type">float</span> w = <span class="number">250</span>;</span><br><span class="line"><span class="type">float</span> h = <span class="number">350</span>;</span><br><span class="line">Mat matrix,imgWarp;<span class="comment">//分别用于存储透视变换的矩阵,用于存储变换后的图像</span></span><br><span class="line"></span><br><span class="line">Point2f src[<span class="number">4</span>] =&#123;&#123;<span class="number">520</span>,<span class="number">142</span>&#125;,&#123;<span class="number">771</span>,<span class="number">190</span>&#125;,&#123;<span class="number">405</span>,<span class="number">395</span>&#125;,&#123;<span class="number">674</span>,<span class="number">457</span>&#125;&#125;;<span class="comment">//定义变换前的矩形</span></span><br><span class="line">Point2f dst[<span class="number">4</span>] =&#123;&#123;<span class="number">0.0f</span>,<span class="number">0.0f</span>&#125;,&#123;w,<span class="number">0.0f</span>&#125;,&#123;<span class="number">0.0f</span>,h&#125;,&#123;w,h&#125;&#125;;<span class="comment">//定义变换后的矩形</span></span><br><span class="line"></span><br><span class="line">matrix = <span class="built_in">getPerspectiveTransform</span>(src,dst);<span class="comment">//计算透视变换矩阵matrix</span></span><br><span class="line"><span class="comment">///使用warpPerspective函数，将img中的图像应用透视变换，结果存储在imgWarp中。参数matrix是变换矩阵，Point(w,h)指定输出图像的大小</span></span><br><span class="line"><span class="built_in">warpPerspective</span>(img,imgWarp,matrix,<span class="built_in">Point</span>(w,h));</span><br><span class="line"></span><br><span class="line"><span class="comment">//画上一些标记点</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">circle</span>(img,src[i],<span class="number">10</span>,<span class="built_in">Scalar</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>),FILLED);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image&quot;</span>,img);</span><br><span class="line"><span class="built_in">imshow</span>(<span class="string">&quot;Image Warp&quot;</span>,imgWarp);</span><br><span class="line"><span class="built_in">DestroyAllWindows</span>();</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202405051810787.png" alt="image-20240505181014198" style="zoom: 50%;" />

<h2 id="颜色检测"><a href="#颜色检测" class="headerlink" title="颜色检测"></a>颜色检测</h2><h2 id="直方图均衡化"><a href="#直方图均衡化" class="headerlink" title="直方图均衡化"></a>直方图均衡化</h2><p><strong>直方图均衡化（Histogram Equalization）</strong>是一种用于图像处理的技术，目的是增强图像的对比度，使得图像的亮度分布更加均匀。这种方法尤其适合提升灰度图像的对比度，但也可以扩展到彩色图像。</p>
<p>像的<strong>直方图</strong>表示图像中不同灰度级（亮度）的像素分布情况。例如，假设一个灰度图像的像素值在 0（黑色）到 255（白色）之间，那么直方图就展示了每个灰度级出现的次数。通过分析直方图，可以判断图像是否过亮、过暗，或对比度过低。</p>
<p><strong>直方图均衡化</strong>的核心思想是通过重新分布图像的灰度值，使得像素在所有灰度级上的分布更为均匀，从而增加图像的整体对比度。</p>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><blockquote>
<p>通过累积分布函数重新分配图像的灰度级，从而均衡亮度并提升细节</p>
</blockquote>
<ol>
<li><p>计算直方图：首先，计算图像中每个灰度值的像素数量，得到图像的直方图。</p>
</li>
<li><p>计算累积分布函数 (CDF)：累积分布函数表示某个灰度级及其以下的所有像素值在图像中所占的总比例。计算每个灰度值的累积概率分布。公式如下：<br>$$<br>CDF(i) &#x3D; \sum_{j&#x3D;0}^{i} p(j)<br>$$<br>其中，<code>p(j)</code> 是第 j 灰度值出现的概率。</p>
</li>
<li><p>灰度值映射：根据累积分布函数，将每个灰度值映射到一个新的灰度值区间。新的灰度值会是原始值的线性扩展，从而平衡亮度分布。公式为：<br>$$<br>new_pixel_value &#x3D; CDF(i) \times (L - 1)<br>$$<br>其中，L 是灰度级数（例如，对于 8 位图像，L 为 256）。</p>
</li>
<li><p>生成均衡化后的图像：将所有像素点的灰度值通过映射转换为新的值，得到对比度增强的图像。</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实际计算案例参考如下:</span></span><br><span class="line">假设有一个简单的直方图，灰度值为 <span class="number">0</span> 到 <span class="number">3</span>，频率如下：</span><br><span class="line"></span><br><span class="line">| 灰度值 | 频率 |</span><br><span class="line">|--------|------|</span><br><span class="line">| <span class="number">0</span>      | <span class="number">2</span>    |</span><br><span class="line">| <span class="number">1</span>      | <span class="number">3</span>    |</span><br><span class="line">| <span class="number">2</span>      | <span class="number">1</span>    |</span><br><span class="line">| <span class="number">3</span>      | <span class="number">2</span>    |</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 计算直方图：</span><br><span class="line">   - 直方图已经给出。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 计算 <span class="variable constant_">CDF</span>：</span><br><span class="line">   - <span class="title function_">CDF</span>(<span class="number">0</span>) = <span class="number">2</span></span><br><span class="line">   - <span class="title function_">CDF</span>(<span class="number">1</span>) = <span class="number">2</span> + <span class="number">3</span> = <span class="number">5</span></span><br><span class="line">   - <span class="title function_">CDF</span>(<span class="number">2</span>) = <span class="number">5</span> + <span class="number">1</span> = <span class="number">6</span></span><br><span class="line">   - <span class="title function_">CDF</span>(<span class="number">3</span>) = <span class="number">6</span> + <span class="number">2</span> = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 归一化 <span class="variable constant_">CDF</span>（假设总像素数 N = <span class="number">8</span>）：</span><br><span class="line">   - <span class="title function_">CDF_norm</span>(<span class="number">0</span>) = <span class="number">2</span> / <span class="number">8</span> = <span class="number">0.25</span></span><br><span class="line">   - <span class="title function_">CDF_norm</span>(<span class="number">1</span>) = <span class="number">5</span> / <span class="number">8</span> = <span class="number">0.625</span></span><br><span class="line">   - <span class="title function_">CDF_norm</span>(<span class="number">2</span>) = <span class="number">6</span> / <span class="number">8</span> = <span class="number">0.75</span></span><br><span class="line">   - <span class="title function_">CDF_norm</span>(<span class="number">3</span>) = <span class="number">8</span> / <span class="number">8</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 映射到新的灰度值（L = <span class="number">4</span>）：</span><br><span class="line">   - <span class="title function_">new_pixel_value</span>(<span class="number">0</span>) = <span class="number">0.25</span> * (<span class="number">4</span> - <span class="number">1</span>) = <span class="number">0.75</span> → 变为 <span class="number">1</span>（取整）</span><br><span class="line">   - <span class="title function_">new_pixel_value</span>(<span class="number">1</span>) = <span class="number">0.625</span> * (<span class="number">4</span> - <span class="number">1</span>) = <span class="number">1.875</span> → 变为 <span class="number">2</span></span><br><span class="line">   - <span class="title function_">new_pixel_value</span>(<span class="number">2</span>) = <span class="number">0.75</span> * (<span class="number">4</span> - <span class="number">1</span>) = <span class="number">2.25</span> → 变为 <span class="number">2</span></span><br><span class="line">   - <span class="title function_">new_pixel_value</span>(<span class="number">3</span>) = <span class="number">1.0</span> * (<span class="number">4</span> - <span class="number">1</span>) = <span class="number">3.0</span> → 变为 <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 生成新的图像:</span><br><span class="line">   - 替换原始灰度值为新灰度值，得到增强后的图像。</span><br></pre></td></tr></table></figure>

<p>经过直方图均衡化处理的图像通常会显得更加清晰，对比度更强。<strong>对于暗淡或亮度不均的图像，这种方法非常有效</strong>。直方图均衡化可以让更多的细节显现出来，尤其是在光照不足的情况下。直方图均衡化处理使得整个图像的亮度分布更加均匀，提升图像的可视性。</p>
<blockquote>
<p><strong>局限性</strong></p>
<ul>
<li><strong>过度增强</strong>：在某些情况下，直方图均衡化可能会导致图像的噪声也被增强，从而影响图像质量。</li>
<li><strong>色彩失真</strong>：在处理彩色图像时，若直接对每个颜色通道单独进行均衡化，可能会导致色彩失真。因此，处理彩色图像时通常采用类似的技术，比如<strong>自适应直方图均衡化</strong>或<strong>对亮度通道进行均衡化</strong>。</li>
</ul>
</blockquote>
<h3 id="python案例"><a href="#python案例" class="headerlink" title="python案例"></a>python案例</h3><p>在OpenCV中，直方图均衡化可以通过函数 cv2.equalizeHist() 实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取灰度图像</span></span><br><span class="line">img = cv2.imread(<span class="string">&#x27;image.jpg&#x27;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行直方图均衡化</span></span><br><span class="line">equalized_img = cv2.equalizeHist(img)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示原图与均衡化后的图像</span></span><br><span class="line">cv2.imshow(<span class="string">&#x27;Original Image&#x27;</span>, img)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;Equalized Image&#x27;</span>, equalized_img)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">cv2.destroyAllWindows()</span><br></pre></td></tr></table></figure>

<p>对于彩色图像，可以先将其转换到 <strong>YUV</strong> 颜色空间，对亮度通道（Y）进行均衡化，然后再转换回 RGB 颜色空间：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取彩色图像</span></span><br><span class="line">img = cv2.imread(<span class="string">&#x27;image.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换为YUV颜色空间</span></span><br><span class="line">yuv_img = cv2.cvtColor(img, cv2.COLOR_BGR2YUV)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对亮度通道Y进行直方图均衡化</span></span><br><span class="line">yuv_img[:, :, <span class="number">0</span>] = cv2.equalizeHist(yuv_img[:, :, <span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转回RGB颜色空间</span></span><br><span class="line">equalized_img = cv2.cvtColor(yuv_img, cv2.COLOR_YUV2BGR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示结果</span></span><br><span class="line">cv2.imshow(<span class="string">&#x27;Equalized Image&#x27;</span>, equalized_img)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">cv2.destroyAllWindows()</span><br></pre></td></tr></table></figure>

<h3 id="自适应直方图均衡化"><a href="#自适应直方图均衡化" class="headerlink" title="自适应直方图均衡化"></a>自适应直方图均衡化</h3><blockquote>
<p>全面替代<a href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E5%9D%87%E8%A1%A1%E5%8C%96">直方图均衡化</a></p>
</blockquote>
<p>自适应直方图均衡化（<strong>Adaptive Histogram Equalization</strong>, 简称 AHE）是一种改进的直方图均衡化技术，主要用于提升图像局部区域的对比度。在普通的直方图均衡化中，整个图像使用全局直方图进行处理，这可能导致对比度过度增强或者细节丢失，<strong>尤其是在对比度变化较大的图像中</strong>。自适应直方图均衡化通过对图像的不同区域分别进行均衡化，来解决这些问题。</p>
<p>在 C++ 中，使用 OpenCV 可以通过 CLAHE（<strong>Contrast Limited Adaptive Histogram Equalization</strong>，对比度限制的自适应直方图均衡化）来实现这种效果。CLAHE 是 AHE 的一种改进，它通过限制对比度增强的强度，防止过度增强。</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><ol>
<li><strong>分块处理</strong>：将图像分成多个小块（通常称为“网格”或“区块”），并对每个小块分别进行直方图均衡化。每个小块的对比度都根据其局部直方图来调整。</li>
<li><strong>插值</strong>：为了避免块与块之间出现明显的边界（块效应），会对相邻块的均衡化结果进行[[算法#插值算法|双线性插值]]，使图像变得更平滑。</li>
<li><strong>对比度限制</strong>：在 CLAHE 中，会限制直方图中某个灰度值的最大频率（像素数量），这样可以防止局部区域对比度过高，避免过亮或过暗的区域产生噪声。</li>
</ol>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/imgproc.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 读取灰度图像</span></span><br><span class="line">    cv::Mat src = cv::<span class="built_in">imread</span>(<span class="string">&quot;image.jpg&quot;</span>, cv::IMREAD_GRAYSCALE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断图像是否成功加载</span></span><br><span class="line">    <span class="keyword">if</span>(src.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;图像加载失败！&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个CLAHE对象</span></span><br><span class="line">    <span class="comment">// clipLimit 是对比度限制阈值，tileGridSize 是分块的大小</span></span><br><span class="line">    cv::Ptr&lt;cv::CLAHE&gt; clahe = cv::<span class="built_in">createCLAHE</span>(<span class="number">2.0</span>, cv::<span class="built_in">Size</span>(<span class="number">8</span>, <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储均衡化后的结果</span></span><br><span class="line">    cv::Mat dst;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用CLAHE</span></span><br><span class="line">    clahe-&gt;<span class="built_in">apply</span>(src, dst);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示原图和处理后的图像</span></span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;Original Image&quot;</span>, src);</span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;CLAHE Image&quot;</span>, dst);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待按键</span></span><br><span class="line">    cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>创建 CLAHE 对象</strong>：</p>
<p>使用 <code>cv::createCLAHE()</code> 函数创建一个 CLAHE 对象。这个函数的两个参数分别是：</p>
<ul>
<li><strong>clipLimit</strong>：限制对比度的阈值，通常值在 2 到 4 之间。较大的值会允许更强的对比度增强。</li>
<li><strong>tileGridSize</strong>：控制分块的大小。较小的块会对局部区域增强更多细节。</li>
</ul>
<p><strong>应用 CLAHE</strong>：</p>
<p><code>clahe-&gt;apply()</code> 方法用于对图像进行自适应直方图均衡化，结果存储在 dst 中。</p>
<p>附一个CSharp案例</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应用CLAHE</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Mat <span class="title">ApplyCLAHE</span>(<span class="params">Mat input</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Mat output = <span class="keyword">new</span> Mat();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 转换到LAB颜色空间</span></span><br><span class="line">    Cv2.CvtColor(input, output, ColorConversionCodes.BGR2Lab);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分离通道</span></span><br><span class="line">    Mat[] channels = Cv2.Split(output);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对L通道应用CLAHE</span></span><br><span class="line">    <span class="keyword">var</span> clahe = Cv2.CreateCLAHE(<span class="number">2.0</span>, <span class="keyword">new</span> OpenCvSharp.Size(<span class="number">8</span>, <span class="number">8</span>));</span><br><span class="line">    Mat enhancedL = <span class="keyword">new</span> Mat();</span><br><span class="line">    clahe.Apply(channels[<span class="number">0</span>], enhancedL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个与原始L通道大小相同的Mat</span></span><br><span class="line">    Mat resizedL = <span class="keyword">new</span> Mat();</span><br><span class="line">    Cv2.Resize(enhancedL, resizedL, channels[<span class="number">0</span>].Size(), <span class="number">0</span>, <span class="number">0</span>, InterpolationFlags.Linear);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用双线性插值混合原始L通道和增强后的L通道</span></span><br><span class="line">    Mat blendedL = <span class="keyword">new</span> Mat();</span><br><span class="line">    Cv2.AddWeighted(channels[<span class="number">0</span>], <span class="number">0.5</span>, resizedL, <span class="number">0.5</span>, <span class="number">0</span>, blendedL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用混合后的L通道替换原始L通道</span></span><br><span class="line">    channels[<span class="number">0</span>] = blendedL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 合并通道</span></span><br><span class="line">    Cv2.Merge(channels, output);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换回BGR颜色空间</span></span><br><span class="line">    Cv2.CvtColor(output, output, ColorConversionCodes.Lab2BGR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 ApplyCLAHE 方法中：</p>
<ol>
<li>仍然将图像转换到 LAB 颜色空间并分离通道。</li>
<li>对 L 通道应用 CLAHE，但结果保存在一个新的 Mat enhancedL 中。</li>
<li>使用 Cv2.Resize 方法将增强后的 L 通道调整回原始大小，使用双线性插值（InterpolationFlags.Linear）。</li>
<li>使用 Cv2.AddWeighted 方法将原始 L 通道和增强后的 L 通道混合。这里使用了 0.5 的权重，您可以根据需要调整这个值。</li>
<li>用混合后的 L 通道替换原始 L 通道。</li>
<li>最后，合并通道并转换回 BGR 颜色空间。</li>
</ol>
<p>这种方法应该能显著减少块状效果，使结果更加平滑自然。您可以调整以下参数来进一步优化结果：</p>
<ul>
<li>CLAHE 的对比度限制（当前为 2.0）</li>
<li>CLAHE 的网格大小（当前为 8x8）</li>
<li>混合时原始和增强 L 通道的权重（当前各为 0.5）</li>
</ul>
<h1 id="视频加载与摄像头调用"><a href="#视频加载与摄像头调用" class="headerlink" title="视频加载与摄像头调用"></a>视频加载与摄像头调用</h1><h2 id="视频-摄像头加载"><a href="#视频-摄像头加载" class="headerlink" title="视频&#x2F;摄像头加载"></a>视频&#x2F;摄像头加载</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv::VideoCapture::<span class="built_in">VideoCapture</span>(<span class="type">const</span> String&amp; filename,<span class="type">int</span> apiPreference=CAP_ANY)</span><br></pre></td></tr></table></figure>

<ul>
<li>filename: 读取的视频文件或图像序列名称</li>
<li>apiPreference: 读取数据时设置的属性,例如编码格式,是否调用OpenNI等</li>
</ul>
<p>支持的摄像头类型</p>
<ol>
<li><p><strong>USB 摄像头</strong>：这是最常见的摄像头类型，您可以通过 <code>cv::VideoCapture</code> 类直接访问 USB 摄像头。通常情况下，您可以使用设备索引（例如 <code>0</code>、<code>1</code> 等）来打开 USB 摄像头。</p>
</li>
<li><p><strong>网络摄像头</strong>：OpenCV 也支持通过网络协议（如 RTSP 或 HTTP）访问网络摄像头。只需提供网络摄像头的 URL，您就可以使用 <code>cv::VideoCapture</code> 来打开和读取视频流。例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cv::VideoCapture <span class="title">cap</span><span class="params">(<span class="string">&quot;http://&lt;ip_address&gt;:&lt;port&gt;/video&quot;</span>)</span></span>; <span class="comment">// HTTP 流</span></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="function">cv::VideoCapture <span class="title">cap</span><span class="params">(<span class="string">&quot;rtsp://&lt;ip_address&gt;:&lt;port&gt;/stream&quot;</span>)</span></span>; <span class="comment">// RTSP 流</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>IP 摄像头</strong>：许多现代 IP 摄像头提供 RTSP 或 HTTP 流，您可以使用相同的方法通过 OpenCV 访问它们。</p>
</li>
</ol>
<p>打开视频文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">VideoCapture video;</span><br><span class="line">video.<span class="built_in">open</span>(<span class="string">&quot;视频文件路径&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!video.<span class="built_in">isOpened</span>())</span><br><span class="line">&#123;</span><br><span class="line">  cout&lt;&lt;<span class="string">&quot;未成功打开&quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Mat frame;</span><br><span class="line">  video&gt;&gt;frame;</span><br><span class="line">  <span class="keyword">if</span>(frame.<span class="built_in">empty</span>())</span><br><span class="line">  	<span class="keyword">break</span>;</span><br><span class="line"> 	<span class="built_in">imshow</span>(<span class="string">&quot;video&quot;</span>,frame);</span><br><span class="line">  uchar c = <span class="built_in">waitKey</span>(<span class="number">1000</span>/video.<span class="built_in">get</span>(CAP_PROP_FPS));<span class="comment">//等待每帧的时间,没输入就等&quot;算出来的帧间隔&quot;那么长时间</span></span><br><span class="line">  <span class="keyword">if</span>(c==<span class="string">&#x27;q&#x27;</span>)<span class="comment">//按q退出</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="视频属性获取"><a href="#视频属性获取" class="headerlink" title="视频属性获取"></a>视频属性获取</h2><p>通过<code>get()</code>函数可以获取下面的属性,如:<code>cap.get(CAP_PROP_FRAME_WIDTH);</code></p>
<table>
<thead>
<tr>
<th>标志参数</th>
<th>简记</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>CAP_PROP_POS_MSEC</td>
<td>0</td>
<td>视频文件的当前位置(以毫秒为单位)</td>
</tr>
<tr>
<td>CAP_PROP_FRAME_WIDTH</td>
<td>3</td>
<td>视频流中图像的<strong>宽度</strong></td>
</tr>
<tr>
<td>CAP_PROP_FRAME_HEIGHT</td>
<td>4</td>
<td>视频流中图像的<strong>高度</strong></td>
</tr>
<tr>
<td>CAP_PROP_FPS</td>
<td>5</td>
<td>视频流中图像的<strong>帧率</strong>(每秒帧数)</td>
</tr>
<tr>
<td>CAP_PROP_FOURCC</td>
<td>6</td>
<td>编解码器的4字符代码</td>
</tr>
<tr>
<td>CAP_PROP_FRAME_COUNT</td>
<td>7</td>
<td>视频流中图像的帧数</td>
</tr>
<tr>
<td>CAP_PROP_FORMAT</td>
<td>8</td>
<td>返回的Mat对象的格式</td>
</tr>
<tr>
<td>CAP_PROP_BRIGHTNESS</td>
<td>10</td>
<td>图像的亮度(仅适用于支持的相机)</td>
</tr>
<tr>
<td>CAP_PROP_CONTRAST</td>
<td>11</td>
<td>图像对比度(仅适用于相机)</td>
</tr>
<tr>
<td>CAP_PROP_SATURATION</td>
<td>12</td>
<td>图像饱和度(仅适用于相机)</td>
</tr>
<tr>
<td>CAP_PROP_HUE</td>
<td>13</td>
<td>图像的色调(仅适用于相机)</td>
</tr>
<tr>
<td>CAP_PROP_GAIN</td>
<td>14</td>
<td>图像的增益(仅适用于支持的相机)</td>
</tr>
</tbody></table>
<p>如果使用的是opencv3以前的版本,属性名前还要加<code>CV_</code></p>
<h2 id="相关方法"><a href="#相关方法" class="headerlink" title="相关方法"></a>相关方法</h2><ul>
<li><p><code>bool isOpened() const</code>: 检查视频是否成功打开。</p>
</li>
<li><p><code>bool read(OutputArray image)</code>: 读取视频中的一帧，并将其存储在Mat对象中。</p>
</li>
<li><p><code>void release()</code>: 释放VideoCapture对象所占用的资源。</p>
</li>
<li><p><code>double get(int propId)</code>: 获取视频属性，如帧率、宽度、高度等。</p>
</li>
<li><p><code>bool set(int propId, double value)</code>: 设置视频属性，如帧率、宽度、高度等。</p>
<p>调用 <code>set</code> 函数之后，后续捕获的帧或写入的视频将会应用新的属性设置。</p>
</li>
</ul>
<h2 id="视频图像逐帧获取"><a href="#视频图像逐帧获取" class="headerlink" title="视频图像逐帧获取"></a>视频图像逐帧获取</h2><blockquote>
<p>OpenCV为了减缓内存消耗，VideoWriter会将数据直接保存到外存，这样就可以保证在内存极小的情况下进行长时间录制，故嵌入式设备如果发现内存不足应将注意力放在其他地方，大部分时候都是Mat实例调用clone函数进行克隆，但未即使释放内存。</p>
</blockquote>
<h3 id="VideoWriter"><a href="#VideoWriter" class="headerlink" title="VideoWriter"></a>VideoWriter</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cv::VideoWriter::<span class="built_in">VideoWriter</span>(<span class="type">const</span> String&amp; filename,<span class="type">int</span> fourcc,<span class="type">double</span> fps,Size frameSize,<span class="type">bool</span> isColor=<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>filename: 保存视频的地址和文件名,包含视频格式</li>
<li><a href="#fourcc">fourcc</a>: 压缩帧的4字符编解码器代码</li>
<li>fps: 保存视频的帧率,即视频中每秒图像的张数,这个数字若小于原视频帧率,则是快放,否则是慢放</li>
<li>frameSize: 视频帧的尺寸,是一个 <code>cv::Size</code> 对象，包含两个整数，分别表示视频帧的宽度和高度,<strong>这里的视频帧尺寸必须是和图像的大小一致</strong>,如果想要更改分辨率大小,必须将图像调整(使用 <code>cv::resize</code> 函数)之后再次进行保存才可以</li>
<li>isColor: 保存视频是否为彩色视频</li>
</ul>
<p>例子: <code>VideoWriter()</code></p>
<h3 id="fourcc"><a href="#fourcc" class="headerlink" title="fourcc"></a>fourcc</h3><p>用于在构造VideoWriter时设置编码格式，具体的设置需要有硬件提供支持，常见的有以下几种：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;0&#x27;</span>) </span><br><span class="line"><span class="comment">//这个选项是一个未压缩的YUV编码，4:2:0色度子采样。这种编码广泛兼容，但会产生大文件。文件扩展名应为.avi。</span></span><br><span class="line"> </span><br><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="comment">//此选项为MPEG-1。文件扩展名应为.avi。</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;D&#x27;</span>) </span><br><span class="line"><span class="comment">//此选项是一个相对较旧的MPEG-4编码。如果要限制结果视频的大小，这是一个很好的选择。文件扩展名应为.avi。</span></span><br><span class="line"> </span><br><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;v&#x27;</span>) </span><br><span class="line"><span class="comment">//此选项是另一个相对较旧的MPEG-4编码。如果要限制结果视频的大小，这是一个很好的选择。文件扩展名应为.m4v。</span></span><br><span class="line"> </span><br><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;4&#x27;</span>):</span><br><span class="line"><span class="comment">//这个选项是一种比较新的MPEG-4编码方式。如果你想限制结果视频的大小，这可能是最好的选择。文件扩展名应为.mp4。</span></span><br><span class="line"> </span><br><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;4&#x27;</span>):</span><br><span class="line"><span class="comment">//这个选项是传统的H264编码方式。如果你想限制结果视频的大小，这可能是很好的选择。文件扩展名应为.mp4。</span></span><br><span class="line"> </span><br><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;O&#x27;</span>) </span><br><span class="line"><span class="comment">//这个选项是Ogg Vorbis。文件扩展名应为.ogv。</span></span><br><span class="line"> </span><br><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="comment">//此选项为Flash视频。文件扩展名应为.flv。</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">cv<span class="number">2.</span><span class="built_in">VideoWriter_fourcc</span>(<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;G&#x27;</span>)</span><br><span class="line"><span class="comment">//此选项为motion-jpeg视频。文件扩展名应为.avi。</span></span><br></pre></td></tr></table></figure>

<p>经验证：X264为压缩效率最高的编码格式，可以做到3s的视频802.6KB,H264次之为861.2KB，I420最大为131.3MB，在嵌入式开发板内建议使用X264</p>
<h3 id="相关函数-1"><a href="#相关函数-1" class="headerlink" title="相关函数"></a>相关函数</h3><h4 id="isOpened函数"><a href="#isOpened函数" class="headerlink" title="isOpened函数"></a>isOpened函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">isOpened</span><span class="params">()</span> <span class="type">const</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="Write函数"><a href="#Write函数" class="headerlink" title="Write函数"></a>Write函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">write</span><span class="params">(InputArray image)</span></span>;</span><br></pre></td></tr></table></figure>

<p>该函数用于将一帧图片保存到文件里面</p>
<h4 id="operator"><a href="#operator" class="headerlink" title="operator &lt;&lt;"></a>operator &lt;&lt;</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VideoWriter&amp; <span class="keyword">operator</span> &lt;&lt; (<span class="type">const</span> Mat&amp; image);</span><br></pre></td></tr></table></figure>

<p>为了方便IO处理，也可用流控制符来完成写入操作，如<code>writer &lt;&lt; image;</code></p>
<h4 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">release</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="实例技巧"><a href="#实例技巧" class="headerlink" title="实例技巧"></a>实例技巧</h2><h3 id="优化帧率控制"><a href="#优化帧率控制" class="headerlink" title="优化帧率控制"></a>优化帧率控制</h3><ul>
<li><p>使用 Stopwatch 进行精确计时。</p>
</li>
<li><p>计算每帧所需的时间间隔。</p>
</li>
<li><p>不使用自旋等待来实现更精确的帧率控制</p>
<p>在精细调整的自旋等待循环中，我们使用 Thread.Sleep(0) 代替了 Thread.SpinWait(1)</p>
<blockquote>
<p>这种方法可以在保持较好的帧率控制精度的同时，显著减少 CPU 负载。Thread.Sleep(0) 会让出当前线程的时间片，但不会导致线程进入长时间的睡眠状态，从而在降低 CPU 使用率和保持精确计时之间取得平衡。<br>请注意，这种方法可能会略微降低帧率控制的精确度，但对于大多数应用来说，这种微小的差异是可以接受的，尤其是考虑到 CPU 使用率的显著降低。</p>
</blockquote>
</li>
<li><p>动态调整等待时间，以补偿处理时间的变化。</p>
</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 刷新Frame帧</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RefreshFrame</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            isCapture = <span class="literal">true</span>;</span><br><span class="line">            _lastSaveTime = DateTime.Now;</span><br><span class="line">            InitializeVideoWriter();</span><br><span class="line"></span><br><span class="line">            Task.Run(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Stopwatch stopwatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">                <span class="built_in">long</span> frameInterval = (<span class="built_in">long</span>)(<span class="number">1000.0</span> / Fps * TimeSpan.TicksPerMillisecond);</span><br><span class="line">                <span class="built_in">long</span> nextFrameTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (isCapture)</span><br><span class="line">                &#123;</span><br><span class="line">                    stopwatch.Start();</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Mat tempFrame = <span class="keyword">new</span> Mat();</span><br><span class="line">                        <span class="keyword">if</span> (!cap.Read(tempFrame))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.WriteLine(<span class="string">&quot;无法读取帧&quot;</span>);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (tempFrame.Empty())</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.WriteLine(<span class="string">&quot;帧为空&quot;</span>);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        FrameChanged?.Invoke(tempFrame);</span><br><span class="line">                        <span class="keyword">lock</span> (_lockObject)</span><br><span class="line">                        &#123;</span><br><span class="line">                            tempFrame.CopyTo(_BufferFrame);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (isSave)</span><br><span class="line">                        &#123;</span><br><span class="line">                            SaveFrame(tempFrame);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (Application.Current == <span class="literal">null</span>)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        Application.Current.Dispatcher.Invoke(() =&gt;</span><br><span class="line">                        &#123;</span><br><span class="line">                            Frame = _BufferFrame.Clone();</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">long</span> elapsedTicks = stopwatch.ElapsedTicks;</span><br><span class="line">                        <span class="keyword">if</span> (elapsedTicks &lt; frameInterval)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">long</span> sleepTime = (frameInterval - elapsedTicks) / TimeSpan.TicksPerMillisecond;</span><br><span class="line">                            <span class="keyword">if</span> (sleepTime &gt; <span class="number">1</span>)</span><br><span class="line">                                Thread.Sleep((<span class="built_in">int</span>)sleepTime - <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        nextFrameTime += frameInterval;</span><br><span class="line">                        <span class="keyword">while</span> (stopwatch.ElapsedTicks &lt; nextFrameTime)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Thread.Sleep(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.WriteLine(<span class="string">$&quot;捕获帧时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                CloseVideoWriter();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>





<h1 id="CSharp案例"><a href="#CSharp案例" class="headerlink" title="CSharp案例"></a>CSharp案例</h1><p>摄像头视频显示并录制案例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">VideoCapture _capture = <span class="keyword">new</span> VideoCapture(<span class="number">0</span>); <span class="comment">// 打开默认摄像头</span></span><br><span class="line"> _capture.Set(VideoCaptureProperties.FrameWidth, <span class="number">320</span>); <span class="comment">// 设置宽度</span></span><br><span class="line"> _capture.Set(VideoCaptureProperties.FrameHeight, <span class="number">240</span>); <span class="comment">// 设置高度</span></span><br><span class="line">  Timer _timer = <span class="keyword">new</span> Timer(<span class="number">40</span>);</span><br><span class="line">  _timer.Elapsed += OnTimerTick; <span class="comment">// 绑定计时器事件</span></span><br><span class="line"> <span class="built_in">string</span> _outputFilePath = <span class="string">&quot;output.mp4&quot;</span>;</span><br><span class="line">  _timer.AutoReset = <span class="literal">true</span>; <span class="comment">// 设置为自动重置</span></span><br><span class="line">VideoWriter _videoWriter = <span class="keyword">new</span> VideoWriter(<span class="string">&quot;output.mp4&quot;</span>, FourCC.H264, <span class="number">25</span>, <span class="keyword">new</span> OpenCvSharp.Size(<span class="number">320</span>, <span class="number">240</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnTimerTick</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> frame = <span class="keyword">new</span> Mat()) <span class="comment">// 创建一个Mat对象来存储帧</span></span><br><span class="line">    &#123;</span><br><span class="line">        _capture.Read(frame); <span class="comment">// 从摄像头读取一帧</span></span><br><span class="line">        <span class="keyword">if</span> (!frame.Empty()) <span class="comment">// 检查帧是否为空</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 将当前帧写入视频文件</span></span><br><span class="line">            _videoWriter.Write(frame);</span><br><span class="line">          <span class="comment">// 使用异步方式更新UI，避免卡顿</span></span><br><span class="line">          Dispatcher.Invoke(() =&gt;</span><br><span class="line">                            &#123;</span><br><span class="line">                              <span class="comment">// 显示原始视频帧</span></span><br><span class="line">                              CameraImage.Source = BitmapSourceConverter.ToBitmapSource(frame);</span><br><span class="line">                            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 窗口关闭事件处理</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnClosed</span>(<span class="params">EventArgs e</span>)</span></span><br><span class="line"> &#123;</span><br><span class="line">     _timer.Stop(); <span class="comment">// 停止计时器</span></span><br><span class="line">     _capture.Release(); <span class="comment">// 释放摄像头资源</span></span><br><span class="line">     _videoWriter.Release(); <span class="comment">// 释放视频写入对象</span></span><br><span class="line">     <span class="keyword">base</span>.OnClosed(e); <span class="comment">// 调用基类的OnClosed方法</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>这样保存出来的视频文件特别大</p>
<p>可以采取下面几种做法:</p>
<ul>
<li>采用H.265编码格式,获得更好的压缩率    FourCC.H264&#x3D;&gt; FourCC.HEVC</li>
<li>智能码率控制：根据画面内容的复杂度和运动情况动态调整码率。画面简单、静止时降低码率，画面复杂、运动剧烈时适当提高码率，以在保证画质的同时减小文件大小。</li>
<li>运动检测与区域编码：通过运动检测算法，区分静止区域和运动区域，对静止区域采用更高效的压缩方式，而对运动区域保证足够的编码精度。</li>
<li>多分辨率编码：结合不同的分辨率进行编码，例如在画面静止时使用较低分辨率编码，运动时切换到较高分辨率。</li>
<li>利用硬件编码加速：借助专门的硬件编码器（如 GPU 中的编码器）来加速编码过程，提高效率和压缩性能。</li>
</ul>
<p>使用了Farneback光流算法来计算帧间的运动，并只更新变化的部分。这样可以减少每帧的更新量，提高视频流畅性</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>





<p>完整交互库案例</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> OpenCvSharp;</span><br><span class="line"><span class="keyword">using</span> OpenCvSharp.Flann;</span><br><span class="line"><span class="keyword">using</span> OpenCvSharp.WpfExtensions;</span><br><span class="line"><span class="keyword">using</span> Prism.Mvvm;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> System.Configuration;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Media.Imaging;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Threading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">camera</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraService</span> : <span class="title">BindableBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        VideoCapture cap;</span><br><span class="line">        VideoWriter capWriter;</span><br><span class="line">        <span class="built_in">double</span> FpsOrigin;</span><br><span class="line">        <span class="built_in">double</span> WidthOrigin;</span><br><span class="line">        <span class="built_in">double</span> HeightOrigin;</span><br><span class="line">        <span class="built_in">bool</span> isCapture = <span class="literal">false</span>;<span class="comment">//是否退出捕获线程</span></span><br><span class="line">        <span class="built_in">bool</span> isSave = <span class="literal">true</span>;<span class="comment">//是否保存</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Mat _BufferFrame = <span class="keyword">new</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">object</span> _lockObject = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">double</span> _Fps;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Fps</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> _Fps; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; SetProperty(<span class="keyword">ref</span> _Fps, <span class="keyword">value</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">double</span> _Width;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Width</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> _Width; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; SetProperty(<span class="keyword">ref</span> _Width, <span class="keyword">value</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">double</span> _Height;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Height</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> _Height; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; SetProperty(<span class="keyword">ref</span> _Height, <span class="keyword">value</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//帧对外开放读取</span></span><br><span class="line">        <span class="keyword">private</span> Mat _Frame = <span class="keyword">new</span>();</span><br><span class="line">        <span class="keyword">public</span> Mat Frame</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> _Frame; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; SetProperty(<span class="keyword">ref</span> _Frame, <span class="keyword">value</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> VideoWriter _videoWriter;</span><br><span class="line">        <span class="keyword">private</span> DateTime _lastSaveTime;</span><br><span class="line">        <span class="keyword">private</span> TimeSpan _saveInterval = TimeSpan.FromMinutes(<span class="number">1</span>); <span class="comment">// 默认5分钟保存一次</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">string</span> _saveDirectory = <span class="string">&quot;SavedVideos&quot;</span>; <span class="comment">// 保存视频的目录</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> TimeSpan SaveInterval</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> _saveInterval; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; SetProperty(<span class="keyword">ref</span> _saveInterval, <span class="keyword">value</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 委托与事件</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">FrameChangedEventHandler</span>(<span class="params">Mat frame</span>)</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">event</span> FrameChangedEventHandler FrameChanged;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CameraService</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            FrameChanged += AddOverlayTime;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">getCameraNum</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ShowVideoInfo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            FpsOrigin = cap.Get(VideoCaptureProperties.Fps);</span><br><span class="line">            WidthOrigin = cap.Get(VideoCaptureProperties.FrameWidth);</span><br><span class="line">            HeightOrigin = cap.Get(VideoCaptureProperties.FrameHeight);</span><br><span class="line">            Debug.WriteLine(<span class="string">$&quot;原始数据格式:<span class="subst">&#123;WidthOrigin&#125;</span>*<span class="subst">&#123;HeightOrigin&#125;</span> <span class="subst">&#123;FpsOrigin&#125;</span>Hz&quot;</span>);</span><br><span class="line">            <span class="comment">//估算码率</span></span><br><span class="line">            <span class="comment">// long totalBytes = 0;</span></span><br><span class="line">            <span class="comment">// totalBytes+= Frame.Total() * Frame.ElemSize();</span></span><br><span class="line">            <span class="comment">// double bitrate = (totalBytes * 8) / elapsedSeconds; // 比特/秒</span></span><br><span class="line">            <span class="comment">// Debug.WriteLine($&quot;估算比特率: &#123;bitrate / 1000000:F2&#125; Mbps&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 开始捕获摄像</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">StartCapture</span>(<span class="params"><span class="built_in">int</span> index = <span class="number">0</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                cap = <span class="keyword">new</span> VideoCapture(index);</span><br><span class="line">                <span class="keyword">if</span> (!cap.IsOpened())</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取视频本身的各种数据</span></span><br><span class="line">                ShowVideoInfo();</span><br><span class="line">                Fps = FpsOrigin;</span><br><span class="line">                Width = WidthOrigin;</span><br><span class="line">                Height = HeightOrigin;</span><br><span class="line">                RefreshFrame();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.WriteLine(<span class="string">$&quot;启动摄像头时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 刷新Frame帧的线程,使用isCapture控制是否跳出循环,跳出循环时执行关闭写入并压缩覆盖</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RefreshFrame</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            isCapture = <span class="literal">true</span>;</span><br><span class="line">            _lastSaveTime = DateTime.Now;</span><br><span class="line">            InitializeVideoWriter();</span><br><span class="line"></span><br><span class="line">            Task.Run(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Stopwatch stopwatch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">                <span class="built_in">long</span> frameInterval = (<span class="built_in">long</span>)(<span class="number">1000.0</span> / Fps * TimeSpan.TicksPerMillisecond);</span><br><span class="line">                <span class="built_in">long</span> nextFrameTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (isCapture)</span><br><span class="line">                &#123;</span><br><span class="line">                    stopwatch.Start();</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Mat tempFrame = <span class="keyword">new</span> Mat();</span><br><span class="line">                        <span class="keyword">if</span> (!cap.Read(tempFrame))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.WriteLine(<span class="string">&quot;无法读取帧&quot;</span>);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (tempFrame.Empty())</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.WriteLine(<span class="string">&quot;帧为空&quot;</span>);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        FrameChanged?.Invoke(tempFrame);</span><br><span class="line">                        <span class="keyword">lock</span> (_lockObject)</span><br><span class="line">                        &#123;</span><br><span class="line">                            tempFrame.CopyTo(_BufferFrame);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (isSave)</span><br><span class="line">                        &#123;</span><br><span class="line">                            SaveFrame(tempFrame);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (Application.Current == <span class="literal">null</span>)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        Application.Current.Dispatcher.Invoke(() =&gt;</span><br><span class="line">                        &#123;</span><br><span class="line">                            Frame = _BufferFrame.Clone();</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">long</span> elapsedTicks = stopwatch.ElapsedTicks;</span><br><span class="line">                        <span class="keyword">if</span> (elapsedTicks &lt; frameInterval)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">long</span> sleepTime = (frameInterval - elapsedTicks) / TimeSpan.TicksPerMillisecond;</span><br><span class="line">                            <span class="keyword">if</span> (sleepTime &gt; <span class="number">1</span>)</span><br><span class="line">                                Thread.Sleep((<span class="built_in">int</span>)sleepTime - <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        nextFrameTime += frameInterval;</span><br><span class="line">                        <span class="keyword">while</span> (stopwatch.ElapsedTicks &lt; nextFrameTime)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Thread.Sleep(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.WriteLine(<span class="string">$&quot;捕获帧时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//跳出循环的时候压缩视频文件</span></span><br><span class="line">                CloseVideoWriter();</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">string</span> fileName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> filePath = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitializeVideoWriter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Directory.Exists(_saveDirectory))</span><br><span class="line">            &#123;</span><br><span class="line">                Directory.CreateDirectory(_saveDirectory);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fileName = <span class="string">$&quot;<span class="subst">&#123;DateTime.Now:yyyyMMdd_HHmmss&#125;</span>.mp4&quot;</span>;</span><br><span class="line">            filePath = Path.Combine(_saveDirectory, fileName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//_videoWriter = new VideoWriter(filePath, FourCC.MP4V, Fps, new OpenCvSharp.Size(Width, Height));</span></span><br><span class="line">            _videoWriter = <span class="keyword">new</span> VideoWriter(filePath, FourCC.XVID, Fps, <span class="keyword">new</span> OpenCvSharp.Size(Width, Height));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SaveFrame</span>(<span class="params">Mat frame</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _videoWriter.Write(frame);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DateTime.Now - _lastSaveTime &gt;= SaveInterval)</span><br><span class="line">            &#123;</span><br><span class="line">                CloseVideoWriter();</span><br><span class="line">                InitializeVideoWriter();</span><br><span class="line">                _lastSaveTime = DateTime.Now;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> _ffmpegPath = <span class="string">@&quot;D:\ffmpeg-7.0.2-full_build\bin\ffmpeg.exe&quot;</span>;</span><br><span class="line">        <span class="comment">// 启动FFmpeg进程</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">StartFFmpegProcess</span>(<span class="params"><span class="built_in">string</span> absolutePath</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> directory = Path.GetDirectoryName(absolutePath);</span><br><span class="line">            <span class="built_in">string</span> fileName = Path.GetFileNameWithoutExtension(absolutePath);</span><br><span class="line">            <span class="built_in">string</span> tempOutputPath = Path.Combine(directory, <span class="string">$&quot;<span class="subst">&#123;fileName&#125;</span>_temp.mp4&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> arguments = <span class="string">$&quot;-i \&quot;<span class="subst">&#123;absolutePath&#125;</span>\&quot; -c:v libx264 -preset slow -crf 26 -an \&quot;<span class="subst">&#123;tempOutputPath&#125;</span>\&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> processStartInfo = <span class="keyword">new</span> ProcessStartInfo</span><br><span class="line">            &#123;</span><br><span class="line">                FileName = _ffmpegPath,</span><br><span class="line">                Arguments = arguments,</span><br><span class="line">                RedirectStandardOutput = <span class="literal">true</span>,</span><br><span class="line">                RedirectStandardError = <span class="literal">true</span>,</span><br><span class="line">                UseShellExecute = <span class="literal">false</span>,</span><br><span class="line">                CreateNoWindow = <span class="literal">true</span>,</span><br><span class="line">                WorkingDirectory = directory</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (Process process = <span class="keyword">new</span> Process &#123; StartInfo = processStartInfo &#125;)</span><br><span class="line">            &#123;</span><br><span class="line">                process.Start();</span><br><span class="line">                <span class="built_in">string</span> error = process.StandardError.ReadToEnd();</span><br><span class="line">                process.WaitForExit();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (process.ExitCode != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.WriteLine(<span class="string">$&quot;FFmpeg 执行失败。错误：<span class="subst">&#123;error&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (File.Exists(tempOutputPath))</span><br><span class="line">                    &#123;</span><br><span class="line">                        File.Delete(absolutePath);</span><br><span class="line">                        File.Move(tempOutputPath, absolutePath);</span><br><span class="line">                        Debug.WriteLine(<span class="string">&quot;文件压缩并替换成功&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.WriteLine(<span class="string">&quot;临时输出文件未找到&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CloseVideoWriter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _videoWriter?.Release();</span><br><span class="line">            _videoWriter?.Dispose();</span><br><span class="line">            <span class="comment">//压缩视频</span></span><br><span class="line">            <span class="built_in">string</span> absolutePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, filePath);</span><br><span class="line">            Task.Run(() =&gt; StartFFmpegProcess(absolutePath)).Wait();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangeCameraInfo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            isCapture = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// 设置分辨率</span></span><br><span class="line">            cap.Set(VideoCaptureProperties.FrameWidth, Width);</span><br><span class="line">            cap.Set(VideoCaptureProperties.FrameHeight, Height);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置帧率</span></span><br><span class="line">            cap.Set(VideoCaptureProperties.Fps, Fps);</span><br><span class="line">            <span class="comment">// 验证设置是否成功</span></span><br><span class="line">            <span class="built_in">double</span> actualWidth = cap.Get(VideoCaptureProperties.FrameWidth);</span><br><span class="line">            <span class="built_in">double</span> actualHeight = cap.Get(VideoCaptureProperties.FrameHeight);</span><br><span class="line">            <span class="built_in">double</span> actualFps = cap.Get(VideoCaptureProperties.Fps);</span><br><span class="line">            Debug.WriteLine(<span class="string">$&quot;设置的分辨率: <span class="subst">&#123;Width&#125;</span>x<span class="subst">&#123;Height&#125;</span>, 实际分辨率: <span class="subst">&#123;actualWidth&#125;</span>x<span class="subst">&#123;actualHeight&#125;</span>&quot;</span>);</span><br><span class="line">            Debug.WriteLine(<span class="string">$&quot;设置的帧率: <span class="subst">&#123;Fps&#125;</span>, 实际帧率: <span class="subst">&#123;actualFps&#125;</span>&quot;</span>);</span><br><span class="line">            cap.Release();</span><br><span class="line">            cap = <span class="keyword">new</span> VideoCapture(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!cap.IsOpened())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.WriteLine(<span class="string">&quot;重新打开摄像头失败&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            RefreshFrame();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加时间文字信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;frame&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddOverlayTime</span>(<span class="params">Mat frame</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            String nowStr = DateTime.Now.ToString();</span><br><span class="line">            <span class="comment">// 设置文本参数</span></span><br><span class="line">            <span class="built_in">double</span> fontScale = <span class="number">0.7</span>;</span><br><span class="line">            <span class="built_in">int</span> thickness = <span class="number">2</span>;</span><br><span class="line">            HersheyFonts font = HersheyFonts.HersheySimplex;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算文本大小</span></span><br><span class="line">            OpenCvSharp.Size textSize = Cv2.GetTextSize(nowStr, font, fontScale, thickness, <span class="keyword">out</span> <span class="built_in">int</span> baseline);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算文本位置（右上角，留出10像素的边距）</span></span><br><span class="line">            OpenCvSharp.Point textOrg = <span class="keyword">new</span> OpenCvSharp.Point(frame.Width - textSize.Width - <span class="number">10</span>, textSize.Height + <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建一个与原始帧相同大小和类型的覆盖层</span></span><br><span class="line">            Mat overlay = <span class="keyword">new</span> Mat(frame.Size(), frame.Type());</span><br><span class="line">            overlay.SetTo(<span class="keyword">new</span> Scalar(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)); <span class="comment">// 完全透明</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 绘制半透明背景</span></span><br><span class="line">            OpenCvSharp.Rect bgRect = <span class="keyword">new</span> OpenCvSharp.Rect(textOrg.X - <span class="number">5</span>, textOrg.Y - textSize.Height - <span class="number">5</span>, textSize.Width + <span class="number">10</span>, textSize.Height + <span class="number">10</span>);</span><br><span class="line">            Cv2.Rectangle(overlay, bgRect, <span class="keyword">new</span> Scalar(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将背景叠加到原始帧上</span></span><br><span class="line">            Cv2.AddWeighted(overlay, <span class="number">0.5</span>, frame, <span class="number">1.0</span>, <span class="number">0</span>, frame);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 绘制透明背景文本(但必须在带有alpha的RGBA图像上)</span></span><br><span class="line">            <span class="comment">// OpenCvSharp.Rect bgRect = new OpenCvSharp.Rect(textOrg.X - 5, textOrg.Y - textSize.Height - 5, textSize.Width + 10, textSize.Height + 10);</span></span><br><span class="line">            <span class="comment">// Cv2.Rectangle(frame, bgRect, new Scalar(0, 0, 0, 0), -1);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 绘制文本</span></span><br><span class="line">            Cv2.PutText(frame, nowStr, textOrg, font, fontScale, <span class="keyword">new</span> Scalar(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>), thickness, LineTypes.AntiAlias);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateOverlayDate</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StopCapture</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            isCapture = <span class="literal">false</span>;</span><br><span class="line">            cap.Release();</span><br><span class="line">            CloseVideoWriter();</span><br><span class="line">            <span class="comment"><span class="doctag">///</span>/压缩视频</span></span><br><span class="line">            <span class="comment">//string absolutePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, filePath);</span></span><br><span class="line">            <span class="comment">//Task.Run(() =&gt; StartFFmpegProcess(absolutePath));</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="音频库"><a href="#音频库" class="headerlink" title="音频库"></a>音频库</h1><h2 id="C-音频库"><a href="#C-音频库" class="headerlink" title="C#音频库"></a>C#音频库</h2><p>MIT开源   <a target="_blank" rel="noopener" href="https://github.com/naudio/NAudio">开源地址</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LuoCore/p/17241242.html">音频,视频录制后合并音视频案例</a></p>
<h1 id="均匀分窗体算法"><a href="#均匀分窗体算法" class="headerlink" title="均匀分窗体算法"></a>均匀分窗体算法</h1><p>1  –   1</p>
<p>2  –   2</p>
<p>3  –   2</p>
<p>4  –   2</p>
<p>5  –   3</p>
<p>6  –   3</p>
<p>9  –   3</p>
<p>10  –  4</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4" title="头像" alt="头像"></a><div class="post-copyright__author_name">ZEROKO14</div><div class="post-copyright__author_desc">zeroko14's blog</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://che77a38.github.io/posts/opencv/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://che77a38.github.io/posts/opencv/')">opencv</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://che77a38.github.io/posts/opencv/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=opencv&amp;url=https://che77a38.github.io/posts/opencv/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://che77a38.github.io" target="_blank">ZEROKO14的个人博客</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/C/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>C++<span class="tagsPageCount">5</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/doxygen/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">doxygen</div></div></a></div><div class="next-post pull-right"><a href="/posts/%E8%BD%AF%E8%80%83%E7%9B%B8%E5%85%B3/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">软考</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/C++%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="C++多线程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-18</div><div class="title">C++多线程</div></div></a></div><div><a href="/posts/C++%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E7%9B%98%E7%82%B9/" title="C++相关工具盘点"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-04-22</div><div class="title">C++相关工具盘点</div></div></a></div><div><a href="/posts/C++11%E4%B8%8E14/" title="C++11与14"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-28</div><div class="title">C++11与14</div></div></a></div><div><a href="/posts/mac%E5%8F%8Alinux_C++%E7%8E%AF%E5%A2%83/" title="mac及linux C++环境配置"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">mac及linux C++环境配置</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description">欢迎来到ZEROKO14的个人博客</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">ZEROKO14</h1><div class="author-info__desc">zeroko14's blog</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/che77a38" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%83%8F%E9%A2%9C%E8%89%B2%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA"><span class="toc-number">1.</span> <span class="toc-text">计算机图像颜色基础理论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RGB%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4"><span class="toc-number">1.1.</span> <span class="toc-text">RGB颜色空间</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="toc-number">1.1.1.</span> <span class="toc-text">基本知识</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HSV%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4"><span class="toc-number">1.2.</span> <span class="toc-text">HSV颜色空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BE%E5%83%8F%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">图像的基本类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%83%8F%E7%9A%84%E5%A4%A7%E5%B0%8F%E3%80%81%E6%B7%B1%E5%BA%A6%E5%92%8C%E9%80%9A%E9%81%93"><span class="toc-number">1.3.1.</span> <span class="toc-text">图像的大小、深度和通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%83%8F%E5%9C%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%AD%E7%9A%84%E5%9D%90%E6%A0%87"><span class="toc-number">1.3.2.</span> <span class="toc-text">图像在计算机中的坐标</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#opencv%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">opencv环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mac%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">mac配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.</span> <span class="toc-text">Windows配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSharp-Opencv"><span class="toc-number">2.3.</span> <span class="toc-text">CSharp Opencv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B"><span class="toc-number">2.4.</span> <span class="toc-text">简单代码案例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mat%E7%B1%BB"><span class="toc-number">3.</span> <span class="toc-text">Mat类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Mat%E8%83%BD%E5%AD%98%E5%82%A8%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">3.1.</span> <span class="toc-text">Mat能存储的数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenCV%E4%B8%AD%E8%A7%84%E5%AE%9A%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.2.</span> <span class="toc-text">OpenCV中规定的数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mat%E7%B1%BB%E7%9A%84%E8%B5%8B%E5%80%BC"><span class="toc-number">3.3.</span> <span class="toc-text">Mat类的赋值</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%97%B6%E8%B5%8B%E5%80%BC"><span class="toc-number">3.3.1.</span> <span class="toc-text">创建时赋值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%B7%B2%E6%9C%89%E7%9A%84Mat%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84Mat%E7%B1%BB"><span class="toc-number">3.3.2.</span> <span class="toc-text">利用已有的Mat类创建新的Mat类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%9F%A9%E9%98%B5Size-%E7%BB%93%E6%9E%84%E5%92%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%E5%88%9B%E5%BB%BAMat%E7%B1%BB"><span class="toc-number">3.3.3.</span> <span class="toc-text">利用矩阵Size()结构和数据类型参数创建Mat类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mat%E7%B1%BB%E6%96%B9%E6%B3%95%E8%B5%8B%E5%80%BC"><span class="toc-number">3.3.4.</span> <span class="toc-text">Mat类方法赋值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E6%B3%95%E8%B5%8B%E5%80%BC"><span class="toc-number">3.3.5.</span> <span class="toc-text">枚举法赋值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mat%E7%B1%BB%E5%85%83%E7%B4%A0%E7%9A%84%E8%AF%BB%E5%8F%96"><span class="toc-number">3.4.</span> <span class="toc-text">Mat类元素的读取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B1%9E%E6%80%A7"><span class="toc-number">3.4.1.</span> <span class="toc-text">常用属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#at%E6%96%B9%E6%B3%95%E8%AF%BB%E5%8F%96"><span class="toc-number">3.4.2.</span> <span class="toc-text">at方法读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A9%E9%98%B5%E5%85%83%E7%B4%A0%E5%9C%B0%E5%9D%80%E5%AE%9A%E4%BD%8D%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE%E5%85%83%E7%B4%A0"><span class="toc-number">3.4.3.</span> <span class="toc-text">矩阵元素地址定位方式访问元素</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mat%E6%94%AF%E6%8C%81%E7%9A%84%E8%BF%90%E7%AE%97"><span class="toc-number">3.5.</span> <span class="toc-text">Mat支持的运算</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E7%9F%A9%E9%98%B5%E7%9B%B8%E4%B9%98"><span class="toc-number">3.5.1.</span> <span class="toc-text">两个矩阵相乘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-number">3.5.2.</span> <span class="toc-text">相关函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E6%93%8D%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">基本图像处理操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%81%B0%E5%BA%A6-%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A-%E8%BE%B9%E7%BC%98-%E6%89%A9%E5%BC%A0-%E4%BE%B5%E8%9A%80"><span class="toc-number">4.1.</span> <span class="toc-text">灰度&#x2F;高斯模糊&#x2F;边缘&#x2F;扩张&#x2F;侵蚀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%AE%E5%BA%A6%E4%B8%8E%E5%AF%B9%E6%AF%94%E5%BA%A6"><span class="toc-number">4.2.</span> <span class="toc-text">亮度与对比度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConvertTo"><span class="toc-number">4.2.1.</span> <span class="toc-text">ConvertTo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConvertScaleAbs"><span class="toc-number">4.2.2.</span> <span class="toc-text">ConvertScaleAbs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.2.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E5%9B%BE%E5%83%8F%E5%A4%A7%E5%B0%8F-%E8%A3%81%E5%89%AA%E5%9B%BE%E5%83%8F"><span class="toc-number">4.3.</span> <span class="toc-text">调整图像大小&#x2F;裁剪图像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%98%E5%88%B6"><span class="toc-number">4.4.</span> <span class="toc-text">绘制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BF%E5%B0%84%E5%8F%98%E6%8D%A2"><span class="toc-number">4.5.</span> <span class="toc-text">仿射变换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%9C%E8%89%B2%E6%A3%80%E6%B5%8B"><span class="toc-number">4.6.</span> <span class="toc-text">颜色检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E5%9D%87%E8%A1%A1%E5%8C%96"><span class="toc-number">4.7.</span> <span class="toc-text">直方图均衡化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">4.7.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python%E6%A1%88%E4%BE%8B"><span class="toc-number">4.7.2.</span> <span class="toc-text">python案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E9%80%82%E5%BA%94%E7%9B%B4%E6%96%B9%E5%9B%BE%E5%9D%87%E8%A1%A1%E5%8C%96"><span class="toc-number">4.7.3.</span> <span class="toc-text">自适应直方图均衡化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.7.3.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">4.7.3.2.</span> <span class="toc-text">案例</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%8A%A0%E8%BD%BD%E4%B8%8E%E6%91%84%E5%83%8F%E5%A4%B4%E8%B0%83%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">视频加载与摄像头调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E9%A2%91-%E6%91%84%E5%83%8F%E5%A4%B4%E5%8A%A0%E8%BD%BD"><span class="toc-number">5.1.</span> <span class="toc-text">视频&#x2F;摄像头加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%B1%9E%E6%80%A7%E8%8E%B7%E5%8F%96"><span class="toc-number">5.2.</span> <span class="toc-text">视频属性获取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-number">5.3.</span> <span class="toc-text">相关方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%9B%BE%E5%83%8F%E9%80%90%E5%B8%A7%E8%8E%B7%E5%8F%96"><span class="toc-number">5.4.</span> <span class="toc-text">视频图像逐帧获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VideoWriter"><span class="toc-number">5.4.1.</span> <span class="toc-text">VideoWriter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fourcc"><span class="toc-number">5.4.2.</span> <span class="toc-text">fourcc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0-1"><span class="toc-number">5.4.3.</span> <span class="toc-text">相关函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#isOpened%E5%87%BD%E6%95%B0"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">isOpened函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Write%E5%87%BD%E6%95%B0"><span class="toc-number">5.4.3.2.</span> <span class="toc-text">Write函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#operator"><span class="toc-number">5.4.3.3.</span> <span class="toc-text">operator &lt;&lt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-number">5.4.3.4.</span> <span class="toc-text">析构函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E6%8A%80%E5%B7%A7"><span class="toc-number">5.5.</span> <span class="toc-text">实例技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%B8%A7%E7%8E%87%E6%8E%A7%E5%88%B6"><span class="toc-number">5.5.1.</span> <span class="toc-text">优化帧率控制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSharp%E6%A1%88%E4%BE%8B"><span class="toc-number">6.</span> <span class="toc-text">CSharp案例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E5%BA%93"><span class="toc-number">7.</span> <span class="toc-text">音频库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#C-%E9%9F%B3%E9%A2%91%E5%BA%93"><span class="toc-number">7.1.</span> <span class="toc-text">C#音频库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9D%87%E5%8C%80%E5%88%86%E7%AA%97%E4%BD%93%E7%AE%97%E6%B3%95"><span class="toc-number">8.</span> <span class="toc-text">均匀分窗体算法</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/avalonia/" title="avalonia">avalonia</a><time datetime="2024-09-11T14:51:13.000Z" title="发表于 2024-09-11 22:51:13">2024-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/%E8%A7%86%E9%A2%91%E6%95%88%E6%9E%9C/" title="PR">PR</a><time datetime="2024-07-18T07:06:08.330Z" title="发表于 2024-07-18 15:06:08">2024-07-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/%E5%89%8D%E7%AB%AF/" title="WEB前端">WEB前端</a><time datetime="2024-07-18T07:06:08.323Z" title="发表于 2024-07-18 15:06:08">2024-07-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/slidev/" title="slidev">slidev</a><time datetime="2024-07-18T07:06:08.319Z" title="发表于 2024-07-18 15:06:08">2024-07-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/C++%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="C++多线程">C++多线程</a><time datetime="2024-07-18T07:05:59.794Z" title="发表于 2024-07-18 15:05:59">2024-07-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="ZEROKO14" target="_blank">ZEROKO14</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu"></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">57</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">6</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 0.88rem;">C#<sup>3</sup></a><a href="/tags/C/" style="font-size: 0.88rem;">C++<sup>5</sup></a><a href="/tags/CSS/" style="font-size: 0.88rem;">CSS<sup>1</sup></a><a href="/tags/CSharp/" style="font-size: 0.88rem;">CSharp<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">C语言<sup>1</sup></a><a href="/tags/FPS/" style="font-size: 0.88rem;">FPS<sup>1</sup></a><a href="/tags/HTML/" style="font-size: 0.88rem;">HTML<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size: 0.88rem;">JavaScript<sup>1</sup></a><a href="/tags/MFC/" style="font-size: 0.88rem;">MFC<sup>1</sup></a><a href="/tags/PE/" style="font-size: 0.88rem;">PE<sup>1</sup></a><a href="/tags/QT/" style="font-size: 0.88rem;">QT<sup>1</sup></a><a href="/tags/WPF/" style="font-size: 0.88rem;">WPF<sup>3</sup></a><a href="/tags/ai/" style="font-size: 0.88rem;">ai<sup>1</sup></a><a href="/tags/cmake/" style="font-size: 0.88rem;">cmake<sup>1</sup></a><a href="/tags/doxygen/" style="font-size: 0.88rem;">doxygen<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>1</sup></a><a href="/tags/json/" style="font-size: 0.88rem;">json<sup>1</sup></a><a href="/tags/linux/" style="font-size: 0.88rem;">linux<sup>1</sup></a><a href="/tags/next/" style="font-size: 0.88rem;">next<sup>1</sup></a><a href="/tags/ppt/" style="font-size: 0.88rem;">ppt<sup>1</sup></a><a href="/tags/slidev/" style="font-size: 0.88rem;">slidev<sup>1</sup></a><a href="/tags/vue/" style="font-size: 0.88rem;">vue<sup>1</sup></a><a href="/tags/xml/" style="font-size: 0.88rem;">xml<sup>1</sup></a><a href="/tags/yaml/" style="font-size: 0.88rem;">yaml<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 0.88rem;">代码规范<sup>1</sup></a><a href="/tags/%E5%86%85%E6%A0%B8/" style="font-size: 0.88rem;">内核<sup>2</sup></a><a href="/tags/%E5%86%85%E6%A0%B8%E7%9B%B8%E5%85%B3/" style="font-size: 0.88rem;">内核相关<sup>5</sup></a><a href="/tags/%E5%8A%A0%E8%A7%A3%E5%AF%86/" style="font-size: 0.88rem;">加解密<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">多线程<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">开发<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 0.88rem;">数学<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 0.88rem;">数据库<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">架构<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 0.88rem;">正则表达式<sup>1</sup></a><a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 0.88rem;">监控<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>1</sup></a><a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">管理<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>2</sup></a><a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 0.88rem;">逆向<sup>2</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>