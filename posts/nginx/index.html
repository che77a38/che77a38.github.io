<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>nginx | ZEROKO14的个人博客</title><meta name="keywords" content="网络"><meta name="author" content="ZEROKO14"><meta name="copyright" content="ZEROKO14"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="nginx"><meta name="application-name" content="nginx"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="nginx"><meta property="og:url" content="https://che77a38.github.io/posts/nginx/index.html"><meta property="og:site_name" content="ZEROKO14的个人博客"><meta property="og:description" content="基本介绍 Nginx 是异步框架的网页服务器，也可以用作反向代理、负载平衡器和 HTTP缓存。该软件由俄罗斯程序员伊戈尔•赛索耶夫开发的开源框架,由c语言实现，并于2004年首次公开发布。2011年成立同名公司以提供支持服务。2019年3月11日，Nginx公司被F5网络公司以6.7亿美元收购。Ng"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4"><meta property="article:author" content="ZEROKO14"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4"><meta name="description" content="基本介绍 Nginx 是异步框架的网页服务器，也可以用作反向代理、负载平衡器和 HTTP缓存。该软件由俄罗斯程序员伊戈尔•赛索耶夫开发的开源框架,由c语言实现，并于2004年首次公开发布。2011年成立同名公司以提供支持服务。2019年3月11日，Nginx公司被F5网络公司以6.7亿美元收购。Ng"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://che77a38.github.io/posts/nginx/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":true,"limitCount":50,"languages":{"author":"作者: ZEROKO14","link":"链接: ","source":"来源: ZEROKO14的个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'ZEROKO14的个人博客',
  title: 'nginx',
  postAI: '',
  pageFillDescription: '基本介绍, 作用, 优点, Nginx安装, nginx各种默认路径, Linux, Mac, Nginx基本命令, nginx配置, nginx.conf详解, 全局配置main段详解, events段, http段, server段, server_name的匹配规则, location段, 监控模块, nginx语法, nginx模块语法指令, –with-http_rewrite_module, rewritex2Freturn指令, rewrite, return, 使用案例, set指令, if指令, –with-http_map_module, map指令, nginx核心指令, rootx2Falias指令, break指令, nginx变量, TCP连接相关变量, HTTP请求相关变量, Nginx处理请求时相关变量, Nginx返回响应时相关变量, 系统变量, 时间空间单位, 时间单位, 空间单位, nginx实用场景, 虚拟主机, 静态站点, 反向代理, 七层反向代理, 四层反向代理, 负载均衡, upstream模块, 负载均衡算法, 轮询(默认), 加权轮询, 实际案例, 哈希-hash, ip_hash, 最少连接数算法, 对上游服务器返回异常时的处理, proxy_next_upstream, proxy_next_upstream_timeout, proxy_next_upstream_tries, 异常处理样例, HTTPS加密传输, 生成自签名HTTPS证书, nginx.conf配置, 文件服务器, nginx.conf配置, 限速, 限流, limit_conn, limit_conn_zone, limit_conn_status, limit_req, limit_req_zone, limit_req_status, 限流案例, 黑白名单, 请求拦截, 防盗链, nginx配置问题, nginx配置端口问题, 直接return文本, nginx插件, fastdfs插件, nginx-http-flv-module, nginx javascript基本介绍是异步框架的网页服务器也可以用作反向代理负载平衡器和缓存该软件由俄罗斯程序员伊戈尔赛索耶夫开发的开源框架由语言实现并于年首次公开发布年成立同名公司以提供支持服务年月日公司被网络公司以亿美元收购是免费的开源软件根据类许可证的条款发布作用服务器解析协议反向代理服务器了解反向代理的概念邮件服务器解析邮件相关的协议优点高并发支持单机能够支持的并发连接取决于内存大小极限能够到百万那么在实际生产中也是非常能接近这个数字的这主要得益于在环境下使用了多路复用模型内存消耗低在同类型服务中比占用的内存资源更少在一般情况下非活跃的连接在中仅消耗内存高扩展性低耦合的模块设计并且有丰富的第三方模块支持高可靠性经过十几年各种复杂场景和各大公司的生产环境验证并且的架构是由进程和进程组成的如果进程出现问题那么进程可以快速开启一个新的进程提供服务经过大批网站检验热部署和的分离设置可实现小时不间断服务的前提下升级可执行文件最自由的许可协议许可协议即的简称是由加州大学伯克利分校发布并维护的开源软件许可证它是自由软件中使用最广泛的许可协议之一许可协议给予使用者很大的自由可以自由地使用修改源代码也可以将修改后的代码作为开源或专有软件再发布这种许可证因此而得名被叫做许可证许可协议允许用户免费使用修改源码再发布淘宝代理非常好非常好一般好非常好一般不好好非常好热部署不支持支持不支持系统压力比较很大很小比较小稳定性好非常好不好安全性好一般一般技术支持非常好很少一般静态文件处理一般非常好好虚拟主机支持不支持支持反向代理一般非常好一般支持不支持不支持是网络编程多并发服务器异步非阻塞的事件驱动模型官方地址安装源码安装方式如下官网官网官网工作时候需要依赖三个库没有版本要求源码下载源码下载源码下载三个参数为这三个库对应的源码安装目录根据自己的电脑的库安装包的位置进行指定要安装的位置省略的话默认安装到返回如下表示没有问题最终会将安装到下上面命令中的和可以不写路径需要安装支持的话需要测试是否安装成功在浏览器中访问部署了对应的主机的地址如果能看到的欢迎页面表示已经安装成功安装的话已包含大量常用模块推荐使用方式安装简单快速可执行程序路径快速启动的方式将添加到环境变量中创建软链接由于安装需要很多模块源码编译比较麻烦因此有捆绑了标准核心大量第三方模块以及大部分外部依赖项的项目是一个基于和的动态网页服务器它集成了大量精良的库第三方模块以及大多数的依赖项用于方便地搭建能够处理超高并发扩展性极高的动态应用服务和动态网关通过汇聚各类设计精良的模块主要由团队自主开发从而将有效地变成一个强大的通用应用平台这样开发人员和系统工程师可以使用脚本语言调动支持的各种以及模块快速构造出足以胜任以上并发连接响应的超高性能应用的目标是让你的服务直接跑在服务内部充分利用的非阻塞模型不仅仅对客户端请求甚至于对远程后端诸如以及等都进行一致且友好的非阻塞响应已经在很多知名的互联网公司包括阿里巴巴腾讯和新浪和许多高流量的网站例如和中得到了广泛应用并得到了越来越多的全球知名互联网公司的青睐各种默认路径在不手动指定各项路径的时候的默认路径详解在下各种默认目录详解下面是目录结构介绍存储配置文件的目录默认存储网站服务器静态资源的目录图片存储日志其中用于分析问题用于查看访问记录启动的可执行程序在下下各种默认目录详解此时中是上配置文件真正的根目录为即配置文件中的相对路径都为相对此地址后面跟的如果是即则是会去路径下找文件中等同于互为映射关系像系统会把映射到基本命令启动需要管理员权限启动重启修改配置文件后需要执行该命令以生效关闭马上关闭等完成当前操作之后关闭查看配置文件位置并且测试配置文件正确与否使用命令查看查看的版本查看的编译配置信息配置的配置需要通过文件来配置配置文件可以通过来查看位置可以通过端口号查看端口是否正确被监听中详解配置文件的组织形式上图中模块本身即为最外层即所有之外就是模块模块这个是协议级别模块每个模块对应一个服务器服务器级别模块用来匹配不同的请求进而对请求做不同的处理和响应请求级别模块处理邮件相关的动作重要常用配置项介绍启动之后的进程属于谁需要将改为否则操作文件时会失败显示原因设置进程的个数建议最大为核数日志级别设置错误日志路径相对路径和日志级别如等文件记录启动的进程的的事件处理多路转接模型选择每个工作进程的最大连接数模块省略模块服务器监听的端口服务器的域名不能写地址让客户端通过该域名访问服务器设置字符编码正常工作也会写访问日志设置访问日志位置该行注释掉表示正常工作不写访问日志模块可以有多个为指令名可以是正则表达式指令名不能重复一个相对来找的路径为默认自带的静态资源目录也可以设置为自己建立的目录名当客户端的请求是一个目录时通过该指令设置会找一个默认显示的网页先找找不到再找假设自建的静态资源目录下有个文件夹当访问的为实际上是访问此处的表示指令名的第一个部分结合这条指令的可以视为此处如果不写的话如果访问会返回指令名可以是正则表达式正则表达式服务器要处理的指令如何从中提取例子去掉协议去掉域名端口剩下的会去下找全局配置段详解核心参数其他参数大部分情况下用不到解释指定运行的子进程的属主和属组其中属组可以不指定解释指定启动的子进程数量自动设置为物理核心数解释指定运行的主进程的文件存放路径解释指定子进程可以打开的最大文件句柄数系统最大打开每个子进程打开数乘子进程数实际也不会超过这个值需要调大指定子进程异常终止后的文件用于记录分析问题必须对子进程用户赋写权限解释将每个子进程与物理核心绑定负责调度负责处理请求假设有个核心某一时刻获取到了的工作调度时间片时间片过后从上面撤下来去处理其他事件下一时刻可能是的时间片调度到了上面那么就会在其他上面工作进程与的调度切换是有损耗的如果绑定了将永远等待的调度充分利用缓存主要作用将每个子进程与特定物理核心绑定优势在于避免同一个子进程在不同的核心上切换缓存失效降低性能其并不能真正避免进程切换进程切换是工作特性核心个核心个核心个解释指定子进程的值以调整运行的优先级通常设定为负值以优先调用默认进程的优先级值是值越小越优先设定范围为到对来说优先级值则是到指定子进程优雅退出时的超时时间不管秒内是否处理完都强制退出子进程内部使用的计时器精度调整时间间隔越大系统调用越少有利于性能提升反之系统调用越多性能下降比如某些计时的操作需要去获取内核时间频繁跟内核打交道会降低性能设定的运行方式前台还是后台前台用户调试后台用于生产负载均衡互斥锁文件存放路径负载均衡器是将网络流量分发到多个服务器的设备负载均衡器可以确保流量均匀分布在多个服务器之间从而提高性能和可靠性负载均衡互斥锁文件用于确保一次只有一个进程正在访问负载均衡器这可以防止冲突并确保负载均衡器正常运行段使用何种事件驱动模型一般不指定这个参数子进程能够处理的最大并发连接数多核情况最大其实达不到是否打开负载均衡互斥锁默认当接收到请求时会给每个发送消息去唤醒状态为时则会有一个负载均衡锁会轮流发给每一个新连接分配给子进程的超时时间默认超时后会转给下一个处理请求子进程可以接收的新连接个数这个参数对性能影响不太大段段客户端请求对应磁盘映射路径为客户端请求对应磁盘映射路径为末尾一定要加与的区别语法上下文区别将定义路径与叠加只取定义路径末尾一定要加的匹配规则精确匹配优先级最高左通配优先级右通配优先级正则通配优先级最低多个段匹配规则含义示例优先级最高精确匹配匹配到即停止搜索正则匹配区分大小写正则匹配不区分大小写表示区分大小写不匹配的正则表示不区分大小写不匹配的正则无符号通用匹配任何请求都会匹配到内部跳转查找顺序和优先级带有的精确匹配优先没有修饰符的精确匹配正则表达式按照他们在配置文件中定义的顺序带有修饰符的开头匹配带有或修饰符的如果正则表达式与匹配没有修饰符的如果指定字符串与开头匹配末尾带与不带的区别不带尝试把当成目录如果找不到则找文件带将作为目录如果不存在则直接返回测试样例监控模块主要用于监控各种连接数需要模块监控模块页面结果页面结果解释状态项含义当前客户端与间的连接数等于下面数量之和自启动起与客户端建立过的连接总数自启动起处理过的客户端连接总数如果没有超出配置该值与相同自启动起处理过的客户端请求总数由于存在请求故值会大于值正在读取请求头部的连接总数正在向客户端发送响应数据的连接总数当前空闲的连接总数内嵌变量变量名含义同值同值同值同值语法模块语法指令指令由此模块提供支持根据指定正则表达式匹配规则重写其实就是重定向停止处理请求直接返回响应码或重定向到其他执行指令后中后续指令将不会被执行主要实现地址重写以及重定向就是把传入的请求重定向到其他的过程的规则采用兼容正则表达式的语法进行规则匹配如相使用的功能在编译前要编译安装库上下文格式用来匹配的正则表达式正则匹配成功后用来替换的字符串如果该字符串以或开头则处理将停止并重定向到客户端是一个可选参数其有个候选值重写后的发起新请求再次进入段重试中的匹配默认为直接使用重写后的不再匹配其他中的语句返回临时重定向返回永久重定向在以上的标记中和用来实现重写浏览器地址栏的地址不变但在服务器访问的程序及路径发生了变化和用来实现跳转浏览器地址会显示跳转后的地址和标记的实现功能类似但二者之间有细微的差别使用指令时必须用标记使用指令时要使用标记例子在上述指令中为固定关键字表示开启一条匹配规则部分是这是一个正则表达式表示匹配所有匹配成功后跳转到这里的是取前面部分括号里的内容结尾的是永久重定向标记即跳转到后面的地址上上下文该指令可以停止处理并指定的响应码返回给前端既可以返回文本也可以重定向响应体内容如果是例重定向例直接跟的话必须是开头的完整路径使用案例继续匹配不会再匹配直接找下面的文件请求结果直接返回不会再去找文件执行了上面后这里的还会执行通常不会联合一起写指令由此模块提供支持用于定义一个变量上下文格式为变量的名称可以看到变量的名称以符号开头且不要与预设的全局变量名相同为变量的值可以是字符串其他变量或者两者的组合如为客户端发起的完整指令由此模块提供支持上下文格式和之间有一个空格条件表达式的形式变量名如果变量的值为空字符串或则为其他条件为使用和比较变量和字符串是否相等满足条件则为否则为判断文件是否存在和判断目录是否存在和使用正则表达式与变量的值进行匹配变量与正则表达式之间使用如果正则表达式包含或则整个表达式应该用单引号或双引号括起来正则匹配区分大小写正则匹配不区分大小写正则不匹配区分大小写正则不匹配不区分大小写和用来判断是否存在文件和用来判断是否存在目录和用来判断是否存在文件或目录和用来判断文件是否可执行在匹配过程中可以引用一些的全局变量指令核心指令指令若按照上述配置的话则访问目录里面的文件时会自动去目录找文件若按照这种配置的话则访问目录下的文件时会去目录下找文件是一个目录别名的定义则是最上层目录的定义还有一个重要的区别是后面必须要用结束否则会找不到文件的而则可有可无指令上下文格式在同一作用域中中断该指令之后的其他指令位于其前面的指令配置生效位于其后面的指令配置则无效变量更详细的看下方连接相关变量客户端地址例如客户端端口例如客户端地址的整型格式已处理连接是一个递增的序号当前连接上执行的请求数对于连接有意义如果使用协议则返回原始用户的地址否则为空如果使用协议则返回原始用户的端口否则为空服务器地址例如服务器端口例如服务端协议例如请求相关变量请求包体头部长度请求包体类型中某个参数参数名所有参数中有参数则返回否则返回空与完全相同请求的不包含参数请求的包含参数协议名或者请求的方法等所有请求内容的大小包含请求行头部请求体由协议传入的用户名客户端请求主体信息的临时文件名包含请求的主要信息在使用或指令的中比较有意义先看请求行再看请求头最后找用户浏览器标识从哪些链接过来的请求经过一层代表服务器添加对应代理服务器的信息获取用户真实用户处理请求时相关变量请求处理到现在所耗费的时间单位为秒例如代表毫秒请求处理完成则返回否则为空进制显示的请求随机生成的匹配上请求的值若开启则值为否则为空待访问文件的完整路径由和规则生成的文件夹路径将中的软链接换成真实路径返回响应时的速度上限值返回响应时相关变量响应体中真实内容的大小全部响应体大小返回状态码系统变量系统版本服务器时间时间空间单位时间单位毫秒秒分钟小时天周月年空间单位实用场景虚拟主机基于多的虚拟主机监听不同网卡的端口可相同基于多端口的虚拟主机局域网常用监听不同端口基于域名的虚拟主机公网最常用端口可相同为不同域名静态站点为了加快网站解析速度可以将动态资源交给后端服务器纯前端的静态页面放在系统目录下交给来解析反向代理网络编程反向代理了解反向代理反向代理是用户客户端访问代理服务器后被反向代理服务器按照一定的规则从一个或多个被代理服务器中获取响应资源并返回给客户端的代理模式客户端只知道代理服务器的并不知道后端服务器的原因是代理服务器隐藏了被代理服务器的信息反向代理可以七层反向代理应用层四层反向代理代理七层反向代理在配置文件中的段中写入如下格式的配置即可将本地端口代理到百度使用做反向代理以支持跨域请求访问相关参考超详细解释设置解析器拆解请求目标设置代理转发设置头信息处理请求作用为当访问的时候访问的实际上是的资源解决了跨域问题四层反向代理除了可以代理七层流量还可以代理四层流量需要使用核心模块手动编译的话需要在编译配置时增加参数进行编译配置文件如下需写在段中访问本机的就被转发到了远程的负载均衡当出现高并发大流量的业务场景时单台后端服务器已无法支撑业务正常运行需要将请求流量按照一定规则分发到多台服务节点上即使某个节点宕机系统依然能够对外正常提供服务以此来提高系统的性能和稳定性支持的协议如下模块用于定义上游模块及其下层指令说明指令含义段名中间定义上游服务定义上游服务地址定义共享内存用于跨子进程共享数据对上游服务启用长连接每个子进程与上游服务器空闲长连接的最大数量当同时有个请求过来处理完毕后会保留个连接其他全部关闭一个长连接可以处理的最多请求个数空闲情况下一个长连接的超时时长超过后会销毁长连接负载均衡算法哈希负载均衡算法依据进行哈希计算负载均衡算法最少连接数负载均衡算法最短响应时间负载均衡算法随机模块参数含义权重值默认为上游服务器的最大并发连接数服务器不可用的判定时间内不可用次数达次则在这内不会再转发给后端超过后依然还是会转发过去服务器不可用的检查次数备份服务器仅当其他服务器都不可用时标记服务器长期不可用离线维护负载均衡算法轮询默认每个请求按时间顺序逐一分配到不同的后端服务器默认所有服务器权重为加权轮询指定轮询概率用于后端服务器性能不均的情况实际案例模块代理几台服务器就需要几个模块同时也需要几个代理模块客户端访问反向代理服务器反向代理服务器监听的端口客户端访问反向代理服务器的域名当需要反向代理多个服务器的时候需要不同的域名以区分反向代理服务器转发指令指定转发地址固定的头名字自己定与下面的代理模块需要一一对应与指令一致只替代名中的符号添加一个代理模块该网址需要与上面后面接的网址对应的真实地址与端口此指令可以有多个以实现负载均衡不设置权重的情况下为轮询设置权重的格式端口表示设置访问该的权重为关于上面实现负载均衡的加权轮询算法详解点击跳转哈希哈希算法是将任意长度的二进制值映射为较短的固定长度的二进制值这个小的二进制值叫哈希值映射不可逆根据这个变量的哈希值来负载相同统一资源标识符的请求将始终被路由到相同的后端服务器每个请求按访问的结果分配这样每个访客固定访问一个后端服务器是共享问题的解决方案之一最少连接数算法从上游服务器挑选一台当前已建立连接数最少的分配请求极端情况下会退化为轮询算法多个子进程同时处理请求时无法共享后端服务器的连接数状态此时需要开辟共享内存空间用来在多个子进程中共享信息指定开辟共享内存的大小对上游服务器返回异常时的处理主要有这三个关键词可以设置含义是配置的这些情况下执行失败转发如果不配置当遇到上游返回错误码时会直接返回给客户端语法默认值上下文可选参数含义向后端服务器传输请求或读取响应头出错时服务器宕机会转发到下一台向后端服务器传输请求或读取响应头超时时设置的时间内没有接收完响应体则会转发到下一台服务器但是服务器宕机的话会返回不会转发下一台后端返回无效的响应时响应状态为时非幂等请求失败时是否需要转发下一台后端服务器不设置就是不转发如请求时如果命中则会直接返回对于写操作最好不要轻易设置禁用请求失败转发功能案例上面的案例中如果访问会因为负载均衡访问上游服务器其中一个但是由于设置了即设置的上述情况不会走负载均衡的转发因此访问始终会在多次转发下最终访问的是含义超过该时间不再尝试失败转发语法默认值含义为如果在向上游服务器发送请求时如果连接超时时间超过了将不会尝试将请求转发到下一个上游服务器而是立即返回一个失败响应通常是给客户端上下文含义设置最大尝试转发次数超过转发次数依旧失败则错误码直接返回给客户端语法默认值一直转发上下文异常处理样例如果不配置当遇到上游返回错误状态码时会直接返回给客户端加密传输通过加密通道保护客户端与服务端之间的数据传输已成为当前网站部署的必选配置在部署有代理集群的站点通常会把证书部署在的服务器上然后把请求代理到后端的上游服务器这种部署方式由服务器负责请求的运算相对减轻了后端上游服务器的运算量生成自签名证书配置签名证书创建证书存放目录创建私钥这样创建私钥可以直接带上密码创建签名请求证书您即将被要求输入一些信息这些信息将被包含在您的证书请求中这些信息通常用于标识和识别您的身份这些信息被称为简称它包含了一些字段在输入时您可以留下某些字段为空白如果您不想提供相关信息对于某些字段系统可能会有默认值如果您想使用默认值可以直接按下回车键如果您想保持某个字段为空白可以输入句点根据您的需求和证书颁发机构的要求您可以根据提示逐个输入相关信息例如国家地区组织名称单位名称常用名等请确保提供准确的信息因为这些信息将在您的证书中显示并用于识别您的身份在加载支持的并使用上述私钥时除去必须的口令最后标记证书使用上述私钥和和有效期这种自签名的证书只能提供数据加密的功能无法提供身份验证这意味着虽然数据传输是加密的但用户无法确认他们正在与预期的服务器进行通信而不是与中间人攻击者进行通信此外自签名证书在用户的浏览器中通常会显示警告这可能会影响用户对网站的信任度而购买证书尤其是从知名的证书颁发机构购买可以提供更全面的保护这些证书不仅提供数据加密还经过了严格的身份验证过程可以证明网站的身份是真实的此外这些证书会被用户的浏览器所信任不会显示任何警告总的来说如果你的网站需要处理敏感信息如用户登录凭据信用卡信息等那么购买证书是非常必要的如果你的网站只是提供一些公开的非敏感的信息那么使用自签名的证书或许就足够了但无论如何使用证书无论是购买的还是自签名的总比完全不使用证书要安全得多配置证书部分证书密钥握手优化会话缓存的存储大小为会话缓存的超时时间为分钟如果未开启模块配置后会提示错误默认安装的包通常不包含选项即不包含模块可用下面命令查看配置的模块报该错误的解决方案文件服务器要归档一些数据或资料那么文件服务器必不可少使用可以非常快速便捷的搭建一个简易的文件服务配置正常显示中文服务器下中文目录无法下钻目前无解打开功能以结尾的请求可以将指向的目录作为一个列表来显示到页面上显示文件的大小以字节显示人性化显示文件过大会显示为或以哪种格式返回默认值显示时间格式当前时区时区如果文件存在则会返回内容否则才会返回目录内容注意点按照上述配置配置好后访问网址会出现错误查看会发现是权限不足问题使用会发现进程是权限而进程是权限是工作进程的运行用户通常会使用非特权用户运行工作进程以增加安全性是一个常见的非特权用户用于执行网络服务进程它通常具有较低的权限只能访问必要的系统资源以减少潜在的安全风险因此作为文件服务器不具备权限访问文件资源因此会返回错误中添加可以解决问题此后进程也将会获得权限在中是通过指令查看的用户组为虽然这种方法可以解决权限不足问题但有安全隐患最好还是用别的用户基础以及系统编程用户权限用户和用户组相关命令查看权限相关命令限速定义响应数据的传输速度本指令属于不属于定义响应数据的传输速度默认这些是处理请求时相关变量加大返回数据量更好地看到限速效果限流限制客户端并发连接数限制客户端处理请求的平均速率用于限制客户端的并发连接数使用共享内存对所有的子进程生效需要保存客户端连接数格式用中定义的名称以为标识的客户端被允许的同时最大连接数上下文案例格式上下文用于定义客户端的唯一标识来限速如使用个字节空间高效使用个字节空间给取的任意名称共享内存大小空间为单位案例格式触发限速后返回的状态码上下文案例用于限制客户端处理请求的平均速率使用共享内存对所有的子进程生效限流算法漏桶暂时拦截住上方水的向下流动等待桶中的一部分水漏走后再放行上方水溢出的上方水直接抛弃格式上下文桶大小设置一个大小为的缓冲区当有大量请求爆发过来时超过了访问频次限制的请求可以先放到这个缓冲区内等待但是这个等待区里的位置只有个超过的请求会直接报设置的状态码的错误然后返回如果设置会在瞬时提供处理个请求的能力请求超过的时候就会直接返回设置的状态码永远不存在请求需要等待的情况指设置给取的任意名称案例案例格式上下文用于定义客户端的唯一标识来限速如使用个字节空间高效使用个字节空间给取的任意名称共享内存大小空间为单位表示允许相同标识的客户端的访问频次的即限制每秒访问一次每秒才处理一个请求案例格式的状态码默认值上下文案例限流案例结合和的案例格式用于定义客户端的唯一标识来限速如给空间取的任意名称共享内存大小空间为单位使用个字节空间高效使用个字节空间格式上下文表示允许相同标识的客户端的访问频次的即限制每秒访问一次每秒才处理一个请求触发限速后返回状态码默认上下文当触发限速后错误日志出记录一条日志这里用于定义日志等级上下文默认值用中定义的名称以为标识的客户端被允许的同时最大连接数定义响应数据的传输速度本指令属于不属于的状态码默认值上下文触发限速后日志记录的等级默认值上下文桶大小设置一个大小为的缓冲区当有大量请求爆发过来时超过了访问频次限制的请求可以先放到这个缓冲区内等待但是这个等待区里的位置只有个超过的请求会直接报的错误然后返回如果设置会在瞬时提供处理个请求的能力请求超过的时候就会直接返回永远不存在请求需要等待的情况上下文黑白名单限制特定或网段访问规则是从上到下的规则顺序很重要默认值上下文默认值上下文规则示例规则从上到下拒绝放行网段子网掩码位但是除了放行网段子网掩码位放行除了上面放行的其他全部拒绝请求拦截关键词基于子请求收到的响应码做访问控制如拦截所有请求先去做鉴权请求通过后再放行典型的应用就是鉴权默认值上下文鉴权成功对会返回后面实际内容鉴权失败会返回鉴权服务的返回内容防盗链如果出现盗链的情况将会出现类似于如下效果配置问题配置过程中遇到的一些问题记录配置端口问题系统的限制系统默认只允许以下的端口号被系统服务使用如果要使用以下的端口号需要权限或者修改系统配置即通过指令配置设置为权限但似乎阿里云服务器可以部署到以内的端口不明所以直接文本使用指令将默认的设置为以确保返回的内容被浏览器识别为纯文本然后我们使用指令返回带有和的文本响应插件插件网络编程插件详解跳转网络编程配合项目配合使用跳转实现了协议在的基础上实现了并覆盖的所有功能插件源码使支持语法',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-31 18:07:15',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://th.bing.com/th/id/OIP.wtmjepfWPBvn26uz7s18dgHaHa?rs=1&amp;pid=ImgDetMain"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">ZEROKO14的个人博客</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 1.05rem;">C#<sup>2</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C++<sup>5</sup></a><a href="/tags/CSS/" style="font-size: 1.05rem;">CSS<sup>1</sup></a><a href="/tags/CSharp/" style="font-size: 1.05rem;">CSharp<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">C语言<sup>1</sup></a><a href="/tags/FPS/" style="font-size: 1.05rem;">FPS<sup>1</sup></a><a href="/tags/HTML/" style="font-size: 1.05rem;">HTML<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem;">JavaScript<sup>1</sup></a><a href="/tags/MFC/" style="font-size: 1.05rem;">MFC<sup>1</sup></a><a href="/tags/PE/" style="font-size: 1.05rem;">PE<sup>1</sup></a><a href="/tags/QT/" style="font-size: 1.05rem;">QT<sup>1</sup></a><a href="/tags/WPF/" style="font-size: 1.05rem;">WPF<sup>2</sup></a><a href="/tags/ai/" style="font-size: 1.05rem;">ai<sup>1</sup></a><a href="/tags/cmake/" style="font-size: 1.05rem;">cmake<sup>1</sup></a><a href="/tags/doxygen/" style="font-size: 1.05rem;">doxygen<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>1</sup></a><a href="/tags/json/" style="font-size: 1.05rem;">json<sup>1</sup></a><a href="/tags/linux/" style="font-size: 1.05rem;">linux<sup>1</sup></a><a href="/tags/nas/" style="font-size: 1.05rem;">nas<sup>1</sup></a><a href="/tags/next/" style="font-size: 1.05rem;">next<sup>1</sup></a><a href="/tags/ppt/" style="font-size: 1.05rem;">ppt<sup>1</sup></a><a href="/tags/slidev/" style="font-size: 1.05rem;">slidev<sup>1</sup></a><a href="/tags/vue/" style="font-size: 1.05rem;">vue<sup>1</sup></a><a href="/tags/xml/" style="font-size: 1.05rem;">xml<sup>1</sup></a><a href="/tags/yaml/" style="font-size: 1.05rem;">yaml<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 1.05rem;">代码规范<sup>1</sup></a><a href="/tags/%E5%86%85%E6%A0%B8/" style="font-size: 1.05rem;">内核<sup>2</sup></a><a href="/tags/%E5%86%85%E6%A0%B8%E7%9B%B8%E5%85%B3/" style="font-size: 1.05rem;">内核相关<sup>5</sup></a><a href="/tags/%E5%8A%A0%E8%A7%A3%E5%AF%86/" style="font-size: 1.05rem;">加解密<sup>1</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">基础<sup>2</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">多线程<sup>1</sup></a><a href="/tags/%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">并发模式<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">开发<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 1.05rem;">数学<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 1.05rem;">正则表达式<sup>1</sup></a><a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 1.05rem;">监控<sup>1</sup></a><a href="/tags/%E7%A1%AC%E7%BC%96%E7%A0%81/" style="font-size: 1.05rem;">硬编码<sup>1</sup></a><a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">管理<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>3</sup></a><a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 1.05rem;">逆向<sup>2</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">14</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">27</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url">技术</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>网络</span></a></span></div></div><h1 class="post-title" itemprop="name headline">nginx</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-11-24T02:51:09.100Z" title="发表于 2023-11-24 10:51:09">2023-11-24</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-10-31T10:07:15.831Z" title="更新于 2024-10-31 18:07:15">2024-10-31</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="nginx"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为新加坡"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>新加坡</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://che77a38.github.io/posts/nginx/"><header><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url">技术</a><a href="/tags/%E7%BD%91%E7%BB%9C/" tabindex="-1" itemprop="url">网络</a><h1 id="CrawlerTitle" itemprop="name headline">nginx</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">ZEROKO14</span><time itemprop="dateCreated datePublished" datetime="2023-11-24T02:51:09.100Z" title="发表于 2023-11-24 10:51:09">2023-11-24</time><time itemprop="dateCreated datePublished" datetime="2024-10-31T10:07:15.831Z" title="更新于 2024-10-31 18:07:15">2024-10-31</time></header><h1 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h1><blockquote>
<p><strong>Nginx</strong> 是异步框架的网页服务器，也可以用作反向代理、负载平衡器和 HTTP缓存。该软件由俄罗斯程序员伊戈尔•赛索耶夫开发的开源框架,由c语言实现，并于2004年首次公开发布。2011年成立同名公司以提供支持服务。2019年3月11日，Nginx公司被F5网络公司以6.7亿美元收购。Nginx是免费的开源软件，根据类BSD许可证的条款发布。</p>
</blockquote>
<span id="more"></span>

<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><ul>
<li><p>web服务器</p>
<p>解析http协议</p>
</li>
<li><p><a href="#%E6%AD%A3%E5%90%91/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">反向代理</a>服务器</p>
<p>了解反向代理的概念</p>
</li>
<li><p>邮件服务器</p>
<p>解析邮件相关的协议:pop3&#x2F;smtp&#x2F;imap</p>
</li>
</ul>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><blockquote>
<ul>
<li><p><strong>高并发支持</strong>： 单机能够支持10W+的并发连接（取决于内存大小，极限能够到百万），那么在实际生产中也是非常能接近这个数字的，这主要得益于 nginx 在linux 环境下使用了 epol1 I0 多路复用模型。</p>
</li>
<li><p><strong>内存消耗低</strong>： 在同类型 web 服务中，nginx 比 apache 占用的内存资源更少，在一般情况下 10K非活跃的 HTTP Keep-Alive 连接在 nginx中仅消耗 2.5M内存。</p>
</li>
<li><p><strong>高扩展性</strong>： 低耦合的模块设计，并且有丰富的第三方模块支持。</p>
</li>
<li><p><strong>高可靠性</strong>： 经过十几年各种复杂场景和各大公司的生产环境验证，并且 nginx 的架构是由 master 进程和worker 进程组成的，如果 worker 进程出现问题，那么 master 进程可以快速开启一个新的worker 进程提供服务。</p>
<p>经过大批网站检验：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.sina.com.cn/">www.sina.com.cn</a></li>
<li><a target="_blank" rel="noopener" href="http://www.xunlei.com/">www.xunlei.com</a></li>
<li><a target="_blank" rel="noopener" href="http://www.163.com/">www.163.com</a></li>
</ul>
</li>
<li><p><strong>热部署</strong></p>
<p>master和worker的分离设置,可实现7*24小时不间断服务的前提下升级nginx可执行文件</p>
</li>
<li><p><strong>最自由的BSD许可协议</strong></p>
<p>BSD许可协议，即Berkeley Software Distribution license的简称，是由加州大学伯克利分校发布并维护的开源软件许可证<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/350968635">。它是自由软件中使用最广泛的许可协议之一。BSD许可协议给予使用者很大的自由，可以自由地使用、修改源代码，也可以将修改后的代码作为开源或专有软件再发布。这种许可证因此而得名，被叫做BSD许可证</a>。</p>
<p>BSD许可协议允许用户免费使用nginx,修改nginx源码再发布</p>
<ul>
<li>淘宝:tengine</li>
</ul>
</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th>server</th>
<th>Apache</th>
<th>Nginx</th>
<th>Lighttpd</th>
</tr>
</thead>
<tbody><tr>
<td>Proxy代理</td>
<td>非常好</td>
<td>非常好</td>
<td>一般</td>
</tr>
<tr>
<td>Rewriter</td>
<td>好</td>
<td>非常好</td>
<td>一般</td>
</tr>
<tr>
<td>Fcgi</td>
<td>不好</td>
<td>好</td>
<td>非常好</td>
</tr>
<tr>
<td>热部署</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>系统压力比较</td>
<td>很大</td>
<td>很小</td>
<td>比较小</td>
</tr>
<tr>
<td>稳定性</td>
<td>好</td>
<td>非常好</td>
<td>不好</td>
</tr>
<tr>
<td>安全性</td>
<td>好</td>
<td>一般</td>
<td>一般</td>
</tr>
<tr>
<td>技术支持</td>
<td>非常好</td>
<td>很少</td>
<td>一般</td>
</tr>
<tr>
<td>静态文件处理</td>
<td>一般</td>
<td>非常好</td>
<td>好</td>
</tr>
<tr>
<td>Vhosts虚拟主机</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>反向代理</td>
<td>一般</td>
<td>非常好</td>
<td>一般</td>
</tr>
<tr>
<td>Session sticky</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<p>Nginx是[[网络编程#多并发服务器|异步非阻塞的事件驱动模型]]</p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/">Nginx官方地址</a></p>
<h1 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h1><p>源码安装方式如下:</p>
<p><a target="_blank" rel="noopener" href="https://pcre.org/">pcre官网</a>    <a target="_blank" rel="noopener" href="https://zlib.net/">zlib官网</a>   <a target="_blank" rel="noopener" href="https://www.openssl.org/">openssl官网</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx工作时候需要依赖三个库(openssl没有版本要求)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">openssl源码下载:wget https://www.openssl.org/source/openssl-1.1.1.tar.gz</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">zlib源码下载:wget https://zlib.net/fossils/zlib-1.2.11.tar.gz</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">pcre源码下载:wget https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.42/pcre2-10.42.tar.gz</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">三个参数为:这三个库对应的源码安装目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据自己的电脑的库安装包的位置进行指定</span></span><br><span class="line">./configure --with-openssl=../openssl-1.0.1t --with-pcre=../pcre-8.40 --with-zlib=../zlib-1.2.11 --prefix=要安装的位置(省略的话默认安装到/usr/local/nginx/)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">返回如下表示configure没有问题</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Configuration summary</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> + using PCRE2 library: ../pcre2-10.42</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> + using OpenSSL library: /root/openssl/openssl</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> + using zlib library: ../zlib-1.2.13</span></span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">最终会将nginx安装到/usr/local/nginx/下</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">上面命令中的--with-zlib和--with-pcre可以不写路径</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要安装ssl支持的话,需要<code>--with-http_ssl_module</code></p>
</blockquote>
<p>测试是否安装成功:</p>
<p>在浏览器中访问[部署了nginx对应的主机的ip地址],如果能看到nginx的欢迎页面表示已经安装成功</p>
<p>apt安装的话,已包含大量常用模块,推荐使用apt方式安装,简单快速</p>
<p><strong>nginx可执行程序路径</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">快速启动的方式</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">将/usr/local/nginx/sbin添加到环境变量PATH中</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">创建软链接</span></span><br><span class="line">		ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx</span><br></pre></td></tr></table></figure>

<p>由于nginx安装需要很多模块,源码编译比较麻烦,因此有捆绑了标准 nginx 核心、大量第三方 nginx 模块以及大部分外部依赖项的项目<a target="_blank" rel="noopener" href="https://github.com/openresty/openresty">OpenResty</a></p>
<blockquote>
<p>OpenResty® 是一个基于 Nginx 和 LuaJIT 的动态网页服务器，它集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<p>OpenResty® 通过汇聚各类设计精良的 Nginx 模块（主要由 OpenResty 团队自主开发），从而将 Nginx 有效地变成一个强大的通用 Web 应用平台。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 以上并发连接响应的超高性能 Web 应用。</p>
<p>OpenResty® 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I&#x2F;O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致且友好的非阻塞响应。</p>
<p>OpenResty® 已经在很多知名的互联网公司（包括阿里巴巴、腾讯和新浪）和许多高流量的网站（例如 weibo.com、taobao.com 和 jd.com）中得到了广泛应用，并得到了越来越多的全球知名互联网公司的青睐。</p>
</blockquote>
<h2 id="nginx各种默认路径"><a href="#nginx各种默认路径" class="headerlink" title="nginx各种默认路径"></a>nginx各种默认路径</h2><blockquote>
<p>在nginx不手动指定各项路径的时候的默认路径详解</p>
</blockquote>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p><strong>nginx在linux下各种默认目录详解</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202311061743282.png" alt="image-20231106174312888" style="zoom: 33%;" />

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下面是目录结构介绍</span></span><br><span class="line">conf -&gt; 存储配置文件的目录</span><br><span class="line">html -&gt; 默认存储网站(服务器)静态资源的目录[图片,html]</span><br><span class="line">logs -&gt; 存储log日志(其中error.log用于分析问题,access.log用于查看访问记录)</span><br><span class="line">sbin -&gt; 启动nginx的可执行程序</span><br></pre></td></tr></table></figure>

<h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><p><strong>nginx在mac下下各种默认目录详解</strong> (此时location中是<code>root html</code>)</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202311061742999.png" alt="image-20231106174235994" style="zoom: 33%;" />

<p>mac上配置文件真正的根目录为：<code>/opt/homebrew/Cellar/nginx/1.25.3/</code>，即配置文件中的相对路径都为相对此地址</p>
<blockquote>
<p>root后面跟的如果是<code>.</code>即 <code>root .</code>,则nginx是会去<code>/opt/homebrew/Cellar/nginx/1.25.3/</code>路径下找nginx.conf文件</p>
</blockquote>
<p>mac中<code>/opt/homebrew/Cellar/nginx/1.25.3/html/</code>等同于<code>/opt/homebrew/var/www/</code>，互为映射关系</p>
<p>像kali系统，会把<code>/var/www/html</code>映射到<code>/usr/local/nginx/html</code></p>
<h1 id="Nginx基本命令"><a href="#Nginx基本命令" class="headerlink" title="Nginx基本命令"></a>Nginx基本命令</h1><p><strong>启动nginx</strong>(需要管理员权限)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动</span></span><br><span class="line">sudo nginx</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启(修改配置文件后需要执行该命令以生效)</span></span><br><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<p><strong>关闭nginx</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">马上关闭</span></span><br><span class="line">sudo nginx -s stop</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">等nginx完成当前操作之后关闭</span></span><br><span class="line">sudo nginx -s quit</span><br></pre></td></tr></table></figure>

<p>查看nginx配置文件位置并且测试配置文件正确与否使用命令查看: <strong><code>nginx -t</code></strong></p>
<p>查看nginx的版本： <code>nginx -v</code></p>
<p>查看nginx的编译配置信息： <code>nginx -V</code></p>
<h1 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h1><p>nginx的配置需要通过nginx.conf文件来配置</p>
<p>配置文件可以通过 <code>nginx -t</code>来查看位置</p>
<p>可以通过 <code>sudo netstat -tuln | grep 端口号</code>查看端口是否正确被监听中</p>
<h2 id="nginx-conf详解"><a href="#nginx-conf详解" class="headerlink" title="nginx.conf详解"></a>nginx.conf详解</h2><p>配置文件的组织形式</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2/202306071742265.png" alt="image-20230607174201176" style="zoom:50%;" />

<p>上图中main模块本身即为最外层,即所有<code>&#123;...&#125;</code>之外就是main模块</p>
<ul>
<li>http模块  (这个是<strong>协议级别</strong>)<ul>
<li>server模块  (每个server模块对应一个web服务器:<strong>服务器级别</strong>) <ul>
<li>location模块 (用来匹配不同的URI请求，进而对请求做不同的处理和响应:<strong>请求级别</strong>)</li>
</ul>
</li>
</ul>
</li>
<li>mail模块 (处理邮件相关的动作)</li>
</ul>
<p><strong>[重要]常用配置项介绍</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span>  nobody;<span class="comment">#启动之后的worker进程属于谁</span></span><br><span class="line"><span class="comment">#需要将nobody改为root,否则nginx操作文件时会失败,显示原因:Permission denied</span></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;<span class="comment">#设置worker进程的个数,建议最大为cpu核数</span></span><br><span class="line"><span class="attribute">error_log</span> logs/<span class="literal">error</span>.log &#123;日志级别&#125;;<span class="comment">#设置错误日志路径(相对路径)和日志级别(如notice,info等)</span></span><br><span class="line"><span class="attribute">pid</span> logs/nginx.pid;<span class="comment">#pid文件,记录启动的nginx进程的pid</span></span><br><span class="line"><span class="comment">#nginx的事件处理</span></span><br><span class="line">events&#123;</span><br><span class="line">	<span class="attribute">use</span> <span class="literal">epoll</span>; <span class="comment">#多路IO转接模型选择epoll</span></span><br><span class="line">	<span class="attribute">worker_connections</span> <span class="number">1024</span>;<span class="comment">#每个工作进程的最大连接数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#http模块</span></span><br><span class="line">http&#123;</span><br><span class="line">	<span class="comment">#省略...</span></span><br><span class="line">	<span class="comment">#server模块</span></span><br><span class="line">	server&#123;</span><br><span class="line">			<span class="attribute">listen</span>  <span class="number">80</span>;<span class="comment">#web服务器监听的端口</span></span><br><span class="line">			<span class="attribute">server_name</span> localhost;<span class="comment">#服务器的域名(不能写ip地址),让客户端通过该域名访问服务器</span></span><br><span class="line">			<span class="attribute">charset</span> utf8;<span class="comment">#设置字符编码</span></span><br><span class="line">			<span class="comment">#access_log logs/host.access.log main;#正常工作也会写访问日志,设置访问日志位置,该行注释掉表示正常工作不写访问日志.</span></span><br><span class="line">			<span class="comment">#location模块可以有多个</span></span><br><span class="line">			<span class="section">location</span> / &#123; <span class="comment">#&#x27;/&#x27;为location指令名(可以是正则表达式),location指令名不能重复</span></span><br><span class="line">            <span class="attribute">root</span>   html;<span class="comment">#一个相对/usr/local/nginx/来找的路径,html为nginx默认自带的web静态资源目录,也可以设置为自己建立的目录名</span></span><br><span class="line">            <span class="comment">#当客户端的请求是一个目录时,通过该指令设置nginx会找一个默认显示的网页,先找index.html,找不到再找index.htm</span></span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">#假设自建的静态资源目录yundisk下有个hello文件夹,当访问的url为http:xxx.xxx.xxx.xxx/hello/text.html,实际上是访问/usr/local/nginx/yundisk/hello/text.html</span></span><br><span class="line">				<span class="section">location</span> /hello/ &#123;</span><br><span class="line">						<span class="attribute">root</span> yundisk;<span class="comment">#此处的root表示location指令名&#x27;/hello/&#x27;的第一个&#x27;/&#x27;部分.结合这条root指令的&#x27;/hello&#x27;可以视为&#x27;/yundisk/hello/&#x27;</span></span><br><span class="line">						<span class="comment">#此处如果不写index的话,如果访问http:xxx.xxx.xxx.xxx/hello/会返回404</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>location指令名可以是[[正则表达式|正则表达式]]</p>
<p>服务器要处理的指令如何<strong>从url中提取?</strong></p>
<p>例子:<code>http://192.168.10.100:80/login.html</code></p>
<ol>
<li>去掉协议  <code>http://</code></li>
<li>去掉IP&#x2F;域名+端口:<code>192.168.10.100:80</code></li>
<li>剩下的:<code>/login.html</code>,会去<code>/usr/local/nginx/</code>下找<code>./login.html</code></li>
</ol>
<h3 id="全局配置main段详解"><a href="#全局配置main段详解" class="headerlink" title="全局配置main段详解"></a>全局配置main段详解</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">核心参数（其他参数大部分情况下用不到）</span><br><span class="line"></span><br><span class="line"><span class="comment"># user USERNAME [GROUP]</span></span><br><span class="line"><span class="comment"># 解释：指定运行nginx的worker子进程的属主和属组，其中属组可以不指定</span></span><br><span class="line"><span class="attribute">user</span>  nginx;</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker_processes NUMBER | auto</span></span><br><span class="line"><span class="comment"># 解释：指定nginx启动的worker子进程数量</span></span><br><span class="line"><span class="comment"># 【*auto：自动设置为物理CPU核心数】</span></span><br><span class="line"><span class="attribute">worker_processes</span>  auto;</span><br><span class="line"></span><br><span class="line"><span class="comment"># pid DIR</span></span><br><span class="line"><span class="comment"># 解释：指定运行nginx的master主进程的pid文件存放路径</span></span><br><span class="line"><span class="attribute">pid</span> /opt/nginx/logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker_rlimit_nofile NUMBER</span></span><br><span class="line"><span class="comment"># 解释：指定worker子进程可以打开的最大文件句柄数</span></span><br><span class="line"><span class="comment"># 【系统最大打开65535，每个子进程打开数乘子进程数，实际也不会超过65535】</span></span><br><span class="line"><span class="comment"># 这个值需要调大</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">20480</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker_rlimit_core SIZE</span></span><br><span class="line"><span class="comment"># 指定worker子进程异常终止后的core文件，用于记录分析问题</span></span><br><span class="line"><span class="attribute">worker_rlimit_core</span> <span class="number">50M</span>;</span><br><span class="line"><span class="attribute">working_directory</span> /opt/nginx/tmp;<span class="comment">#【必须对子进程用户赋写权限】</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解释：将每个worker子进程与CPU物理核心绑定</span></span><br><span class="line"><span class="comment"># 【master负责调度，worker负责处理请求】</span></span><br><span class="line"><span class="comment"># 【假设CPU有4个核心，某一时刻worker1获取到了CPU1的工作调度时间片，时间片过后worker1从CPU1上面撤下来，CPU1去处理其他事件，下一时刻可能是CPU2、CPU3的时间片调度到了worker1上面，那么worker1就会在其他CPU上面工作，进程与CPU的调度切换是有损耗的，worker1如果绑定了CPU1，worker1将永远等待CPU1的调度，充分利用CPU缓存】</span></span><br><span class="line"><span class="comment"># 【【主要作用：将每个worker子进程与特定CPU物理核心绑定，优势在于：避免同一个worker子进程在不同的CPU核心上切换，缓存失效，降低性能；其并不能真正避免进程切换（进程切换是CPU工作特性）】】</span></span><br><span class="line"><span class="comment"># -- worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;# 8核心，8个worker</span></span><br><span class="line"><span class="comment"># -- worker_cpu_affinity 01 10 01 10;# 2核心，4个worker</span></span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> <span class="number">0001</span> <span class="number">0010</span> <span class="number">0100</span> <span class="number">1000</span>;<span class="comment"># 4核心，4个worker</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解释：指定worker子进程的nice值，以调整运行nginx的优先级，通常设定为“负值”，以优先调用nginx</span></span><br><span class="line"><span class="comment"># 【Linux默认进程的优先级值是120，值越小越优先；nice设定范围为-20到+19】</span></span><br><span class="line"><span class="comment"># 【对Linux来说，优先级值则是100到139】</span></span><br><span class="line"><span class="attribute">worker_priority</span> -<span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定worker子进程优雅退出时的超时时间，不管5秒内是否处理完，都强制退出</span></span><br><span class="line"><span class="attribute">worker_shutdown_timeout</span> <span class="number">5s</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker子进程内部使用的计时器精度，调整时间间隔越大，系统调用越少，有利于性能提升；反之，系统调用越多，性能下降</span></span><br><span class="line"><span class="comment"># 比如某些计时的操作，worker需要去获取内核时间，频繁跟内核打交道会降低性能</span></span><br><span class="line"><span class="attribute">timer_resolution</span> 100ms;</span><br><span class="line"></span><br><span class="line"><span class="comment"># daemon on | off</span></span><br><span class="line"><span class="comment"># 设定nginx的运行方式，前台还是后台，前台用户调试，后台用于生产</span></span><br><span class="line"><span class="attribute">daemon</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 负载均衡互斥锁文件存放路径</span></span><br><span class="line"><span class="attribute">lock_file</span> logs/nginx.lock;</span><br><span class="line"><span class="comment">#负载均衡器是将网络流量分发到多个服务器的设备。负载均衡器可以确保流量均匀分布在多个服务器之间，从而提高性能和可靠性。负载均衡互斥锁文件用于确保一次只有一个进程正在访问负载均衡器。这可以防止冲突并确保负载均衡器正常运行。</span></span><br></pre></td></tr></table></figure>

<h3 id="events段"><a href="#events段" class="headerlink" title="events段"></a>events段</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment"># Nginx使用何种事件驱动模型,一般不指定这个参数</span></span><br><span class="line">    <span class="comment"># use epoll;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># worker子进程能够处理的最大并发连接数，多核情况最大其实达不到65535，</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">65535</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 是否打开负载均衡互斥锁，默认off（当master接收到请求时，会给每个worker发送消息去唤醒，状态为on时，则会有一个负载均衡锁，master会轮流发给每一个）</span></span><br><span class="line">    <span class="attribute">accept_mutex</span> <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 新连接分配给worker子进程的超时时间，默认500ms，超时后会转给下一个worker处理请求</span></span><br><span class="line">    <span class="attribute">accept_mutex_delay</span> 100ms;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># worker子进程可以接收的新连接个数(这个参数对性能影响不太大)</span></span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="http段"><a href="#http段" class="headerlink" title="http段"></a>http段</h3><h4 id="server段"><a href="#server段" class="headerlink" title="server段"></a>server段</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"> <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.test.com; </span><br><span class="line">    <span class="section">location</span> /picture &#123;</span><br><span class="line">     <span class="attribute">root</span> /opt/nginx/html/picture;</span><br><span class="line">        <span class="comment"># 客户端请求 www.test.com/picture/1.jpg；</span></span><br><span class="line">        <span class="comment"># 对应磁盘映射路径为：/opt/nginx/html/picture/picture/1.jpg</span></span><br><span class="line">        </span><br><span class="line"> &#125;</span><br><span class="line"> <span class="section">location</span> /picture &#123;</span><br><span class="line">     <span class="attribute">alias</span> /opt/nginx/html/picture/;</span><br><span class="line">        <span class="comment"># 客户端请求 www.test.com/picture/1.jpg；</span></span><br><span class="line">        <span class="comment"># 对应磁盘映射路径为：/opt/nginx/html/picture/1.jpg</span></span><br><span class="line">        <span class="comment"># 【末尾一定要加/】</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">root与alias的区别</th>
<th align="left">root</th>
<th align="left">alias</th>
</tr>
</thead>
<tbody><tr>
<td align="left">语法</td>
<td align="left">root path</td>
<td align="left">alias path</td>
</tr>
<tr>
<td align="left">上下文</td>
<td align="left">http, server, location, if</td>
<td align="left">location</td>
</tr>
<tr>
<td align="left">区别</td>
<td align="left">将定义路径与URI叠加</td>
<td align="left">只取定义路径，末尾一定要加&#x2F;</td>
</tr>
</tbody></table>
<h5 id="server-name的匹配规则"><a href="#server-name的匹配规则" class="headerlink" title="server_name的匹配规则"></a>server_name的匹配规则</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 精确匹配，优先级最高，1</span></span><br><span class="line"><span class="attribute">server_name</span> www.test.com;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 左通配，优先级2</span></span><br><span class="line"><span class="attribute">server_name</span> <span class="regexp">*.test.com</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 右通配，优先级3</span></span><br><span class="line"><span class="attribute">server_name</span> <span class="regexp">www.test.*</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正则通配，优先级最低，4</span></span><br><span class="line"><span class="attribute">server_name</span> ~^w\.test\..*$;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个</span></span><br><span class="line"><span class="attribute">server_name</span> www.test.com <span class="regexp">*.test.com</span> <span class="regexp">www.test.*</span> ~^w\.test\..*$;</span><br></pre></td></tr></table></figure>

<h5 id="location段"><a href="#location段" class="headerlink" title="location段"></a>location段</h5><table>
<thead>
<tr>
<th align="left">匹配规则</th>
<th align="left">含义</th>
<th align="left">示例</th>
<th align="left">优先级（1最高）</th>
</tr>
</thead>
<tbody><tr>
<td align="left">&#x3D;</td>
<td align="left">精确匹配</td>
<td align="left"><code>location = /pic/</code></td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">^~</td>
<td align="left">匹配到即停止搜索</td>
<td align="left"><code>location ^~ /pic/</code></td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">~</td>
<td align="left">正则匹配，区分大小写</td>
<td align="left">&#96;location ~ .(Jpg</td>
<td align="left">gif)#&#96;</td>
</tr>
<tr>
<td align="left">~*</td>
<td align="left">正则匹配，不区分大小写</td>
<td align="left">&#96;location ~* .(Jpg</td>
<td align="left">gif)$&#96;</td>
</tr>
<tr>
<td align="left">!~</td>
<td align="left">表示区分大小写不匹配的正则</td>
<td align="left"></td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">!~*</td>
<td align="left">表示不区分大小写不匹配的正则</td>
<td align="left"></td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">无符号</td>
<td align="left">通用匹配,任何请求都会匹配到</td>
<td align="left"><code>location /</code></td>
<td align="left">4</td>
</tr>
<tr>
<td align="left">@</td>
<td align="left">内部跳转</td>
<td align="left"><code>location @errorpage</code></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>查找顺序和优先级</p>
<ol>
<li>带有“&#x3D;”的精确匹配优先</li>
<li>没有修饰符的精确匹配</li>
<li>正则表达式按照他们在配置文件中定义的顺序</li>
<li>带有”^~”修饰符的，开头匹配</li>
<li>带有”<del>“或”</del>*”修饰符的，如果正则表达式与URI匹配</li>
<li>没有修饰符的，如果指定字符串与URI开头匹配</li>
</ol>
<table>
<thead>
<tr>
<th align="left">location末尾带与不带&#x2F;的区别</th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">不带&#x2F;</td>
<td align="left">location &#x2F;test</td>
<td align="left">尝试把test当成目录，如果找不到则找test文件</td>
</tr>
<tr>
<td align="left">带&#x2F;</td>
<td align="left">location &#x2F;test&#x2F;</td>
<td align="left">将test作为目录，如果不存在则直接返回404</td>
</tr>
</tbody></table>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试样例</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /test/8005/t/$</span> &#123;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;first regular expressions match!&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> <span class="regexp">~* /test/8005/t/(\w+)$</span> &#123;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;longest regular expressions match!&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /test/<span class="number">8005</span>/t/ &#123;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;stop regular expressions match!&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /test/<span class="number">8005</span>/t/Test2 &#123;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;longest prefix string match!&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /test/<span class="number">8005</span>/t &#123;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;prefix string match!&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> = /test/<span class="number">8005</span>/t &#123;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;exact match!&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="监控模块"><a href="#监控模块" class="headerlink" title="监控模块"></a>监控模块</h6><p>主要用于监控各种连接数</p>
<blockquote>
<p>需要模块–with-http_stub_status_module</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /status &#123;</span><br><span class="line"> <span class="comment"># 监控模块</span></span><br><span class="line">    stub_status;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ------页面结果------</span></span><br><span class="line"><span class="attribute">Active</span> connections: <span class="number">2</span> </span><br><span class="line">server accepts handled requests</span><br><span class="line"> <span class="number">16</span> <span class="number">16</span> <span class="number">26</span> </span><br><span class="line">Reading: <span class="number">0</span> Writing: <span class="number">1</span> Waiting: <span class="number">1</span> </span><br></pre></td></tr></table></figure>

<p>页面结果解释:</p>
<table>
<thead>
<tr>
<th align="left">状态项</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Active connections</td>
<td align="left">当前客户端与Nginx间的TCP连接数，等于下面Reading、Writing、Waiting数量之和</td>
</tr>
<tr>
<td align="left">accepts</td>
<td align="left">自Nginx启动起，与客户端建立过的连接总数</td>
</tr>
<tr>
<td align="left">handled</td>
<td align="left">自Nginx启动起，处理过的客户端连接总数。如果没有超出worker_connections配置，该值与accepts相同</td>
</tr>
<tr>
<td align="left">requests</td>
<td align="left">自Nginx启动起，处理过的客户端请求总数。由于存在HTTP Keep-Alive请求，故requests值会大于handled值</td>
</tr>
<tr>
<td align="left">Reading</td>
<td align="left">正在读取HTTP请求头部的连接总数</td>
</tr>
<tr>
<td align="left">Writing</td>
<td align="left">正在向客户端发送响应数据的连接总数</td>
</tr>
<tr>
<td align="left">Waiting</td>
<td align="left">当前空闲的HTTP Keep-Alive连接总数</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">内嵌变量</th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">变量名</td>
<td align="left">含义</td>
</tr>
<tr>
<td align="left">$connections_active</td>
<td align="left">同Active connections值</td>
</tr>
<tr>
<td align="left">$connections_reading</td>
<td align="left">同Reading值</td>
</tr>
<tr>
<td align="left">$connections_writing</td>
<td align="left">同Writing值</td>
</tr>
<tr>
<td align="left">$connections_waiting</td>
<td align="left">同waiting值</td>
</tr>
</tbody></table>
<h1 id="nginx语法"><a href="#nginx语法" class="headerlink" title="nginx语法"></a>nginx语法</h1><h2 id="nginx模块语法指令"><a href="#nginx模块语法指令" class="headerlink" title="nginx模块语法指令"></a>nginx模块语法指令</h2><h3 id="–with-http-rewrite-module"><a href="#–with-http-rewrite-module" class="headerlink" title="–with-http_rewrite_module"></a>–with-http_rewrite_module</h3><h4 id="rewrite-return指令"><a href="#rewrite-return指令" class="headerlink" title="rewrite&#x2F;return指令"></a>rewrite&#x2F;return指令</h4><p>由此模块提供支持: <code>ngx_http_rewrite_module</code></p>
<ul>
<li><strong>rewrite</strong><ul>
<li>根据指定正则表达式匹配规则，重写URL(其实就是重定向)</li>
</ul>
</li>
<li><strong>return</strong><ul>
<li>停止处理请求，直接返回响应码或重定向到其他URL</li>
<li>执行return指令后，location中后续指令将不会被执行</li>
</ul>
</li>
</ul>
<h5 id="rewrite"><a href="#rewrite" class="headerlink" title="rewrite"></a>rewrite</h5><blockquote>
<p>Rewrite主要实现<strong>url地址重写</strong>，以及<strong>重定向</strong>，就是把传入web的请求重定向到其他url的过程。Nginx 的 Rewrite 规则采用 PCRE Perl 兼容正则表达式的语法进行规则匹配，如相使用 Nginx 的 Rewrite 功能，在编译 Nginx 前要编译安装 PCRE 库</p>
</blockquote>
<p>上下文：<code>server, location, if</code></p>
<p><strong>[格式]</strong> <code>rewrite regex replacement [flag]</code></p>
<ul>
<li><p><code>regex</code>：用来匹配URI的正则表达式。</p>
</li>
<li><p><code>replacement</code>：正则匹配成功后，用来替换URI的字符串。如果该字符串以<code>http://</code>、<code>https://</code>或<code>$scheme</code>开头，则处理将停止，并重定向URI到客户端。</p>
</li>
<li><p><code>flag</code>：是一个可选参数，其有4个候选值。</p>
<ul>
<li><p><code>last</code>: 重写后的url发起新请求，再次进入server段，重试location中的匹配(默认为last)</p>
</li>
<li><p><code>break</code>: 直接使用重写后的url，不再匹配其他location中的语句</p>
</li>
<li><p><code>redirect</code>: 返回302临时重定向</p>
</li>
<li><p><code>permanent</code>: 返回301永久重定向</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>在以上的flag标记中，last和break用来实现URL重写，浏览器地址栏的URL地址不变，但在服务器访问的程序及路径发生了变化。redirect和permanent用来实现URL跳转，浏览器地址会显示跳转后的URL地址。</p>
<p>last和break标记的实现功能类似，但二者之间有细微的差别，使用alias指令时必须用last标记，使用proxy_pass指令时要使用break标记</p>
</blockquote>
<p>例子: <code>rewrite ^/(.*) http://www.cjzzc.com/$1 permanent;</code> </p>
<p>在上述指令中，rewrite为固定关键字，表示开启一条rewrite匹配规则，regex部分是<code>^/(.*)</code>，这是一个正则表达式，表示匹配所有，匹配成功后跳转到<code>http://www.cjzzc.com/$1</code>。这里的$1是取前面regex部分括号里的内容结尾的permanent；是永久301重定向标记，即跳转到后面的<code>http://www.cjzzc.com/$1</code>地址上。</p>
<h5 id="return"><a href="#return" class="headerlink" title="return"></a>return</h5><p>上下文：<code>server, location, if</code></p>
<p>该指令可以停止处理并指定的响应码返回给前端。既可以返回文本，也可以重定向URL。</p>
<ul>
<li><code>return code [text];</code><ul>
<li>text：响应体内容（如果code是200）</li>
<li>例:<code>return 200 &quot;return 200 HTTP Code&quot;;</code></li>
</ul>
</li>
<li><code>return code URL;</code><ul>
<li>URL：重定向</li>
<li>例:<code>return 302 /test;</code></li>
</ul>
</li>
<li><code>return URL;</code><ul>
<li>URL:直接跟URL的话必须是http&#x2F;https开头的完整路径</li>
</ul>
</li>
</ul>
<h6 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h6><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">return</span> http://localhost:8000/test;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /test &#123;</span><br><span class="line">    <span class="attribute">index</span> test.html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /search &#123;</span><br><span class="line">    <span class="attribute">rewrite</span> /(.*) https://www.baidu.com <span class="literal">permanent</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /test1 &#123;</span><br><span class="line">    <span class="comment"># 继续匹配location，</span></span><br><span class="line">    <span class="attribute">rewrite</span> /images/(.*) /test2/<span class="variable">$1</span> <span class="literal">last</span>;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;return 200 in /test1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /test2 &#123;</span><br><span class="line">    <span class="comment"># 不会再匹配，直接找test3下面的文件</span></span><br><span class="line">    <span class="attribute">rewrite</span> /pics/(.*) /test3/<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;return 200 in /test2&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /test3 &#123;</span><br><span class="line">    <span class="comment"># 请求：/test3/index.html,</span></span><br><span class="line">    <span class="comment"># 结果：直接返回&quot;return 200 in /test3&quot;，不会再去找index.html文件</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;return 200 in /test3&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /test4/ &#123;</span><br><span class="line">    <span class="attribute">if</span> ( <span class="variable">$remote_addr</span> = <span class="string">&quot;192.168.1.1&quot;</span> ) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;test if OK in URL /test4/&quot;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /test5 &#123;</span><br><span class="line">    <span class="attribute">if</span> ( <span class="variable">$uri</span> = <span class="string">&quot;/images/&quot;</span> ) &#123;</span><br><span class="line">        <span class="attribute">rewrite</span> (.*) /test2/ <span class="literal">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 执行了上面rewrite后，这里的return还会执行，通常不会联合一起写</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;test5 if failed\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="set指令"><a href="#set指令" class="headerlink" title="set指令"></a>set指令</h5><p>由此模块提供支持: <code>ngx_http_rewrite_module</code></p>
<p><strong>用于定义一个变量</strong></p>
<p>上下文:<code>server，location，if</code></p>
<p>格式: <code>set $variable value</code></p>
<ul>
<li><code>$variable</code>：为变量的名称，可以看到变量的名称以<code>$</code>符号开头，且不要与nginx预设的全局变量名相同。</li>
<li><code>value</code>：为变量的值，可以是字符串、其他变量或者两者的组合。</li>
</ul>
<p>如:<code>set $url $scheme://$host:$server_port$request_uri;</code></p>
<p>$url为客户端发起的完整url</p>
<h5 id="if指令"><a href="#if指令" class="headerlink" title="if指令"></a>if指令</h5><p>由此模块提供支持: <code>ngx_http_rewrite_module</code></p>
<p>上下文: <code>server，location</code></p>
<p>格式: <code>if (condition) &#123; ... &#125;</code> (<strong><code>if</code>和<code>(</code>之间有一个空格。</strong>)</p>
<p>条件表达式condition的形式</p>
<ul>
<li>变量名，如果变量的值为空字符串或”0”，则为false，其他条件为true。</li>
<li>使用”&#x3D;”和”!&#x3D;”比较变量和字符串是否相等，满足条件则为true，否则为false。</li>
<li>判断文件是否存在：<code>-f</code>和<code>!-f</code></li>
<li>判断目录是否存在: <code>-d</code>和<code>!-d</code></li>
<li>使用正则表达式与变量的值进行匹配。变量与正则表达式之间使用<code>~</code>、<code>~*</code>、<code>!~</code>、<code>!~*</code>，如果正则表达式包含<code>&#125;</code>或<code>;</code>，则整个表达式应该用单引号或双引号括起来。</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~                     正则匹配 (区分大小写)</span><br><span class="line">~*                     正则匹配 (不区分大小写)</span><br><span class="line">!~                  正则不匹配 (区分大小写)</span><br><span class="line">!~*                    正则不匹配  (不区分大小写)</span><br><span class="line">-<span class="attribute">f</span> 和!-f             用来判断是否存在文件</span><br><span class="line">-d 和!-d             用来判断是否存在目录</span><br><span class="line">-e 和!-e             用来判断是否存在文件或目录</span><br><span class="line">-x 和!-x             用来判断文件是否可执行</span><br></pre></td></tr></table></figure>

<p>在匹配过程中可以引用一些<a href="#nginx%E5%8F%98%E9%87%8F">Nginx的全局变量</a></p>
<h3 id="–with-http-map-module"><a href="#–with-http-map-module" class="headerlink" title="–with-http_map_module"></a>–with-http_map_module</h3><h4 id="map指令"><a href="#map指令" class="headerlink" title="map指令"></a>map指令</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$request_uri</span> <span class="variable">$real</span> &#123;</span><br><span class="line">    &quot;~^/(.*)&quot;   /$1;</span><br><span class="line">    <span class="attribute">default</span>     <span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="nginx核心指令"><a href="#nginx核心指令" class="headerlink" title="nginx核心指令"></a>nginx核心指令</h2><h3 id="root-alias指令"><a href="#root-alias指令" class="headerlink" title="root&#x2F;alias指令"></a>root&#x2F;alias指令</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /img/ &#123;</span><br><span class="line">    <span class="attribute">alias</span> /var/www/image/;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#若按照上述配置的话，则访问/img/目录里面的文件时，ningx会自动去/var/www/image/目录找文件</span></span><br><span class="line"><span class="section">location</span> /img/ &#123;</span><br><span class="line">    <span class="attribute">root</span> /var/www/image;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#若按照这种配置的话，则访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件。]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>alias</code> 是一个目录别名的定义，</li>
<li><code>root</code> 则是最上层目录的定义。</li>
</ul>
<p>还有一个重要的区别是alias后面必须要用“&#x2F;”结束，否则会找不到文件的,而root则可有可无 </p>
<h3 id="break指令"><a href="#break指令" class="headerlink" title="break指令"></a>break指令</h3><p>上下文: <code>server, location, if;</code></p>
<p>格式: <code>break;</code></p>
<p>在同一作用域中，中断该指令之后的其他指令，位于其前面的指令配置生效，位于其后面的指令配置则无效。</p>
<h2 id="nginx变量"><a href="#nginx变量" class="headerlink" title="nginx变量"></a>nginx变量</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202312041044051.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202312041045644.png" alt="img">更详细的看下方</p>
<h3 id="TCP连接相关变量"><a href="#TCP连接相关变量" class="headerlink" title="TCP连接相关变量"></a>TCP连接相关变量</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#客户端地址，例如192.168.1.1</span></span><br><span class="line"><span class="attribute">remote_addr</span>     </span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端端口，例如58473</span></span><br><span class="line">remote_port     </span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端地址的整型格式</span></span><br><span class="line">binary_remote_addr   </span><br><span class="line"></span><br><span class="line"><span class="comment">#已处理连接，是一个递增的序号</span></span><br><span class="line">connection     </span><br><span class="line"></span><br><span class="line"><span class="comment">#当前连接上执行的请求数，对于keepalive连接有意义</span></span><br><span class="line">connection_request   </span><br><span class="line"></span><br><span class="line"><span class="comment">#如果使用proxy_protocol协议，则返回原始用户的地址，否则为空</span></span><br><span class="line">proxy_protocol_addr   </span><br><span class="line"></span><br><span class="line"><span class="comment">#如果使用proxy_protocol协议，则返回原始用户的端口，否则为空</span></span><br><span class="line">proxy_protocol_port   </span><br><span class="line"></span><br><span class="line"><span class="comment">#服务器地址，例如192.168.184.240</span></span><br><span class="line">server_addr     </span><br><span class="line"></span><br><span class="line"><span class="comment">#服务器端口,例如80</span></span><br><span class="line">server_port     </span><br><span class="line"></span><br><span class="line"><span class="comment">#服务端协议，例如HTTP/1.1</span></span><br><span class="line">server_protocol  </span><br></pre></td></tr></table></figure>

<h3 id="HTTP请求相关变量"><a href="#HTTP请求相关变量" class="headerlink" title="HTTP请求相关变量"></a>HTTP请求相关变量</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#请求包体头部长度</span></span><br><span class="line"><span class="attribute">conten_length</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">#请求包体类型</span></span><br><span class="line">content_type    </span><br><span class="line"></span><br><span class="line"><span class="comment">#URL中某个参数</span></span><br><span class="line">arg_参数名     </span><br><span class="line"></span><br><span class="line"><span class="comment">#所有URL参数</span></span><br><span class="line">args      </span><br><span class="line"></span><br><span class="line"><span class="comment">#URL中有参数，则返回?；否则返回空</span></span><br><span class="line">is_args      </span><br><span class="line"></span><br><span class="line"><span class="comment">#与args完全相同</span></span><br><span class="line">query_string    </span><br><span class="line"></span><br><span class="line"><span class="comment">#请求的URL，不包含参数</span></span><br><span class="line">uri       </span><br><span class="line"></span><br><span class="line"><span class="comment">#请求的URL，包含参数</span></span><br><span class="line">request_uri     </span><br><span class="line"></span><br><span class="line"><span class="comment">#协议名，http或者https</span></span><br><span class="line">scheme      </span><br><span class="line"></span><br><span class="line"><span class="comment">#请求的方法，GET、HEAD、POST等</span></span><br><span class="line">request_method    </span><br><span class="line"></span><br><span class="line"><span class="comment">#所有请求内容的大小，包含请求行，头部，请求体</span></span><br><span class="line">request_length    </span><br><span class="line"></span><br><span class="line"><span class="comment">#由HTTP Basic Authentication协议传入的用户名</span></span><br><span class="line">remote_user     </span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端请求主体信息的临时文件名</span></span><br><span class="line">request_body_file   </span><br><span class="line"></span><br><span class="line"><span class="comment">#包含请求的主要信息，在使用proxy_pass或fastcgi_pass指令的location中比较有意义</span></span><br><span class="line">request_body </span><br><span class="line"></span><br><span class="line"><span class="comment">#先看请求行，再看请求头，最后找server_name</span></span><br><span class="line">host</span><br><span class="line"></span><br><span class="line"><span class="comment">#用户浏览器标识</span></span><br><span class="line">http_user_agent</span><br><span class="line"></span><br><span class="line"><span class="comment">#从哪些链接过来的请求</span></span><br><span class="line">http_referer</span><br><span class="line"></span><br><span class="line"><span class="comment">#经过一层代表服务器，添加对应代理服务器的信息</span></span><br><span class="line">http_via</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取用户真实IP</span></span><br><span class="line">http_x_forwarded_for</span><br><span class="line"></span><br><span class="line"><span class="comment">#用户cookie</span></span><br><span class="line">http_cookie</span><br></pre></td></tr></table></figure>

<h3 id="Nginx处理请求时相关变量"><a href="#Nginx处理请求时相关变量" class="headerlink" title="Nginx处理请求时相关变量"></a>Nginx处理请求时相关变量</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#请求处理到现在所耗费的时间，单位为秒，例如0.03代表30毫秒</span></span><br><span class="line"><span class="attribute">request_time</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">#请求处理完成，则返回OK，否则为空</span></span><br><span class="line">request_completion   </span><br><span class="line"></span><br><span class="line"><span class="comment">#16进制显示的请求id，随机生成的</span></span><br><span class="line">request_id     </span><br><span class="line"></span><br><span class="line"><span class="comment">#匹配上请求的server_name值</span></span><br><span class="line">server_name     </span><br><span class="line"></span><br><span class="line"><span class="comment">#若开启https，则值为on,否则为空</span></span><br><span class="line">https      </span><br><span class="line"></span><br><span class="line"><span class="comment">#待访问文件的完整路径</span></span><br><span class="line">request_filename   </span><br><span class="line"></span><br><span class="line"><span class="comment">#由URI和root/alias规则生成的文件夹路径</span></span><br><span class="line">document_root    </span><br><span class="line"></span><br><span class="line"><span class="comment">#将document_root中的软链接换成真实路径</span></span><br><span class="line">realpath_root    </span><br><span class="line"></span><br><span class="line"><span class="comment">#返回响应时的速度上限值</span></span><br><span class="line">limit_rate     </span><br></pre></td></tr></table></figure>

<h3 id="Nginx返回响应时相关变量"><a href="#Nginx返回响应时相关变量" class="headerlink" title="Nginx返回响应时相关变量"></a>Nginx返回响应时相关变量</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#响应体中真实内容的大小 </span></span><br><span class="line"><span class="attribute">body_bytes_sent</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">#全部响应体大小</span></span><br><span class="line">body_sent     </span><br><span class="line"></span><br><span class="line"><span class="comment">#HTTP返回状态码</span></span><br><span class="line">status      </span><br></pre></td></tr></table></figure>

<h3 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nginx系统版本</span></span><br><span class="line"><span class="attribute">nginx_version</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务器时间</span></span><br><span class="line">time_local</span><br></pre></td></tr></table></figure>

<h2 id="时间空间单位"><a href="#时间空间单位" class="headerlink" title="时间空间单位"></a>时间空间单位</h2><h3 id="时间单位"><a href="#时间单位" class="headerlink" title="时间单位"></a>时间单位</h3><ul>
<li>ms：毫秒</li>
<li>s：秒</li>
<li>m：分钟</li>
<li>h：小时</li>
<li>d：天</li>
<li>w：周</li>
<li>M：月</li>
<li>y：年</li>
</ul>
<h3 id="空间单位"><a href="#空间单位" class="headerlink" title="空间单位"></a>空间单位</h3><ul>
<li>k&#x2F;K：KB</li>
<li>m&#x2F;M：MB</li>
<li>g&#x2F;G：GB</li>
</ul>
<h1 id="nginx实用场景"><a href="#nginx实用场景" class="headerlink" title="nginx实用场景"></a>nginx实用场景</h1><h2 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment"># 1: 基于多ip的虚拟主机：listen监听不同网卡的ip，端口可相同</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8000</span>;</span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">172.17.1.1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8000</span>;</span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">172.17.1.2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2: 基于多端口的虚拟主机(局域网常用)：listen监听不同端口</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8001</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8002</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#3: 基于域名的虚拟主机(公网最常用)：端口可相同，server_name为不同域名</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8003</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.test1.com;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8003</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.test2.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="静态站点"><a href="#静态站点" class="headerlink" title="静态站点"></a>静态站点</h2><blockquote>
<p>为了加快网站解析速度，可以将动态资源交给后端服务器，纯前端的静态页面放在系统目录下，交给Nginx来解析。</p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202311071751738.png" alt="image-20231107175136906" style="zoom:33%;" />

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">          <span class="attribute">root</span>   /opt/nginx/html;</span><br><span class="line">          <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>[[网络编程#反向代理|了解反向代理]]</p>
<blockquote>
<p>反向代理是用户客户端访问代理服务器后，被反向代理服务器按照一定的规则从一个或多个被代理服务器中获取响应资源并返回给客户端的代理模式，客户端只知道代理服务器的 IP，并不知道后端服务器的 IP，原因是代理服务器隐藏了被代理服务器的信息。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202311071754917.png" alt="image-20231107175434006"></p>
<p>nginx反向代理可以</p>
<ul>
<li>七层反向代理(应用层)</li>
<li>四层反向代理(TCP&#x2F;UDP代理)</li>
</ul>
<h4 id="七层反向代理"><a href="#七层反向代理" class="headerlink" title="七层反向代理"></a>七层反向代理</h4><p>在配置文件nginx.conf中的http段中，写入如下格式的配置，即可将本地8088端口代理到百度：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">8088</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   https://www.baidu.com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用nginx做反向代理以支持cors跨域请求访问</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Lv_Victor/article/details/113417960">相关参考</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HpO683eTzyFYjujR2qv_HQ">超详细解释</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">                <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;  <span class="comment"># 设置DNS解析器</span></span><br><span class="line"><span class="comment"># 拆解请求目标</span></span><br><span class="line">                        <span class="attribute">set</span> <span class="variable">$target</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="attribute">if</span> (<span class="variable">$request_uri</span> <span class="regexp">~ &quot;^/([^/].*)$&quot;)</span> &#123;</span><br><span class="line">                        <span class="attribute">set</span> <span class="variable">$target</span> <span class="variable">$1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment"># 设置代理转发</span></span><br><span class="line">                <span class="attribute">proxy_pass</span> <span class="variable">$target</span>;</span><br><span class="line"><span class="comment"># 设置CORS头信息</span></span><br><span class="line">                <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">                <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class="string">&#x27;GET, POST, OPTIONS&#x27;</span>;</span><br><span class="line">                <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class="string">&#x27;DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range&#x27;</span>;</span><br><span class="line">                <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Expose-Headers&#x27;</span> <span class="string">&#x27;Content-Length,Content-Range&#x27;</span>;</span><br><span class="line"><span class="comment"># 处理OPTIONS请求</span></span><br><span class="line">                <span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">&#x27;OPTIONS&#x27;</span>) &#123;</span><br><span class="line">                            <span class="attribute">return</span> <span class="number">200</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><strong>作用为</strong>: 当访问<code>https://xxx.xxx.xxx.xxx:xxxx/https://www.github.com</code>的时候访问的实际上是<code>https://www.github.com</code>的资源,解决了跨域问题</p>
<h4 id="四层反向代理"><a href="#四层反向代理" class="headerlink" title="四层反向代理"></a>四层反向代理</h4><blockquote>
<p>Nginx除了可以代理HTTP七层流量，还可以代理 TCP&#x2F;UDP 四层流量，需要使用核心模块 <strong>stream</strong>,手动编译的话需要在编译配置时增加<code>--with-stream</code>参数进行编译。</p>
</blockquote>
<p>配置文件如下（需写在<a href="#nginx.conf%E8%AF%A6%E8%A7%A3">main段</a>中）：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">3306</span>;</span><br><span class="line">        <span class="comment"># 访问本机的3306，就被转发到了远程的3306</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> <span class="number">172.17.0.1:3306</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><blockquote>
<p>当出现高并发大流量的业务场景时，单台后端服务器已无法支撑业务正常运行，需要将请求流量按照一定规则分发到多台服务节点上，即使某个节点宕机，系统依然能够对外正常提供服务，以此来提高系统的性能和稳定性。</p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202311071811827.png" alt="image-20231107181143583" style="zoom: 33%;" />

<p> 支持的协议如下:</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202311071826427.png" alt="640" style="zoom:67%;" />

<h3 id="upstream模块"><a href="#upstream模块" class="headerlink" title="upstream模块"></a>upstream模块</h3><p>用于定义上游模块</p>
<p>upstream及其下层指令说明</p>
<table>
<thead>
<tr>
<th align="left">指令</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">upstream</td>
<td align="left">段名，中间定义上游服务url</td>
</tr>
<tr>
<td align="left">server</td>
<td align="left">定义上游服务地址</td>
</tr>
<tr>
<td align="left">zone</td>
<td align="left">定义共享内存，用于跨worker子进程共享数据</td>
</tr>
<tr>
<td align="left">keepalive</td>
<td align="left">对上游服务启用长连接，每个worker子进程与上游服务器<em><strong>空闲长连接</strong></em>的最大数量（keepalive 16；当同时有5000个请求过来，处理完毕后，会保留16个连接，其他全部关闭）</td>
</tr>
<tr>
<td align="left">keepalive_requests</td>
<td align="left">一个长连接可以处理的最多请求个数</td>
</tr>
<tr>
<td align="left">keepalive_timeout</td>
<td align="left">空闲情况下，一个长连接的超时时长，超过后会销毁长连接</td>
</tr>
<tr>
<td align="left">hash</td>
<td align="left">负载均衡算法：哈希</td>
</tr>
<tr>
<td align="left">ip_hash</td>
<td align="left">负载均衡算法：依据ip进行哈希计算</td>
</tr>
<tr>
<td align="left">least_conn</td>
<td align="left">负载均衡算法：最少连接数</td>
</tr>
<tr>
<td align="left">least_time</td>
<td align="left">负载均衡算法：最短响应时间</td>
</tr>
<tr>
<td align="left">random</td>
<td align="left">负载均衡算法：随机</td>
</tr>
</tbody></table>
<p><strong>server模块</strong></p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">weight&#x3D;number</td>
<td align="left">权重值，默认为1</td>
</tr>
<tr>
<td align="left">max_conns&#x3D;number</td>
<td align="left">上游服务器的最大并发连接数</td>
</tr>
<tr>
<td align="left">fail_timeout&#x3D;time</td>
<td align="left">服务器不可用的判定时间（10s内不可用次数达3次，则在这10s内不会再转发给后端，超过10后依然还是会转发过去）</td>
</tr>
<tr>
<td align="left">max_fails&#x3D;number</td>
<td align="left">服务器不可用的检查次数</td>
</tr>
<tr>
<td align="left">backup</td>
<td align="left">备份服务器，仅当其他服务器都不可用时</td>
</tr>
<tr>
<td align="left">down</td>
<td align="left">标记服务器长期不可用，离线维护</td>
</tr>
</tbody></table>
<h3 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h3><h4 id="轮询-默认"><a href="#轮询-默认" class="headerlink" title="轮询(默认)"></a>轮询(默认)</h4><p>每个请求按时间顺序逐一分配到不同的后端服务器</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="comment"># 默认所有服务器权重为 1</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.3:8080</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="加权轮询"><a href="#加权轮询" class="headerlink" title="加权轮询"></a>加权轮询</h5><p>指定轮询概率，用于后端服务器性能不均的情况</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1:8080</span> weight=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2:8080</span> weight=<span class="number">2</span>;</span><br><span class="line">    <span class="comment"># default weight=1</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.3:8080</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="实际案例"><a href="#实际案例" class="headerlink" title="实际案例"></a>实际案例</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server模块,代理几台服务器就需要几个server模块,同时也需要几个代理模块upstream</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;<span class="comment">#客户端访问反向代理服务器,反向代理服务器监听的端口</span></span><br><span class="line">	<span class="attribute">server_name</span> localhost;<span class="comment">#客户端访问反向代理服务器的域名.当需要反向代理多个服务器的时候,需要不同的域名以区分</span></span><br><span class="line">	<span class="section">location</span> / &#123;</span><br><span class="line">		<span class="comment">#反向代理服务器转发指令(指定转发地址,http:// 固定的头,名字自己定,与下面的代理模块需要一一对应)</span></span><br><span class="line">		<span class="attribute">proxy_pass</span> http://robin.test.com;<span class="comment">#proxy_pass与root指令一致,只替代location名中的&#x27;/&#x27;符号</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#添加一个代理模块upstream</span></span><br><span class="line"><span class="section">upstream</span> robin.test.com&#123;<span class="comment">#该网址需要与上面proxy_pass后面接的网址对应</span></span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.247.135:80</span>;<span class="comment">#http://robin.test.com的真实ip地址与端口.此server指令可以有多个以实现负载均衡,不设置权重的情况下为轮询.</span></span><br><span class="line">	<span class="comment">#设置权重的格式:</span></span><br><span class="line">	<span class="comment">#server ip:端口 weight=1;#表示设置访问该ip的权重为1.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于上面<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27937043/article/details/80372599">nginx实现负载均衡的加权轮询算法(WeightedRound-Robin)详解,点击跳转</a></p>
<h4 id="哈希-hash"><a href="#哈希-hash" class="headerlink" title="哈希-hash"></a>哈希-hash</h4><blockquote>
<ul>
<li>哈希算法是将任意长度的二进制值映射为较短的固定长度的二进制值，这个小的二进制值叫哈希值，映射不可逆。</li>
<li><code>hash $request_uri</code>：根据这个变量的哈希值来负载</li>
<li><strong>相同统一资源标识符(Uniform Resource Identifier)的请求将始终被路由到相同的后端服务器</strong></li>
</ul>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.3:8080</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h5><blockquote>
<p>每个请求按访问ip的hash结果分配，这样<strong>每个访客固定访问一个后端服务器</strong>，是session共享问题的解决方案之一</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.3:8080</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="最少连接数算法"><a href="#最少连接数算法" class="headerlink" title="最少连接数算法"></a>最少连接数算法</h4><ul>
<li><blockquote>
<ul>
<li><strong>从上游服务器挑选一台当前已建立连接数最少的分配请求</strong></li>
<li>极端情况下会退化为轮询算法</li>
<li><code>least_conn</code>：<ul>
<li>多个worker子进程同时处理请求时，无法共享后端服务器的连接数状态，此时需要开辟共享内存空间，用来在多个worker子进程中共享信息</li>
<li>zone zone_name 1M，指定开辟共享内存的大小</li>
</ul>
</li>
</ul>
</blockquote>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.3:8080</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对上游服务器返回异常时的处理"><a href="#对上游服务器返回异常时的处理" class="headerlink" title="对上游服务器返回异常时的处理"></a>对上游服务器返回异常时的处理</h4><p>主要有这三个关键词可以设置</p>
<ul>
<li><a href="#proxy_next_upstream">proxy_next_upstream</a></li>
<li><a href="#proxy_next_upstream_timeout">proxy_next_upstream_timeout</a></li>
<li><a href="#proxy_next_upstream_tries">proxy_next_upstream_tries</a></li>
</ul>
<h5 id="proxy-next-upstream"><a href="#proxy-next-upstream" class="headerlink" title="proxy_next_upstream"></a>proxy_next_upstream</h5><p>含义是:<strong>proxy_next_upstream配置的这些情况下执行失败转发</strong>,如果不配置proxy_next_upstream,当遇到上游返回http错误码时,nginx会直接返回给客户端.</p>
<p>语法：  <code>proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504 http_403 http_404 http_429 non_idempotent off;</code></p>
<p>默认值：<code>proxy_next_upstream error timeout</code></p>
<p>上下文：http, server, location</p>
<table>
<thead>
<tr>
<th align="left">可选参数</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">error</td>
<td align="left">向后端服务器传输请求，或读取响应头<strong>「出错」</strong>时（服务器宕机会转发到下一台）</td>
</tr>
<tr>
<td align="left">timeout</td>
<td align="left">向后端服务器传输请求，或读取响应头<strong>「超时」</strong>时（<code>proxy_read_timeout</code>设置的时间内没有接收完响应体，则会转发到下一台服务器；但是服务器宕机的话会返回502，不会转发下一台）</td>
</tr>
<tr>
<td align="left">invalid_header</td>
<td align="left">后端返回无效的响应时</td>
</tr>
<tr>
<td align="left">http_500、502、503、504、403、404、429</td>
<td align="left">http响应状态为xxx时</td>
</tr>
<tr>
<td align="left">non_idempotent</td>
<td align="left">非幂等请求失败时，是否需要转发下一台后端服务器（不设置就是不转发，如post请求时，如果命中404，则会直接返回404。对于写操作最好不要轻易设置）</td>
</tr>
<tr>
<td align="left">off</td>
<td align="left">禁用请求失败转发功能</td>
</tr>
</tbody></table>
<p><strong>案例</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span> text/plain;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> upstream_test&#123;</span><br><span class="line">            <span class="attribute">server</span> <span class="number">127.0.0.1:8001</span>;</span><br><span class="line">            <span class="attribute">server</span> <span class="number">127.0.0.1:8002</span>;</span><br><span class="line">            <span class="attribute">server</span> <span class="number">127.0.0.1:8003</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">8080</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> /test &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://upstream_test/test;</span><br><span class="line">	    <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> timeout invalid_header http_500 http_502 http_503 http_504 http_403 http_404 http_429; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">8001</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">return</span> <span class="number">404</span> <span class="string">&quot;html_8001&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">8002</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;html_8002&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">8003</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">return</span> <span class="number">500</span> <span class="string">&quot;html_8003&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的案例中:如果访问<code>localhost:8080/test</code>,会因为负载均衡访问上游服务器<code>localhost:8001</code>,<code>localhost:8002</code>,<code>localhost:8003</code>其中一个,但是由于设置了<code>proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504 http_403 http_404 http_429;</code> 即设置的上述情况不会走负载均衡的转发,因此访问<code>localhost:8080/test</code>始终会在多次转发下最终访问的是<code>localhost:8002</code></p>
<h5 id="proxy-next-upstream-timeout"><a href="#proxy-next-upstream-timeout" class="headerlink" title="proxy_next_upstream_timeout"></a>proxy_next_upstream_timeout</h5><p>含义:<strong>超过该时间不再尝试失败转发</strong></p>
<p>语法：  <code>proxy_next_upstream_timeout time</code></p>
<p>默认值：<code>proxy_next_upstream_timeout 0</code> </p>
<blockquote>
<p>含义为:如果nginx在向上游服务器发送请求时，如果连接超时时间超过了0，nginx将不会尝试将请求转发到下一个上游服务器，而是<strong>立即返回一个失败响应</strong>（通常是502 Bad Gateway）给客户端</p>
</blockquote>
<p>上下文：http, server, location</p>
<h5 id="proxy-next-upstream-tries"><a href="#proxy-next-upstream-tries" class="headerlink" title="proxy_next_upstream_tries"></a>proxy_next_upstream_tries</h5><p>含义:设置最大尝试<strong>转发次数</strong>,超过转发次数依旧失败则错误码直接返回给客户端</p>
<p>语法：  <code>proxy_next_upstream_tries number</code></p>
<p>默认值：<code>proxy_next_upstream_tries  0</code> (一直转发)</p>
<p>上下文：http, server, location</p>
<h5 id="异常处理样例"><a href="#异常处理样例" class="headerlink" title="异常处理样例"></a>异常处理样例</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">zone</span> upstream_backend <span class="number">64k</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span> weight=<span class="number">2</span> max_conns=<span class="number">1000</span> fail_timeout=<span class="number">10s</span> max_fails=<span class="number">5</span>;</span><br><span class="line">    <span class="attribute">server</span> test.nginx.com weight=<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">keepalive</span> <span class="number">16</span>;</span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">100</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">30s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="section">location</span> /test &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend/test;</span><br><span class="line">        <span class="comment"># 如果不配置proxy_next_upstream，当遇到上游返回http错误状态码时，nginx会直接返回给客户端</span></span><br><span class="line">        <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> timeout invalid_header http_500 http_502 http_503 http_504 http_403 http_404 http_429; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HTTPS加密传输"><a href="#HTTPS加密传输" class="headerlink" title="HTTPS加密传输"></a>HTTPS加密传输</h2><blockquote>
<p>HTTPS 通过加密通道保护客户端与服务端之间的数据传输，已成为当前网站部署的必选配置。在部署有 Nginx 代理集群的 HTTPS 站点，通常会把 SSL 证书部署在 Nginx 的服务器上，然后把请求代理到后端的上游服务器。这种部署方式由 Nginx 服务器负责 SSL 请求的运算，相对减轻了后端上游服务器的 CPU 运算量。</p>
</blockquote>
<h3 id="生成自签名HTTPS证书"><a href="#生成自签名HTTPS证书" class="headerlink" title="生成自签名HTTPS证书"></a>生成自签名HTTPS证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置https签名证书</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">1、创建https证书存放目录：</span></span><br><span class="line">  cd /usr/local/nginx/conf/</span><br><span class="line">  mkdir ssl</span><br><span class="line">  cd ssl</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">2、创建私钥：</span></span><br><span class="line">  openssl genrsa -des3 -out https.key 2048</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">这样创建私钥可以直接带上密码</span></span><br><span class="line">  openssl genrsa -des3 -passout pass:your_password -out https.key 2048</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">3、创建签名请求证书：</span></span><br><span class="line">  openssl req -new -key https.key -out https.csr</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">您即将被要求输入一些信息，这些信息将被包含在您的证书请求中。这些信息通常用于标识和识别您的身份。这些信息被称为Distinguished Name（简称DN），它包含了一些字段。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在输入DN时，您可以留下某些字段为空白，如果您不想提供相关信息。对于某些字段，系统可能会有默认值，如果您想使用默认值，可以直接按下回车键。如果您想保持某个字段为空白，可以输入句点（.）。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">根据您的需求和证书颁发机构的要求，您可以根据提示逐个输入相关信息，例如国家/地区、组织名称、单位名称、常用名等。请确保提供准确的信息，因为这些信息将在您的证书中显示并用于识别您的身份。</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">4、在加载SSL支持的Nginx并使用上述私钥时除去必须的口令：</span></span><br><span class="line">  cp https.key https.key.org</span><br><span class="line">  openssl rsa -in https.key.org -out https.key</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">5、最后标记证书使用上述私钥和CSR和有效期：</span></span><br><span class="line">  openssl x509 -req -days 365 -in https.csr -signkey https.key -out https.crt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这种自签名的SSL证书只能提供数据加密的功能，无法提供身份验证。这意味着，虽然数据传输是加密的，但用户无法确认他们正在与预期的服务器进行通信，而不是与中间人攻击者进行通信。此外，自签名证书在用户的浏览器中通常会显示<strong>警告</strong>，这可能会影响用户对网站的信任度。</p>
<p>而购买SSL证书，尤其是从知名的证书颁发机构购买，可以提供更全面的保护。这些证书不仅提供数据加密，还经过了严格的身份验证过程，可以证明网站的身份是真实的。此外，这些证书会被用户的浏览器所信任，不会显示任何警告。</p>
<p>总的来说，如果你的网站需要处理敏感信息，如用户登录凭据、信用卡信息等，那么购买SSL证书是非常必要的。如果你的网站只是提供一些公开的、非敏感的信息，那么使用自签名的SSL证书或许就足够了。但无论如何，使用SSL证书（无论是购买的还是自签名的）总比完全不使用SSL证书要安全得多</p>
</blockquote>
<h3 id="nginx-conf配置"><a href="#nginx-conf配置" class="headerlink" title="nginx.conf配置"></a>nginx.conf配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 证书部分</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span>     /usr/local/nginx/conf/ssl/https.crt; <span class="comment">#RSA证书</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>  /usr/local/nginx/conf/ssl/https.key; <span class="comment">#RSA密钥</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># TLS 握手优化</span></span><br><span class="line">    <span class="comment"># 会话缓存的存储大小为1MB</span></span><br><span class="line">    <span class="attribute">ssl_session_cache</span>    shared:SSL:<span class="number">1m</span>;</span><br><span class="line">    <span class="comment"># 会话缓存的超时时间为5分钟</span></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span>  <span class="number">5m</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>    <span class="number">75s</span>;</span><br><span class="line">    <span class="attribute">keepalive_requests</span>   <span class="number">100</span>;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span>   html;</span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nginx如果未开启SSL模块,配置https后<code>nginx -t</code>会提示错误:<code>[emerg] the &quot;ssl&quot; parameter requires ngx_http_ssl_module in /usr/local/nginx</code></p>
<p><code>apt</code> 默认安装的 Nginx 包通常不包含 <code>--with-http_ssl_module</code> 选项,即不包含ssl模块。可用下面命令查看配置的模块</p>
<p>nginx -V:</p>
<p><code>--with-openssl=/root/openssl/openssl --with-pcre=../pcre2-10.42 --with-zlib=../zlib-1.2.13</code></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/guo_qiangqiang/article/details/95622649">报该错误的解决方案</a></p>
<h2 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h2><p>要归档一些数据或资料，那么文件服务器必不可少。使用 Nginx 可以非常快速便捷的搭建一个<strong>简易的文件服务</strong>。</p>
<h3 id="nginx-conf配置-1"><a href="#nginx-conf配置-1" class="headerlink" title="nginx.conf配置"></a>nginx.conf配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8004</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 正常显示中文，windows服务器下中文目录无法下钻，目前无解</span></span><br><span class="line">    <span class="attribute">charset</span> gbk,utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打开autoindex功能，以/结尾的请求:可以将root指向的目录作为一个列表来显示到页面上</span></span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 显示文件的大小，</span></span><br><span class="line">    <span class="comment"># on：以字节显示</span></span><br><span class="line">    <span class="comment"># off：人性化显示，文件过大会显示为mb或gb</span></span><br><span class="line">    <span class="attribute">autoindex_exact_size</span> <span class="literal">off</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 以哪种格式返回：html | xml | json | jsonp</span></span><br><span class="line">    <span class="comment"># 默认值：autoindex_format html</span></span><br><span class="line">    <span class="attribute">autoindex_format</span> html;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 显示时间格式</span></span><br><span class="line">    <span class="comment"># on: 12-Jul-2019 10:11（当前时区）</span></span><br><span class="line">    <span class="comment"># off: 12-Jul-2019 02:11(0时区，GMT)</span></span><br><span class="line">    <span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /data/files/;</span><br><span class="line">        <span class="comment"># 如果a.html文件存在，则会返回a.html内容，否则才会返回目录内容</span></span><br><span class="line">        <span class="attribute">index</span> a.html;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意点</strong></p>
<p>按照上述配置配置好后,访问网址会出现403错误,查看error.log会发现是权限不足问题,使用<code>ps aux | grep nginx</code>会发现 master进程是root权限,而worker进程是<code>nobody</code>权限</p>
<blockquote>
<p><code>nobody</code>是nginx工作进程的运行用户。Nginx通常会使用非特权用户运行工作进程，以增加安全性。”nobody”是一个常见的非特权用户，用于执行网络服务进程。它通常具有较低的权限，只能访问必要的系统资源，以减少潜在的安全风险。因此，作为文件服务器不具备权限访问文件资源,因此会返回403错误.</p>
</blockquote>
<p>nginx.conf中添加<code>user root wheel；</code>可以解决问题,此后,worker进程也将会获得root权限.</p>
<blockquote>
<p>在<code>user root wheel；</code>中,wheel是通过<code>id root</code>指令查看root的用户组为wheel</p>
</blockquote>
<p>虽然这种方法可以解决权限不足问题,但有安全隐患,最好还是用别的用户    [[linux基础以及系统编程#用户权限,用户和用户组相关命令|查看linux权限相关命令]]</p>
<h2 id="限速"><a href="#限速" class="headerlink" title="限速"></a>限速</h2><p><strong>limit_rate</strong></p>
<blockquote>
<p>定义响应数据的传输速度，bytes&#x2F;s</p>
<p>本指令属于ngx_http_core_module，不属于ngx_http_limit_conn_module</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /rate &#123;</span><br><span class="line"> <span class="comment"># 定义响应数据的传输速度，默认bytes/s</span></span><br><span class="line">    <span class="attribute">limit_rate</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这些是Nginx处理请求时相关变量，加大返回数据量更好地看到限速效果</span></span><br><span class="line"> <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;request_time  <span class="variable">$request_time</span></span></span><br><span class="line"><span class="string">request_id   <span class="variable">$request_id</span></span></span><br><span class="line"><span class="string">server_name   <span class="variable">$server_name</span></span></span><br><span class="line"><span class="string">request_filename <span class="variable">$request_filename</span></span></span><br><span class="line"><span class="string">document_root  <span class="variable">$document_root</span></span></span><br><span class="line"><span class="string">realpath_root  <span class="variable">$realpath_root</span></span></span><br><span class="line"><span class="string">request_completion <span class="variable">$request_completion</span></span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h2><ul>
<li><a href="#limit_conn">limit_conn</a>     限制客户端并发连接数<ul>
<li><a href="#limit_conn_zone">limit_conn_zone</a></li>
<li><a href="#limit_conn_status">limit_conn_status</a></li>
</ul>
</li>
<li><a href="#limit_req">limit_req</a>       限制客户端处理请求的平均速率<ul>
<li><a href="#limit_req_zone">limit_req_zone</a></li>
<li><a href="#limit_req_status">limit_req_status</a></li>
</ul>
</li>
</ul>
<h3 id="limit-conn"><a href="#limit-conn" class="headerlink" title="limit_conn"></a>limit_conn</h3><ul>
<li>用于<strong>限制客户端的并发连接数</strong></li>
<li>使用共享内存，对所有的worker子进程生效（需要保存客户端连接数）</li>
</ul>
<p><strong>[格式] <code>limit_conn zone number</code></strong></p>
<ul>
<li><code>zone</code>：用limit_conn_zone中定义的zone名称</li>
<li><code>number</code>：以zone为标识的客户端被允许的同时最大连接数</li>
</ul>
<p>上下文:http,server,location</p>
<p><strong>案例</strong>: <code>limit_conn limit_addr 1</code></p>
<h4 id="limit-conn-zone"><a href="#limit-conn-zone" class="headerlink" title="limit_conn_zone"></a>limit_conn_zone</h4><p><strong>[格式] <code>limit_conn_zone key zone=name:size</code></strong></p>
<p>上下文：http</p>
<ul>
<li><code>key</code>：用于定义客户端的唯一标识来限速，如<ul>
<li><code>$binary_remote_addr</code> 使用4个字节空间，高效</li>
<li><code>$remote_addr</code> 使用7-15个字节空间</li>
</ul>
</li>
<li><code>name</code>：给zone取的任意名称</li>
<li><code>size</code>：共享内存大小空间，m为单位</li>
</ul>
<p><strong>案例</strong>:<code>limit_conn_zone $binary_remote_addr zone=limit_addr:10m;</code></p>
<h4 id="limit-conn-status"><a href="#limit-conn-status" class="headerlink" title="limit_conn_status"></a>limit_conn_status</h4><p><strong>[格式] <code>limit_conn_status 触发限速后返回的状态码</code></strong></p>
<p>上下文:http,server,location</p>
<p><strong>案例</strong>: limit_conn_status 503</p>
<h3 id="limit-req"><a href="#limit-req" class="headerlink" title="limit_req"></a>limit_req</h3><ul>
<li>用于限制客户端处理请求的<strong>「平均速率」</strong></li>
<li>使用共享内存，对所有的worker子进程生效</li>
<li>限流算法：<strong>「leaky_bucket」</strong>（漏桶）<ul>
<li>暂时拦截住上方水的向下流动，等待桶中的一部分水漏走后，再放行上方水。</li>
<li>溢出的上方水直接抛弃。</li>
</ul>
</li>
</ul>
<p><strong>[格式] <code>limit_req zone=name [burst=number] [nodelay | delay=number];</code></strong></p>
<p>上下文：http, server, location</p>
<ul>
<li><code>burst</code>：桶大小,设置一个大小为x的缓冲区,当有大量请求（爆发）过来时，超过了访问频次限制的请求可以先放到这个缓冲区内等待，但是这个等待区里的位置只有5个，超过的请求会直接报<code>limit_req_status设置的状态码</code>的错误然后返回。</li>
<li><code>nodelay</code>：如果设置，会在瞬时提供处理(burst + rate)个请求的能力，请求超过（burst + rate）的时候就会直接返回<code>limit_req_status设置的状态码</code>，永远不存在请求需要等待的情况。(rate指limit_req_zone设置)</li>
<li><code>name</code>：给zone取的任意名称</li>
</ul>
<p><strong>案例</strong>:<code>limit_req zone=limit_req burst=7 nodelay;</code></p>
<p><strong>案例</strong>:<code>limit_req zone=limit_req;</code></p>
<h4 id="limit-req-zone"><a href="#limit-req-zone" class="headerlink" title="limit_req_zone"></a>limit_req_zone</h4><p><strong>[格式] <code>limit_req_zone key zone=name:size rate=rate;</code></strong></p>
<p>上下文：http</p>
<ul>
<li><code>key</code>：用于定义客户端的唯一标识来限速，如remote_addr<ul>
<li><code>$binary_remote_addr</code> 使用4个字节空间，高效</li>
<li><code>$remote_addr</code> 使用7-15个字节空间</li>
</ul>
</li>
<li><code>name</code>：给zone取的任意名称</li>
<li><code>size</code>：共享内存大小空间，m为单位</li>
<li><code>rate</code>:表示允许<strong>相同标识的客户端的访问频次</strong>，12r&#x2F;m的，即限制每5秒访问一次，每5秒才处理一个请求。</li>
</ul>
<p><strong>案例</strong>:<code>limit_req_zone  $binary_remote_addr zone=limit_req:15m rate=12r/m;</code></p>
<h4 id="limit-req-status"><a href="#limit-req-status" class="headerlink" title="limit_req_status"></a>limit_req_status</h4><p><strong>[格式] <code>limit_req_status code（http的状态码,默认值：503）</code></strong> </p>
<p>上下文：http, server, location</p>
<p><strong>案例</strong>: <code>limit_req_status 504;</code></p>
<h2 id="限流案例"><a href="#限流案例" class="headerlink" title="限流案例"></a>限流案例</h2><p>结合limit_conn和limit_req的案例</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/json;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># [格式] limit_conn_zone key zone=name:size</span></span><br><span class="line">    <span class="comment"># key：用于定义客户端的唯一标识来限速，如remote_addr</span></span><br><span class="line">    <span class="comment"># name：给空间取的任意名称</span></span><br><span class="line">    <span class="comment"># size：共享内存大小空间，m为单位</span></span><br><span class="line">    <span class="comment"># binary_remote_addr 使用4个字节空间，高效;remote_addr 使用7-15个字节空间</span></span><br><span class="line">    <span class="attribute">limit_conn_zone</span> <span class="variable">$binary_remote_addr</span> zone=limit_addr:<span class="number">10m</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># [格式] limit_req_zone key zone=name:size rate=rate;</span></span><br><span class="line">    <span class="comment"># 上下文：http</span></span><br><span class="line">    <span class="comment"># rate:表示允许相同标识的客户端的访问频次，12r/m的，即限制每5秒访问一次，每5秒才处理一个请求。</span></span><br><span class="line">    <span class="attribute">limit_req_zone</span>  <span class="variable">$binary_remote_addr</span> zone=limit_req:<span class="number">15m</span> rate=12r/m;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">           <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 触发限速后，返回状态码,默认503</span></span><br><span class="line">            <span class="comment"># 上下文：http, server, location</span></span><br><span class="line">            <span class="attribute">limit_conn_status</span> <span class="number">503</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 当触发限速后，错误日志出记录一条日志， 这里用于定义日志等级</span></span><br><span class="line">            <span class="comment"># info|notice|warn|error</span></span><br><span class="line">            <span class="comment"># 上下文：http, server, location</span></span><br><span class="line">            <span class="comment"># 默认值：error</span></span><br><span class="line">            <span class="attribute">limit_conn_log_level</span> <span class="literal">warn</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># limit_conn zone number;</span></span><br><span class="line">            <span class="comment"># zone：用limit_conn_zone中定义的zone名称</span></span><br><span class="line">            <span class="comment"># number：以zone为标识的客户端被允许的同时最大连接数</span></span><br><span class="line">            <span class="attribute">limit_conn</span> limit_addr <span class="number">2</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 定义响应数据的传输速度，bytes/s</span></span><br><span class="line">            <span class="comment"># 本指令属于ngx_http_core_module，不属于ngx_http_limit_conn_module</span></span><br><span class="line">            <span class="attribute">limit_rate</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># limit_req_status code（http的状态码） </span></span><br><span class="line">            <span class="comment"># 默认值：503</span></span><br><span class="line">            <span class="comment"># 上下文：http, server, location</span></span><br><span class="line">            <span class="attribute">limit_req_status</span> <span class="number">504</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 触发限速后，日志记录的等级 </span></span><br><span class="line">            <span class="comment"># info|notice|warn|error</span></span><br><span class="line">            <span class="comment"># 默认值：error</span></span><br><span class="line">            <span class="comment"># 上下文：http, server, location</span></span><br><span class="line">            <span class="attribute">limit_req_log_level</span> <span class="literal">notice</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># limit_req zone=name [burst=number] [nodelay | delay=number];</span></span><br><span class="line">            <span class="comment"># burst：桶大小,设置一个大小为x的缓冲区,当有大量请求（爆发）过来时，超过了访问频次限制的请求可以先放到这个缓冲区内等待，但是这个等待区里的位置只有5个，超过的请求会直接报503的错误然后返回。</span></span><br><span class="line">            <span class="comment"># nodelay：如果设置，会在瞬时提供处理(burst + rate)个请求的能力，请求超过（burst + rate）的时候就会直接返回503，永远不存在请求需要等待的情况。</span></span><br><span class="line">            <span class="comment"># 上下文：http, server, location</span></span><br><span class="line">            <span class="comment"># limit_req zone=limit_req burst=7 nodelay;</span></span><br><span class="line">            <span class="attribute">limit_req</span> zone=limit_req;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="黑白名单"><a href="#黑白名单" class="headerlink" title="黑白名单"></a>黑白名单</h2><p>限制特定IP或网段访问</p>
<ul>
<li>allow</li>
<li>deny</li>
</ul>
<p>规则是从上到下的,<strong>规则顺序</strong>很重要</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># allow address | CIDR | UNIX | all</span></span><br><span class="line">        <span class="comment"># 默认值</span></span><br><span class="line">        <span class="comment"># 上下文：http, server, location, limit_except</span></span><br><span class="line">        <span class="attribute">allow</span> <span class="number">192.168.0.1</span>/<span class="number">24</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># deny address | CIDR | UNIX | all</span></span><br><span class="line">        <span class="comment"># 默认值</span></span><br><span class="line">        <span class="comment"># 上下文：http, server, location, limit_except</span></span><br><span class="line">        <span class="attribute">deny</span> all;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>规则示例</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment"># 规则从上到下</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 拒绝</span></span><br><span class="line">    <span class="attribute">deny</span>   <span class="number">192.168.1.1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 放行192.168.1.0网段，子网掩码24位（255.255.255.0），但是除了192.168.1.1</span></span><br><span class="line">    <span class="attribute">allow</span>  <span class="number">192.168.1.0</span>/<span class="number">24</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 放行10.1.1.0网段，子网掩码16位（255.255.0.0）</span></span><br><span class="line">    <span class="attribute">allow</span>  <span class="number">10.1.1.0</span>/<span class="number">16</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 放行ipv6</span></span><br><span class="line">    <span class="attribute">allow</span>  <span class="number">2001</span>:0db8::/<span class="number">32</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 除了上面放行的，其他全部拒绝</span></span><br><span class="line">    <span class="attribute">deny</span>   all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="请求拦截"><a href="#请求拦截" class="headerlink" title="请求拦截"></a>请求拦截</h2><p>关键词: <strong><code>auth_request</code></strong></p>
<p>基于子请求收到的HTTP响应码做访问控制</p>
<p>如：拦截所有请求，先去做鉴权请求，通过后再放行(典型的应用就是鉴权)</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /private &#123;</span><br><span class="line">    <span class="comment"># 默认值：off</span></span><br><span class="line">    <span class="comment"># 上下文：http, server, location;</span></span><br><span class="line">    <span class="comment"># 鉴权成功对会返回后面实际内容，鉴权失败会返回鉴权服务的返回内容</span></span><br><span class="line">    <span class="attribute">auth_request</span> /auth;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /auth &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8080/auth;</span><br><span class="line">    <span class="attribute">proxy_pass_request_body</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Content-Length <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Original-URI <span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">location</span> <span class="string">~^/.*\.(png|jpg|gif|jfif) &#123;</span></span><br><span class="line">    <span class="attr">valid_referers</span> <span class="string">www.example.com;</span></span><br><span class="line">    <span class="attr">if</span> <span class="string">($invalid_referer)&#123;</span></span><br><span class="line">        <span class="attr">rewrite</span> <span class="string">^/ http://192.168.110.98/images/forbidden.png;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">root</span>   <span class="string">html;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果出现盗链的情况，将会出现类似于如下效果：<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/che77a38/blogImage2//202312041125985.png" alt="img" style="zoom: 25%;" /></p>
<h1 id="nginx配置问题"><a href="#nginx配置问题" class="headerlink" title="nginx配置问题"></a>nginx配置问题</h1><p>nginx配置过程中遇到的一些<strong>问题记录</strong></p>
<h2 id="nginx配置端口问题"><a href="#nginx配置端口问题" class="headerlink" title="nginx配置端口问题"></a>nginx配置端口问题</h2><p><strong>Mac&#x2F;linux系统的限制</strong>：Mac系统默认只允许1024以下的端口号被系统服务使用，如果要使用1024以下的端口号，需要root权限或者修改系统配置,即通过<a href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AEmain%E6%AE%B5%E8%AF%A6%E8%A7%A3">user指令配置</a>设置为root权限</p>
<p>但似乎阿里云服务器可以部署到8000以内的端口.不明所以</p>
<h2 id="直接return文本"><a href="#直接return文本" class="headerlink" title="直接return文本"></a>直接return文本</h2><p>使用<code>default_type</code>指令将默认的<code>Content-Type</code>设置为<code>text/plain</code>，以确保返回的内容被浏览器识别为纯文本。然后，我们使用<code>return</code>指令返回带有<code>target_host</code>和<code>target_uri</code>的文本响应。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /test &#123;</span><br><span class="line">    <span class="attribute">default_type</span> text/plain;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="nginx插件"><a href="#nginx插件" class="headerlink" title="nginx插件"></a>nginx插件</h1><h2 id="fastdfs插件"><a href="#fastdfs插件" class="headerlink" title="fastdfs插件"></a>fastdfs插件</h2><p>[[网络编程#FastDFS|fastdfs插件详解跳转]]</p>
<p>[[网络编程#fastDFS配合fastCGI项目|nginx配合fastcgi使用跳转]]</p>
<h2 id="nginx-http-flv-module"><a href="#nginx-http-flv-module" class="headerlink" title="nginx-http-flv-module"></a>nginx-http-flv-module</h2><p>nginx-rtmp-module实现了RTMP协议</p>
<p>nginx-http-flv-module： 在nginx-rtmp-module的基础上，实现了HTTPFLV，并覆盖nginx-rtmp-module的所有功能</p>
<p><a target="_blank" rel="noopener" href="https://github.com/winshining/nginx-http-flv-module/">插件源码</a></p>
<h2 id="nginx-javascript"><a href="#nginx-javascript" class="headerlink" title="nginx javascript"></a>nginx javascript</h2><p>使nginx支持js语法</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4" title="头像" alt="头像"></a><div class="post-copyright__author_name">ZEROKO14</div><div class="post-copyright__author_desc">zeroko14's blog</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://che77a38.github.io/posts/nginx/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://che77a38.github.io/posts/nginx/')">nginx</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://che77a38.github.io/posts/nginx/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=nginx&amp;url=https://che77a38.github.io/posts/nginx/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://che77a38.github.io" target="_blank">ZEROKO14的个人博客</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>网络<span class="tagsPageCount">3</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/QT/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">QT入门</div></div></a></div><div class="next-post pull-right"><a href="/posts/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">进程与线程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" title="网络架构"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-11-18</div><div class="title">网络架构</div></div></a></div><div><a href="/posts/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" title="网络编程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">网络编程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://avatars.githubusercontent.com/u/27732581?s=400&amp;u=303b2c0e2118ad20406f8d718e885bcf99fc8bf8&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description">欢迎来到ZEROKO14的个人博客</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">ZEROKO14</h1><div class="author-info__desc">zeroko14's blog</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/che77a38" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">基本介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">优点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">Nginx安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E5%90%84%E7%A7%8D%E9%BB%98%E8%AE%A4%E8%B7%AF%E5%BE%84"><span class="toc-number">2.1.</span> <span class="toc-text">nginx各种默认路径</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">2.1.1.</span> <span class="toc-text">Linux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mac"><span class="toc-number">2.1.2.</span> <span class="toc-text">Mac</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">Nginx基本命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">nginx配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-conf%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.1.</span> <span class="toc-text">nginx.conf详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AEmain%E6%AE%B5%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.1.1.</span> <span class="toc-text">全局配置main段详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#events%E6%AE%B5"><span class="toc-number">4.1.2.</span> <span class="toc-text">events段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http%E6%AE%B5"><span class="toc-number">4.1.3.</span> <span class="toc-text">http段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#server%E6%AE%B5"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">server段</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#server-name%E7%9A%84%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="toc-number">4.1.3.1.1.</span> <span class="toc-text">server_name的匹配规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#location%E6%AE%B5"><span class="toc-number">4.1.3.1.2.</span> <span class="toc-text">location段</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%A8%A1%E5%9D%97"><span class="toc-number">4.1.3.1.2.1.</span> <span class="toc-text">监控模块</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx%E8%AF%AD%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">nginx语法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E6%A8%A1%E5%9D%97%E8%AF%AD%E6%B3%95%E6%8C%87%E4%BB%A4"><span class="toc-number">5.1.</span> <span class="toc-text">nginx模块语法指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%93with-http-rewrite-module"><span class="toc-number">5.1.1.</span> <span class="toc-text">–with-http_rewrite_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rewrite-return%E6%8C%87%E4%BB%A4"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">rewrite&#x2F;return指令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rewrite"><span class="toc-number">5.1.1.1.1.</span> <span class="toc-text">rewrite</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#return"><span class="toc-number">5.1.1.1.2.</span> <span class="toc-text">return</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">5.1.1.1.2.1.</span> <span class="toc-text">使用案例</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set%E6%8C%87%E4%BB%A4"><span class="toc-number">5.1.1.1.3.</span> <span class="toc-text">set指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#if%E6%8C%87%E4%BB%A4"><span class="toc-number">5.1.1.1.4.</span> <span class="toc-text">if指令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%93with-http-map-module"><span class="toc-number">5.1.2.</span> <span class="toc-text">–with-http_map_module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#map%E6%8C%87%E4%BB%A4"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">map指令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E6%A0%B8%E5%BF%83%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.</span> <span class="toc-text">nginx核心指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#root-alias%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.1.</span> <span class="toc-text">root&#x2F;alias指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#break%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.2.</span> <span class="toc-text">break指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E5%8F%98%E9%87%8F"><span class="toc-number">5.3.</span> <span class="toc-text">nginx变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP%E8%BF%9E%E6%8E%A5%E7%9B%B8%E5%85%B3%E5%8F%98%E9%87%8F"><span class="toc-number">5.3.1.</span> <span class="toc-text">TCP连接相关变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP%E8%AF%B7%E6%B1%82%E7%9B%B8%E5%85%B3%E5%8F%98%E9%87%8F"><span class="toc-number">5.3.2.</span> <span class="toc-text">HTTP请求相关变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E6%97%B6%E7%9B%B8%E5%85%B3%E5%8F%98%E9%87%8F"><span class="toc-number">5.3.3.</span> <span class="toc-text">Nginx处理请求时相关变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94%E6%97%B6%E7%9B%B8%E5%85%B3%E5%8F%98%E9%87%8F"><span class="toc-number">5.3.4.</span> <span class="toc-text">Nginx返回响应时相关变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="toc-number">5.3.5.</span> <span class="toc-text">系统变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%A9%BA%E9%97%B4%E5%8D%95%E4%BD%8D"><span class="toc-number">5.4.</span> <span class="toc-text">时间空间单位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%8D%95%E4%BD%8D"><span class="toc-number">5.4.1.</span> <span class="toc-text">时间单位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E9%97%B4%E5%8D%95%E4%BD%8D"><span class="toc-number">5.4.2.</span> <span class="toc-text">空间单位</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx%E5%AE%9E%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">6.</span> <span class="toc-text">nginx实用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">6.1.</span> <span class="toc-text">虚拟主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E7%AB%99%E7%82%B9"><span class="toc-number">6.2.</span> <span class="toc-text">静态站点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">6.2.1.</span> <span class="toc-text">反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%83%E5%B1%82%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">七层反向代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">6.2.1.2.</span> <span class="toc-text">四层反向代理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">6.3.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#upstream%E6%A8%A1%E5%9D%97"><span class="toc-number">6.3.1.</span> <span class="toc-text">upstream模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">6.3.2.</span> <span class="toc-text">负载均衡算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AE%E8%AF%A2-%E9%BB%98%E8%AE%A4"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">轮询(默认)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E6%9D%83%E8%BD%AE%E8%AF%A2"><span class="toc-number">6.3.2.1.1.</span> <span class="toc-text">加权轮询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E6%A1%88%E4%BE%8B"><span class="toc-number">6.3.2.1.2.</span> <span class="toc-text">实际案例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C-hash"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">哈希-hash</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ip-hash"><span class="toc-number">6.3.2.2.1.</span> <span class="toc-text">ip_hash</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%B0%91%E8%BF%9E%E6%8E%A5%E6%95%B0%E7%AE%97%E6%B3%95"><span class="toc-number">6.3.2.3.</span> <span class="toc-text">最少连接数算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%B8%8A%E6%B8%B8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%94%E5%9B%9E%E5%BC%82%E5%B8%B8%E6%97%B6%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">6.3.2.4.</span> <span class="toc-text">对上游服务器返回异常时的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#proxy-next-upstream"><span class="toc-number">6.3.2.4.1.</span> <span class="toc-text">proxy_next_upstream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#proxy-next-upstream-timeout"><span class="toc-number">6.3.2.4.2.</span> <span class="toc-text">proxy_next_upstream_timeout</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#proxy-next-upstream-tries"><span class="toc-number">6.3.2.4.3.</span> <span class="toc-text">proxy_next_upstream_tries</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%A0%B7%E4%BE%8B"><span class="toc-number">6.3.2.4.4.</span> <span class="toc-text">异常处理样例</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTPS%E5%8A%A0%E5%AF%86%E4%BC%A0%E8%BE%93"><span class="toc-number">6.4.</span> <span class="toc-text">HTTPS加密传输</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%87%AA%E7%AD%BE%E5%90%8DHTTPS%E8%AF%81%E4%B9%A6"><span class="toc-number">6.4.1.</span> <span class="toc-text">生成自签名HTTPS证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-conf%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.2.</span> <span class="toc-text">nginx.conf配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.5.</span> <span class="toc-text">文件服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-conf%E9%85%8D%E7%BD%AE-1"><span class="toc-number">6.5.1.</span> <span class="toc-text">nginx.conf配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E9%80%9F"><span class="toc-number">6.6.</span> <span class="toc-text">限速</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E6%B5%81"><span class="toc-number">6.7.</span> <span class="toc-text">限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#limit-conn"><span class="toc-number">6.7.1.</span> <span class="toc-text">limit_conn</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#limit-conn-zone"><span class="toc-number">6.7.1.1.</span> <span class="toc-text">limit_conn_zone</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#limit-conn-status"><span class="toc-number">6.7.1.2.</span> <span class="toc-text">limit_conn_status</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limit-req"><span class="toc-number">6.7.2.</span> <span class="toc-text">limit_req</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#limit-req-zone"><span class="toc-number">6.7.2.1.</span> <span class="toc-text">limit_req_zone</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#limit-req-status"><span class="toc-number">6.7.2.2.</span> <span class="toc-text">limit_req_status</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E6%B5%81%E6%A1%88%E4%BE%8B"><span class="toc-number">6.8.</span> <span class="toc-text">限流案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-number">6.9.</span> <span class="toc-text">黑白名单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA"><span class="toc-number">6.10.</span> <span class="toc-text">请求拦截</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">6.11.</span> <span class="toc-text">防盗链</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98"><span class="toc-number">7.</span> <span class="toc-text">nginx配置问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E9%97%AE%E9%A2%98"><span class="toc-number">7.1.</span> <span class="toc-text">nginx配置端口问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5return%E6%96%87%E6%9C%AC"><span class="toc-number">7.2.</span> <span class="toc-text">直接return文本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx%E6%8F%92%E4%BB%B6"><span class="toc-number">8.</span> <span class="toc-text">nginx插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fastdfs%E6%8F%92%E4%BB%B6"><span class="toc-number">8.1.</span> <span class="toc-text">fastdfs插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-http-flv-module"><span class="toc-number">8.2.</span> <span class="toc-text">nginx-http-flv-module</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-javascript"><span class="toc-number">8.3.</span> <span class="toc-text">nginx javascript</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/%E5%B7%A5%E4%B8%9A%E7%9B%B8%E5%85%B3/" title="工业相关">工业相关</a><time datetime="2025-02-14T03:04:40.761Z" title="发表于 2025-02-14 11:04:40">2025-02-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/%E8%AE%A1%E7%BB%84/" title="计算机组成原理">计算机组成原理</a><time datetime="2024-12-16T01:38:01.470Z" title="发表于 2024-12-16 09:38:01">2024-12-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" title="网络架构">网络架构</a><time datetime="2024-11-18T06:17:01.282Z" title="发表于 2024-11-18 14:17:01">2024-11-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/avalonia/" title="avalonia">avalonia</a><time datetime="2024-09-11T14:51:13.000Z" title="发表于 2024-09-11 22:51:13">2024-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/%E8%A7%86%E9%A2%91%E6%95%88%E6%9E%9C/" title="PR">PR</a><time datetime="2024-07-18T07:06:08.330Z" title="发表于 2024-07-18 15:06:08">2024-07-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="ZEROKO14" target="_blank">ZEROKO14</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu"></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">60</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">50</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">6</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 0.88rem;">C#<sup>2</sup></a><a href="/tags/C/" style="font-size: 0.88rem;">C++<sup>5</sup></a><a href="/tags/CSS/" style="font-size: 0.88rem;">CSS<sup>1</sup></a><a href="/tags/CSharp/" style="font-size: 0.88rem;">CSharp<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">C语言<sup>1</sup></a><a href="/tags/FPS/" style="font-size: 0.88rem;">FPS<sup>1</sup></a><a href="/tags/HTML/" style="font-size: 0.88rem;">HTML<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size: 0.88rem;">JavaScript<sup>1</sup></a><a href="/tags/MFC/" style="font-size: 0.88rem;">MFC<sup>1</sup></a><a href="/tags/PE/" style="font-size: 0.88rem;">PE<sup>1</sup></a><a href="/tags/QT/" style="font-size: 0.88rem;">QT<sup>1</sup></a><a href="/tags/WPF/" style="font-size: 0.88rem;">WPF<sup>2</sup></a><a href="/tags/ai/" style="font-size: 0.88rem;">ai<sup>1</sup></a><a href="/tags/cmake/" style="font-size: 0.88rem;">cmake<sup>1</sup></a><a href="/tags/doxygen/" style="font-size: 0.88rem;">doxygen<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>1</sup></a><a href="/tags/json/" style="font-size: 0.88rem;">json<sup>1</sup></a><a href="/tags/linux/" style="font-size: 0.88rem;">linux<sup>1</sup></a><a href="/tags/nas/" style="font-size: 0.88rem;">nas<sup>1</sup></a><a href="/tags/next/" style="font-size: 0.88rem;">next<sup>1</sup></a><a href="/tags/ppt/" style="font-size: 0.88rem;">ppt<sup>1</sup></a><a href="/tags/slidev/" style="font-size: 0.88rem;">slidev<sup>1</sup></a><a href="/tags/vue/" style="font-size: 0.88rem;">vue<sup>1</sup></a><a href="/tags/xml/" style="font-size: 0.88rem;">xml<sup>1</sup></a><a href="/tags/yaml/" style="font-size: 0.88rem;">yaml<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 0.88rem;">代码规范<sup>1</sup></a><a href="/tags/%E5%86%85%E6%A0%B8/" style="font-size: 0.88rem;">内核<sup>2</sup></a><a href="/tags/%E5%86%85%E6%A0%B8%E7%9B%B8%E5%85%B3/" style="font-size: 0.88rem;">内核相关<sup>5</sup></a><a href="/tags/%E5%8A%A0%E8%A7%A3%E5%AF%86/" style="font-size: 0.88rem;">加解密<sup>1</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">基础<sup>2</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">多线程<sup>1</sup></a><a href="/tags/%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem;">并发模式<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">开发<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 0.88rem;">数学<sup>1</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 0.88rem;">正则表达式<sup>1</sup></a><a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 0.88rem;">监控<sup>1</sup></a><a href="/tags/%E7%A1%AC%E7%BC%96%E7%A0%81/" style="font-size: 0.88rem;">硬编码<sup>1</sup></a><a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">管理<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>3</sup></a><a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 0.88rem;">逆向<sup>2</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>