<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zeroko14.gitee.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="API函数的调用过程Application Programming Interface,简称API函数。">
<meta property="og:type" content="article">
<meta property="og:title" content="系统调用">
<meta property="og:url" content="http://zeroko14.gitee.io/4f5d4e8d/index.html">
<meta property="og:site_name" content="ZEROKO14的个人博客">
<meta property="og:description" content="API函数的调用过程Application Programming Interface,简称API函数。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210902143222155.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210902143202632.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831143046585.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831155837942.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831145044898.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210902143436444.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20211028194257701.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191749044.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191949142.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831151847441.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831152107988.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191911557.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20211106145549920.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20211107153842092.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831192744340.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831205053088.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20211107202221078.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210904123123962.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210904123102688.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210904123203383.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210904121940924.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210905142808963.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210906134948152.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210906135151739.png">
<meta property="article:published_time" content="2023-11-24T02:49:02.212Z">
<meta property="article:modified_time" content="2023-11-24T02:49:02.212Z">
<meta property="article:author" content="ZEROKO14">
<meta property="article:tag" content="内核相关">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210902143222155.png">

<link rel="canonical" href="http://zeroko14.gitee.io/4f5d4e8d/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>系统调用 | ZEROKO14的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ZEROKO14的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">zeroko14's blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zeroko14.gitee.io/4f5d4e8d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="ZEROKO14">
      <meta itemprop="description" content="你好，欢迎来到ZEROKO14的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZEROKO14的个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          系统调用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-11-24 10:49:02" itemprop="dateCreated datePublished" datetime="2023-11-24T10:49:02+08:00">2023-11-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="API函数的调用过程"><a href="#API函数的调用过程" class="headerlink" title="API函数的调用过程"></a>API函数的调用过程</h1><p>Application Programming Interface,简称API函数。</p>
<span id="more"></span>

<p>Windows有多少个API：主要是存放在C:&#x2F;WINDOWS&#x2F;system32下的所有dll</p>
<p>几个重要的DLL</p>
<ul>
<li><strong>Kernel32.dll</strong>：最核心的功能模块，比如管理内存，进程，线程相关的函数等。</li>
<li><strong>User32.dll</strong>：是Windows用户界面相关应用程序接口，如创建窗口和发送消息等。</li>
<li><strong>GDI32.dll</strong>：全称是Graphical Device Interface(图形设备接口)，包含用于画图和显示文本的函数。比如要显示一个程序窗口，就调用其中的函数来画这个窗口</li>
<li><strong>Ntdll.dll</strong>：大多数API都会通过这个DLL进入内核（0环）</li>
</ul>
<h2 id="3环部分"><a href="#3环部分" class="headerlink" title="3环部分"></a>3环部分</h2><h3 id="分析ReadProcessMemory"><a href="#分析ReadProcessMemory" class="headerlink" title="分析ReadProcessMemory"></a><strong>分析ReadProcessMemory</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">7</span>C8021D0 ; Exported entry <span class="number">682.</span> ReadProcessMemory</span><br><span class="line">.text:<span class="number">7</span>C8021D0</span><br><span class="line">.text:<span class="number">7</span>C8021D0 ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:<span class="number">7</span>C8021D0</span><br><span class="line">.text:<span class="number">7</span>C8021D0 ; Attributes: bp-based frame</span><br><span class="line">.text:<span class="number">7</span>C8021D0</span><br><span class="line">.text:<span class="number">7</span>C8021D0 ; BOOL __stdcall <span class="title function_">ReadProcessMemory</span><span class="params">(HANDLE hProcess, LPCVOID lpBaseAddress, LPVOID lpBuffer, SIZE_T nSize, SIZE_T *lpNumberOfBytesRead)</span></span><br><span class="line">.text:7C8021D0                 public _ReadProcessMemory@20</span><br><span class="line">.text:7C8021D0 _ReadProcessMemory@20 proc near         ; CODE XREF: GetProcessVersion(x)+<span class="number">2F</span>12F↓p</span><br><span class="line">.text:<span class="number">7</span>C8021D0                                         ; GetProcessVersion(x)+<span class="number">2F</span>14E↓p ...</span><br><span class="line">.text:<span class="number">7</span>C8021D0</span><br><span class="line">.text:<span class="number">7</span>C8021D0 hProcess        = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">7</span>C8021D0 lpBaseAddress   = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">7</span>C8021D0 lpBuffer        = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">7</span>C8021D0 nSize           = dword ptr  <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">7</span>C8021D0 lpNumberOfBytesRead= dword ptr  <span class="number">18</span>h</span><br><span class="line">.text:<span class="number">7</span>C8021D0</span><br><span class="line">.text:<span class="number">7</span>C8021D0                 mov     edi, edi</span><br><span class="line">.text:<span class="number">7</span>C8021D2                 push    ebp</span><br><span class="line">.text:<span class="number">7</span>C8021D3                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">7</span>C8021D5                 lea     eax, [ebp+nSize]</span><br><span class="line">.text:<span class="number">7</span>C8021D8                 push    eax             ; NumberOfBytesRead</span><br><span class="line">.text:<span class="number">7</span>C8021D9                 push    [ebp+nSize]     ; NumberOfBytesToRead</span><br><span class="line">.text:<span class="number">7</span>C8021DC                 push    [ebp+lpBuffer]  ; Buffer</span><br><span class="line">.text:<span class="number">7</span>C8021DF                 push    [ebp+lpBaseAddress] ; BaseAddress</span><br><span class="line">.text:<span class="number">7</span>C8021E2                 push    [ebp+hProcess]  ; ProcessHandle</span><br><span class="line">.text:<span class="number">7</span>C8021E5                 call    ds:__imp__NtReadVirtualMemory@<span class="number">20</span> ; NtReadVirtualMemory(x,x,x,x,x)<span class="comment">//跳到ntdll.dll中的NtReadVirtualMemory函数</span></span><br><span class="line">.text:<span class="number">7</span>C8021EB                 mov     ecx, [ebp+lpNumberOfBytesRead]</span><br><span class="line">.text:<span class="number">7</span>C8021EE                 test    ecx, ecx</span><br><span class="line">.text:<span class="number">7</span>C8021F0                 jnz     <span class="type">short</span> loc_7C8021FD</span><br><span class="line">.text:<span class="number">7</span>C8021F2</span><br><span class="line">.text:<span class="number">7</span>C8021F2 loc_7C8021F2:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+<span class="number">32</span>↓j</span><br><span class="line">.text:<span class="number">7</span>C8021F2                 test    eax, eax</span><br><span class="line">.text:<span class="number">7</span>C8021F4                 jl      <span class="type">short</span> loc_7C802204</span><br><span class="line">.text:<span class="number">7</span>C8021F6                 xor     eax, eax</span><br><span class="line">.text:<span class="number">7</span>C8021F8                 inc     eax</span><br><span class="line">.text:<span class="number">7</span>C8021F9</span><br><span class="line">.text:<span class="number">7</span>C8021F9 loc_7C8021F9:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+<span class="number">3</span>C↓j</span><br><span class="line">.text:<span class="number">7</span>C8021F9                 pop     ebp</span><br><span class="line">.text:<span class="number">7</span>C8021FA                 retn    <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">7</span>C8021FD ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">7</span>C8021FD</span><br><span class="line">.text:<span class="number">7</span>C8021FD loc_7C8021FD:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+<span class="number">20</span>↑j</span><br><span class="line">.text:<span class="number">7</span>C8021FD                 mov     edx, [ebp+nSize]</span><br><span class="line">.text:<span class="number">7</span>C802200                 mov     [ecx], edx</span><br><span class="line">.text:<span class="number">7</span>C802202                 jmp     <span class="type">short</span> loc_7C8021F2</span><br><span class="line">.text:<span class="number">7</span>C802204 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">7</span>C802204</span><br><span class="line">.text:<span class="number">7</span>C802204 loc_7C802204:                           ; CODE XREF: ReadProcessMemory(x,x,x,x,x)+<span class="number">24</span>↑j</span><br><span class="line">.text:<span class="number">7</span>C802204                 push    eax             ; Status</span><br><span class="line">.text:<span class="number">7</span>C802205                 call    _BaseSetLastNTError@<span class="number">4</span> ; BaseSetLastNTError(x)</span><br><span class="line">.text:<span class="number">7</span>C80220A                 xor     eax, eax</span><br><span class="line">.text:<span class="number">7</span>C80220C                 jmp     <span class="type">short</span> loc_7C8021F9</span><br><span class="line">.text:<span class="number">7</span>C80220C _ReadProcessMemory@<span class="number">20</span> endp</span><br><span class="line"><span class="comment">//通篇流程基本上就是调用了NtReadVirtualMemory函数</span></span><br></pre></td></tr></table></figure>

<p>ReadProcessMemory-&gt;NtReadVirtualMemory</p>
<p>ntdll.dll中的NtReadVirtualMemory函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">7</span>C92D9E0 ; __stdcall <span class="title function_">NtReadVirtualMemory</span><span class="params">(x, x, x, x, x)</span></span><br><span class="line">.text:7C92D9E0                 public _NtReadVirtualMemory@20</span><br><span class="line">.text:7C92D9E0 _NtReadVirtualMemory@20 proc near       ; CODE XREF: LdrFindCreateProcessManifest(x,x,x,x,x)+<span class="number">1</span>CC↓p</span><br><span class="line">.text:<span class="number">7</span>C92D9E0                                         ; LdrCreateOutOfProcessImage(x,x,x,x)+<span class="number">7</span>C↓p ...</span><br><span class="line">.text:<span class="number">7</span>C92D9E0                 mov     eax, <span class="number">0B</span>Ah       ; NtReadVirtualMemory<span class="comment">//操作系统内核函数的编号</span></span><br><span class="line">.text:<span class="number">7</span>C92D9E5                 mov     edx, <span class="number">7F</span>FE0300h<span class="comment">//存放函数地址的地址，这个值决定了我们用什么方式进入零环</span></span><br><span class="line">.text:<span class="number">7</span>C92D9EA                 call    dword ptr [edx]</span><br><span class="line">.text:<span class="number">7</span>C92D9EC                 retn    <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">7</span>C92D9EC _NtReadVirtualMemory@<span class="number">20</span> endp</span><br></pre></td></tr></table></figure>

<p>NtReadVirtualMemory就是提供一个编号，找到一个函数，通过这个函数进零环。</p>
<p><strong>7FFE0300h这个地址存放着系统调用进零环的函数地址</strong></p>
<h4 id="课后练习："><a href="#课后练习：" class="headerlink" title="课后练习："></a>课后练习：</h4><p>自己编写WriteProcessMemory函数(不使用任何DLL，直接调用0环函数)，并在代码中使用。</p>
<p>重写API的意义：自己实现API，可避免三环恶意挂钩</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __stdcall <span class="title function_">myWriteProcessMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">  HANDLE  hProcess,</span></span><br><span class="line"><span class="params">  LPVOID  lpBaseAddress,</span></span><br><span class="line"><span class="params">  LPCVOID lpBuffer,</span></span><br><span class="line"><span class="params">  SIZE_T  nSize,</span></span><br><span class="line"><span class="params">  SIZE_T  *lpNumberOfBytesWritten</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		push lpNumberOfBytesWritten;</span><br><span class="line">		push nSize;</span><br><span class="line">		push lpBuffer;</span><br><span class="line">		push lpBaseAddress;</span><br><span class="line">		push hProcess;</span><br><span class="line">		mov eax,<span class="number">0x115</span>;<span class="comment">//写内存对应的系统服务号</span></span><br><span class="line">		lea edx,dword ptr [esp];</span><br><span class="line">		<span class="type">int</span> <span class="number">0x2E</span>;</span><br><span class="line">		add esp,<span class="number">0x14</span>;<span class="comment">//平栈</span></span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> a=<span class="number">300</span>;</span><br><span class="line">	SIZE_T haveRead;</span><br><span class="line">	HANDLE hProcess=OpenProcess(PROCESS_ALL_ACCESS,<span class="literal">NULL</span>,<span class="number">1520</span>);</span><br><span class="line">	myWriteProcessMemory(hProcess,(LPVOID)<span class="number">0x12ff7c</span>,&amp;a,<span class="number">4</span>,&amp;haveRead);</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目标修改进程：<img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210902143222155.png" alt="image-20210902143222155"></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210902143202632.png" alt="image-20210902143202632"></p>
<h2 id="3环进0环"><a href="#3环进0环" class="headerlink" title="3环进0环"></a>3环进0环</h2><h3 id="KUSER-SHARED-DATA结构"><a href="#KUSER-SHARED-DATA结构" class="headerlink" title="_KUSER_SHARED_DATA结构"></a>_KUSER_SHARED_DATA结构</h3><ol>
<li>在User层和Kernel层分别定义了一个_KUSER_SHARED_DATA结构区域，用于User层和Kernel层<strong>共享</strong>某些数据。</li>
<li>它们使用固定的地址值映射，_KUSER_SHARED_DATA结构区域在User和Kernel层地址分别为：<ul>
<li>​	<strong>User层地址为：0x7FFE0000</strong></li>
<li>​	<strong>Kernel层地址为：0xFFDF0000</strong></li>
</ul>
</li>
</ol>
<p>0x7FFE0000和0xFFDF0000指向的是同一个物理页，但<strong>User层只读，Kernel可写</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_KUSER_SHARED_DATA</span><br><span class="line">   +<span class="number">0x000</span> TickCountLow     : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> TickCountMultiplier : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> InterruptTime    : _KSYSTEM_TIME</span><br><span class="line">   +<span class="number">0x014</span> SystemTime       : _KSYSTEM_TIME</span><br><span class="line">   +<span class="number">0x020</span> TimeZoneBias     : _KSYSTEM_TIME</span><br><span class="line">   +<span class="number">0x02c</span> ImageNumberLow   : Uint2B</span><br><span class="line">   +<span class="number">0x02e</span> ImageNumberHigh  : Uint2B</span><br><span class="line">   +<span class="number">0x030</span> NtSystemRoot     : [<span class="number">260</span>] Uint2B</span><br><span class="line">   +<span class="number">0x238</span> MaxStackTraceDepth : Uint4B</span><br><span class="line">   +<span class="number">0x23c</span> CryptoExponent   : Uint4B</span><br><span class="line">   +<span class="number">0x240</span> TimeZoneId       : Uint4B</span><br><span class="line">   +<span class="number">0x244</span> Reserved2        : [<span class="number">8</span>] Uint4B</span><br><span class="line">   +<span class="number">0x264</span> NtProductType    : _NT_PRODUCT_TYPE</span><br><span class="line">   +<span class="number">0x268</span> ProductTypeIsValid : UChar</span><br><span class="line">   +<span class="number">0x26c</span> NtMajorVersion   : Uint4B<span class="comment">//NT内核的主版本号</span></span><br><span class="line">   +<span class="number">0x270</span> NtMinorVersion   : Uint4B<span class="comment">//NT内核的次版本号</span></span><br><span class="line">   +<span class="number">0x274</span> ProcessorFeatures : [<span class="number">64</span>] UChar</span><br><span class="line">   +<span class="number">0x2b4</span> Reserved1        : Uint4B</span><br><span class="line">   +<span class="number">0x2b8</span> Reserved3        : Uint4B</span><br><span class="line">   +<span class="number">0x2bc</span> TimeSlip         : Uint4B</span><br><span class="line">   +<span class="number">0x2c0</span> AlternativeArchitecture : _ALTERNATIVE_ARCHITECTURE_TYPE</span><br><span class="line">   +<span class="number">0x2c8</span> SystemExpirationDate : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x2d0</span> SuiteMask        : Uint4B</span><br><span class="line">   +<span class="number">0x2d4</span> KdDebuggerEnabled : UChar</span><br><span class="line">   +<span class="number">0x2d5</span> NXSupportPolicy  : UChar</span><br><span class="line">   +<span class="number">0x2d8</span> ActiveConsoleId  : Uint4B</span><br><span class="line">   +<span class="number">0x2dc</span> DismountCount    : Uint4B</span><br><span class="line">   +<span class="number">0x2e0</span> ComPlusPackage   : Uint4B</span><br><span class="line">   +<span class="number">0x2e4</span> LastSystemRITEventTickCount : Uint4B</span><br><span class="line">   +<span class="number">0x2e8</span> NumberOfPhysicalPages : Uint4B</span><br><span class="line">   +<span class="number">0x2ec</span> SafeBootMode     : UChar</span><br><span class="line">   +<span class="number">0x2f0</span> TraceLogging     : Uint4B</span><br><span class="line">   +<span class="number">0x2f8</span> TestRetInstruction : Uint8B</span><br><span class="line">   +<span class="number">0x300</span> SystemCall       : Uint4B<span class="comment">//系统调用的方式，存放KiFastSystemCall或KiIntSystemCall地址</span></span><br><span class="line">   +<span class="number">0x304</span> SystemCallReturn : Uint4B<span class="comment">//快速调用的返回地址</span></span><br><span class="line">   +<span class="number">0x308</span> SystemCallPad    : [<span class="number">3</span>] Uint8B</span><br><span class="line">   +<span class="number">0x320</span> TickCount        : _KSYSTEM_TIME</span><br><span class="line">   +<span class="number">0x320</span> TickCountQuad    : Uint8B</span><br><span class="line">   +<span class="number">0x330</span> Cookie           : Uint4B</span><br><span class="line">       </span><br><span class="line"><span class="comment">//实例</span></span><br><span class="line">ntdll!_KUSER_SHARED_DATA</span><br><span class="line">   +<span class="number">0x000</span> TickCountLow     : <span class="number">0xb752</span></span><br><span class="line">   +<span class="number">0x004</span> TickCountMultiplier : <span class="number">0xfa00000</span></span><br><span class="line">   +<span class="number">0x008</span> InterruptTime    : _KSYSTEM_TIME</span><br><span class="line">   +<span class="number">0x014</span> SystemTime       : _KSYSTEM_TIME</span><br><span class="line">   +<span class="number">0x020</span> TimeZoneBias     : _KSYSTEM_TIME</span><br><span class="line">   +<span class="number">0x02c</span> ImageNumberLow   : <span class="number">0x14c</span></span><br><span class="line">   +<span class="number">0x02e</span> ImageNumberHigh  : <span class="number">0x14c</span></span><br><span class="line">   +<span class="number">0x030</span> NtSystemRoot     : [<span class="number">260</span>] <span class="number">0x43</span></span><br><span class="line">   +<span class="number">0x238</span> MaxStackTraceDepth : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x23c</span> CryptoExponent   : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x240</span> TimeZoneId       : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x244</span> Reserved2        : [<span class="number">8</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x264</span> NtProductType    : <span class="number">1</span> ( NtProductWinNt )</span><br><span class="line">   +<span class="number">0x268</span> ProductTypeIsValid : <span class="number">0x1</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x26c NtMajorVersion   : 5//NT内核的主版本号</span></span><br><span class="line"><span class="string">   +0x270 NtMinorVersion   : 1//NT内核的次版本号</span></span><br><span class="line"><span class="string">   +0x274 ProcessorFeatures : [64]  &quot;&quot;</span></span><br><span class="line"><span class="string">   +0x2b4 Reserved1        : 0x7ffeffff</span></span><br><span class="line"><span class="string">   +0x2b8 Reserved3        : 0x80000000</span></span><br><span class="line"><span class="string">   +0x2bc TimeSlip         : 0</span></span><br><span class="line"><span class="string">   +0x2c0 AlternativeArchitecture : 0 ( StandardDesign )</span></span><br><span class="line"><span class="string">   +0x2c8 SystemExpirationDate : _LARGE_INTEGER 0x0</span></span><br><span class="line"><span class="string">   +0x2d0 SuiteMask        : 0x110</span></span><br><span class="line"><span class="string">   +0x2d4 KdDebuggerEnabled : 0x3 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x2d5</span> NXSupportPolicy  : <span class="number">0x2</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x2d8 ActiveConsoleId  : 0</span></span><br><span class="line"><span class="string">   +0x2dc DismountCount    : 0</span></span><br><span class="line"><span class="string">   +0x2e0 ComPlusPackage   : 0xffffffff</span></span><br><span class="line"><span class="string">   +0x2e4 LastSystemRITEventTickCount : 0xadbe8</span></span><br><span class="line"><span class="string">   +0x2e8 NumberOfPhysicalPages : 0x1ff6a</span></span><br><span class="line"><span class="string">   +0x2ec SafeBootMode     : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x2f0</span> TraceLogging     : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x2f8</span> TestRetInstruction : <span class="number">0xc3</span></span><br><span class="line">   +<span class="number">0x300</span> SystemCall       : <span class="number">0x7c92e4f0</span><span class="comment">//系统调用的方式，存放</span></span><br><span class="line">   +<span class="number">0x304</span> SystemCallReturn : <span class="number">0x7c92e4f4</span><span class="comment">//快速调用的返回地址</span></span><br><span class="line">   +<span class="number">0x308</span> SystemCallPad    : [<span class="number">3</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x320</span> TickCount        : _KSYSTEM_TIME</span><br><span class="line">   +<span class="number">0x320</span> TickCountQuad    : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x330</span> Cookie           : <span class="number">0xbde19661</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>0x7FFE0300存储的到底是什么？</p>
<p>两种情况：是否支持快速调用</p>
<p>当通过<strong>eax&#x3D;1来执行cpuid指令时</strong>，处理器的特征信息被放在ecx和edx寄存器中，其中edx包含了一个<strong>SEP位(0开始第11位)<strong>，该位指明了</strong>当前处理器是否支持systenter&#x2F;sysexit指令</strong></p>
<ul>
<li>1&#x3D;&#x3D;支持——&gt;ntdll.dll!KiFastSystemCall()</li>
<li>0&#x3D;&#x3D;不支持—&gt;ntdll.dll!KiIntSystemCall()</li>
</ul>
<p>0x7FFE0300存储的就是上诉两个函数地址之一</p>
<blockquote>
<p><strong>3环进0环需要更改哪些寄存器</strong></p>
<ol>
<li>CS的权限由3变为0，意味着需要新的<strong>CS</strong></li>
<li>SS与CS的权限永远一致，因此需要新的<strong>SS</strong></li>
<li>权限发生切换的时候，堆栈也一定会切换，需要新的<strong>ESP</strong></li>
<li>进0环后代码的位置，因此需要<strong>EIP</strong></li>
</ol>
</blockquote>
<p>p.s. windbg进入指定进程空间命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.process <span class="number">0</span>xXXXXXXXX(!process <span class="number">0</span> <span class="number">0</span>遍历出来的每个PROCESS的第一个数值)</span><br></pre></td></tr></table></figure>

<h3 id="KiFastSystemCall与KiIntSystemCall的区别"><a href="#KiFastSystemCall与KiIntSystemCall的区别" class="headerlink" title="KiFastSystemCall与KiIntSystemCall的区别"></a>KiFastSystemCall与KiIntSystemCall的区别</h3><h4 id="KiIntSystemCall"><a href="#KiIntSystemCall" class="headerlink" title="KiIntSystemCall"></a>KiIntSystemCall</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//KiIntSystemCall</span></span><br><span class="line">.text:<span class="number">7</span>C92E500 ; _DWORD __stdcall <span class="title function_">KiIntSystemCall</span><span class="params">()</span></span><br><span class="line">.text:7C92E500                 public _KiIntSystemCall@0</span><br><span class="line">.text:7C92E500 _KiIntSystemCall@0 proc near            ; DATA XREF: .text:off_7C923428↑o</span><br><span class="line">.text:<span class="number">7</span>C92E500</span><br><span class="line">.text:<span class="number">7</span>C92E500 arg_4           = byte ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">7</span>C92E500							<span class="comment">//eax是内核函数的编号，系统调用号</span></span><br><span class="line">.text:<span class="number">7</span>C92E500                 lea     edx, [esp+arg_4]<span class="comment">//edx说明参数在哪里</span></span><br><span class="line">.text:<span class="number">7</span>C92E504                 <span class="type">int</span>     <span class="number">2</span>Eh             ; DOS <span class="number">2</span>+ internal - EXECUTE COMMAND<span class="comment">//中断门进内核</span></span><br><span class="line">.text:<span class="number">7</span>C92E504                                         ; DS:SI -&gt; counted CR-terminated command <span class="built_in">string</span></span><br><span class="line">.text:<span class="number">7</span>C92E506                 retn</span><br><span class="line">.text:<span class="number">7</span>C92E506 _KiIntSystemCall@<span class="number">0</span> endp</span><br></pre></td></tr></table></figure>

<p><strong>分析INT 0x2E进0环</strong></p>
<ol>
<li><p>在IDT表中找到0x2E</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831143046585.png" alt="image-20210831143046585"></p>
</li>
<li><p>分析CS&#x2F;SS&#x2F;ESP&#x2F;EIP</p>
<p>ee表明是个中断门描述符，CS是0x0008，EIP为0x8053E481</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831155837942.png" alt="image-20210831155837942"></p>
</li>
<li><p>分析EIP是什么</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//只取开头部分</span></span><br><span class="line">kd&gt; u <span class="number">8053e481</span></span><br><span class="line">nt!KiSystemService:</span><br><span class="line"><span class="number">8053e481</span> <span class="number">6</span>a00            push    <span class="number">0</span></span><br><span class="line"><span class="number">8053e483</span> <span class="number">55</span>              push    ebp</span><br><span class="line"><span class="number">8053e484</span> <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">8053e485</span> <span class="number">56</span>              push    esi</span><br><span class="line"><span class="number">8053e486</span> <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">8053e487</span> <span class="number">0f</span>a0            push    fs</span><br><span class="line"><span class="number">8053e489</span> bb30000000      mov     ebx,<span class="number">30</span>h</span><br><span class="line"><span class="number">8053e48</span>e <span class="number">668</span>ee3          mov     fs,bx</span><br></pre></td></tr></table></figure></li>
</ol>
<p>此时KiSystemService函数才真正是内核函数</p>
<hr>
<h4 id="KiFastSystemCall"><a href="#KiFastSystemCall" class="headerlink" title="KiFastSystemCall"></a>KiFastSystemCall</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//KiFastSystemCall</span></span><br><span class="line">.text:<span class="number">7</span>C92E4F0 ; _DWORD __stdcall <span class="title function_">KiFastSystemCall</span><span class="params">()</span></span><br><span class="line">.text:7C92E4F0                 public _KiFastSystemCall@0</span><br><span class="line">.text:7C92E4F0 _KiFastSystemCall@0 proc near           ; DATA XREF: .text:off_7C923428↑o</span><br><span class="line">.text:<span class="number">7</span>C92E4F0                 mov     edx, esp<span class="comment">//3环栈顶esp放到edx中 //系统调用号在eax寄存器</span></span><br><span class="line">.text:<span class="number">7</span>C92E4F2                 sysenter<span class="comment">//快速调用进内核</span></span><br><span class="line">.text:<span class="number">7</span>C92E4F2 _KiFastSystemCall@<span class="number">0</span> endp</span><br><span class="line">.text:<span class="number">7</span>C92E4F2</span><br><span class="line">.text:<span class="number">7</span>C92E4F4 ; Exported entry  <span class="number">42.</span> KiFastSystemCallRet</span><br><span class="line">.text:<span class="number">7</span>C92E4F4</span><br><span class="line">.text:<span class="number">7</span>C92E4F4 ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:<span class="number">7</span>C92E4F4</span><br><span class="line">.text:<span class="number">7</span>C92E4F4</span><br><span class="line">.text:<span class="number">7</span>C92E4F4 ; _DWORD __stdcall <span class="title function_">KiFastSystemCallRet</span><span class="params">()</span></span><br><span class="line">.text:7C92E4F4                 public _KiFastSystemCallRet@0</span><br><span class="line">.text:7C92E4F4 _KiFastSystemCallRet@0 proc near        ; DATA XREF: .text:off_7C923428↑o</span><br><span class="line">.text:<span class="number">7</span>C92E4F4                 retn</span><br><span class="line">.text:<span class="number">7</span>C92E4F4 _KiFastSystemCallRet@<span class="number">0</span> endp</span><br></pre></td></tr></table></figure>

<p><strong>什么叫快速调用？</strong></p>
<ul>
<li>中断门进0环，需要的CS，EIP在IDT表中，需要查内存(SS与ESP由TSS提供)</li>
<li>而CPU如果支持sysenter指令时，操作系统会提前将CS&#x2F;SS&#x2F;ESP&#x2F;EIP的值存储在<strong>MSR寄存器</strong>中，sysenter指令执行时，CPU会将MSR寄存器中的值直接写入相关寄存器，没有读内存的过程，所以叫快速调用，但本质都是切换CS,SS,ESP,EIP。</li>
</ul>
<p><strong>分析sysenter进0环</strong></p>
<p>在<strong>执行sysenter指令之前，操作系统必须指定0环的CS段，SS段，EIP以及ESP</strong>。sysenter是由CPU设计规定并操作的</p>
<table>
<thead>
<tr>
<th>MSR</th>
<th>地址</th>
</tr>
</thead>
<tbody><tr>
<td>IA32_SYSENTER_CS</td>
<td>174H</td>
</tr>
<tr>
<td>IA32_SYSENTER_ESP</td>
<td>175H</td>
</tr>
<tr>
<td>IA32_SYSENTER_EIP</td>
<td>176H</td>
</tr>
</tbody></table>
<p><strong>SS</strong>是通过【IA32_SYSENTER_CS+8】的段选择子来计算出来的。即CS是0x08指向的段，SS就是gdt中0x08指向的段描述符的下一个段描述符。</p>
<p>vt，MSR结构非常重要。</p>
<p>intel文档上说该指令是为了快速的系统调用（从ring3 到ring0），在执行sysenter之前了，必须要设置好ring0中的代码段、入口函数地址、ring0栈所在的段、栈指针，设置方式是写下列MSRs：</p>
<ul>
<li>IA32_SYSENTER_CS:32bit，前16个字节为代码段选择符，其确定的索引+1为栈段的索引，所以在全局描述符表中这两个必须相连。</li>
<li>IA32_SYSENTER_EIP:32bit，入口指令地址。</li>
<li>IA32_SYSENTER_ESP:32bit，内核栈地址。</li>
</ul>
<p><strong>可以通过RDMSR&#x2F;WRMST来进行读写(操作系统使用WRMST写该寄存器)：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831145044898.png" alt="image-20210831145044898"></p>
<p>参考：Intel白皮书第二卷（搜索sysenter）</p>
<p>当执行<strong>SYSENTER</strong>，处理器会做下面的动作：</p>
<ol>
<li><p>从IA32_SYSENTER_CS从取出段选择子加载到CS中。</p>
</li>
<li><p>从IA32_SYSENTER_EIP取出指令指针放到EIP中</p>
</li>
<li><p>将IA32_SYSENTER_CS的值加上8，将其结果加载到SS中。</p>
</li>
<li><p>从IA32_SYSENTER_ESP取出堆栈指针放到ESP寄存器中</p>
</li>
</ol>
<p>上述步骤相当于<strong>切换到0环的_KiFastCallEntry函数</strong>  </p>
<p>EIP指向的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//只取开头部分</span></span><br><span class="line">kd&gt; u <span class="number">8053e540</span></span><br><span class="line">nt!KiFastCallEntry:</span><br><span class="line"><span class="number">8053e540</span> b923000000      mov     ecx,<span class="number">23</span>h</span><br><span class="line"><span class="number">8053e545</span> <span class="number">6</span>a30            push    <span class="number">30</span>h</span><br><span class="line"><span class="number">8053e547</span> <span class="number">0f</span>a1            pop     fs</span><br><span class="line"><span class="number">8053e549</span> <span class="number">8</span>ed9            mov     ds,cx</span><br><span class="line"><span class="number">8053e54</span>b <span class="number">8</span>ec1            mov     es,cx</span><br><span class="line"><span class="number">8053e54</span>d <span class="number">8b</span>0d40f0dfff    mov     ecx,dword ptr ds:[<span class="number">0F</span>FDFF040h]</span><br><span class="line"><span class="number">8053e553</span> <span class="number">8b</span>6104          mov     esp,dword ptr [ecx+<span class="number">4</span>]</span><br><span class="line"><span class="number">8053e556</span> <span class="number">6</span>a23            push    <span class="number">23</span>h</span><br></pre></td></tr></table></figure>

<p>可见，进入了KiFastCallEntry内核函数。</p>
<h3 id="API进零环的两种方式总结"><a href="#API进零环的两种方式总结" class="headerlink" title="API进零环的两种方式总结"></a>API进零环的两种方式总结</h3><ul>
<li>API通过<strong>中断门</strong>进0环<ol>
<li>固定中断号为0x2E</li>
<li>CS&#x2F;EIP由门描述符提供，ESP&#x2F;SS由TSS提供</li>
<li>进入0环后执行的内核函数：<strong>NT!KiStstemService</strong></li>
</ol>
</li>
<li>API通过<strong>sysenter</strong>指令进入0环<ol>
<li>CS&#x2F;ESP&#x2F;EIP由MSR寄存器提供（SS是算出来的）（实际上逆向时ESP还是由TSS中来）</li>
<li>进入0环后执行的内核函数：<strong>NT!KiFastCallEntry</strong></li>
</ol>
</li>
</ul>
<p>winXP内核模块：ntoskrnl.exe(10-10-12分页)&#x2F;ntkrnlpa.exe(2-9-9-12分页)</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210902143436444.png" alt="image-20210902143436444"></p>
<p>KiFastSystemCall方式三环进0环，TerminateThread API进入流程（未记录返回部分）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20211028194257701.png" alt="image-20211028194257701"></p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>自己实现通过中断门直接调用内核函数</p>
<p>通过IDA找到KiStstemService和KiFastCallEntry函数并分析</p>
<ol>
<li>进0环后，原来的寄存器存在哪里？</li>
<li>如何根据系统调用号（eax中存储）找到要执行的内核函数？</li>
<li>调用时参数时存储到3环的堆栈，如何传递给内核函数？</li>
<li>两种调用方式分别是如何返回到3环的</li>
</ol>
<p>后续的章节会展开讲上面的点。</p>
<h2 id="内核结构体介绍"><a href="#内核结构体介绍" class="headerlink" title="内核结构体介绍"></a>内核结构体介绍</h2><ol>
<li>储存3环寄存器信息结构体：_Ktrap_frame结构体</li>
<li>描述线程相关信息结构体：_ETHREAD和_KTHREAD</li>
<li>描述当前CPU状态的结构体：_KPCR</li>
</ol>
<h3 id="Ktrap-frame结构体"><a href="#Ktrap-frame结构体" class="headerlink" title="_Ktrap_frame结构体"></a>_Ktrap_frame结构体</h3><p>陷阱帧</p>
<p>无论是通过sysenter还是通过中断门进入零环，<strong>三环所有寄存器都会存在这个结构中</strong>。</p>
<p>该结构是<strong>零环结构体，由操作系统进行维护</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _Ktrap_frame</span><br><span class="line">ntdll!_KTRAP_FRAME</span><br><span class="line">   +<span class="number">0x000</span> DbgEbp           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> DbgEip           : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> DbgArgMark       : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> DbgArgPointer    : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> TempSegCs        : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> TempEsp          : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> Dr0              : Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> Dr1              : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> Dr2              : Uint4B</span><br><span class="line">   +<span class="number">0x024</span> Dr3              : Uint4B</span><br><span class="line">   +<span class="number">0x028</span> Dr6              : Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> Dr7              : Uint4B</span><br><span class="line">   +<span class="number">0x030</span> SegGs            : Uint4B</span><br><span class="line">   +<span class="number">0x034</span> SegEs            : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> SegDs            : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> Edx              : Uint4B</span><br><span class="line">   +<span class="number">0x040</span> Ecx              : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> Eax              : Uint4B</span><br><span class="line">   +<span class="number">0x048</span> PreviousPreviousMode : Uint4B</span><br><span class="line">   +<span class="number">0x04c</span> ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x050</span> SegFs            : Uint4B</span><br><span class="line">   +<span class="number">0x054</span> Edi              : Uint4B</span><br><span class="line">   +<span class="number">0x058</span> Esi              : Uint4B</span><br><span class="line">   +<span class="number">0x05c</span> Ebx              : Uint4B</span><br><span class="line">   +<span class="number">0x060</span> Ebp              : Uint4B</span><br><span class="line">   +<span class="number">0x064</span> ErrCode          : Uint4B</span><br><span class="line">   +<span class="number">0x068</span> Eip              : Uint4B</span><br><span class="line">   +<span class="number">0x06c</span> SegCs            : Uint4B</span><br><span class="line">   +<span class="number">0x070</span> EFlags           : Uint4B</span><br><span class="line">   +<span class="number">0x074</span> HardwareEsp      : Uint4B</span><br><span class="line">   +<span class="number">0x078</span> HardwareSegSs    : Uint4B</span><br><span class="line">   +<span class="number">0x07c</span> V86Es            : Uint4B</span><br><span class="line">   +<span class="number">0x080</span> V86Ds            : Uint4B</span><br><span class="line">   +<span class="number">0x084</span> V86Fs            : Uint4B</span><br><span class="line">   +<span class="number">0x088</span> V86Gs            : Uint4B</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191749044.png" alt="image-20210831191749044"></p>
<ul>
<li>KiFastSystemCall由0x78开始往上压栈。(sysenter)</li>
<li>KiIntSystemCall由0x64开始往上压栈。(中断)</li>
</ul>
<h3 id="THREAD线程相关的结构体"><a href="#THREAD线程相关的结构体" class="headerlink" title="THREAD线程相关的结构体"></a>THREAD线程相关的结构体</h3><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191949142.png" alt="image-20210831191949142"></p>
<h4 id="ETHREAD结构体"><a href="#ETHREAD结构体" class="headerlink" title="_ETHREAD结构体"></a>_ETHREAD结构体</h4><p>每个线程在零环都有一个对应的_ETHREAD结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_ETHREAD</span><br><span class="line">   +<span class="number">0x000</span> Tcb              : _KTHREAD</span><br><span class="line">   +<span class="number">0x1c0</span> CreateTime       : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1c0</span> NestedFaultCount : Pos <span class="number">0</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x1c0</span> ApcNeeded        : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x1c8</span> ExitTime         : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1c8</span> LpcReplyChain    : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1c8</span> KeyedWaitChain   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1d0</span> ExitStatus       : Int4B</span><br><span class="line">   +<span class="number">0x1d0</span> OfsChain         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1d4</span> PostBlockList    : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1dc</span> TerminationPort  : Ptr32 _TERMINATION_PORT</span><br><span class="line">   +<span class="number">0x1dc</span> ReaperLink       : Ptr32 _ETHREAD</span><br><span class="line">   +<span class="number">0x1dc</span> KeyedWaitValue   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1e0</span> ActiveTimerListLock : Uint4B</span><br><span class="line">   +<span class="number">0x1e4</span> ActiveTimerListHead : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1ec</span> Cid              : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x1f4</span> LpcReplySemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x1f4</span> KeyedWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x208</span> LpcReplyMessage  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x208</span> LpcWaitingOnPort : Ptr32 Void</span><br><span class="line">   +<span class="number">0x20c</span> ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION</span><br><span class="line">   +<span class="number">0x210</span> IrpList          : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x218</span> TopLevelIrp      : Uint4B</span><br><span class="line">   +<span class="number">0x21c</span> DeviceToVerify   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x220</span> ThreadsProcess   : Ptr32 _EPROCESS</span><br><span class="line">   +<span class="number">0x224</span> StartAddress     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x228</span> Win32StartAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x228</span> LpcReceivedMessageId : Uint4B</span><br><span class="line">   +<span class="number">0x22c</span> ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x234</span> RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +<span class="number">0x238</span> ThreadLock       : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x23c</span> LpcReplyMessageId : Uint4B</span><br><span class="line">   +<span class="number">0x240</span> ReadClusterSize  : Uint4B</span><br><span class="line">   +<span class="number">0x244</span> GrantedAccess    : Uint4B</span><br><span class="line">   +<span class="number">0x248</span> CrossThreadFlags : Uint4B</span><br><span class="line">   +<span class="number">0x248</span> Terminated       : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> DeadThread       : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> HideFromDebugger : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> ActiveImpersonationInfo : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> SystemThread     : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> HardErrorsAreDisabled : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> BreakOnTermination : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> SkipCreationMsg  : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> SkipTerminationMsg : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x24c</span> SameThreadPassiveFlags : Uint4B</span><br><span class="line">   +<span class="number">0x24c</span> ActiveExWorker   : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x24c</span> ExWorkerCanWaitUser : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x24c</span> MemoryMaker      : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x250</span> SameThreadApcFlags : Uint4B</span><br><span class="line">   +<span class="number">0x250</span> LpcReceivedMsgIdValid : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x250</span> LpcExitThreadCalled : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x250</span> AddressSpaceOwner : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x254</span> ForwardClusterOnly : UChar</span><br><span class="line">   +<span class="number">0x255</span> DisablePageFaultClustering : UChar</span><br></pre></td></tr></table></figure>

<h4 id="KTHREAD结构体"><a href="#KTHREAD结构体" class="headerlink" title="_KTHREAD结构体"></a>_KTHREAD结构体</h4><p>_ETHRAD结构体中的子结构体，存储的都是相对比较重要的信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_KTHREAD</span><br><span class="line">   +<span class="number">0x000</span> Header           : _DISPATCHER_HEADER</span><br><span class="line">   +<span class="number">0x010</span> MutantListHead   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x018</span> InitialStack     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x01c</span> StackLimit       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x020</span> Teb              : Ptr32 Void</span><br><span class="line">   +<span class="number">0x024</span> TlsArray         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x028</span> KernelStack      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x02c</span> DebugActive      : UChar</span><br><span class="line">   +<span class="number">0x02d</span> State            : UChar</span><br><span class="line">   +<span class="number">0x02e</span> Alerted          : [<span class="number">2</span>] UChar</span><br><span class="line">   +<span class="number">0x030</span> Iopl             : UChar</span><br><span class="line">   +<span class="number">0x031</span> NpxState         : UChar</span><br><span class="line">   +<span class="number">0x032</span> Saturation       : Char</span><br><span class="line">   +<span class="number">0x033</span> Priority         : Char</span><br><span class="line">   +<span class="number">0x034</span> ApcState         : _KAPC_STATE</span><br><span class="line">   +<span class="number">0x04c</span> ContextSwitches  : Uint4B</span><br><span class="line">   +<span class="number">0x050</span> IdleSwapBlock    : UChar</span><br><span class="line">   +<span class="number">0x051</span> Spare0           : [<span class="number">3</span>] UChar</span><br><span class="line">   +<span class="number">0x054</span> WaitStatus       : Int4B</span><br><span class="line">   +<span class="number">0x058</span> WaitIrql         : UChar</span><br><span class="line">   +<span class="number">0x059</span> WaitMode         : Char</span><br><span class="line">   +<span class="number">0x05a</span> WaitNext         : UChar</span><br><span class="line">   +<span class="number">0x05b</span> WaitReason       : UChar</span><br><span class="line">   +<span class="number">0x05c</span> WaitBlockList    : Ptr32 _KWAIT_BLOCK</span><br><span class="line">   +<span class="number">0x060</span> WaitListEntry    : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x060</span> SwapListEntry    : _SINGLE_LIST_ENTRY</span><br><span class="line">   +<span class="number">0x068</span> WaitTime         : Uint4B</span><br><span class="line">   +<span class="number">0x06c</span> BasePriority     : Char</span><br><span class="line">   +<span class="number">0x06d</span> DecrementCount   : UChar</span><br><span class="line">   +<span class="number">0x06e</span> PriorityDecrement : Char</span><br><span class="line">   +<span class="number">0x06f</span> Quantum          : Char</span><br><span class="line">   +<span class="number">0x070</span> WaitBlock        : [<span class="number">4</span>] _KWAIT_BLOCK</span><br><span class="line">   +<span class="number">0x0d0</span> LegoData         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x0d4</span> KernelApcDisable : Uint4B</span><br><span class="line">   +<span class="number">0x0d8</span> UserAffinity     : Uint4B</span><br><span class="line">   +<span class="number">0x0dc</span> SystemAffinityActive : UChar</span><br><span class="line">   +<span class="number">0x0dd</span> PowerState       : UChar</span><br><span class="line">   +<span class="number">0x0de</span> NpxIrql          : UChar</span><br><span class="line">   +<span class="number">0x0df</span> InitialNode      : UChar</span><br><span class="line">   +<span class="number">0x0e0</span> ServiceTable     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x0e4</span> Queue            : Ptr32 _KQUEUE</span><br><span class="line">   +<span class="number">0x0e8</span> ApcQueueLock     : Uint4B</span><br><span class="line">   +<span class="number">0x0f0</span> Timer            : _KTIMER</span><br><span class="line">   +<span class="number">0x118</span> QueueListEntry   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x120</span> SoftAffinity     : Uint4B</span><br><span class="line">   +<span class="number">0x124</span> Affinity         : Uint4B</span><br><span class="line">   +<span class="number">0x128</span> Preempted        : UChar</span><br><span class="line">   +<span class="number">0x129</span> ProcessReadyQueue : UChar</span><br><span class="line">   +<span class="number">0x12a</span> KernelStackResident : UChar</span><br><span class="line">   +<span class="number">0x12b</span> NextProcessor    : UChar</span><br><span class="line">   +<span class="number">0x12c</span> CallbackStack    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x130</span> Win32Thread      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x134</span> TrapFrame        : Ptr32 _KTRAP_FRAME</span><br><span class="line">   +<span class="number">0x138</span> ApcStatePointer  : [<span class="number">2</span>] Ptr32 _KAPC_STATE</span><br><span class="line">   +<span class="number">0x140</span> PreviousMode     : Char<span class="comment">//先前模式，从用户模式调用Native API则previous mode是1，如果从内核模式调用Native API则previous mode是0</span></span><br><span class="line">   +<span class="number">0x141</span> EnableStackSwap  : UChar</span><br><span class="line">   +<span class="number">0x142</span> LargeStack       : UChar</span><br><span class="line">   +<span class="number">0x143</span> ResourceIndex    : UChar</span><br><span class="line">   +<span class="number">0x144</span> KernelTime       : Uint4B</span><br><span class="line">   +<span class="number">0x148</span> UserTime         : Uint4B</span><br><span class="line">   +<span class="number">0x14c</span> SavedApcState    : _KAPC_STATE</span><br><span class="line">   +<span class="number">0x164</span> Alertable        : UChar</span><br><span class="line">   +<span class="number">0x165</span> ApcStateIndex    : UChar</span><br><span class="line">   +<span class="number">0x166</span> ApcQueueable     : UChar</span><br><span class="line">   +<span class="number">0x167</span> AutoAlignment    : UChar</span><br><span class="line">   +<span class="number">0x168</span> StackBase        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x16c</span> SuspendApc       : _KAPC</span><br><span class="line">   +<span class="number">0x19c</span> SuspendSemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x1b0</span> ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1b8</span> FreezeCount      : Char</span><br><span class="line">   +<span class="number">0x1b9</span> SuspendCount     : Char</span><br><span class="line">   +<span class="number">0x1ba</span> IdealProcessor   : UChar</span><br><span class="line">   +<span class="number">0x1bb</span> DisableBoost     : UChar</span><br></pre></td></tr></table></figure>

<h3 id="CPU相关结构体"><a href="#CPU相关结构体" class="headerlink" title="CPU相关结构体"></a>CPU相关结构体</h3><h4 id="CPU相关windbg指令"><a href="#CPU相关windbg指令" class="headerlink" title="CPU相关windbg指令"></a>CPU相关windbg指令</h4><h5 id="查看CPU数量"><a href="#查看CPU数量" class="headerlink" title="查看CPU数量"></a>查看CPU数量</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd KeNumberProcessors</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831151847441.png" alt="image-20210831151847441"></p>
<p>表示一核</p>
<h5 id="查看KPRCB存在哪里"><a href="#查看KPRCB存在哪里" class="headerlink" title="查看KPRCB存在哪里"></a>查看KPRCB存在哪里</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd KiProcessorBlock</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831152107988.png" alt="image-20210831152107988"></p>
<p>如果有两个核，那么就会出现两个地址，上图由于只有一个核所以还有一个地址。</p>
<p>120为kpcr中KPRCB的对应位置，0xffdff120-0x120就是_kpcr结构体的地址。</p>
<p>p.s. 在0环中，FS段描述符指向的就是KPCR结构首地址，写死在gdtr+0x30位置。</p>
<p><strong>查看kpcr指令：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dt _kpcr <span class="number">0xffdff120</span><span class="number">-0x120</span></span><br></pre></td></tr></table></figure>

<h4 id="KPCR结构体"><a href="#KPCR结构体" class="headerlink" title="_KPCR结构体"></a>_KPCR结构体</h4><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191911557.png" alt="image-20210831191911557"></p>
<p>KPCR 也叫CPU控制区(Processor Control Region)</p>
<p>每一个CPU核都有一个_KPCR结构体来描述当前CPU所处的状态。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _kpcr <span class="number">0xffdff120</span><span class="number">-0x120</span></span><br><span class="line">nt!_KPCR</span><br><span class="line">   +<span class="number">0x000</span> NtTib            : _NT_TIB</span><br><span class="line">   +<span class="number">0x01c</span> SelfPcr          : <span class="number">0xffdff000</span> _KPCR</span><br><span class="line">   +<span class="number">0x020</span> Prcb             : <span class="number">0xffdff120</span> _KPRCB</span><br><span class="line">   +<span class="number">0x024</span> Irql             : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x028 IRR              : 0</span></span><br><span class="line"><span class="string">   +0x02c IrrActive        : 0</span></span><br><span class="line"><span class="string">   +0x030 IDR              : 0xffffffff</span></span><br><span class="line"><span class="string">   +0x034 KdVersionBlock   : 0x80546ab8 Void</span></span><br><span class="line"><span class="string">   +0x038 IDT              : 0x8003f400 _KIDTENTRY//当前核的IDT</span></span><br><span class="line"><span class="string">   +0x03c GDT              : 0x8003f000 _KGDTENTRY//当前核的GDT</span></span><br><span class="line"><span class="string">   +0x040 TSS              : 0x80042000 _KTSS//当前核的TSS</span></span><br><span class="line"><span class="string">   +0x044 MajorVersion     : 1</span></span><br><span class="line"><span class="string">   +0x046 MinorVersion     : 1</span></span><br><span class="line"><span class="string">   +0x048 SetMember        : 1</span></span><br><span class="line"><span class="string">   +0x04c StallScaleFactor : 0xd49</span></span><br><span class="line"><span class="string">   +0x050 DebugActive      : 0 &#x27;</span><span class="string">&#x27;//调试激活位</span></span><br><span class="line"><span class="string">   +0x051 Number           : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x052</span> Spare0           : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x053 SecondLevelCacheAssociativity : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x054</span> VdmAlert         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> KernelReserved   : [<span class="number">14</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x090</span> SecondLevelCacheSize : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x094</span> HalReserved      : [<span class="number">16</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0d4</span> InterruptMode    : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0d8</span> Spare1           : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x0dc KernelReserved2  : [17] 0</span></span><br><span class="line"><span class="string">   +0x120 PrcbData         : _KPRCB</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">ntdll!_NT_TIB</span></span><br><span class="line"><span class="string">   +0x000 ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD　　//当前线程内核异常链表(SEH)</span></span><br><span class="line"><span class="string">   +0x004 StackBase        : Ptr32 Void　　　　　　　　　　　　　　　　　 //当前线程堆栈的基址</span></span><br><span class="line"><span class="string">   +0x008 StackLimit       : Ptr32 Void　　　　　　　　　　　　　　　　　 //当前线程堆栈的大小</span></span><br><span class="line"><span class="string">   +0x00c SubSystemTib     : Ptr32 Void</span></span><br><span class="line"><span class="string">   +0x010 FiberData        : Ptr32 Void</span></span><br><span class="line"><span class="string">   +0x010 Version          : Uint4B</span></span><br><span class="line"><span class="string">   +0x014 ArbitraryUserPointer : Ptr32 Void</span></span><br><span class="line"><span class="string">   +0x018 Self             : Ptr32 _NT_TIB　　　　　　　　　　　　　　　 //指向自己头部，目的为了方便查找</span></span><br></pre></td></tr></table></figure>

<h4 id="KPRCB结构体"><a href="#KPRCB结构体" class="headerlink" title="_KPRCB结构体"></a>_KPRCB结构体</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPRCB ffdff000+<span class="number">0x120</span></span><br><span class="line">ntdll!_KPRCB</span><br><span class="line">   +<span class="number">0x000</span> MinorVersion     : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x002</span> MajorVersion     : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x004</span> CurrentThread    : <span class="number">0x80553740</span> _KTHREAD</span><br><span class="line">   +<span class="number">0x008</span> NextThread       : (null) </span><br><span class="line">   +<span class="number">0x00c</span> IdleThread       : <span class="number">0x80553740</span> _KTHREAD</span><br><span class="line">   +<span class="number">0x010</span> Number           : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x011 Reserved         : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x012</span> BuildType        : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x014</span> SetMember        : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x018</span> CpuType          : <span class="number">6</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x019 CpuID            : 1 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x01a</span> CpuStep          : <span class="number">0x3c03</span></span><br><span class="line">   +<span class="number">0x01c</span> ProcessorState   : _KPROCESSOR_STATE</span><br><span class="line">   +<span class="number">0x33c</span> KernelReserved   : [<span class="number">16</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x37c</span> HalReserved      : [<span class="number">16</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x3bc</span> PrcbPad0         : [<span class="number">92</span>]  <span class="string">&quot;&quot;</span></span><br><span class="line">   +<span class="number">0x418</span> LockQueue        : [<span class="number">16</span>] _KSPIN_LOCK_QUEUE</span><br><span class="line">   +<span class="number">0x498</span> PrcbPad1         : [<span class="number">8</span>]  <span class="string">&quot;&quot;</span></span><br><span class="line">   +<span class="number">0x4a0</span> NpxThread        : <span class="number">0x81d10af0</span> _KTHREAD</span><br><span class="line">   +<span class="number">0x4a4</span> InterruptCount   : <span class="number">0x34e1</span></span><br><span class="line">   +<span class="number">0x4a8</span> KernelTime       : <span class="number">0x1aaf</span></span><br><span class="line">   +<span class="number">0x4ac</span> UserTime         : <span class="number">0xa1</span></span><br><span class="line">   +<span class="number">0x4b0</span> DpcTime          : <span class="number">0x16</span></span><br><span class="line">   +<span class="number">0x4b4</span> DebugDpcTime     : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x4b8</span> InterruptTime    : <span class="number">0x79</span></span><br><span class="line">   +<span class="number">0x4bc</span> AdjustDpcThreshold : <span class="number">0x14</span></span><br><span class="line">   +<span class="number">0x4c0</span> PageColor        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x4c4</span> SkipTick         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x4c8</span> MultiThreadSetBusy : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x4c9 Spare2           : [3]  &quot;&quot;</span></span><br><span class="line"><span class="string">   +0x4cc ParentNode       : 0x80553e00 _KNODE</span></span><br><span class="line"><span class="string">   +0x4d0 MultiThreadProcessorSet : 1</span></span><br><span class="line"><span class="string">   +0x4d4 MultiThreadSetMaster : (null) </span></span><br><span class="line"><span class="string">   +0x4d8 ThreadStartCount : [2] 0</span></span><br><span class="line"><span class="string">   +0x4e0 CcFastReadNoWait : 0</span></span><br><span class="line"><span class="string">   +0x4e4 CcFastReadWait   : 0</span></span><br><span class="line"><span class="string">   +0x4e8 CcFastReadNotPossible : 0</span></span><br><span class="line"><span class="string">   +0x4ec CcCopyReadNoWait : 0</span></span><br><span class="line"><span class="string">   +0x4f0 CcCopyReadWait   : 0</span></span><br><span class="line"><span class="string">   +0x4f4 CcCopyReadNoWaitMiss : 0</span></span><br><span class="line"><span class="string">   +0x4f8 KeAlignmentFixupCount : 0</span></span><br><span class="line"><span class="string">   +0x4fc KeContextSwitches : 0x1a44d</span></span><br><span class="line"><span class="string">   +0x500 KeDcacheFlushCount : 0</span></span><br><span class="line"><span class="string">   +0x504 KeExceptionDispatchCount : 0x290</span></span><br><span class="line"><span class="string">   +0x508 KeFirstLevelTbFills : 0</span></span><br><span class="line"><span class="string">   +0x50c KeFloatingEmulationCount : 0</span></span><br><span class="line"><span class="string">   +0x510 KeIcacheFlushCount : 0</span></span><br><span class="line"><span class="string">   +0x514 KeSecondLevelTbFills : 0</span></span><br><span class="line"><span class="string">   +0x518 KeSystemCalls    : 0x24189b//系统调用次数</span></span><br><span class="line"><span class="string">   +0x51c SpareCounter0    : [1] 0</span></span><br><span class="line"><span class="string">   +0x520 PPLookasideList  : [16] _PP_LOOKASIDE_LIST</span></span><br><span class="line"><span class="string">   +0x5a0 PPNPagedLookasideList : [32] _PP_LOOKASIDE_LIST</span></span><br><span class="line"><span class="string">   +0x6a0 PPPagedLookasideList : [32] _PP_LOOKASIDE_LIST</span></span><br><span class="line"><span class="string">   +0x7a0 PacketBarrier    : 0</span></span><br><span class="line"><span class="string">   +0x7a4 ReverseStall     : 0</span></span><br><span class="line"><span class="string">   +0x7a8 IpiFrame         : (null) </span></span><br><span class="line"><span class="string">   +0x7ac PrcbPad2         : [52]  &quot;&quot;</span></span><br><span class="line"><span class="string">   +0x7e0 CurrentPacket    : [3] (null) </span></span><br><span class="line"><span class="string">   +0x7ec TargetSet        : 0</span></span><br><span class="line"><span class="string">   +0x7f0 WorkerRoutine    : (null) </span></span><br><span class="line"><span class="string">   +0x7f4 IpiFrozen        : 0</span></span><br><span class="line"><span class="string">   +0x7f8 PrcbPad3         : [40]  &quot;&quot;</span></span><br><span class="line"><span class="string">   +0x820 RequestSummary   : 0</span></span><br><span class="line"><span class="string">   +0x824 SignalDone       : (null) </span></span><br><span class="line"><span class="string">   +0x828 PrcbPad4         : [56]  &quot;&quot;</span></span><br><span class="line"><span class="string">   +0x860 DpcListHead      : _LIST_ENTRY [ 0x80553da4 - 0x80553da4 ]</span></span><br><span class="line"><span class="string">   +0x868 DpcStack         : 0xf8ac2000 Void</span></span><br><span class="line"><span class="string">   +0x86c DpcCount         : 0x2058</span></span><br><span class="line"><span class="string">   +0x870 DpcQueueDepth    : 1</span></span><br><span class="line"><span class="string">   +0x874 DpcRoutineActive : 0</span></span><br><span class="line"><span class="string">   +0x878 DpcInterruptRequested : 0</span></span><br><span class="line"><span class="string">   +0x87c DpcLastCount     : 0x2058</span></span><br><span class="line"><span class="string">   +0x880 DpcRequestRate   : 0</span></span><br><span class="line"><span class="string">   +0x884 MaximumDpcQueueDepth : 1</span></span><br><span class="line"><span class="string">   +0x888 MinimumDpcRate   : 3</span></span><br><span class="line"><span class="string">   +0x88c QuantumEnd       : 0</span></span><br><span class="line"><span class="string">   +0x890 PrcbPad5         : [16]  &quot;&quot;</span></span><br><span class="line"><span class="string">   +0x8a0 DpcLock          : 0</span></span><br><span class="line"><span class="string">   +0x8a4 PrcbPad6         : [28]  &quot;&quot;</span></span><br><span class="line"><span class="string">   +0x8c0 CallDpc          : _KDPC</span></span><br><span class="line"><span class="string">   +0x8e0 ChainedInterruptList : (null) </span></span><br><span class="line"><span class="string">   +0x8e4 LookasideIrpFloat : 0n1438</span></span><br><span class="line"><span class="string">   +0x8e8 SpareFields0     : [6] 0</span></span><br><span class="line"><span class="string">   +0x900 VendorString     : [13]  &quot;GenuineIntel&quot;//CPU厂商名称</span></span><br><span class="line"><span class="string">   +0x90d InitialApicId    : 0 &#x27;</span>&#x27;</span><br><span class="line">   +<span class="number">0x90e</span> LogicalProcessorsPerPhysicalProcessor : <span class="number">0x1</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">   +0x910 MHz              : 0xd47</span></span><br><span class="line"><span class="string">   +0x914 FeatureBits      : 0xa0013fff</span></span><br><span class="line"><span class="string">   +0x918 UpdateSignature  : _LARGE_INTEGER 0x00000025`00000000</span></span><br><span class="line"><span class="string">   +0x920 NpxSaveArea      : _FX_SAVE_AREA</span></span><br><span class="line"><span class="string">   +0xb30 PowerState       : _PROCESSOR_POWER_STATE</span></span><br></pre></td></tr></table></figure>



<h2 id="分析KiStstemService和KiFastCallEntry"><a href="#分析KiStstemService和KiFastCallEntry" class="headerlink" title="分析KiStstemService和KiFastCallEntry"></a>分析KiStstemService和KiFastCallEntry</h2><p>KiStstemService和KiFastCallEntry从两个口进来，最终执行的代码是一样的。</p>
<p>开始的时候，这两函数都在填充_Ktrap_frame结构体以保存三环的信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; uf <span class="number">8053e481</span></span><br><span class="line">Flow analysis was incomplete, some code may be missing</span><br><span class="line">nt!KiBBTUnexpectedRange:</span><br><span class="line"><span class="number">8053e332</span> <span class="number">83f</span>910          cmp     ecx,<span class="number">10</span>h</span><br><span class="line"><span class="number">8053e335</span> <span class="number">7539</span>            jne     nt!KiBBTUnexpectedRange+<span class="number">0x3e</span> (<span class="number">8053e370</span>)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiBBTUnexpectedRange+<span class="number">0x5</span>:</span><br><span class="line"><span class="number">8053e337</span> <span class="number">52</span>              push    edx</span><br><span class="line"><span class="number">8053e338</span> <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">8053e339</span> e8e2530800      call    nt!PsConvertToGuiThread (<span class="number">805</span>c3720)</span><br><span class="line"><span class="number">8053e33</span>e <span class="number">0b</span>c0            or      eax,eax</span><br><span class="line"><span class="number">8053e340</span> <span class="number">58</span>              pop     eax</span><br><span class="line"><span class="number">8053e341</span> <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">8053e342</span> <span class="number">8b</span>ec            mov     ebp,esp</span><br><span class="line"><span class="number">8053e344</span> <span class="number">89</span>ae34010000    mov     dword ptr [esi+<span class="number">134</span>h],ebp</span><br><span class="line"><span class="number">8053e34</span>a <span class="number">0f</span>847d020000    je      nt!KiFastCallEntry+<span class="number">0x8d</span> (<span class="number">8053e5</span>cd)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiBBTUnexpectedRange+<span class="number">0x1e</span>:</span><br><span class="line"><span class="number">8053e350</span> <span class="number">8</span>d15703f5580    lea     edx,[nt!KeServiceDescriptorTableShadow+<span class="number">0x10</span> (<span class="number">80553f</span>70)]</span><br><span class="line"><span class="number">8053e356</span> <span class="number">8b</span>4a08          mov     ecx,dword ptr [edx+<span class="number">8</span>]</span><br><span class="line"><span class="number">8053e359</span> <span class="number">8b</span>12            mov     edx,dword ptr [edx]</span><br><span class="line"><span class="number">8053e35</span>b <span class="number">8</span>d148a          lea     edx,[edx+ecx*<span class="number">4</span>]</span><br><span class="line"><span class="number">8053e35</span>e <span class="number">25f</span>f0f0000      and     eax,<span class="number">0F</span>FFh</span><br><span class="line"><span class="number">8053e363</span> <span class="number">03</span>d0            add     edx,eax</span><br><span class="line"><span class="number">8053e365</span> <span class="number">0f</span>be02          movsx   eax,byte ptr [edx]</span><br><span class="line"><span class="number">8053e368</span> <span class="number">0b</span>c0            or      eax,eax</span><br><span class="line"><span class="number">8053e36</span>a <span class="number">0f</span>8eca020000    jle     nt!KiFastCallEntry+<span class="number">0xfa</span> (<span class="number">8053e63</span>a)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiBBTUnexpectedRange+<span class="number">0x3e</span>:</span><br><span class="line"><span class="number">8053e370</span> b81c0000c0      mov     eax,<span class="number">0</span>C000001Ch</span><br><span class="line"><span class="number">8053e375</span> e9c0020000      jmp     nt!KiFastCallEntry+<span class="number">0xfa</span> (<span class="number">8053e63</span>a)  Branch</span><br><span class="line"></span><br><span class="line">   <span class="comment">//==================================调试相关beign==============================</span></span><br><span class="line">    <span class="comment">//就是将调试寄存器中的DR0到DR7放入_KTRAP_FRAME结构中的DR0到DR7</span></span><br><span class="line">nt!Dr_kss_a:</span><br><span class="line"><span class="number">8053e37</span>c f7457000000200  test    dword ptr [ebp+<span class="number">70</span>h],<span class="number">20000</span>h</span><br><span class="line"><span class="number">8053e383</span> <span class="number">750</span>d            jne     nt!Dr_kss_a+<span class="number">0x16</span> (<span class="number">8053e392</span>)  Branch</span><br><span class="line"></span><br><span class="line">nt!Dr_kss_a+<span class="number">0x9</span>:</span><br><span class="line"><span class="number">8053e385</span> f7456c01000000  test    dword ptr [ebp+<span class="number">6</span>Ch],<span class="number">1</span></span><br><span class="line"><span class="number">8053e38</span>c <span class="number">0f</span>845d010000    je      nt!KiSystemService+<span class="number">0x6e</span> (<span class="number">8053e4</span>ef)  Branch</span><br><span class="line"></span><br><span class="line">nt!Dr_kss_a+<span class="number">0x16</span>:</span><br><span class="line"><span class="number">8053e392</span> <span class="number">0f</span>21c3          mov     ebx,dr0</span><br><span class="line"><span class="number">8053e395</span> <span class="number">0f</span>21c9          mov     ecx,dr1</span><br><span class="line"><span class="number">8053e398</span> <span class="number">0f</span>21d7          mov     edi,dr2</span><br><span class="line"><span class="number">8053e39</span>b <span class="number">895</span>d18          mov     dword ptr [ebp+<span class="number">18</span>h],ebx</span><br><span class="line"><span class="number">8053e39</span>e <span class="number">894</span>d1c          mov     dword ptr [ebp+<span class="number">1</span>Ch],ecx</span><br><span class="line"><span class="number">8053e3</span>a1 <span class="number">897</span>d20          mov     dword ptr [ebp+<span class="number">20</span>h],edi</span><br><span class="line"><span class="number">8053e3</span>a4 <span class="number">0f</span>21db          mov     ebx,dr3</span><br><span class="line"><span class="number">8053e3</span>a7 <span class="number">0f</span>21f1          mov     ecx,dr6</span><br><span class="line"><span class="number">8053e3</span>aa <span class="number">0f</span>21ff          mov     edi,dr7</span><br><span class="line"><span class="number">8053e3</span>ad <span class="number">895</span>d24          mov     dword ptr [ebp+<span class="number">24</span>h],ebx</span><br><span class="line"><span class="number">8053e3</span>b0 <span class="number">894</span>d28          mov     dword ptr [ebp+<span class="number">28</span>h],ecx</span><br><span class="line"><span class="number">8053e3</span>b3 <span class="number">33</span>db            xor     ebx,ebx</span><br><span class="line"><span class="number">8053e3</span>b5 <span class="number">897</span>d2c          mov     dword ptr [ebp+<span class="number">2</span>Ch],edi</span><br><span class="line"><span class="number">8053e3</span>b8 <span class="number">0f</span>23fb          mov     dr7,ebx</span><br><span class="line"><span class="number">8053e3</span>bb <span class="number">648b</span>3d20000000  mov     edi,dword ptr fs:[<span class="number">20</span>h]</span><br><span class="line"><span class="number">8053e3</span>c2 <span class="number">8b</span>9ff8020000    mov     ebx,dword ptr [edi+<span class="number">2F</span>8h]</span><br><span class="line"><span class="number">8053e3</span>c8 <span class="number">8b</span>8ffc020000    mov     ecx,dword ptr [edi+<span class="number">2F</span>Ch]</span><br><span class="line"><span class="number">8053e3</span>ce <span class="number">0f</span>23c3          mov     dr0,ebx</span><br><span class="line"><span class="number">8053e3</span>d1 <span class="number">0f</span>23c9          mov     dr1,ecx</span><br><span class="line"><span class="number">8053e3</span>d4 <span class="number">8b</span>9f00030000    mov     ebx,dword ptr [edi+<span class="number">300</span>h]</span><br><span class="line"><span class="number">8053e3</span>da <span class="number">8b</span>8f04030000    mov     ecx,dword ptr [edi+<span class="number">304</span>h]</span><br><span class="line"><span class="number">8053e3</span>e0 <span class="number">0f</span>23d3          mov     dr2,ebx</span><br><span class="line"><span class="number">8053e3</span>e3 <span class="number">0f</span>23d9          mov     dr3,ecx</span><br><span class="line"><span class="number">8053e3</span>e6 <span class="number">8b</span>9f08030000    mov     ebx,dword ptr [edi+<span class="number">308</span>h]</span><br><span class="line"><span class="number">8053e3</span>ec <span class="number">8b</span>8f0c030000    mov     ecx,dword ptr [edi+<span class="number">30</span>Ch]</span><br><span class="line"><span class="number">8053e3</span>f2 <span class="number">0f</span>23f3          mov     dr6,ebx</span><br><span class="line"><span class="number">8053e3</span>f5 <span class="number">0f</span>23f9          mov     dr7,ecx</span><br><span class="line"><span class="number">8053e3</span>f8 e9f2000000      jmp     nt!KiSystemService+<span class="number">0x6e</span> (<span class="number">8053e4</span>ef)  Branch</span><br><span class="line"><span class="comment">//==================================调试相关end==============================</span></span><br><span class="line">    </span><br><span class="line">nt!KiSystemService:<span class="comment">//KiStstemService此函数开始（//系统调用号在eax寄存器，系统调用号//edx说明参数在哪里）</span></span><br><span class="line"><span class="number">8053e481</span> <span class="number">6</span>a00            push    <span class="number">0</span>	<span class="comment">//_KTRAP_FRAME +0x64  ErrCode</span></span><br><span class="line"><span class="number">8053e483</span> <span class="number">55</span>              push    ebp<span class="comment">//+0x060  ebp</span></span><br><span class="line"><span class="number">8053e484</span> <span class="number">53</span>              push    ebx<span class="comment">//+0x05c  ebx</span></span><br><span class="line"><span class="number">8053e485</span> <span class="number">56</span>              push    esi<span class="comment">//+0x058  esi</span></span><br><span class="line"><span class="number">8053e486</span> <span class="number">57</span>              push    edi<span class="comment">//+0x054  edi</span></span><br><span class="line"><span class="number">8053e487</span> <span class="number">0f</span>a0            push    fs<span class="comment">//+0x050 SegFs</span></span><br><span class="line"><span class="number">8053e489</span> bb30000000      mov     ebx,<span class="number">30</span>h<span class="comment">//0x30的选择子指向ffc093df`f0000001描述符,其中base为ffdff000,刚好是KPCR结构体的地址</span></span><br><span class="line"><span class="number">8053e48</span>e <span class="number">668</span>ee3          mov     fs,bx<span class="comment">//FS在3环指向PEB，在零环FS指向KPCR结构体！！！！！！</span></span><br><span class="line"><span class="number">8053e491</span> ff3500f0dfff    push    dword ptr ds:[<span class="number">0F</span>FDFF000h]<span class="comment">//_KTRAP_FRAME +0x4c保存老的ExceptionList</span></span><br><span class="line"><span class="number">8053e497</span> c70500f0dfffffffffff mov dword ptr ds:[<span class="number">0F</span>FDFF000h],<span class="number">0F</span>FFFFFFFh<span class="comment">//将新的ExceptionList置为-1</span></span><br><span class="line"><span class="number">8053e4</span>a1 <span class="number">8b</span>3524f1dfff    mov     esi,dword ptr ds:[<span class="number">0F</span>FDFF124h]<span class="comment">//KPCR结构体0x124偏移的CurrentThread,esi为当前线程信息_ETHREAD结构体地址</span></span><br><span class="line"><span class="number">8053e4</span>a7 ffb640010000    push    dword ptr [esi+<span class="number">140</span>h]<span class="comment">//当前线程_ETHREAD中0x140偏移的PreviousMode先前模式存入_KTRAP_FRAME +0x48</span></span><br><span class="line"><span class="number">8053e4</span>ad <span class="number">83</span>ec48          sub     esp,<span class="number">48</span>h<span class="comment">//提升堆栈，esp也为_KTRAP_FRAME首地址</span></span><br><span class="line"><span class="number">8053e4</span>b0 <span class="number">8b</span>5c246c        mov     ebx,dword ptr [esp+<span class="number">6</span>Ch]<span class="comment">//ebx为三环原来的CS值</span></span><br><span class="line"><span class="number">8053e4</span>b4 <span class="number">83e301</span>          and     ebx,<span class="number">1</span><span class="comment">//取三环原来的CS值最后一位，0环为0，三环为1</span></span><br><span class="line"><span class="number">8053e4</span>b7 <span class="number">889e40010000</span>    mov     byte ptr [esi+<span class="number">140</span>h],bl<span class="comment">//当前线程_ETHREAD中0x140偏移的PreviousMode先前模式位置存入值，先前模式表示，提升权限前是三环就是1，提升权限前是0环就是0。有些内核代码在三环和零环都可以执行，但是执行不一样，就是通过该先前模式进行判断。</span></span><br><span class="line"><span class="number">8053e4</span>bd <span class="number">8b</span>ec            mov     ebp,esp<span class="comment">//栈底提升，ebp也为_KTRAP_FRAME首地址</span></span><br><span class="line"><span class="number">8053e4</span>bf <span class="number">8b</span>9e34010000    mov     ebx,dword ptr [esi+<span class="number">134</span>h]<span class="comment">//ebx为_ETHREAD中的0x134偏移的旧_KTRAP_FRAME地址</span></span><br><span class="line"><span class="number">8053e4</span>c5 <span class="number">895</span>d3c          mov     dword ptr [ebp+<span class="number">3</span>Ch],ebx<span class="comment">//将旧_KTRAP_FRAME地址临时存在这里_KTRAP_FRAME内的edx位置</span></span><br><span class="line"><span class="number">8053e4</span>c8 <span class="number">89</span>ae34010000    mov     dword ptr [esi+<span class="number">134</span>h],ebp<span class="comment">//将新的_KTRAP_FRAME地址存入_ETHREAD中的0x134偏移处</span></span><br><span class="line"><span class="number">8053e4</span>ce fc              cld</span><br><span class="line"><span class="number">8053e4</span>cf <span class="number">8b</span>5d60          mov     ebx,dword ptr [ebp+<span class="number">60</span>h]<span class="comment">//将原来的三环的ebp放进ebx中</span></span><br><span class="line"><span class="number">8053e4</span>d2 <span class="number">8b</span>7d68          mov     edi,dword ptr [ebp+<span class="number">68</span>h]<span class="comment">//将原来三环的eip放进edi</span></span><br><span class="line"><span class="number">8053e4</span>d5 <span class="number">89550</span>c          mov     dword ptr [ebp+<span class="number">0</span>Ch],edx<span class="comment">//_Trap_Frame结构中的DbgArgPointer位置存【三环时往edx存入的参数指针】</span></span><br><span class="line"><span class="number">8053e4</span>d8 c74508000ddbba  mov     dword ptr [ebp+<span class="number">8</span>],<span class="number">0B</span>ADB0D00h<span class="comment">//将0BADB0D00h存入_Trap_Frame结构中的DbgArgMark位置</span></span><br><span class="line"><span class="number">8053e4</span>df <span class="number">895</span>d00          mov     dword ptr [ebp],ebx<span class="comment">//将原来的三环的ebp放进_Trap_Frame结构中的DbgEbp位置</span></span><br><span class="line"><span class="number">8053e4</span>e2 <span class="number">897</span>d04          mov     dword ptr [ebp+<span class="number">4</span>],edi<span class="comment">//将原来的三环的eip放进_Trap_Frame结构中的DbgEip位置</span></span><br><span class="line"><span class="number">8053e4</span>e5 f6462cff        test    byte ptr [esi+<span class="number">2</span>Ch],<span class="number">0F</span>Fh<span class="comment">//比较当前线程_ETHREAD中0x2C偏移的DebugActive的值和-1比较</span></span><br><span class="line"><span class="number">8053e4</span>e9 <span class="number">0f</span>858dfeffff    jne     nt!Dr_kss_a (<span class="number">8053e37</span>c)  Branch<span class="comment">//如果当前线程_ETHREAD中0x2C偏移的DebugActive的值不是-1，则说明处于调试状态，则跳转去：将调试寄存器中的DR0到DR7放入_KTRAP_FRAME结构中的DR0到DR7</span></span><br><span class="line">    <span class="comment">//因此人为将当前线程_ETHREAD中0x2C偏移的DebugActive置为-1，则无法进行硬件断点了。</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">nt!KiSystemService+<span class="number">0x6e</span>:</span><br><span class="line"><span class="number">8053e4</span>ef fb              sti<span class="comment">//允许中断</span></span><br><span class="line"><span class="number">8053e4</span>f0 e9d8000000      jmp     nt!KiFastCallEntry+<span class="number">0x8d</span> (<span class="number">8053e5</span>cd)  Branch</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">nt!KiFastCallEntry2+<span class="number">0x24</span>:<span class="comment">//不知道啥意思</span></span><br><span class="line"><span class="number">8053e519</span> <span class="number">8b</span>0d40f0dfff    mov     ecx,dword ptr ds:[<span class="number">0F</span>FDFF040h]<span class="comment">//TSS地址放入ecx</span></span><br><span class="line"><span class="number">8053e51</span>f <span class="number">8b</span>6104          mov     esp,dword ptr [ecx+<span class="number">4</span>]<span class="comment">//esp0放入esp</span></span><br><span class="line"><span class="number">8053e522</span> <span class="number">6</span>a00            push    <span class="number">0</span><span class="comment">//填的是啥</span></span><br><span class="line"><span class="number">8053e524</span> <span class="number">6</span>a00            push    <span class="number">0</span></span><br><span class="line"><span class="number">8053e526</span> <span class="number">6</span>a00            push    <span class="number">0</span></span><br><span class="line"><span class="number">8053e528</span> <span class="number">6</span>a00            push    <span class="number">0</span></span><br><span class="line"><span class="number">8053e52</span>a <span class="number">6</span>a23            push    <span class="number">23</span>h</span><br><span class="line"><span class="number">8053e52</span>c <span class="number">6</span>a00            push    <span class="number">0</span></span><br><span class="line"><span class="number">8053e52</span>e <span class="number">6802020200</span>      push    <span class="number">20202</span>h</span><br><span class="line"><span class="number">8053e533</span> <span class="number">6</span>a1b            push    <span class="number">1B</span>h</span><br><span class="line"><span class="number">8053e535</span> <span class="number">6</span>a00            push    <span class="number">0</span></span><br><span class="line"><span class="number">8053e537</span> e9f8150000      jmp     nt!KiTrap06 (<span class="number">8053f</span>b34)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry2+<span class="number">0x47</span>:</span><br><span class="line"><span class="number">8053e53</span>c ebdb            jmp     nt!KiFastCallEntry2+<span class="number">0x24</span> (<span class="number">8053e519</span>)  Branch</span><br><span class="line"></span><br><span class="line"><span class="comment">//KiFastCallEntry此函数开始（//3环栈顶放到edx中 //系统调用号在eax寄存器）</span></span><br><span class="line">nt!KiFastCallEntry:</span><br><span class="line"><span class="number">8053e540</span> b923000000      mov     ecx,<span class="number">23</span>h</span><br><span class="line"><span class="number">8053e545</span> <span class="number">6</span>a30            push    <span class="number">30</span>h</span><br><span class="line"><span class="number">8053e547</span> <span class="number">0f</span>a1            pop     fs<span class="comment">//fs指向的段描述符base指向KPCR结构体的地址</span></span><br><span class="line"><span class="number">8053e549</span> <span class="number">8</span>ed9            mov     ds,cx<span class="comment">//ds置为0x23段选择子对应的段</span></span><br><span class="line"><span class="number">8053e54</span>b <span class="number">8</span>ec1            mov     es,cx<span class="comment">//es置为0x23段选择子对应的段</span></span><br><span class="line"><span class="number">8053e54</span>d <span class="number">8b</span>0d40f0dfff    mov     ecx,dword ptr ds:[<span class="number">0F</span>FDFF040h]<span class="comment">//KPCR地址+0x40偏移存的TSS地址放入ecx中，ecx为当前的TSS内存地址</span></span><br><span class="line"><span class="number">8053e553</span> <span class="number">8b</span>6104          mov     esp,dword ptr [ecx+<span class="number">4</span>]<span class="comment">//堆栈切为内核栈！！！，将TSS内存中的esp0放入esp中</span></span><br><span class="line"><span class="number">8053e556</span> <span class="number">6</span>a23            push    <span class="number">23</span>h<span class="comment">//填入ss</span></span><br><span class="line"><span class="number">8053e558</span> <span class="number">52</span>              push    edx<span class="comment">//push 3环栈顶esp</span></span><br><span class="line"><span class="number">8053e559</span> <span class="number">9</span>c              pushfd</span><br><span class="line"><span class="number">8053e55</span>a <span class="number">6</span>a02            push    <span class="number">2</span></span><br><span class="line"><span class="number">8053e55</span>c <span class="number">83</span>c208          add     edx,<span class="number">8</span><span class="comment">//edx=三环esp+8，其实就是edx现在为参数起始地址</span></span><br><span class="line"><span class="number">8053e55</span>f <span class="number">9</span>d              popfd	<span class="comment">//eflags置为2，因为eflags第二位默认为1</span></span><br><span class="line"><span class="number">8053e560</span> <span class="number">804</span>c240102      or      byte ptr [esp+<span class="number">1</span>],<span class="number">2</span><span class="comment">//将在陷阱帧中的老的eflags的第10位IF位置1，设置可屏蔽中断使能，但是只是在内存中(不是寄存器中)，所以无用</span></span><br><span class="line"><span class="number">8053e565</span> <span class="number">6</span>a1b            push    <span class="number">1B</span>h<span class="comment">//CS，写死的R3的CS</span></span><br><span class="line"><span class="number">8053e567</span> ff350403dfff    push    dword ptr ds:[<span class="number">0F</span>FDF0304h]<span class="comment">//_KUSER_SHARED_DATA中的SystemCallReturn作为eip填入陷阱帧。调用结束后返回就返回到这里。</span></span><br><span class="line"><span class="number">8053e56</span>d <span class="number">6</span>a00            push    <span class="number">0</span><span class="comment">//errCode</span></span><br><span class="line"><span class="number">8053e56</span>f <span class="number">55</span>              push    ebp</span><br><span class="line"><span class="number">8053e570</span> <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">8053e571</span> <span class="number">56</span>              push    esi</span><br><span class="line"><span class="number">8053e572</span> <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">8053e573</span> <span class="number">8b</span>1d1cf0dfff    mov     ebx,dword ptr ds:[<span class="number">0F</span>FDFF01Ch]<span class="comment">//ebx为SelfPcr自己的PCR，自己的成员指向自己</span></span><br><span class="line"><span class="number">8053e579</span> <span class="number">6</span>a3b            push    <span class="number">3B</span>h<span class="comment">//三环的fs，写死的fs</span></span><br><span class="line"><span class="number">8053e57</span>b <span class="number">8b</span>b324010000    mov     esi,dword ptr [ebx+<span class="number">124</span>h]<span class="comment">//esi为currentThread，_ETHREAD结构体地址</span></span><br><span class="line"><span class="number">8053e581</span> ff33            push    dword ptr [ebx]<span class="comment">//保存到陷阱帧的三环的exceptionList</span></span><br><span class="line"><span class="number">8053e583</span> c703ffffffff    mov     dword ptr [ebx],<span class="number">0F</span>FFFFFFFh<span class="comment">//零环的exceptionList置为-1</span></span><br><span class="line"><span class="number">8053e589</span> <span class="number">8b</span>6e18          mov     ebp,dword ptr [esi+<span class="number">18</span>h]<span class="comment">//_ethread中InitialStack放入ebp</span></span><br><span class="line"><span class="number">8053e58</span>c <span class="number">6</span>a01            push    <span class="number">1</span><span class="comment">//先前模式存为1，表示三环升零环。</span></span><br><span class="line"><span class="number">8053e58</span>e <span class="number">83</span>ec48          sub     esp,<span class="number">48</span>h<span class="comment">//之后esp指向_Trap_Frame首地址</span></span><br><span class="line"><span class="number">8053e591</span> <span class="number">81</span>ed9c020000    sub     ebp,<span class="number">29</span>Ch<span class="comment">//ebp也升，栈底到陷阱帧之间还存了很多结构，ebp提升后正常都会和esp相等。</span></span><br><span class="line"><span class="number">8053e597</span> c6864001000001  mov     byte ptr [esi+<span class="number">140</span>h],<span class="number">1</span><span class="comment">//_ethread先前模式设为1</span></span><br><span class="line"><span class="number">8053e59</span>e <span class="number">3b</span>ec            cmp     ebp,esp</span><br><span class="line"><span class="number">8053e5</span>a0 <span class="number">759</span>a            jne     nt!KiFastCallEntry2+<span class="number">0x47</span> (<span class="number">8053e53</span>c)  Branch<span class="comment">//esp和ebp不相等跳到某个异常处理。</span></span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0x62</span>:<span class="comment">//ebp和esp相等则继续执行</span></span><br><span class="line"><span class="number">8053e5</span>a2 <span class="number">83652</span>c00        and     dword ptr [ebp+<span class="number">2</span>Ch],<span class="number">0</span><span class="comment">//陷阱帧中DR7清零</span></span><br><span class="line"><span class="number">8053e5</span>a6 f6462cff        test    byte ptr [esi+<span class="number">2</span>Ch],<span class="number">0F</span>Fh<span class="comment">//判断当前线程调试状态是否激活</span></span><br><span class="line"><span class="number">8053e5</span>aa <span class="number">89</span>ae34010000    mov     dword ptr [esi+<span class="number">134</span>h],ebp<span class="comment">//记录_Ktrap_Framed地址到_ethread中的trapFrame位置，环境和线程相关了</span></span><br><span class="line"><span class="number">8053e5</span>b0 <span class="number">0f</span>854afeffff    jne     nt!Dr_FastCallDrSave (<span class="number">8053e400</span>)  Branch<span class="comment">//跳到保存调试相关部分</span></span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0x76</span>:</span><br><span class="line"><span class="number">8053e5</span>b6 <span class="number">8b</span>5d60          mov     ebx,dword ptr [ebp+<span class="number">60</span>h]<span class="comment">//ebx为ebp</span></span><br><span class="line"><span class="number">8053e5</span>b9 <span class="number">8b</span>7d68          mov     edi,dword ptr [ebp+<span class="number">68</span>h]<span class="comment">//edi为eip</span></span><br><span class="line"><span class="number">8053e5</span>bc <span class="number">89550</span>c          mov     dword ptr [ebp+<span class="number">0</span>Ch],edx<span class="comment">//将三环esp+8的地址存入_Trap_Frame中的DbgArgPointer位置</span></span><br><span class="line"><span class="number">8053e5</span>bf c74508000ddbba  mov     dword ptr [ebp+<span class="number">8</span>],<span class="number">0B</span>ADB0D00h<span class="comment">//将0BADB0D00h存入_Trap_Frame中的DbgArgMark位置</span></span><br><span class="line"><span class="number">8053e5</span>c6 <span class="number">895</span>d00          mov     dword ptr [ebp],ebx<span class="comment">//ebx存到_Trap_Frame中的DbgEbp</span></span><br><span class="line"><span class="number">8053e5</span>c9 <span class="number">897</span>d04          mov     dword ptr [ebp+<span class="number">4</span>],edi<span class="comment">////eip存到_Trap_Frame中的DbgEip</span></span><br><span class="line"><span class="number">8053e5</span>cc fb              sti<span class="comment">//允许中断</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面含义是：取出系统调用号，3环传进来的eax（共同部分，无论是KiFastCallEntry还是KiSystemService都会走的部分）后面的部分，后续有分析：</span></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0x8d</span>:</span><br><span class="line"><span class="number">8053e5</span>cd <span class="number">8b</span>f8            mov     edi,eax</span><br><span class="line"><span class="number">8053e5</span>cf c1ef08          shr     edi,<span class="number">8</span></span><br><span class="line"><span class="number">8053e5</span>d2 <span class="number">83e730</span>          and     edi,<span class="number">30</span>h</span><br><span class="line"><span class="number">8053e5</span>d5 <span class="number">8b</span>cf            mov     ecx,edi</span><br><span class="line"><span class="number">8053e5</span>d7 <span class="number">03b</span>ee0000000    add     edi,dword ptr [esi+<span class="number">0E0</span>h]</span><br><span class="line"><span class="number">8053e5</span>dd <span class="number">8b</span>d8            mov     ebx,eax</span><br><span class="line"><span class="number">8053e5</span>df <span class="number">25f</span>f0f0000      and     eax,<span class="number">0F</span>FFh</span><br><span class="line"><span class="number">8053e5</span>e4 <span class="number">3b</span>4708          cmp     eax,dword ptr [edi+<span class="number">8</span>]</span><br><span class="line"><span class="number">8053e5</span>e7 <span class="number">0f</span>8345fdffff    jae     nt!KiBBTUnexpectedRange (<span class="number">8053e332</span>)  Branch</span><br></pre></td></tr></table></figure>

<p><strong>KiFastCallEntry单独分析：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20211106145549920.png" alt="image-20211106145549920"></p>
<p> <a href="#titleA">系统调用目标内核函数后续跳转</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20211107153842092.png" alt="image-20211107153842092"></p>
<h2 id="系统服务表"><a href="#系统服务表" class="headerlink" title="系统服务表"></a>系统服务表</h2><p>上一章是关于进入0环后，3环的各种寄存器都会保留到_Trap_Frame结构体中</p>
<p>这一章是关于</p>
<ol>
<li>如何根据系统服务号(eax中存储)找到要执行的内核函数</li>
<li>调用时参数时存储的3环的堆栈，如何传递给内核函数</li>
</ol>
<h3 id="系统服务号盘点"><a href="#系统服务号盘点" class="headerlink" title="系统服务号盘点"></a>系统服务号盘点</h3><ul>
<li><code>ntoskrnl.exe</code>, x86: <a target="_blank" rel="noopener" href="http://j00ru.vexillium.org/syscalls/nt/32/">http://j00ru.vexillium.org/syscalls/nt/32/</a></li>
<li><code>ntoskrnl.exe</code>, x64: <a target="_blank" rel="noopener" href="http://j00ru.vexillium.org/syscalls/nt/64/">http://j00ru.vexillium.org/syscalls/nt/64/</a></li>
<li><code>win32k.sys</code>, x86: <a target="_blank" rel="noopener" href="http://j00ru.vexillium.org/syscalls/win32k/32/">http://j00ru.vexillium.org/syscalls/win32k/32/</a></li>
<li><code>win32k.sys</code>, x64: <a target="_blank" rel="noopener" href="http://j00ru.vexillium.org/syscalls/win32k/64/">http://j00ru.vexillium.org/syscalls/win32k/64/</a></li>
</ul>
<h3 id="系统服务表-SystemServiceTable"><a href="#系统服务表-SystemServiceTable" class="headerlink" title="系统服务表(SystemServiceTable)"></a>系统服务表(SystemServiceTable)</h3><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831192744340.png" alt="image-20210831192744340"></p>
<ul>
<li>ServiceTable指向的是函数地址表</li>
<li>COUNT当前函数地址表中的地址被调用了多少次</li>
<li>ServiceLimit当前函数地址表中一共有多少个函数</li>
<li>ArgmentTable指向的是函数参数表，<strong>函数参数表中存的是相对应每个函数的参数的【字节数】</strong>，函数参数表的每个成员只有<strong>1个字节</strong>。</li>
</ul>
<p>函数地址1就对应参数个数1，一一对应。</p>
<p>winXP只有两张系统服务表</p>
<ol>
<li>第一张是Ntoskrl.exe中的常用函数</li>
<li>第二张是Win32k.sys中的常用函数(User32.dll的底层都是使用GDI32.dll,GDI32.dll底层又是Win32k.sys)</li>
</ol>
<p>两张系统服务表挨着放到一起，每张系统服务表占16个字节，4个4字节成员。</p>
<p><strong>SystemServiceTable系统服务表的地址在_KTHREAD中0xE0偏移处存着</strong></p>
<h3 id="系统服务号如何索引"><a href="#系统服务号如何索引" class="headerlink" title="系统服务号如何索引"></a>系统服务号如何索引</h3><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831205053088.png" alt="image-20210831205053088"></p>
<ul>
<li><p>系统服务号<strong>下标为12的位</strong>：如果是0，就在第一张系统服务表，为1就在第二张系统服务表。</p>
</li>
<li><p>系统服务号的<strong>低12位</strong>：就是函数地址表和函数参数表中的索引。</p>
<p>​	<strong>目标函数地址&#x3D;dword ptr ds：[函数地址表地址+（0~11位索引）*4]</strong></p>
<p>​	<strong>目标函数参数总字节数&#x3D;byte ptr ds：[函数参数表地址+（0~11位索引）*1]</strong></p>
</li>
</ul>
<p>系统是怎么通过系统调用号查找函数的：</p>
<p><strong>继续分析KiFastCallEntry和KiSystemService后续部分</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//KiFastCallEntry和KiSystemService汇聚于此：</span></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0x8d</span>:</span><br><span class="line"><span class="number">8053e5</span>cd <span class="number">8b</span>f8            mov     edi,eax<span class="comment">//edi为系统调用号</span></span><br><span class="line"><span class="number">8053e5</span>cf c1ef08          shr     edi,<span class="number">8</span><span class="comment">//系统调用号右移8位</span></span><br><span class="line"><span class="number">8053e5</span>d2 <span class="number">83e730</span>          and     edi,<span class="number">30</span>h<span class="comment">//edi要么是0，要么是0x10，目的在于判断下标12的位是否为1，为1则edi为0x10</span></span><br><span class="line"><span class="number">8053e5</span>d5 <span class="number">8b</span>cf            mov     ecx,edi</span><br><span class="line"><span class="number">8053e5</span>d7 <span class="number">03b</span>ee0000000    add     edi,dword ptr [esi+<span class="number">0E0</span>h]<span class="comment">//esi+0xE0是_KTHREAD结构的ServiceTable(替换这个,突破口之一)，系统服务表加edi的值，系统服务表地址+0正好是第一张系统服务表，系统服务表+0x10则是第二个表，因为系统服务表占的字节大小正好是0x10。之后edi为两种系统服务表之一的首地址</span></span><br><span class="line"><span class="number">8053e5</span>dd <span class="number">8b</span>d8            mov     ebx,eax<span class="comment">//ebx为系统调用号</span></span><br><span class="line"><span class="number">8053e5</span>df <span class="number">25f</span>f0f0000      and     eax,<span class="number">0F</span>FFh<span class="comment">//eax取后12位，即函数地址表的索引</span></span><br><span class="line"><span class="number">8053e5</span>e4 <span class="number">3b</span>4708          cmp     eax,dword ptr [edi+<span class="number">8</span>]<span class="comment">//比较后12位有没有超过函数个数</span></span><br><span class="line"><span class="number">8053e5</span>e7 <span class="number">0f</span>8345fdffff    jae     nt!KiBBTUnexpectedRange (<span class="number">8053e332</span>)  Branch<span class="comment">//eax&gt;[edi+8]则跳，即超过的话表示越界，则跳转</span></span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0xad</span>:</span><br><span class="line"><span class="number">8053e5</span>ed <span class="number">83f</span>910          cmp     ecx,<span class="number">10</span>h<span class="comment">//判断ecx是否0x10</span></span><br><span class="line"><span class="number">8053e5</span>f0 <span class="number">751</span>a            jne     nt!KiFastCallEntry+<span class="number">0xcc</span> (<span class="number">8053e60</span>c)  Branch<span class="comment">//ecx不是0x10，即表示要查的是第一张表则跳转</span></span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0xb2</span>:<span class="comment">//第二张表涉及到图形函数是动态加载相关的，中间多调用了一个函数，略</span></span><br><span class="line"><span class="number">8053e5</span>f2 <span class="number">8b</span>0d18f0dfff    mov     ecx,dword ptr ds:[<span class="number">0F</span>FDFF018h]</span><br><span class="line"><span class="number">8053e5</span>f8 <span class="number">33</span>db            xor     ebx,ebx</span><br><span class="line"><span class="number">8053e5</span>fa <span class="number">0b</span>99700f0000    or      ebx,dword ptr [ecx+<span class="number">0F</span>70h]</span><br><span class="line"><span class="number">8053e600</span> <span class="number">740</span>a            je      nt!KiFastCallEntry+<span class="number">0xcc</span> (<span class="number">8053e60</span>c)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0xc2</span>:</span><br><span class="line"><span class="number">8053e602</span> <span class="number">52</span>              push    edx</span><br><span class="line"><span class="number">8053e603</span> <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">8053e604</span> ff15e43f5580    call    dword ptr [nt!KeGdiFlushUserBatch (<span class="number">80553f</span>e4)]<span class="comment">//第二章表动态加载相关的函数，GDI批量刷新用户界面</span></span><br><span class="line"><span class="number">8053e60</span>a <span class="number">58</span>              pop     eax</span><br><span class="line"><span class="number">8053e60</span>b <span class="number">5</span>a              pop     edx</span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0xcc</span>:</span><br><span class="line"><span class="number">8053e60</span>c ff0538f6dfff    inc     dword ptr ds:[<span class="number">0F</span>FDFF638h]<span class="comment">//_KPRCB地址+0x518的KeSystemCalls系统调用次数加1</span></span><br><span class="line"><span class="number">8053e612</span> <span class="number">8b</span>f2            mov     esi,edx<span class="comment">//esi为三环的参数指针</span></span><br><span class="line"><span class="number">8053e614</span> <span class="number">8b</span>5f0c          mov     ebx,dword ptr [edi+<span class="number">0</span>Ch]<span class="comment">//ebx为SST函数参数表的地址</span></span><br><span class="line"><span class="number">8053e617</span> <span class="number">33</span>c9            xor     ecx,ecx<span class="comment">//ecx清零</span></span><br><span class="line"><span class="number">8053e619</span> <span class="number">8</span>a0c18          mov     cl,byte ptr [eax+ebx]<span class="comment">//SST函数参数表的地址+系统服务号后12位索引中的值就是参数总字节数，cl为参数总字节数</span></span><br><span class="line"><span class="number">8053e61</span>c <span class="number">8b</span>3f            mov     edi,dword ptr [edi]<span class="comment">//edi为SSDT函数地址表地址</span></span><br><span class="line"><span class="number">8053e61</span>e <span class="number">8b</span>1c87          mov     ebx,dword ptr [edi+eax*<span class="number">4</span>]<span class="comment">//ebx为要调用的目标函数地址</span></span><br><span class="line"><span class="number">8053e621</span> <span class="number">2b</span>e1            sub     esp,ecx<span class="comment">//esp开辟参数总字节数的大小</span></span><br><span class="line"><span class="number">8053e623</span> c1e902          shr     ecx,<span class="number">2</span><span class="comment">//ecx为多少个4字节参数，参数个数，也是拷贝时拷贝4字节的次数</span></span><br><span class="line"><span class="number">8053e626</span> <span class="number">8b</span>fc            mov     edi,esp<span class="comment">//设置edi为要拷贝的目的地，目的是要把三环的参数拷贝到零环堆栈里来</span></span><br><span class="line"><span class="number">8053e628</span> <span class="number">3b</span>35d4995580    cmp     esi,dword ptr [nt!MmUserProbeAddress (<span class="number">805599</span>d4)]<span class="comment">//和一个全局变量(0x7FFFFFFF用户程序能访问的最大内存范围)比较，三环的参数地址有没有越界</span></span><br><span class="line"><span class="number">8053e62</span>e <span class="number">0f</span>83a8010000    jae     nt!KiSystemCallExit2+<span class="number">0x9f</span> (<span class="number">8053e7</span>dc)  Branch<span class="comment">//越界的话跳转，实际上就是跳转后判断cs是不是内核权限，是的话正常拷贝，不是的话返回C0000005错误。</span></span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0xf4</span>:</span><br><span class="line"><span class="number">8053e634</span> f3a5            rep movs dword ptr es:[edi],dword ptr [esi]<span class="comment">//开始拷贝，rep是重复的意思，拷贝的次数取决于ecx</span></span><br><span class="line"><span class="number">8053e636</span> ffd3            call    ebx<span class="comment">//终于调用目标函数！！！！！！</span></span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0xf8</span>:</span><br><span class="line"><span class="number">8053e638</span> <span class="number">8b</span>e5            mov     esp,ebp<span class="comment">//零环堆栈平栈，esp又指向了陷阱帧首地址</span></span><br><span class="line"></span><br><span class="line">nt!KiFastCallEntry+<span class="number">0xfa</span>:</span><br><span class="line"><span class="number">8053e63</span>a <span class="number">8b</span>0d24f1dfff    mov     ecx,dword ptr ds:[<span class="number">0F</span>FDFF124h]<span class="comment">//ecx为_ehtread地址</span></span><br><span class="line"><span class="number">8053e640</span> <span class="number">8b</span>553c          mov     edx,dword ptr [ebp+<span class="number">3</span>Ch]<span class="comment">//将前面临时放在edx的旧_Trap_Frame地址放到edx</span></span><br><span class="line"><span class="number">8053e643</span> <span class="number">899134010000</span>    mov     dword ptr [ecx+<span class="number">134</span>h],edx<span class="comment">//将_ethread中TrapFrame设置为前面临时放在edx的旧_Trap_Frame地址</span></span><br><span class="line"><span class="number">8053e649</span> fa              cli<span class="comment">//禁止中断发生</span></span><br><span class="line"><span class="number">8053e64</span>a f7457000000200  test    dword ptr [ebp+<span class="number">70</span>h],<span class="number">20000</span>h<span class="comment">//判断陷阱帧中eflags的VM位，就是判断是不是虚拟8086模式。</span></span><br><span class="line"><span class="number">8053e651</span> <span class="number">7506</span>            jne     nt!KiServiceExit+<span class="number">0x10</span> (<span class="number">8053e659</span>)  Branch<span class="comment">//是虚拟8086跳转</span></span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0xa</span>:</span><br><span class="line"><span class="number">8053e653</span> f6456c01        test    byte ptr [ebp+<span class="number">6</span>Ch],<span class="number">1</span><span class="comment">//判断陷阱帧中cs是R0权限还是R3权限</span></span><br><span class="line"><span class="number">8053e657</span> <span class="number">7457</span>            je      nt!KiServiceExit+<span class="number">0x67</span> (<span class="number">8053e6</span>b0)  Branch<span class="comment">//R0权限则跳转</span></span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0x10</span>:</span><br><span class="line"><span class="number">8053e659</span> <span class="number">8b</span>1d24f1dfff    mov     ebx,dword ptr ds:[<span class="number">0F</span>FDFF124h]<span class="comment">//ecx为_ehtread地址</span></span><br><span class="line"><span class="comment">//后面都是APC的，后续再分析。</span></span><br><span class="line"><span class="number">8053e65</span>f c6432e00        mov     byte ptr [ebx+<span class="number">2</span>Eh],<span class="number">0</span><span class="comment">//线程唤醒标志置0</span></span><br><span class="line"><span class="number">8053e663</span> <span class="number">807b</span>4a00        cmp     byte ptr [ebx+<span class="number">4</span>Ah],<span class="number">0</span></span><br><span class="line"><span class="number">8053e667</span> <span class="number">7447</span>            je      nt!KiServiceExit+<span class="number">0x67</span> (<span class="number">8053e6</span>b0)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0x20</span>:</span><br><span class="line"><span class="number">8053e669</span> <span class="number">8b</span>dd            mov     ebx,ebp</span><br><span class="line"><span class="number">8053e66</span>b <span class="number">894344</span>          mov     dword ptr [ebx+<span class="number">44</span>h],eax</span><br><span class="line"><span class="number">8053e66</span>e c743503b000000  mov     dword ptr [ebx+<span class="number">50</span>h],<span class="number">3B</span>h</span><br><span class="line"><span class="number">8053e675</span> c7433823000000  mov     dword ptr [ebx+<span class="number">38</span>h],<span class="number">23</span>h</span><br><span class="line"><span class="number">8053e67</span>c c7433423000000  mov     dword ptr [ebx+<span class="number">34</span>h],<span class="number">23</span>h</span><br><span class="line"><span class="number">8053e683</span> c7433000000000  mov     dword ptr [ebx+<span class="number">30</span>h],<span class="number">0</span></span><br><span class="line"><span class="number">8053e68</span>a b901000000      mov     ecx,<span class="number">1</span></span><br><span class="line"><span class="number">8053e68</span>f ff15f4864d80    call    dword ptr [nt!_imp_KfRaiseIrql (<span class="number">804</span>d86f4)]</span><br><span class="line"><span class="number">8053e695</span> <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">8053e696</span> fb              sti</span><br><span class="line"><span class="number">8053e697</span> <span class="number">53</span>              push    ebx</span><br><span class="line"><span class="number">8053e698</span> <span class="number">6</span>a00            push    <span class="number">0</span></span><br><span class="line"><span class="number">8053e69</span>a <span class="number">6</span>a01            push    <span class="number">1</span></span><br><span class="line"><span class="number">8053e69</span>c e88d03fcff      call    nt!KiDeliverApc (<span class="number">804f</span>ea2e)<span class="comment">//APC执行函数</span></span><br><span class="line"><span class="number">8053e6</span>a1 <span class="number">59</span>              pop     ecx</span><br><span class="line"><span class="number">8053e6</span>a2 ff151c874d80    call    dword ptr [nt!_imp_KfLowerIrql (<span class="number">804</span>d871c)]</span><br><span class="line"><span class="number">8053e6</span>a8 <span class="number">8b</span>4344          mov     eax,dword ptr [ebx+<span class="number">44</span>h]</span><br><span class="line"><span class="number">8053e6</span>ab fa              cli</span><br><span class="line"><span class="number">8053e6</span>ac ebab            jmp     nt!KiServiceExit+<span class="number">0x10</span> (<span class="number">8053e659</span>)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0x67</span>:<span class="comment">//现场还原</span></span><br><span class="line"><span class="number">8053e6</span>b0 <span class="number">8b</span>54244c        mov     edx,dword ptr [esp+<span class="number">4</span>Ch]<span class="comment">//edx为陷阱帧中存的异常链表</span></span><br><span class="line"><span class="number">8053e6</span>b4 <span class="number">648b</span>1d50000000  mov     ebx,dword ptr fs:[<span class="number">50</span>h]<span class="comment">//ebx为_KPCR调试激活位</span></span><br><span class="line"><span class="number">8053e6</span>bb <span class="number">64891500000000</span>  mov     dword ptr fs:[<span class="number">0</span>],edx<span class="comment">//陷阱帧中存的异常链表放回_KPCR中的异常链表位置（即返回三环异常链表）</span></span><br><span class="line"><span class="number">8053e6</span>c2 <span class="number">8b</span>4c2448        mov     ecx,dword ptr [esp+<span class="number">48</span>h]<span class="comment">//ecx为陷阱帧中先前模式</span></span><br><span class="line"><span class="number">8053e6</span>c6 <span class="number">648b</span>3524010000  mov     esi,dword ptr fs:[<span class="number">124</span>h]<span class="comment">//esi为_ethread结构地址</span></span><br><span class="line"><span class="number">8053e6</span>cd <span class="number">888e40010000</span>    mov     byte ptr [esi+<span class="number">140</span>h],cl<span class="comment">//陷阱帧中原来的先前模式放回_ethread结构地址的先前模式位置（返回原来的先前模式）</span></span><br><span class="line"><span class="number">8053e6</span>d3 f7c3ff000000    test    ebx,<span class="number">0F</span>Fh<span class="comment">//判断_KPCR调试激活位是否-1</span></span><br><span class="line"><span class="number">8053e6</span>d9 <span class="number">7579</span>            jne     nt!KiSystemCallExit2+<span class="number">0x17</span> (<span class="number">8053e754</span>)  Branch<span class="comment">//调试激活位是-1的时候跳转</span></span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0x92</span>:</span><br><span class="line"><span class="number">8053e6</span>db f744247000000200 test    dword ptr [esp+<span class="number">70</span>h],<span class="number">20000</span>h</span><br><span class="line"><span class="number">8053e6</span>e3 <span class="number">0f</span>85eb080000    jne     nt!Kei386EoiHelper+<span class="number">0x12c</span> (<span class="number">8053</span>efd4)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0xa0</span>:</span><br><span class="line"><span class="number">8053e6</span>e9 <span class="number">66f</span>744246cf8ff  test    word ptr [esp+<span class="number">6</span>Ch],<span class="number">0F</span>FF8h</span><br><span class="line"><span class="number">8053e6</span>f0 <span class="number">0f</span>84b4000000    je      nt!KiSystemCallExit2+<span class="number">0x6d</span> (<span class="number">8053e7</span>aa)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0xad</span>:</span><br><span class="line"><span class="number">8053e6</span>f6 <span class="number">66837</span>c246c1b    cmp     word ptr [esp+<span class="number">6</span>Ch],<span class="number">1B</span>h	<span class="comment">//判断一下是否三环</span></span><br><span class="line"><span class="number">8053e6</span>fc <span class="number">660f</span>ba64246c00  bt      word ptr [esp+<span class="number">6</span>Ch],<span class="number">0</span></span><br><span class="line"><span class="number">8053e703</span> f5              cmc</span><br><span class="line"><span class="number">8053e704</span> <span class="number">0f</span>878e000000    ja      nt!KiSystemCallExit2+<span class="number">0x5b</span> (<span class="number">8053e798</span>)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0xc1</span>:</span><br><span class="line"><span class="number">8053e70</span>a <span class="number">66837</span>d6c08      cmp     word ptr [ebp+<span class="number">6</span>Ch],<span class="number">8</span></span><br><span class="line"><span class="number">8053e70</span>f <span class="number">7405</span>            je      nt!KiServiceExit+<span class="number">0xcd</span> (<span class="number">8053e716</span>)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0xc8</span>:</span><br><span class="line"><span class="number">8053e711</span> <span class="number">8</span>d6550          lea     esp,[ebp+<span class="number">50</span>h]</span><br><span class="line"><span class="number">8053e714</span> <span class="number">0f</span>a1            pop     fs</span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0xcd</span>:</span><br><span class="line"><span class="number">8053e716</span> <span class="number">8</span>d6554          lea     esp,[ebp+<span class="number">54</span>h]</span><br><span class="line"><span class="number">8053e719</span> <span class="number">5f</span>              pop     edi</span><br><span class="line"><span class="number">8053e71</span>a <span class="number">5</span>e              pop     esi</span><br><span class="line"><span class="number">8053e71</span>b <span class="number">5b</span>              pop     ebx</span><br><span class="line"><span class="number">8053e71</span>c <span class="number">5</span>d              pop     ebp</span><br><span class="line"><span class="number">8053e71</span>d <span class="number">66817</span>c24088000  cmp     word ptr [esp+<span class="number">8</span>],<span class="number">80</span>h</span><br><span class="line"><span class="number">8053e724</span> <span class="number">0f</span>87c6080000    ja      nt!Kei386EoiHelper+<span class="number">0x148</span> (<span class="number">8053</span>eff0)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiServiceExit+<span class="number">0xe1</span>:</span><br><span class="line"><span class="number">8053e72</span>a <span class="number">83</span>c404          add     esp,<span class="number">4</span></span><br><span class="line"><span class="number">8053e72</span>d f744240401000000 test    dword ptr [esp+<span class="number">4</span>],<span class="number">1</span></span><br><span class="line"><span class="number">8053e735</span> <span class="number">7506</span>            jne     nt!KiSystemCallExit2 (<span class="number">8053e73</span>d)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExitBranch+<span class="number">0x2</span>:</span><br><span class="line"><span class="number">8053e737</span> <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">8053e738</span> <span class="number">59</span>              pop     ecx</span><br><span class="line"><span class="number">8053e739</span> <span class="number">9</span>d              popfd</span><br><span class="line"><span class="number">8053e73</span>a ffe2            jmp     edx</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit:</span><br><span class="line"><span class="number">8053e73</span>c cf              iretd</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2:</span><br><span class="line"><span class="number">8053e73</span>d f644240901      test    byte ptr [esp+<span class="number">9</span>],<span class="number">1</span></span><br><span class="line"><span class="number">8053e742</span> <span class="number">75f</span>8            jne     nt!KiSystemCallExit (<span class="number">8053e73</span>c)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2+<span class="number">0x7</span>:</span><br><span class="line"><span class="number">8053e744</span> <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">8053e745</span> <span class="number">83</span>c404          add     esp,<span class="number">4</span></span><br><span class="line"><span class="number">8053e748</span> <span class="number">80642401f</span>d      and     byte ptr [esp+<span class="number">1</span>],<span class="number">0F</span>Dh</span><br><span class="line"><span class="number">8053e74</span>d <span class="number">9</span>d              popfd</span><br><span class="line"><span class="number">8053e74</span>e <span class="number">59</span>              pop     ecx</span><br><span class="line"><span class="number">8053e74</span>f fb              sti</span><br><span class="line"><span class="number">8053e750</span> <span class="number">0f</span>35            sysexit<span class="comment">//sysenter进去的会用sysexit返回</span></span><br><span class="line"><span class="number">8053e752</span> cf              iretd</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2+<span class="number">0x17</span>:</span><br><span class="line"><span class="number">8053e754</span> f7457000000200  test    dword ptr [ebp+<span class="number">70</span>h],<span class="number">20000</span>h</span><br><span class="line"><span class="number">8053e75</span>b <span class="number">750</span>d            jne     nt!KiSystemCallExit2+<span class="number">0x2d</span> (<span class="number">8053e76</span>a)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2+<span class="number">0x20</span>:</span><br><span class="line"><span class="number">8053e75</span>d f7456c01000000  test    dword ptr [ebp+<span class="number">6</span>Ch],<span class="number">1</span></span><br><span class="line"><span class="number">8053e764</span> <span class="number">0f</span>8471ffffff    je      nt!KiServiceExit+<span class="number">0x92</span> (<span class="number">8053e6</span>db)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2+<span class="number">0x2d</span>:</span><br><span class="line"><span class="number">8053e76</span>a <span class="number">33</span>db            xor     ebx,ebx</span><br><span class="line"><span class="number">8053e76</span>c <span class="number">8b</span>7518          mov     esi,dword ptr [ebp+<span class="number">18</span>h]</span><br><span class="line"><span class="number">8053e76</span>f <span class="number">8b</span>7d1c          mov     edi,dword ptr [ebp+<span class="number">1</span>Ch]</span><br><span class="line"><span class="number">8053e772</span> <span class="number">0f</span>23fb          mov     dr7,ebx</span><br><span class="line"><span class="number">8053e775</span> <span class="number">0f</span>23c6          mov     dr0,esi</span><br><span class="line"><span class="number">8053e778</span> <span class="number">8b</span>5d20          mov     ebx,dword ptr [ebp+<span class="number">20</span>h]</span><br><span class="line"><span class="number">8053e77</span>b <span class="number">0f</span>23cf          mov     dr1,edi</span><br><span class="line"><span class="number">8053e77</span>e <span class="number">0f</span>23d3          mov     dr2,ebx</span><br><span class="line"><span class="number">8053e781</span> <span class="number">8b</span>7524          mov     esi,dword ptr [ebp+<span class="number">24</span>h]</span><br><span class="line"><span class="number">8053e784</span> <span class="number">8b</span>7d28          mov     edi,dword ptr [ebp+<span class="number">28</span>h]</span><br><span class="line"><span class="number">8053e787</span> <span class="number">8b</span>5d2c          mov     ebx,dword ptr [ebp+<span class="number">2</span>Ch]</span><br><span class="line"><span class="number">8053e78</span>a <span class="number">0f</span>23de          mov     dr3,esi</span><br><span class="line"><span class="number">8053e78</span>d <span class="number">0f</span>23f7          mov     dr6,edi</span><br><span class="line"><span class="number">8053e790</span> <span class="number">0f</span>23fb          mov     dr7,ebx</span><br><span class="line"><span class="number">8053e793</span> e943ffffff      jmp     nt!KiServiceExit+<span class="number">0x92</span> (<span class="number">8053e6</span>db)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2+<span class="number">0x5b</span>:</span><br><span class="line"><span class="number">8053e798</span> <span class="number">8b</span>442444        mov     eax,dword ptr [esp+<span class="number">44</span>h]</span><br><span class="line"><span class="number">8053e79</span>c <span class="number">83</span>c430          add     esp,<span class="number">30</span>h</span><br><span class="line"><span class="number">8053e79</span>f <span class="number">0f</span>a9            pop     gs</span><br><span class="line"><span class="number">8053e7</span>a1 <span class="number">07</span>              pop     es</span><br><span class="line"><span class="number">8053e7</span>a2 <span class="number">1f</span>              pop     ds</span><br><span class="line"><span class="number">8053e7</span>a3 <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">8053e7</span>a4 <span class="number">59</span>              pop     ecx</span><br><span class="line"><span class="number">8053e7</span>a5 e967ffffff      jmp     nt!KiServiceExit+<span class="number">0xc8</span> (<span class="number">8053e711</span>)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2+<span class="number">0x6d</span>:</span><br><span class="line"><span class="number">8053e7</span>aa <span class="number">8b</span>5c2410        mov     ebx,dword ptr [esp+<span class="number">10</span>h]</span><br><span class="line"><span class="number">8053e7</span>ae <span class="number">895</span>c246c        mov     dword ptr [esp+<span class="number">6</span>Ch],ebx</span><br><span class="line"><span class="number">8053e7</span>b2 <span class="number">8b</span>5c2414        mov     ebx,dword ptr [esp+<span class="number">14</span>h]</span><br><span class="line"><span class="number">8053e7</span>b6 <span class="number">83</span>eb0c          sub     ebx,<span class="number">0</span>Ch</span><br><span class="line"><span class="number">8053e7</span>b9 <span class="number">895</span>c2464        mov     dword ptr [esp+<span class="number">64</span>h],ebx</span><br><span class="line"><span class="number">8053e7</span>bd <span class="number">8b</span>742470        mov     esi,dword ptr [esp+<span class="number">70</span>h]</span><br><span class="line"><span class="number">8053e7</span>c1 <span class="number">897308</span>          mov     dword ptr [ebx+<span class="number">8</span>],esi</span><br><span class="line"><span class="number">8053e7</span>c4 <span class="number">8b</span>74246c        mov     esi,dword ptr [esp+<span class="number">6</span>Ch]</span><br><span class="line"><span class="number">8053e7</span>c8 <span class="number">897304</span>          mov     dword ptr [ebx+<span class="number">4</span>],esi</span><br><span class="line"><span class="number">8053e7</span>cb <span class="number">8b</span>742468        mov     esi,dword ptr [esp+<span class="number">68</span>h]</span><br><span class="line"><span class="number">8053e7</span>cf <span class="number">8933</span>            mov     dword ptr [ebx],esi</span><br><span class="line"><span class="number">8053e7</span>d1 <span class="number">83</span>c454          add     esp,<span class="number">54</span>h</span><br><span class="line"><span class="number">8053e7</span>d4 <span class="number">5f</span>              pop     edi</span><br><span class="line"><span class="number">8053e7</span>d5 <span class="number">5</span>e              pop     esi</span><br><span class="line"><span class="number">8053e7</span>d6 <span class="number">5b</span>              pop     ebx</span><br><span class="line"><span class="number">8053e7</span>d7 <span class="number">5</span>d              pop     ebp</span><br><span class="line"><span class="number">8053e7</span>d8 <span class="number">8b</span>2424          mov     esp,dword ptr [esp]</span><br><span class="line"><span class="number">8053e7</span>db cf              iretd</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2+<span class="number">0x9f</span>:</span><br><span class="line"><span class="number">8053e7</span>dc f6456c01        test    byte ptr [ebp+<span class="number">6</span>Ch],<span class="number">1</span></span><br><span class="line"><span class="number">8053e7</span>e0 <span class="number">0f</span>844efeffff    je      nt!KiFastCallEntry+<span class="number">0xf4</span> (<span class="number">8053e634</span>)  Branch</span><br><span class="line"></span><br><span class="line">nt!KiSystemCallExit2+<span class="number">0xa9</span>:</span><br><span class="line"><span class="number">8053e7</span>e6 b8050000c0      mov     eax,<span class="number">0</span>C0000005h</span><br><span class="line"><span class="number">8053e7</span>eb e948feffff      jmp     nt!KiFastCallEntry+<span class="number">0xf8</span> (<span class="number">8053e638</span>)  Branch</span><br><span class="line"></span><br><span class="line">nt!Kei386EoiHelper+<span class="number">0x12c</span>:</span><br><span class="line"><span class="number">8053</span>efd4 <span class="number">83</span>c43c          add     esp,<span class="number">3</span>Ch</span><br><span class="line"><span class="number">8053</span>efd7 <span class="number">5</span>a              pop     edx</span><br><span class="line"><span class="number">8053</span>efd8 <span class="number">59</span>              pop     ecx</span><br><span class="line"><span class="number">8053</span>efd9 <span class="number">58</span>              pop     eax</span><br><span class="line"><span class="number">8053</span>efda <span class="number">8</span>d6554          lea     esp,[ebp+<span class="number">54</span>h]</span><br><span class="line"><span class="number">8053</span>efdd <span class="number">5f</span>              pop     edi</span><br><span class="line"><span class="number">8053</span>efde <span class="number">5</span>e              pop     esi</span><br><span class="line"><span class="number">8053</span>efdf <span class="number">5b</span>              pop     ebx</span><br><span class="line"><span class="number">8053</span>efe0 <span class="number">5</span>d              pop     ebp</span><br><span class="line"><span class="number">8053</span>efe1 <span class="number">66817</span>c24088000  cmp     word ptr [esp+<span class="number">8</span>],<span class="number">80</span>h</span><br><span class="line"><span class="number">8053</span>efe8 <span class="number">7706</span>            ja      nt!Kei386EoiHelper+<span class="number">0x148</span> (<span class="number">8053</span>eff0)  Branch</span><br><span class="line"></span><br><span class="line">nt!Kei386EoiHelper+<span class="number">0x142</span>:</span><br><span class="line"><span class="number">8053</span>efea <span class="number">83</span>c404          add     esp,<span class="number">4</span></span><br><span class="line"><span class="number">8053</span>efed cf              iretd</span><br><span class="line"></span><br><span class="line">nt!Kei386EoiHelper+<span class="number">0x148</span>:</span><br><span class="line"><span class="number">8053</span>eff0 <span class="number">66837</span>c240200    cmp     word ptr [esp+<span class="number">2</span>],<span class="number">0</span></span><br><span class="line"><span class="number">8053</span>eff6 <span class="number">74f</span>2            je      nt!Kei386EoiHelper+<span class="number">0x142</span> (<span class="number">8053</span>efea)  Branch</span><br><span class="line"></span><br><span class="line">nt!Kei386EoiHelper+<span class="number">0x150</span>:</span><br><span class="line"><span class="number">8053</span>eff8 <span class="number">66833</span>c2400      cmp     word ptr [esp],<span class="number">0</span></span><br><span class="line"><span class="number">8053</span>effd <span class="number">75</span>eb            jne     nt!Kei386EoiHelper+<span class="number">0x142</span> (<span class="number">8053</span>efea)  Branch</span><br><span class="line"></span><br><span class="line">nt!Kei386EoiHelper+<span class="number">0x157</span>:</span><br><span class="line"><span class="number">8053</span>efff c12c2410        shr     dword ptr [esp],<span class="number">10</span>h</span><br><span class="line"><span class="number">8053f</span>003 <span class="number">66</span>c7442402f800  mov     word ptr [esp+<span class="number">2</span>],<span class="number">0F</span>8h</span><br><span class="line"><span class="number">8053f</span>00a <span class="number">660f</span>b22424      lss     sp,dword ptr [esp]</span><br><span class="line"><span class="number">8053f</span>00f <span class="number">0f</span>b7e4          movzx   esp,sp</span><br><span class="line"><span class="number">8053f</span>012 cf              iretd</span><br></pre></td></tr></table></figure>

<p> <a id="titleA">系统调用号使用流程图</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20211107202221078.png" alt="image-20211107202221078"></p>
<h3 id="SSDT"><a href="#SSDT" class="headerlink" title="SSDT"></a>SSDT</h3><p>上一章通过_kthread的0xE0偏移找到SST</p>
<p>其实还可以通过其他方式来访问系统服务表</p>
<p>就是SSDT</p>
<p><strong>SSDT：System Services Descriptor Table，系统服务描述符表</strong>。</p>
<h4 id="其他两种方式查看SST"><a href="#其他两种方式查看SST" class="headerlink" title="其他两种方式查看SST"></a>其他两种方式查看SST</h4><h5 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h5><p>这种方式只能看第一张SST</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd KeServiceDescriptorTable<span class="comment">//(简称：SSDT)</span></span><br></pre></td></tr></table></figure>

<p>ntkrnlpa.exe或ntoskrnl.exe导出的，代码中声明一下就可以使用</p>
<p>KeServiceDescriptorTable是ntkrnlpa.exe或ntoskrnl.exe导出的全局变量</p>
<h5 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h5><p>这种方式两张SST都有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd KeServiceDescriptorTableShadow<span class="comment">//(简称：SSDT Shadow)</span></span><br></pre></td></tr></table></figure>

<p>KeServiceDescriptorTableShadow是Win32k.sys导出的</p>
<p>代码中要自己通过内存搜索的方式到Win32k.sys的导出表中找到他的地址。</p>
<h4 id="课后练习"><a href="#课后练习" class="headerlink" title="课后练习"></a>课后练习</h4><p>在SSDT表中追加一个函数地址（NtReadVirtualMemory），自己编写API的3环部分调用这个新增的函数(注意使用2-9-9-12分页，因为10-10-12分页会有蓝屏现象(调用返回还没涉及)</p>
<h5 id="R0代码"><a href="#R0代码" class="headerlink" title="R0代码"></a>R0代码</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//卸载函数</span></span><br><span class="line">VOID <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT driver)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;停止运行了\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SST</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG ServiceTable;</span><br><span class="line">	ULONG Count;</span><br><span class="line">	ULONG ServiceLimit;</span><br><span class="line">	ULONG ArgmentTable;</span><br><span class="line">&#125;SST;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> ULONG KeServiceDescriptorTable;<span class="comment">//声明系统内核导出的全局变量</span></span><br><span class="line"><span class="comment">//入口函数，相当于main函数</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pdriver, PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//设置一个卸载函数，用于退出</span></span><br><span class="line">	pdriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	<span class="comment">//修改SST表中的数据。</span></span><br><span class="line">	SST* sst1 = (SST*)KeServiceDescriptorTable;</span><br><span class="line">	ULONG num = sst1-&gt;ServiceLimit;</span><br><span class="line">	ULONG ftAddr = sst1-&gt;ServiceTable;</span><br><span class="line">	ULONG ftArgAddr = sst1-&gt;ArgmentTable;</span><br><span class="line">	DbgPrint(<span class="string">&quot;原来共有%d个函数\n&quot;</span>, num);</span><br><span class="line">	DbgPrint(<span class="string">&quot;修改的函数地址位置：%p\n&quot;</span>, (*(ULONG*)sst1) + num * <span class="number">4</span>);</span><br><span class="line">	DbgPrint(<span class="string">&quot;修改的函数参数位置：%p\n&quot;</span>, (*(ULONG*)((ULONG)sst1 + <span class="number">0xC</span>)) + num);</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		pushad;</span><br><span class="line">		mov eax, dword ptr ds : [ftArgAddr] ;</span><br><span class="line">		mov ecx, dword ptr ds : [num] ;</span><br><span class="line">		mov edx, <span class="number">0xBA</span>;<span class="comment">//NtReadVirtualMemory系统服务号</span></span><br><span class="line">		mov bl, byte ptr ds : [eax + edx] ;</span><br><span class="line">		lea edi, dword ptr ds : [eax + ecx] ;</span><br><span class="line">		mov byte ptr ds : [edi] , bl;<span class="comment">//更换函数参数</span></span><br><span class="line">		mov eax, dword ptr ds : [ftAddr] ;</span><br><span class="line">		shl edx, <span class="number">2</span>;</span><br><span class="line">		mov ebx, dword ptr ds : [eax + edx] ;</span><br><span class="line">		shl ecx, <span class="number">2</span>;</span><br><span class="line">		lea edi, dword ptr ds : [eax + ecx] ;</span><br><span class="line">		mov dword ptr ds : [edi] , ebx;<span class="comment">//更换函数参数总字节数</span></span><br><span class="line">        <span class="comment">//函数个数+1</span></span><br><span class="line">		mov eax, dword ptr ds : [sst1] ;</span><br><span class="line">		add eax, <span class="number">0x8</span>;</span><br><span class="line">		add dword ptr ds : [eax] , <span class="number">1</span>;</span><br><span class="line">		popad;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="R3代码"><a href="#R3代码" class="headerlink" title="R3代码"></a>R3代码</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __stdcall <span class="title function_">myReadProcessMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">  HANDLE  hProcess,</span></span><br><span class="line"><span class="params">  LPCVOID lpBaseAddress,</span></span><br><span class="line"><span class="params">  LPVOID  lpBuffer,</span></span><br><span class="line"><span class="params">  SIZE_T  nSize,</span></span><br><span class="line"><span class="params">  SIZE_T  *lpNumberOfBytesRead</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		push lpNumberOfBytesRead;</span><br><span class="line">		push nSize;</span><br><span class="line">		push lpBuffer;</span><br><span class="line">		push lpBaseAddress;</span><br><span class="line">		push hProcess;</span><br><span class="line">		mov eax,<span class="number">0x11c</span>;<span class="comment">//放在这个位置上</span></span><br><span class="line">		lea edx,dword ptr [esp];</span><br><span class="line">		<span class="type">int</span> <span class="number">0x2E</span>;</span><br><span class="line">		add esp,<span class="number">0x14</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> a=<span class="number">300</span>;</span><br><span class="line">	SIZE_T haveRead;</span><br><span class="line">	HANDLE hProcess=OpenProcess(PROCESS_ALL_ACCESS,<span class="literal">NULL</span>,<span class="number">1552</span>);</span><br><span class="line">	myReadProcessMemory(hProcess,(LPVOID)<span class="number">0x12ff7c</span>,&amp;a,<span class="number">4</span>,&amp;haveRead);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;old a:300   new a after readMemory:%d&quot;</span>,a);</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210904123123962.png" alt="image-20210904123123962"></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210904123102688.png" alt="image-20210904123102688"></p>
<p>修改后函数个数：<img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210904123203383.png" alt="image-20210904123203383"></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210904121940924.png" alt="image-20210904121940924"></p>
<p><strong>关于API调用返回的问题：学完APC后再分析</strong></p>
<h2 id="SSDT-HOOK"><a href="#SSDT-HOOK" class="headerlink" title="SSDT HOOK"></a>SSDT HOOK</h2><ul>
<li>优点：挂起来很容易，并且非常稳定</li>
<li>缺点：容易被发现，容易被绕过，只能HOOK系统服务表里的函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//下面两个结构的名字都可以随便起。</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KSYSTEM_SERVICE_TABLE</span>  //对应<span class="title">SST</span></span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">    PULONG  ServiceTableBase;                               		<span class="comment">// 服务函数地址表基址  </span></span><br><span class="line">    PULONG  ServiceCounterTableBase;                        	    </span><br><span class="line">    ULONG   NumberOfService;                                		<span class="comment">// 服务函数的个数  </span></span><br><span class="line">    PULONG   ParamTableBase;                                		<span class="comment">// 服务函数参数表基址   </span></span><br><span class="line">&#125; KSYSTEM_SERVICE_TABLE, *PKSYSTEM_SERVICE_TABLE;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KSERVICE_TABLE_DESCRIPTOR</span>  //对应<span class="title">SSDT</span></span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">    KSYSTEM_SERVICE_TABLE   ntoskrnl;                       <span class="comment">// ntoskrnl.exe 的服务函数  </span></span><br><span class="line">    KSYSTEM_SERVICE_TABLE   win32k;                         <span class="comment">// win32k.sys 的服务函数(GDI32.dll/User32.dll 的内核支持)  </span></span><br><span class="line">    KSYSTEM_SERVICE_TABLE   notUsed1;  </span><br><span class="line">    KSYSTEM_SERVICE_TABLE   notUsed2;  </span><br><span class="line">&#125;KSERVICE_TABLE_DESCRIPTOR, *PKSERVICE_TABLE_DESCRIPTOR;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//导出由 ntoskrnl所导出的 SSDT</span></span><br><span class="line"><span class="keyword">extern</span> PKSERVICE_TABLE_DESCRIPTOR KeServiceDescriptorTable;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="通过页表基址修改页属性"><a href="#通过页表基址修改页属性" class="headerlink" title="通过页表基址修改页属性"></a>通过页表基址修改页属性</h3><p>SSDT所在物理页是只读的，如果要修改别的进程(修改自己进程无所谓)，先要修改页属性为可写的，两种方法</p>
<h4 id="第一种办法"><a href="#第一种办法" class="headerlink" title="第一种办法"></a>第一种办法</h4><p>用我们学过的知识，通过页表基址直接修改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过CR4判断是什么分页</span></span><br><span class="line"><span class="keyword">if</span>(RCR4 &amp; <span class="number">0x00000020</span>)</span><br><span class="line">&#123;<span class="comment">//说明是2-9-9-12分页</span></span><br><span class="line">	KdPrint((<span class="string">&quot;2-9-9-12分页 %p\n&quot;</span>,RCR4));</span><br><span class="line">	KdPrint((<span class="string">&quot;PTE1 %p\n&quot;</span>,*(DWORD*)(<span class="number">0xC0000000</span> + ((HookFunAddr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x007FFFF8</span>))));</span><br><span class="line">	*(DWORD64*)(<span class="number">0xC0000000</span> + ((HookFunAddr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x007FFFF8</span>)) |= <span class="number">0x02</span>; </span><br><span class="line">	KdPrint((<span class="string">&quot;PTE1 %p\n&quot;</span>,*(DWORD*)(<span class="number">0xC0000000</span> + ((HookFunAddr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x007FFFF8</span>))));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;<span class="comment">//说明是10-10-12分页</span></span><br><span class="line">	KdPrint((<span class="string">&quot;10-10-12分页\n&quot;</span>));</span><br><span class="line">	KdPrint((<span class="string">&quot;PTE1 %p\n&quot;</span>,*(DWORD*)(<span class="number">0xC0000000</span> + ((HookFunAddr &gt;&gt; <span class="number">10</span>) &amp; <span class="number">0x003FFFFC</span>))));</span><br><span class="line">	*(DWORD*)(<span class="number">0xC0000000</span> + ((HookFunAddr &gt;&gt; <span class="number">10</span>) &amp; <span class="number">0x003FFFFC</span>)) |= <span class="number">0x02</span>;</span><br><span class="line">	KdPrint((<span class="string">&quot;PTE2 %p\n&quot;</span>,*(DWORD*)(<span class="number">0xC0000000</span> + ((HookFunAddr &gt;&gt; <span class="number">10</span>) &amp; <span class="number">0x003FFFFC</span>))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式的好处是不用关心是单核还是多核</p>
<h4 id="第二种方法"><a href="#第二种方法" class="headerlink" title="第二种方法"></a>第二种方法</h4><p>通过修改CR0寄存器的WP位</p>
<p>由于修改的CR0寄存器每个核都有一个，这个修改的过程中，如果发生核的切换（cli只是线程无法切换了）多核还是可能切换，导致WP位并未修改。</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210905142808963.png" alt="image-20210905142808963"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">PageProtectOn</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">			mov  eax,cr0</span><br><span class="line">			or   eax,<span class="number">10000</span>h</span><br><span class="line">			mov  cr0,eax</span><br><span class="line">			sti</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">PageProtectOff</span><span class="params">()</span>				</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">			cli					</span><br><span class="line">			mov  eax,cr0</span><br><span class="line">			and  eax,not <span class="number">10000</span>h</span><br><span class="line">			mov  cr0,eax</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PageProtectOff();</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始修改。。。</span></span><br><span class="line"></span><br><span class="line">PageProtectOn();</span><br></pre></td></tr></table></figure>

<p>改代码的一瞬间如果并未有核的切换就没问题。不然就会出问题。</p>
<h3 id="SSDT-HOOK实验"><a href="#SSDT-HOOK实验" class="headerlink" title="SSDT HOOK实验"></a>SSDT HOOK实验</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//下面两个结构的名字都可以随便起。</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KSYSTEM_SERVICE_TABLE</span>  //对应<span class="title">SST</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    PULONG  ServiceTableBase;                               		<span class="comment">// 服务函数地址表基址  </span></span><br><span class="line">    PULONG  ServiceCounterTableBase;</span><br><span class="line">    ULONG   NumberOfService;                                		<span class="comment">// 服务函数的个数  </span></span><br><span class="line">    PULONG   ParamTableBase;                                		<span class="comment">// 服务函数参数表基址   </span></span><br><span class="line">&#125; KSYSTEM_SERVICE_TABLE, * PKSYSTEM_SERVICE_TABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KSERVICE_TABLE_DESCRIPTOR</span>  //对应<span class="title">SSDT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    KSYSTEM_SERVICE_TABLE   ntoskrnl;                       <span class="comment">// ntoskrnl.exe 的服务函数  </span></span><br><span class="line">    KSYSTEM_SERVICE_TABLE   win32k;                         <span class="comment">// win32k.sys 的服务函数(GDI32.dll/User32.dll 的内核支持)  </span></span><br><span class="line">    KSYSTEM_SERVICE_TABLE   notUsed1;</span><br><span class="line">    KSYSTEM_SERVICE_TABLE   notUsed2;</span><br><span class="line">&#125;KSERVICE_TABLE_DESCRIPTOR, * PKSERVICE_TABLE_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">//导出由 ntoskrnl所导出的 SSDT</span></span><br><span class="line"><span class="keyword">extern</span> PKSERVICE_TABLE_DESCRIPTOR KeServiceDescriptorTable;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">PageProtectOn</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm &#123;</span><br><span class="line">		mov  eax, cr0</span><br><span class="line">		or eax, <span class="number">10000</span>h</span><br><span class="line">		mov  cr0, eax</span><br><span class="line">		sti</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">PageProtectOff</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm &#123;</span><br><span class="line">		cli</span><br><span class="line">		mov  eax, cr0</span><br><span class="line">		and eax, not <span class="number">10000</span>h</span><br><span class="line">		mov  cr0, eax</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ULONG oldNtReadVirtualMemoryAdd = <span class="literal">NULL</span>;<span class="comment">//原来的地址</span></span><br><span class="line"></span><br><span class="line">NTSTATUS __stdcall <span class="title function_">MYNtReadVirtualMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">	HANDLE ProcessHandle,</span></span><br><span class="line"><span class="params">	PVOID BaseAddress,</span></span><br><span class="line"><span class="params">	PVOID Buffer,</span></span><br><span class="line"><span class="params">	ULONG BufferLength,</span></span><br><span class="line"><span class="params">	PULONG ReturnLength)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//执行想执行的</span></span><br><span class="line">	DbgPrint(<span class="string">&quot;someOne use NtReadVirtualMemory---SSDT HOOK\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//执行原函数</span></span><br><span class="line">	NTSTATUS result = <span class="number">0</span>;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		push ReturnLength;</span><br><span class="line">		push BufferLength;</span><br><span class="line">		push Buffer;</span><br><span class="line">		push BaseAddress;</span><br><span class="line">		push ProcessHandle;</span><br><span class="line">		call oldNtReadVirtualMemoryAdd;</span><br><span class="line">		mov result, eax;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//卸载函数</span></span><br><span class="line">VOID <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT driver)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//恢复SSDT HOOK</span></span><br><span class="line">	<span class="keyword">if</span> (oldNtReadVirtualMemoryAdd)</span><br><span class="line">	&#123;</span><br><span class="line">		PageProtectOff();</span><br><span class="line">		KeServiceDescriptorTable-&gt;ntoskrnl.ServiceTableBase[<span class="number">0xBA</span>] = oldNtReadVirtualMemoryAdd;</span><br><span class="line">		PageProtectOn();</span><br><span class="line">		oldNtReadVirtualMemoryAdd = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DbgPrint(<span class="string">&quot;停止运行了\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//入口函数，相当于main函数</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pdriver, PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//设置一个卸载函数，用于退出</span></span><br><span class="line">	pdriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	<span class="comment">//保存原地址</span></span><br><span class="line">	oldNtReadVirtualMemoryAdd = KeServiceDescriptorTable-&gt;ntoskrnl.ServiceTableBase[<span class="number">0xBA</span>];</span><br><span class="line">	DbgPrint(<span class="string">&quot;修改位置为：%p\n&quot;</span>, &amp;(KeServiceDescriptorTable-&gt;ntoskrnl.ServiceTableBase[<span class="number">0xBA</span>]));</span><br><span class="line">	DbgPrint(<span class="string">&quot;原函数地址为：%p\n&quot;</span>, oldNtReadVirtualMemoryAdd);</span><br><span class="line">	PageProtectOff();</span><br><span class="line">	<span class="comment">//修改SST对应的0xBA服务号的函数</span></span><br><span class="line">	KeServiceDescriptorTable-&gt;ntoskrnl.ServiceTableBase[<span class="number">0xBA</span>] = MYNtReadVirtualMemory;</span><br><span class="line">	PageProtectOn();</span><br><span class="line">	DbgPrint(<span class="string">&quot;修改后的函数地址为：%p\n&quot;</span>, KeServiceDescriptorTable-&gt;ntoskrnl.ServiceTableBase[<span class="number">0xBA</span>]);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210906134948152.png" alt="image-20210906134948152"></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210906135151739.png" alt="image-20210906135151739"></p>
<p>如图，SSDT HOOK成功实现，但也被pc hunter轻易发现。</p>
<h3 id="SSDT-HOOK隐藏"><a href="#SSDT-HOOK隐藏" class="headerlink" title="SSDT HOOK隐藏"></a>SSDT HOOK隐藏</h3><p>先做自己的进程，非全局</p>
<ol>
<li>首先找到自己的进程，进程遍历</li>
<li>遍历线程</li>
<li>替换_KTHREAD的0xE0存的SSDT表</li>
<li>定时器</li>
</ol>
<p><strong>后续回头做</strong></p>
<h2 id="0环回3环"><a href="#0环回3环" class="headerlink" title="0环回3环"></a><a target="_blank" rel="noopener" href="https://www.pianshen.com/article/2774609984/">0环回3环</a></h2><p>系统调用第二天1小时28分逆向调用返回。（未完就绪）</p>
<p>_KiFastCallEntry由三部分组成</p>
<ol>
<li>创建_KTRAP_FRAME结构备份三环信息</li>
<li>根据系统调用号调用内核中的服务过程</li>
<li>通过1步骤备份的_KTRAP_FRAME结构体返回3环（_KiServiceExit）</li>
</ol>
<h2 id="ZW系列内核函数和NT系列内核函数的区别"><a href="#ZW系列内核函数和NT系列内核函数的区别" class="headerlink" title="ZW系列内核函数和NT系列内核函数的区别"></a>ZW系列内核函数和NT系列内核函数的区别</h2><p> 在ring3层，这两组函数确实是同一个函数，用u命令对NtReadFile以及ZwReadFile反汇编发现，他们的起始地址是一样的。调用ntdll.dll这个动态库的函数时，声明成这两种形式都可以，不过按照微软的说法，声明成Nt函数更恰当些，Zw开头的函数表示的是内核函数。熟悉ntdll.dll这个动态库的人都知道，其实这个库里面的函数都是stub函数，并不做实际功能，只是系统调用进入内核的入口。</p>
<p>​    到了ring0层情况就不同了，两种形式的函数是不同的函数，Nt开头的函数是真正执行功能的函数。应用层所用的系统API都会通过int 2e或者sysenter指令切换到内核，然后调用内核导出的Nt系列函数。分析SSDT表即可以得出这个结论。</p>
<p>​    而对于内核态的Zw开头的函数，通过汇编也可以发现，它的结构与ntdll.dll里面的函数类似，最后都会调用对应的内核nt函数，只不过已经在内核态，就没有int 2e这种切换状态的指令，也没有陷阱帧，但调用形式差不多，都是通过调用号来从SSDT中找到实现功能的Nt函数。微软建议内核开发者使用Zw系列的函数，因为这些函数多了一些参数检查的代码。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/%E5%86%85%E6%A0%B8%E7%9B%B8%E5%85%B3/" rel="tag"># 内核相关</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2f57a694/" rel="prev" title="正则表达式">
      <i class="fa fa-chevron-left"></i> 正则表达式
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/7e077f73/" rel="next" title="PR">
      PR <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#API%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">API函数的调用过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E7%8E%AF%E9%83%A8%E5%88%86"><span class="nav-number">1.1.</span> <span class="nav-text">3环部分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90ReadProcessMemory"><span class="nav-number">1.1.1.</span> <span class="nav-text">分析ReadProcessMemory</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BE%E5%90%8E%E7%BB%83%E4%B9%A0%EF%BC%9A"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">课后练习：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E7%8E%AF%E8%BF%9B0%E7%8E%AF"><span class="nav-number">1.2.</span> <span class="nav-text">3环进0环</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#KUSER-SHARED-DATA%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.1.</span> <span class="nav-text">_KUSER_SHARED_DATA结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KiFastSystemCall%E4%B8%8EKiIntSystemCall%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.2.2.</span> <span class="nav-text">KiFastSystemCall与KiIntSystemCall的区别</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KiIntSystemCall"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">KiIntSystemCall</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KiFastSystemCall"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">KiFastSystemCall</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API%E8%BF%9B%E9%9B%B6%E7%8E%AF%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="nav-number">1.2.3.</span> <span class="nav-text">API进零环的两种方式总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%80%83"><span class="nav-number">1.2.4.</span> <span class="nav-text">思考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E7%BB%93%E6%9E%84%E4%BD%93%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.3.</span> <span class="nav-text">内核结构体介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ktrap-frame%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.3.1.</span> <span class="nav-text">_Ktrap_frame结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#THREAD%E7%BA%BF%E7%A8%8B%E7%9B%B8%E5%85%B3%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.3.2.</span> <span class="nav-text">THREAD线程相关的结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ETHREAD%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">_ETHREAD结构体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KTHREAD%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">_KTHREAD结构体</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.3.3.</span> <span class="nav-text">CPU相关结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CPU%E7%9B%B8%E5%85%B3windbg%E6%8C%87%E4%BB%A4"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">CPU相关windbg指令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BCPU%E6%95%B0%E9%87%8F"><span class="nav-number">1.3.3.1.1.</span> <span class="nav-text">查看CPU数量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BKPRCB%E5%AD%98%E5%9C%A8%E5%93%AA%E9%87%8C"><span class="nav-number">1.3.3.1.2.</span> <span class="nav-text">查看KPRCB存在哪里</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KPCR%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">_KPCR结构体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KPRCB%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">_KPRCB结构体</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90KiStstemService%E5%92%8CKiFastCallEntry"><span class="nav-number">1.4.</span> <span class="nav-text">分析KiStstemService和KiFastCallEntry</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E8%A1%A8"><span class="nav-number">1.5.</span> <span class="nav-text">系统服务表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E5%8F%B7%E7%9B%98%E7%82%B9"><span class="nav-number">1.5.1.</span> <span class="nav-text">系统服务号盘点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E8%A1%A8-SystemServiceTable"><span class="nav-number">1.5.2.</span> <span class="nav-text">系统服务表(SystemServiceTable)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E5%8F%B7%E5%A6%82%E4%BD%95%E7%B4%A2%E5%BC%95"><span class="nav-number">1.5.3.</span> <span class="nav-text">系统服务号如何索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSDT"><span class="nav-number">1.5.4.</span> <span class="nav-text">SSDT</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%9F%A5%E7%9C%8BSST"><span class="nav-number">1.5.4.1.</span> <span class="nav-text">其他两种方式查看SST</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">1.5.4.1.1.</span> <span class="nav-text">第一种方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">1.5.4.1.2.</span> <span class="nav-text">第二种方式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BE%E5%90%8E%E7%BB%83%E4%B9%A0"><span class="nav-number">1.5.4.2.</span> <span class="nav-text">课后练习</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#R0%E4%BB%A3%E7%A0%81"><span class="nav-number">1.5.4.2.1.</span> <span class="nav-text">R0代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#R3%E4%BB%A3%E7%A0%81"><span class="nav-number">1.5.4.2.2.</span> <span class="nav-text">R3代码</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSDT-HOOK"><span class="nav-number">1.6.</span> <span class="nav-text">SSDT HOOK</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E9%A1%B5%E8%A1%A8%E5%9F%BA%E5%9D%80%E4%BF%AE%E6%94%B9%E9%A1%B5%E5%B1%9E%E6%80%A7"><span class="nav-number">1.6.1.</span> <span class="nav-text">通过页表基址修改页属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E5%8A%9E%E6%B3%95"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">第一种办法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">第二种方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSDT-HOOK%E5%AE%9E%E9%AA%8C"><span class="nav-number">1.6.2.</span> <span class="nav-text">SSDT HOOK实验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSDT-HOOK%E9%9A%90%E8%97%8F"><span class="nav-number">1.6.3.</span> <span class="nav-text">SSDT HOOK隐藏</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0%E7%8E%AF%E5%9B%9E3%E7%8E%AF"><span class="nav-number">1.7.</span> <span class="nav-text">0环回3环</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZW%E7%B3%BB%E5%88%97%E5%86%85%E6%A0%B8%E5%87%BD%E6%95%B0%E5%92%8CNT%E7%B3%BB%E5%88%97%E5%86%85%E6%A0%B8%E5%87%BD%E6%95%B0%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.8.</span> <span class="nav-text">ZW系列内核函数和NT系列内核函数的区别</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZEROKO14</p>
  <div class="site-description" itemprop="description">你好，欢迎来到ZEROKO14的个人博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZEROKO14</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  <script defer src="/blog/lib/three/three.min.js"></script>
    <script defer src="/blog/lib/three/three-waves.min.js"></script>


  




  
<script src="/blog/js/local-search.js"></script>













  

  

  

</body>
</html>
