<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zeroko14.gitee.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="更多信息参见《Windows内核原理与实现》第三章。">
<meta property="og:type" content="article">
<meta property="og:title" content="进程与线程">
<meta property="og:url" content="http://zeroko14.gitee.io/eefe591f/index.html">
<meta property="og:site_name" content="ZEROKO14的个人博客">
<meta property="og:description" content="更多信息参见《Windows内核原理与实现》第三章。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909142442752.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909142343552.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210906162843550.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909171530578.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909171108678.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909165418505.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909165445414.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909165516800.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909173755007.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909173913107.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909173241836.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191949142.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210907153725611.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191911557.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912105201611.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912105028347.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912105300055.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913143736703.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/1827556-20200422144013785-765135328.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210910191936188.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917174204289.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917175257328.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917174430574.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917174644671.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917174728430.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210911111900026.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210911143508984.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912143605531.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917180706498.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913123031866.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913123046400.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913123224608.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913122330491.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913122350154.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913122429778.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912205808625.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913113450583.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913143736703.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913144629239.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913170303489.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913175616484.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913180101685.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210915203346309.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210915222903975.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210915232306154.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210916200240912.png">
<meta property="article:published_time" content="2023-11-16T03:52:41.112Z">
<meta property="article:modified_time" content="2023-11-20T03:01:40.258Z">
<meta property="article:author" content="ZEROKO14">
<meta property="article:tag" content="内核相关">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909142442752.png">

<link rel="canonical" href="http://zeroko14.gitee.io/eefe591f/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>进程与线程 | ZEROKO14的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ZEROKO14的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">zeroko14's blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zeroko14.gitee.io/eefe591f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="ZEROKO14">
      <meta itemprop="description" content="你好，欢迎来到ZEROKO14的个人博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZEROKO14的个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          进程与线程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-11-16 11:52:41" itemprop="dateCreated datePublished" datetime="2023-11-16T11:52:41+08:00">2023-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-20 11:01:40" itemprop="dateModified" datetime="2023-11-20T11:01:40+08:00">2023-11-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>更多信息参见《Windows内核原理与实现》第三章。</p>
<span id="more"></span>

<p>特别强调：</p>
<ul>
<li>笔记中的内容，与《内核情景分析》《Windows内核原理与实现》均有不同。</li>
<li>ReactOS是开源免费的Windows NT系列(含NT4.0&#x2F;2000&#x2F;XP&#x2F;2003)克隆操作系统</li>
<li>WRK 是微软针对教育和学术界开放的 Windows 内核的部分源码</li>
<li>而笔记是基于Windows XP SP2&#x2F;SP3 二进制文件.</li>
<li>微软并不开源，很多内核成员的作用需要自己去分析.</li>
</ul>
<p><strong>整个系统结构：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909142442752.png" alt="image-20210909142442752"></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909142343552.png" alt="image-20210909142343552"></p>
<p>执行体只维护属性，内核只根据属性做事，内核层比执行体更接近底层</p>
<ul>
<li>Ps开头的基本是执行体函数</li>
<li>KE，Ki开头函数开头的函数都是内核函数(一般KE是导出函数，Ki是不导出函数)</li>
<li>Nt开头的函数还是ntdll.dll那层</li>
</ul>
<p><strong><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xuanyuan/p/4165232.html">Windows内核重要变量</a></strong></p>
<h1 id="进程结构体"><a href="#进程结构体" class="headerlink" title="进程结构体"></a>进程结构体</h1><h2 id="进程结构体-EPROCESS"><a href="#进程结构体-EPROCESS" class="headerlink" title="进程结构体_EPROCESS"></a>进程结构体_EPROCESS</h2><p>每个windows进程在0环都有一个对应的结构体：_EPROCESS这个结构体包含了进程所有重要的信息。（PEB是三环关于进程信息的另一个结构体）</p>
<p>_EPROCESS结构体中的成员微软并没有公布作用。(靠逆向分析出来的)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _eprocess</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +<span class="number">0x000</span> Pcb              : _KPROCESS<span class="comment">//_KPROCESS结构体</span></span><br><span class="line">   +<span class="number">0x06c</span> ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x070</span> CreateTime       : _LARGE_INTEGER<span class="comment">//进程的创建时间</span></span><br><span class="line">   +<span class="number">0x078</span> ExitTime         : _LARGE_INTEGER<span class="comment">//进程的退出时间</span></span><br><span class="line">   +<span class="number">0x080</span> RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +<span class="number">0x084</span> UniqueProcessId  : Ptr32 Void<span class="comment">//进程的编号，任务管理器中的PID</span></span><br><span class="line">   +<span class="number">0x088</span> ActiveProcessLinks : _LIST_ENTRY<span class="comment">//双向链表，所有的活动进程都链接在一起构成的链表，全局变量PsActiveProcessHead指向该链表的头</span></span><br><span class="line">   +<span class="number">0x090</span> QuotaUsage       : [<span class="number">3</span>] Uint4B<span class="comment">//物理页相关的统计信息</span></span><br><span class="line">   +<span class="number">0x09c</span> QuotaPeak        : [<span class="number">3</span>] Uint4B<span class="comment">//物理页相关的统计信息</span></span><br><span class="line">   +<span class="number">0x0a8</span> CommitCharge     : Uint4B<span class="comment">//虚拟内存相关的统计信息</span></span><br><span class="line">   +<span class="number">0x0ac</span> PeakVirtualSize  : Uint4B<span class="comment">//虚拟内存相关的统计信息</span></span><br><span class="line">   +<span class="number">0x0b0</span> VirtualSize      : Uint4B<span class="comment">//虚拟内存相关的统计信息</span></span><br><span class="line">   +<span class="number">0x0b4</span> SessionProcessLinks : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x0bc</span> DebugPort        : Ptr32 Void<span class="comment">//调试相关，是被调试进程与调试进程的通行的桥梁，与反调试的DebugPort清零相关。</span></span><br><span class="line">   +<span class="number">0x0c0</span> ExceptionPort    : Ptr32 Void<span class="comment">//调试相关</span></span><br><span class="line">   +<span class="number">0x0c4</span> ObjectTable      : Ptr32 _HANDLE_TABLE<span class="comment">//句柄表，反调试也会用到这个句柄表，遍历系统内所有其他进程句柄表查是否存在自己的句柄</span></span><br><span class="line">   +<span class="number">0x0c8</span> Token            : _EX_FAST_REF<span class="comment">//安全相关的属性</span></span><br><span class="line">   +<span class="number">0x0cc</span> WorkingSetLock   : _FAST_MUTEX</span><br><span class="line">   +<span class="number">0x0ec</span> WorkingSetPage   : Uint4B</span><br><span class="line">   +<span class="number">0x0f0</span> AddressCreationLock : _FAST_MUTEX</span><br><span class="line">   +<span class="number">0x110</span> HyperSpaceLock   : Uint4B</span><br><span class="line">   +<span class="number">0x114</span> ForkInProgress   : Ptr32 _ETHREAD</span><br><span class="line">   +<span class="number">0x118</span> HardwareTrigger  : Uint4B</span><br><span class="line">   +<span class="number">0x11c</span> VadRoot          : Ptr32 Void<span class="comment">//非常重要，指向了一棵平衡二叉树，标识0~2G哪些虚拟地址分配了，与模块隐藏有很大关系</span></span><br><span class="line">   +<span class="number">0x120</span> VadHint          : Ptr32 Void</span><br><span class="line">   +<span class="number">0x124</span> CloneRoot        : Ptr32 Void<span class="comment">//已废弃</span></span><br><span class="line">   +<span class="number">0x128</span> NumberOfPrivatePages : Uint4B</span><br><span class="line">   +<span class="number">0x12c</span> NumberOfLockedPages : Uint4B</span><br><span class="line">   +<span class="number">0x130</span> Win32Process     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x134</span> Job              : Ptr32 _EJOB</span><br><span class="line">   +<span class="number">0x138</span> SectionObject    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x13c</span> SectionBaseAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x140</span> QuotaBlock       : Ptr32 _EPROCESS_QUOTA_BLOCK</span><br><span class="line">   +<span class="number">0x144</span> WorkingSetWatch  : Ptr32 _PAGEFAULT_HISTORY</span><br><span class="line">   +<span class="number">0x148</span> Win32WindowStation : Ptr32 Void</span><br><span class="line">   +<span class="number">0x14c</span> InheritedFromUniqueProcessId : Ptr32 Void<span class="comment">//父进程的pid</span></span><br><span class="line">   +<span class="number">0x150</span> LdtInformation   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x154</span> VadFreeHint      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x158</span> VdmObjects       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x15c</span> DeviceMap        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x160</span> PhysicalVadList  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x168</span> PageDirectoryPte : _HARDWARE_PTE_X86</span><br><span class="line">   +<span class="number">0x168</span> Filler           : Uint8B</span><br><span class="line">   +<span class="number">0x170</span> Session          : Ptr32 Void</span><br><span class="line">   +<span class="number">0x174</span> ImageFileName    : [<span class="number">16</span>] UChar<span class="comment">//当前进程的名字</span></span><br><span class="line">   +<span class="number">0x184</span> JobLinks         : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x18c</span> LockedPagesList  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x190</span> ThreadListHead   : _LIST_ENTRY<span class="comment">//8字节，一个进程下的所有线程组成的双向链表</span></span><br><span class="line">   +<span class="number">0x198</span> SecurityPort     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x19c</span> PaeTop           : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1a0</span> ActiveThreads    : Uint4B<span class="comment">//当前进程中活动线程的数量</span></span><br><span class="line">   +<span class="number">0x1a4</span> GrantedAccess    : Uint4B</span><br><span class="line">   +<span class="number">0x1a8</span> DefaultHardErrorProcessing : Uint4B</span><br><span class="line">   +<span class="number">0x1ac</span> LastThreadExitStatus : Int4B</span><br><span class="line">   +<span class="number">0x1b0</span> Peb              : Ptr32 _PEB<span class="comment">//PEB结构体，三环存进程信息的结构体</span></span><br><span class="line">   +<span class="number">0x1b4</span> PrefetchTrace    : _EX_FAST_REF</span><br><span class="line">   +<span class="number">0x1b8</span> ReadOperationCount : _LARGE_INTEGER<span class="comment">//调用Read文件的次数</span></span><br><span class="line">   +<span class="number">0x1c0</span> WriteOperationCount : _LARGE_INTEGER<span class="comment">//调用Write文件的次数</span></span><br><span class="line">   +<span class="number">0x1c8</span> OtherOperationCount : _LARGE_INTEGER<span class="comment">//调用其他IO函数的次数</span></span><br><span class="line">   +<span class="number">0x1d0</span> ReadTransferCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1d8</span> WriteTransferCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1e0</span> OtherTransferCount : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1e8</span> CommitChargeLimit : Uint4B</span><br><span class="line">   +<span class="number">0x1ec</span> CommitChargePeak : Uint4B</span><br><span class="line">   +<span class="number">0x1f0</span> AweInfo          : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1f4</span> SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO<span class="comment">//存着进程全路径名称的信息，结构内部如下注释</span></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">    kd&gt; dt _SE_AUDIT_PROCESS_CREATION_INFO（内嵌结构）</span></span><br><span class="line"><span class="comment">		nt!_SE_AUDIT_PROCESS_CREATION_INFO</span></span><br><span class="line"><span class="comment">   		+0x000 ImageFileName    : Ptr32 _OBJECT_NAME_INFORMATION</span></span><br><span class="line"><span class="comment"> 	kd&gt; dt _OBJECT_NAME_INFORMATION（指针）</span></span><br><span class="line"><span class="comment">		nt!_OBJECT_NAME_INFORMATION</span></span><br><span class="line"><span class="comment">   		+0x000 Name             : _UNICODE_STRING//全路径名称</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">   +<span class="number">0x1f8</span> Vm               : _MMSUPPORT</span><br><span class="line">   +<span class="number">0x238</span> LastFaultCount   : Uint4B</span><br><span class="line">   +<span class="number">0x23c</span> ModifiedPageCount : Uint4B</span><br><span class="line">   +<span class="number">0x240</span> NumberOfVads     : Uint4B</span><br><span class="line">   +<span class="number">0x244</span> JobStatus        : Uint4B</span><br><span class="line">   +<span class="number">0x248</span> Flags            : Uint4B<span class="comment">//死不死活不活都是他</span></span><br><span class="line">   +<span class="number">0x248</span> CreateReported   : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> NoDebugInherit   : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> ProcessExiting   : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> ProcessDelete    : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> Wow64SplitPages  : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> VmDeleted        : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> OutswapEnabled   : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> Outswapped       : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> ForkFailed       : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> HasPhysicalVad   : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> AddressSpaceInitialized : Pos <span class="number">10</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x248</span> SetTimerResolution : Pos <span class="number">12</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> BreakOnTermination : Pos <span class="number">13</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> SessionCreationUnderway : Pos <span class="number">14</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> WriteWatch       : Pos <span class="number">15</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> ProcessInSession : Pos <span class="number">16</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> OverrideAddressSpace : Pos <span class="number">17</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> HasAddressSpace  : Pos <span class="number">18</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> LaunchPrefetched : Pos <span class="number">19</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> InjectInpageErrors : Pos <span class="number">20</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> VmTopDown        : Pos <span class="number">21</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> Unused3          : Pos <span class="number">22</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> Unused4          : Pos <span class="number">23</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> VdmAllowed       : Pos <span class="number">24</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> Unused           : Pos <span class="number">25</span>, <span class="number">5</span> Bits</span><br><span class="line">   +<span class="number">0x248</span> Unused1          : Pos <span class="number">30</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> Unused2          : Pos <span class="number">31</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x24c</span> ExitStatus       : Int4B<span class="comment">//进程死了之后，在内核还会存在一段时间，该成员可获取退出状态</span></span><br><span class="line">   +<span class="number">0x250</span> NextPageColor    : Uint2B</span><br><span class="line">   +<span class="number">0x252</span> SubSystemMinorVersion : UChar<span class="comment">//子系统版本</span></span><br><span class="line">   +<span class="number">0x253</span> SubSystemMajorVersion : UChar<span class="comment">//子系统版本</span></span><br><span class="line">   +<span class="number">0x252</span> SubSystemVersion : Uint2B<span class="comment">//子系统版本</span></span><br><span class="line">   +<span class="number">0x254</span> PriorityClass    : UChar</span><br><span class="line">   +<span class="number">0x255</span> WorkingSetAcquiredUnsafe : UChar</span><br><span class="line">   +<span class="number">0x258</span> Cookie           : Uint4B</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-212357.htm">_EPROCESS结构体定义</a></p>
<p><strong>全局变量PsActiveProcessHead指向活动进程链表头中的_EPROCESS的0x88偏移位置</strong></p>
<p>PsActiveProcessHead也是两个值，下一个和前一个，两个四字节地址。</p>
<p><strong>PsActiveProcessHead未导出</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210906162843550.png" alt="image-20210906162843550"></p>
<p>任务管理器查的就是这个链表。</p>
<h3 id="PEB"><a href="#PEB" class="headerlink" title="PEB"></a>PEB</h3><p>三环进程结构体</p>
<p><strong>三环时，FS:[30]指向这个PEB结构</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span> &#123;</span>               <span class="comment">// Size: 0x1D8</span></span><br><span class="line">    <span class="number">000</span>h    UCHAR           InheritedAddressSpace;</span><br><span class="line">    <span class="number">001</span>h    UCHAR           ReadImageFileExecOptions;</span><br><span class="line">    <span class="comment">//下面参数标识当前进程是否处于调试状态，Kernel32.dll中的IsDebuggerPresent() API就是用来获取该处的值的（是，则返回1；否，则返回0）。【破解之法】只要借助OllyDbg调试器的编辑功能，将PEB.BeingDebugged的值修改为0（FALSE）即可。</span></span><br><span class="line">    <span class="number">002</span>h    UCHAR           BeingDebugged;      <span class="comment">//Debug运行标志(可用于反调试技术)，只要该进程被调试就会被置1</span></span><br><span class="line">    <span class="number">003</span>h    UCHAR           SpareBool;</span><br><span class="line">    <span class="number">004</span>h    HANDLE          Mutant;</span><br><span class="line">    <span class="number">008</span>h    HINSTANCE       ImageBaseAddress;  <span class="comment">//程序加载的基地址</span></span><br><span class="line">    <span class="number">00</span>Ch    <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span>    *<span class="title">Ldr</span>    //<span class="title">Ptr32</span> 指向_<span class="title">PEB_LDR_DATA</span>结构体，记录了程序包含哪些模块(可用于反调试技术)</span></span><br><span class="line"><span class="class">    010<span class="title">h</span>    <span class="keyword">struct</span> _<span class="title">RTL_USER_PROCESS_PARAMETERS</span>  *<span class="title">ProcessParameters</span>;</span></span><br><span class="line">    <span class="number">014</span>h    ULONG           SubSystemData;</span><br><span class="line">    <span class="number">018</span>h    HANDLE          DefaultHeap;    <span class="comment">//(可用于反调试技术)</span></span><br><span class="line">    <span class="number">01</span>Ch    KSPIN_LOCK      FastPebLock;</span><br><span class="line">    <span class="number">020</span>h    ULONG           FastPebLockRoutine;</span><br><span class="line">    <span class="number">024</span>h    ULONG           FastPebUnlockRoutine;</span><br><span class="line">    <span class="number">028</span>h    ULONG           EnvironmentUpdateCount;</span><br><span class="line">    <span class="number">02</span>Ch    ULONG           KernelCallbackTable;</span><br><span class="line">    <span class="number">030</span>h    LARGE_INTEGER   SystemReserved;</span><br><span class="line">    <span class="number">038</span>h    <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_FREE_BLOCK</span>  *<span class="title">FreeList</span></span></span><br><span class="line"><span class="class">    03<span class="title">Ch</span>    <span class="title">ULONG</span>           <span class="title">TlsExpansionCounter</span>;</span></span><br><span class="line">    <span class="number">040</span>h    ULONG           TlsBitmap;</span><br><span class="line">    <span class="number">044</span>h    LARGE_INTEGER   TlsBitmapBits;</span><br><span class="line">    <span class="number">04</span>Ch    ULONG           ReadOnlySharedMemoryBase;</span><br><span class="line">    <span class="number">050</span>h    ULONG           ReadOnlySharedMemoryHeap;</span><br><span class="line">    <span class="number">054</span>h    ULONG           ReadOnlyStaticServerData;</span><br><span class="line">    <span class="number">058</span>h    ULONG           AnsiCodePageData;</span><br><span class="line">    <span class="number">05</span>Ch    ULONG           OemCodePageData;</span><br><span class="line">    <span class="number">060</span>h    ULONG           UnicodeCaseTableData;</span><br><span class="line">    <span class="number">064</span>h    ULONG           NumberOfProcessors;</span><br><span class="line">    <span class="number">068</span>h    LARGE_INTEGER   NtGlobalFlag;               <span class="comment">// Address of a local copy(可用于反调试技术)</span></span><br><span class="line">    <span class="number">070</span>h    LARGE_INTEGER   CriticalSectionTimeout;</span><br><span class="line">    <span class="number">078</span>h    ULONG           HeapSegmentReserve;</span><br><span class="line">    <span class="number">07</span>Ch    ULONG           HeapSegmentCommit;</span><br><span class="line">    <span class="number">080</span>h    ULONG           HeapDeCommitTotalFreeThreshold;</span><br><span class="line">    <span class="number">084</span>h    ULONG           HeapDeCommitFreeBlockThreshold;</span><br><span class="line">    <span class="number">088</span>h    ULONG           NumberOfHeaps;</span><br><span class="line">    <span class="number">08</span>Ch    ULONG           MaximumNumberOfHeaps;</span><br><span class="line">    <span class="number">090</span>h    ULONG           ProcessHeaps;</span><br><span class="line">    <span class="number">094</span>h    ULONG           GdiSharedHandleTable;</span><br><span class="line">    <span class="number">098</span>h    ULONG           ProcessStarterHelper;</span><br><span class="line">    <span class="number">09</span>Ch    ULONG           GdiDCAttributeList;</span><br><span class="line">    <span class="number">0</span>A0h    KSPIN_LOCK      LoaderLock;</span><br><span class="line">    <span class="number">0</span>A4h    ULONG           OSMajorVersion;</span><br><span class="line">    <span class="number">0</span>A8h    ULONG           OSMinorVersion;</span><br><span class="line">    <span class="number">0</span>ACh    USHORT          OSBuildNumber;</span><br><span class="line">    <span class="number">0</span>AEh    USHORT          OSCSDVersion;</span><br><span class="line">    <span class="number">0B</span>0h    ULONG           OSPlatformId;</span><br><span class="line">    <span class="number">0B</span>4h    ULONG           ImageSubsystem;</span><br><span class="line">    <span class="number">0B</span>8h    ULONG           ImageSubsystemMajorVersion;</span><br><span class="line">    <span class="number">0B</span>Ch    ULONG           ImageSubsystemMinorVersion;</span><br><span class="line">    <span class="number">0</span>C0h    ULONG           ImageProcessAffinityMask;</span><br><span class="line">    <span class="number">0</span>C4h    ULONG           GdiHandleBuffer[<span class="number">0x22</span>];</span><br><span class="line">    <span class="number">14</span>Ch    ULONG           PostProcessInitRoutine;</span><br><span class="line">    <span class="number">150</span>h    ULONG           TlsExpansionBitmap;</span><br><span class="line">    <span class="number">154</span>h    UCHAR           TlsExpansionBitmapBits[<span class="number">0x80</span>];</span><br><span class="line">    <span class="number">1</span>D4h    ULONG           SessionId;</span><br><span class="line">&#125; PEB, *PPEB;</span><br></pre></td></tr></table></figure>

<p>PEB更多信息参见<a href="/b5b483bb#%E6%A8%A1%E5%9D%97%E9%9A%90%E8%97%8F/" data-pjax-state target="_Blank">windows开发的模块隐藏章节</a></p>
<h3 id="KRPOCESS结构体"><a href="#KRPOCESS结构体" class="headerlink" title="_KRPOCESS结构体"></a>_KRPOCESS结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPROCESS</span><br><span class="line">ntdll!_KPROCESS</span><br><span class="line">   +<span class="number">0x000</span> Header           : _DISPATCHER_HEADER<span class="comment">//只要0环对象是以这个开头的，就是“可等待”对象，比如Mutex互斥体，Event事件等(WaitForSingleObject)</span></span><br><span class="line">       <span class="comment">/*kd&gt; dt _DISPATCHER_HEADER</span></span><br><span class="line"><span class="comment">nt!_DISPATCHER_HEADER</span></span><br><span class="line"><span class="comment">   +0x000 Type             : UChar</span></span><br><span class="line"><span class="comment">   +0x001 Absolute         : UChar</span></span><br><span class="line"><span class="comment">   +0x002 Size             : UChar</span></span><br><span class="line"><span class="comment">   +0x003 Inserted         : UChar</span></span><br><span class="line"><span class="comment">   +0x004 SignalState      : Int4B</span></span><br><span class="line"><span class="comment">   +0x008 WaitListHead     : _LIST_ENTRY//双向链表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   +<span class="number">0x010</span> ProfileListHead  : _LIST_ENTRY<span class="comment">//性能分析相关，把自己的进程插入这个链表系统就可以帮你监视性能了(一般自动帮你插了)，性能监视器中可以查看</span></span><br><span class="line">   +<span class="number">0x018</span> DirectoryTableBase : [<span class="number">2</span>] Uint4B<span class="comment">//页目录表基址(最重要),第0个就是最终添加到CR3里的值，第1个是如果超过4GB物理内存的CR3</span></span><br><span class="line">   +<span class="number">0x020</span> LdtDescriptor    : _KGDTENTRY<span class="comment">//历史遗留，16位Windows 段选择子不够 每个进程都有一个LDT表</span></span><br><span class="line">   +<span class="number">0x028</span> Int21Descriptor  : _KIDTENTRY<span class="comment">//DOS下用的中断</span></span><br><span class="line">   +<span class="number">0x030</span> IopmOffset       : Uint2B</span><br><span class="line">   +<span class="number">0x032</span> Iopl             : UChar</span><br><span class="line">   +<span class="number">0x033</span> Unused           : UChar</span><br><span class="line">   +<span class="number">0x034</span> ActiveProcessors : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> KernelTime       : Uint4B<span class="comment">//统计信息，记录了一个进程在用户模式下所花的时间</span></span><br><span class="line">   +<span class="number">0x03c</span> UserTime         : Uint4B<span class="comment">//统计信息，记录了一个进程在内核模式下所花的时间</span></span><br><span class="line">   +<span class="number">0x040</span> ReadyListHead    : _LIST_ENTRY<span class="comment">//当前进程所有就绪状态的线程的双向链表</span></span><br><span class="line">   +<span class="number">0x048</span> SwapListEntry    : _SINGLE_LIST_ENTRY<span class="comment">//当前进程被交换到硬盘上的链表</span></span><br><span class="line">   +<span class="number">0x04c</span> VdmTrapcHandler  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x050</span> ThreadListHead   : _LIST_ENTRY<span class="comment">//8字节，一个进程下的所有线程组成的双向链表</span></span><br><span class="line">   +<span class="number">0x058</span> ProcessLock      : Uint4B<span class="comment">//进程锁，拿这个值调API，防止你修改的时候和操作系统同时改冲突。</span></span><br><span class="line">   +<span class="number">0x05c</span> Affinity         : Uint4B<span class="comment">//规定进程里面的所有线程偏好哪些CPU核心上跑(偏好)</span></span><br><span class="line">       <span class="comment">//如果值为1，那么这个进程的所有线程在0号CPU跑(00000001)</span></span><br><span class="line">       <span class="comment">//如果值为3，那么这个进程的所有线程只能在0,1号CPU跑(00000011)</span></span><br><span class="line">       <span class="comment">//如果值为4，那么这个进程的所有线程只能在2号CPU跑(00000100)</span></span><br><span class="line">       <span class="comment">//如果值为5，那么这个进程的所有线程只能在0,2号CPU跑(00000101)</span></span><br><span class="line">       <span class="comment">//所以32位系统最多32核，64位系统最多64核</span></span><br><span class="line">   +<span class="number">0x060</span> StackCount       : Uint2B<span class="comment">//记录了当前进程中有多少个线程的栈位于内存中</span></span><br><span class="line">   +<span class="number">0x062</span> BasePriority     : Char<span class="comment">//基础优先级或最低优先级，该进程中的所有线程最起码的优先级，创建线程的最起始的优先级都是这个</span></span><br><span class="line">   +<span class="number">0x063</span> ThreadQuantum    : Char<span class="comment">//进程下线程默认的时间片</span></span><br><span class="line">   +<span class="number">0x064</span> AutoAlignment    : UChar<span class="comment">//自动对齐(已废弃)</span></span><br><span class="line">   +<span class="number">0x065</span> State            : UChar<span class="comment">//描述硬盘交换的状态，0表示未换（即在内存中），还有正在换中和已经换到硬盘中了等情况</span></span><br><span class="line">   +<span class="number">0x066</span> ThreadSeed       : UChar<span class="comment">//规定进程里面的所有线程偏好在哪个CPU核心上跑</span></span><br><span class="line">   +<span class="number">0x067</span> DisableBoost     : UChar</span><br><span class="line">   +<span class="number">0x068</span> PowerState       : UChar</span><br><span class="line">   +<span class="number">0x069</span> DisableQuantum   : UChar</span><br><span class="line">   +<span class="number">0x06a</span> IdealNode        : UChar</span><br><span class="line">   +<span class="number">0x06b</span> Flags            : _KEXECUTE_OPTIONS</span><br><span class="line">   +<span class="number">0x06b</span> ExecuteOptions   : UChar</span><br></pre></td></tr></table></figure>

<h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><p><strong>1、用OD附加记事本，然后查看记事本进程的PEB的BeingDebugged成员的值(注意：OD不要使用插件)</strong></p>
<p>OD附加前：<img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909171530578.png" alt="image-20210909171530578"></p>
<p>OD附加后：<img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909171108678.png" alt="image-20210909171108678"></p>
<p><strong>2、用OD附加记事本，下断点，然后在windbg中清空EPROCESS中的DebugPort中的值，然后单步调试，观察结果.</strong></p>
<p>修改前：<img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909165418505.png" alt="image-20210909165418505"></p>
<p>修改后：<img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909165445414.png" alt="image-20210909165445414"></p>
<p>单步调试触发：</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909165516800.png" alt="image-20210909165516800"></p>
<p>单步调试直接触发异常，OD卡死</p>
<h3 id="进程断链实现任务管理器隐藏"><a href="#进程断链实现任务管理器隐藏" class="headerlink" title="进程断链实现任务管理器隐藏"></a>进程断链实现任务管理器隐藏</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//目标进程断链函数</span></span><br><span class="line">BOOLEAN <span class="title function_">CutProcessInLink</span><span class="params">(<span class="type">char</span>* name)</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG curProcess;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov eax, dword ptr fs : [<span class="number">0x124</span>] ;</span><br><span class="line">		mov ecx, [eax + <span class="number">0x44</span>];</span><br><span class="line">		mov curProcess, ecx;</span><br><span class="line">	&#125;</span><br><span class="line">	PLIST_ENTRY plistProcess = (PLIST_ENTRY)(curProcess + <span class="number">0x88</span>);</span><br><span class="line">	BOOLEAN isFlags = FALSE;</span><br><span class="line">	<span class="keyword">while</span> (plistProcess-&gt;Flink != (PLIST_ENTRY)(curProcess + <span class="number">0x88</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		ULONG nextProcess = ((ULONG)(plistProcess)) - <span class="number">0x88</span>;</span><br><span class="line">		plistProcess = plistProcess-&gt;Flink;</span><br><span class="line">		<span class="comment">//KdPrint((&quot;%s\n&quot;, (PCHAR)(nextProcess + 0x174)));</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, (PCHAR)(nextProcess + <span class="number">0x174</span>)) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			curProcess = nextProcess;<span class="comment">//找到目标进程</span></span><br><span class="line">			<span class="comment">//执行断链操作</span></span><br><span class="line">			PLIST_ENTRY curProcessLink = (PLIST_ENTRY)(curProcess + <span class="number">0x88</span>);</span><br><span class="line">			curProcessLink-&gt;Blink-&gt;Flink = curProcessLink-&gt;Flink;</span><br><span class="line">			curProcessLink-&gt;Flink-&gt;Blink = curProcessLink-&gt;Blink;</span><br><span class="line">			isFlags = TRUE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!isFlags)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>断链前：<img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909173755007.png" alt="image-20210909173755007"></p>
<p>锻炼后：<img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909173913107.png" alt="image-20210909173913107"></p>
<p>但是这里还是能看到：</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210909173241836.png" alt="image-20210909173241836"></p>
<h1 id="线程结构体"><a href="#线程结构体" class="headerlink" title="线程结构体"></a>线程结构体</h1><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191949142.png" alt="image-20210831191949142"></p>
<h2 id="线程结构体-ETHREAD"><a href="#线程结构体-ETHREAD" class="headerlink" title="线程结构体_ETHREAD"></a>线程结构体_ETHREAD</h2><p>每个windows线程在0环都有一个对应的结构体：_ETHREAD，这个结构体包含了线程所有重要的信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _ETHREAD</span><br><span class="line">nt!_ETHREAD</span><br><span class="line">   +<span class="number">0x000</span> Tcb              : _KTHREAD<span class="comment">//_KTHREAD结构体</span></span><br><span class="line">   +<span class="number">0x1c0</span> CreateTime       : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1c0</span> NestedFaultCount : Pos <span class="number">0</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x1c0</span> ApcNeeded        : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x1c8</span> ExitTime         : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1c8</span> LpcReplyChain    : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1c8</span> KeyedWaitChain   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1d0</span> ExitStatus       : Int4B</span><br><span class="line">   +<span class="number">0x1d0</span> OfsChain         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1d4</span> PostBlockList    : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1dc</span> TerminationPort  : Ptr32 _TERMINATION_PORT</span><br><span class="line">   +<span class="number">0x1dc</span> ReaperLink       : Ptr32 _ETHREAD</span><br><span class="line">   +<span class="number">0x1dc</span> KeyedWaitValue   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1e0</span> ActiveTimerListLock : Uint4B</span><br><span class="line">   +<span class="number">0x1e4</span> ActiveTimerListHead : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x1ec</span> Cid              : _CLIENT_ID<span class="comment">//8字节，两个内容，分别是线程所属进程id和线程id</span></span><br><span class="line">   +<span class="number">0x1f4</span> LpcReplySemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x1f4</span> KeyedWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x208</span> LpcReplyMessage  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x208</span> LpcWaitingOnPort : Ptr32 Void</span><br><span class="line">   +<span class="number">0x20c</span> ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION</span><br><span class="line">   +<span class="number">0x210</span> IrpList          : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x218</span> TopLevelIrp      : Uint4B</span><br><span class="line">   +<span class="number">0x21c</span> DeviceToVerify   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x220</span> ThreadsProcess   : Ptr32 _EPROCESS<span class="comment">//指向创建自己的进程的_EPROCESS结构体</span></span><br><span class="line">   +<span class="number">0x224</span> StartAddress     : Ptr32 Void<span class="comment">//线程起始函数地址</span></span><br><span class="line">   +<span class="number">0x228</span> Win32StartAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x228</span> LpcReceivedMessageId : Uint4B</span><br><span class="line">   +<span class="number">0x22c</span> ThreadListEntry  : _LIST_ENTRY<span class="comment">//双向链表 一个进程所有的线程 都挂在一个链表中 挂的就是这个位置，一共有两个这样的链表，8字节</span></span><br><span class="line">   +<span class="number">0x234</span> RundownProtect   : _EX_RUNDOWN_REF<span class="comment">//线程锁相关</span></span><br><span class="line">   +<span class="number">0x238</span> ThreadLock       : _EX_PUSH_LOCK</span><br><span class="line">   +<span class="number">0x23c</span> LpcReplyMessageId : Uint4B</span><br><span class="line">   +<span class="number">0x240</span> ReadClusterSize  : Uint4B</span><br><span class="line">   +<span class="number">0x244</span> GrantedAccess    : Uint4B</span><br><span class="line">   +<span class="number">0x248</span> CrossThreadFlags : Uint4B<span class="comment">//设置线程状态，比如可设置为系统线程</span></span><br><span class="line">   +<span class="number">0x248</span> Terminated       : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> DeadThread       : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> HideFromDebugger : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> ActiveImpersonationInfo : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> SystemThread     : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> HardErrorsAreDisabled : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> BreakOnTermination : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> SkipCreationMsg  : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x248</span> SkipTerminationMsg : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x24c</span> SameThreadPassiveFlags : Uint4B</span><br><span class="line">   +<span class="number">0x24c</span> ActiveExWorker   : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x24c</span> ExWorkerCanWaitUser : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x24c</span> MemoryMaker      : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x250</span> SameThreadApcFlags : Uint4B</span><br><span class="line">   +<span class="number">0x250</span> LpcReceivedMsgIdValid : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x250</span> LpcExitThreadCalled : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x250</span> AddressSpaceOwner : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x254</span> ForwardClusterOnly : UChar</span><br><span class="line">   +<span class="number">0x255</span> DisablePageFaultClustering : UChar</span><br></pre></td></tr></table></figure>

<h3 id="KTHREAD结构体"><a href="#KTHREAD结构体" class="headerlink" title="_KTHREAD结构体"></a>_KTHREAD结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KTHREAD</span><br><span class="line">nt!_KTHREAD</span><br><span class="line">   +<span class="number">0x000</span> Header           : _DISPATCHER_HEADER<span class="comment">//“可等待对象”</span></span><br><span class="line">   +<span class="number">0x010</span> MutantListHead   : _LIST_ENTRY<span class="comment">//互斥体链表</span></span><br><span class="line">   +<span class="number">0x018</span> InitialStack     : Ptr32 Void<span class="comment">//当前堆栈顶起始</span></span><br><span class="line">   +<span class="number">0x01c</span> StackLimit       : Ptr32 Void<span class="comment">//当前堆栈边界</span></span><br><span class="line">   +<span class="number">0x020</span> Teb              : Ptr32 Void<span class="comment">//TEB,Thread Environment Block,线程环境块。大小4KB，位于用户地址空间。三环时FS:[0]指向TEB。</span></span><br><span class="line">   +<span class="number">0x024</span> TlsArray         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x028</span> KernelStack      : Ptr32 Void<span class="comment">//0环堆栈顶，哪个线程正在跑就把该零环堆栈的地址放到TSS中的esp0中。</span></span><br><span class="line">   +<span class="number">0x02c</span> DebugActive      : UChar<span class="comment">//调试激活，如果值为-1，不能使用调试寄存器：Dr0~Dr7，硬件断点相关</span></span><br><span class="line">   +<span class="number">0x02d</span> State            : UChar<span class="comment">//线程状态：就绪，等待还是运行</span></span><br><span class="line">   +<span class="number">0x02e</span> Alerted          : [<span class="number">2</span>] UChar<span class="comment">//正常情况下，用户模式的APC是不会打断用户态程序的执行流的。除非，线程是Alertable——可唤醒的。</span></span><br><span class="line">   +<span class="number">0x030</span> Iopl             : UChar</span><br><span class="line">   +<span class="number">0x031</span> NpxState         : UChar</span><br><span class="line">   +<span class="number">0x032</span> Saturation       : Char</span><br><span class="line">   +<span class="number">0x033</span> Priority         : Char<span class="comment">//线程的优先级？</span></span><br><span class="line">   +<span class="number">0x034</span> ApcState         : _KAPC_STATE<span class="comment">//APC相关</span></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">       kd&gt; dt _KAPC_STATE</span></span><br><span class="line"><span class="comment">	ntdll!_KAPC_STATE</span></span><br><span class="line"><span class="comment">   +0x000 ApcListHead      : [2] _LIST_ENTRY//两个APC队列</span></span><br><span class="line"><span class="comment">   +0x010 Process          : Ptr32 _KPROCESS//0x44偏移位置是该线程所在的进程的_EPROCESS结构</span></span><br><span class="line"><span class="comment">   +0x014 KernelApcInProgress : UChar</span></span><br><span class="line"><span class="comment">   +0x015 KernelApcPending : UChar</span></span><br><span class="line"><span class="comment">   +0x016 UserApcPending   : UChar</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       </span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">   +<span class="number">0x04c</span> ContextSwitches  : Uint4B<span class="comment">//线程的交换次数</span></span><br><span class="line">   +<span class="number">0x050</span> IdleSwapBlock    : UChar</span><br><span class="line">   +<span class="number">0x051</span> Spare0           : [<span class="number">3</span>] UChar</span><br><span class="line">   +<span class="number">0x054</span> WaitStatus       : Int4B<span class="comment">//线程等待相关。。。</span></span><br><span class="line">   +<span class="number">0x058</span> WaitIrql         : UChar</span><br><span class="line">   +<span class="number">0x059</span> WaitMode         : Char</span><br><span class="line">   +<span class="number">0x05a</span> WaitNext         : UChar</span><br><span class="line">   +<span class="number">0x05b</span> WaitReason       : UChar</span><br><span class="line">   +<span class="number">0x05c</span> WaitBlockList    : Ptr32 _KWAIT_BLOCK<span class="comment">////指向第一个等待块</span></span><br><span class="line">       <span class="comment">//下面两成员是同一个位置，表示的是同一个成员的两种情况</span></span><br><span class="line">   +<span class="number">0x060</span> WaitListEntry    : _LIST_ENTRY<span class="comment">//当线程处于等待状态的时候指向等待链表(8字节)</span></span><br><span class="line">   +<span class="number">0x060</span> SwapListEntry    : _SINGLE_LIST_ENTRY<span class="comment">//等待线程的内存交换到硬盘的信息记录在该链表(8字节)</span></span><br><span class="line">   +<span class="number">0x068</span> WaitTime         : Uint4B</span><br><span class="line">   +<span class="number">0x06c</span> BasePriority     : Char<span class="comment">//优先级，其初始值是所属进程的BasePriority值（KPROCESS-&gt;BasePriority），以后可以通过KeSetBasePriorityThread()函数重新设定</span></span><br><span class="line">   +<span class="number">0x06d</span> DecrementCount   : UChar</span><br><span class="line">   +<span class="number">0x06e</span> PriorityDecrement : Char</span><br><span class="line">   +<span class="number">0x06f</span> Quantum          : Char<span class="comment">//当前线程剩余的CPU时间片</span></span><br><span class="line">   +<span class="number">0x070</span> WaitBlock        : [<span class="number">4</span>] _KWAIT_BLOCK<span class="comment">//等待哪个对象</span></span><br><span class="line">   +<span class="number">0x0d0</span> LegoData         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x0d4</span> KernelApcDisable : Uint4B<span class="comment">//内核apc是否可执行</span></span><br><span class="line">   +<span class="number">0x0d8</span> UserAffinity     : Uint4B</span><br><span class="line">   +<span class="number">0x0dc</span> SystemAffinityActive : UChar</span><br><span class="line">   +<span class="number">0x0dd</span> PowerState       : UChar</span><br><span class="line">   +<span class="number">0x0de</span> NpxIrql          : UChar</span><br><span class="line">   +<span class="number">0x0df</span> InitialNode      : UChar</span><br><span class="line">   +<span class="number">0x0e0</span> ServiceTable     : Ptr32 Void<span class="comment">//指向系统服务表基址</span></span><br><span class="line">   +<span class="number">0x0e4</span> Queue            : Ptr32 _KQUEUE</span><br><span class="line">   +<span class="number">0x0e8</span> ApcQueueLock     : Uint4B<span class="comment">//APC锁相关</span></span><br><span class="line">   +<span class="number">0x0f0</span> Timer            : _KTIMER</span><br><span class="line">   +<span class="number">0x118</span> QueueListEntry   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x120</span> SoftAffinity     : Uint4B</span><br><span class="line">   +<span class="number">0x124</span> Affinity         : Uint4B</span><br><span class="line">   +<span class="number">0x128</span> Preempted        : UChar</span><br><span class="line">   +<span class="number">0x129</span> ProcessReadyQueue : UChar</span><br><span class="line">   +<span class="number">0x12a</span> KernelStackResident : UChar</span><br><span class="line">   +<span class="number">0x12b</span> NextProcessor    : UChar</span><br><span class="line">   +<span class="number">0x12c</span> CallbackStack    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x130</span> Win32Thread      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x134</span> TrapFrame        : Ptr32 _KTRAP_FRAME<span class="comment">//进0环时保存环境，陷阱帧</span></span><br><span class="line">   +<span class="number">0x138</span> ApcStatePointer  : [<span class="number">2</span>] Ptr32 _KAPC_STATE<span class="comment">//APC相关</span></span><br><span class="line">   +<span class="number">0x140</span> PreviousMode     : Char<span class="comment">//先前模式，某些内核函数会判断程序是0环调用还是3环调用。0代表调用来自0环</span></span><br><span class="line">   +<span class="number">0x141</span> EnableStackSwap  : UChar<span class="comment">//开关栈交换，是否允许内存交换到硬盘</span></span><br><span class="line">   +<span class="number">0x142</span> LargeStack       : UChar</span><br><span class="line">   +<span class="number">0x143</span> ResourceIndex    : UChar</span><br><span class="line">   +<span class="number">0x144</span> KernelTime       : Uint4B</span><br><span class="line">   +<span class="number">0x148</span> UserTime         : Uint4B</span><br><span class="line">   +<span class="number">0x14c</span> SavedApcState    : _KAPC_STATE<span class="comment">//APC相关</span></span><br><span class="line">   +<span class="number">0x164</span> Alertable        : UChar</span><br><span class="line">   +<span class="number">0x165</span> ApcStateIndex    : UChar<span class="comment">//表示此时线程是否挂载</span></span><br><span class="line">   +<span class="number">0x166</span> ApcQueueable     : UChar<span class="comment">//表示是否可以向线程的APC队列中插入APC</span></span><br><span class="line">   +<span class="number">0x167</span> AutoAlignment    : UChar</span><br><span class="line">   +<span class="number">0x168</span> StackBase        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x16c</span> SuspendApc       : _KAPC</span><br><span class="line">   +<span class="number">0x19c</span> SuspendSemaphore : _KSEMAPHORE</span><br><span class="line">   +<span class="number">0x1b0</span> ThreadListEntry  : _LIST_ENTRY<span class="comment">//双向链表，一个进程所有的线程都挂在一个链表中，挂的就是这个位置，一共有两个这样的链表，8字节</span></span><br><span class="line">   +<span class="number">0x1b8</span> FreezeCount      : Char</span><br><span class="line">   +<span class="number">0x1b9</span> SuspendCount     : Char</span><br><span class="line">   +<span class="number">0x1ba</span> IdealProcessor   : UChar</span><br><span class="line">   +<span class="number">0x1bb</span> DisableBoost     : UChar</span><br></pre></td></tr></table></figure>

<p>0x1b0：<strong>ThreadListEntry</strong>，一个进程所有的线程都挂在一个链表中，<strong>一共有两个这样的链表</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210907153725611.png" alt="image-20210907153725611"></p>
<ul>
<li>线程：上面的圈在_KTHREAD中，下面的圈在_ETHREAD中</li>
<li>进程：上面的圈在_KPROCESS中，下面的圈在_EPROCESS中</li>
</ul>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>将线程链中的某个线程断了，如果线程断了还是否可以执行，是不是在od就看不到该线程了?</p>
<p><strong>线程和进程实际上是无法真正隐藏的</strong></p>
<p>逆PspCreateProcess大致思路(暂时无法自己逆向，基础铺垫不够)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//3环</span></span><br><span class="line">CreateProcessA</span><br><span class="line">-&gt;CreateProcessInternalA</span><br><span class="line">-&gt;CreateProcessInternalW</span><br><span class="line">-&gt;NtCreateProcessEx</span><br><span class="line">-&gt;BasePushProcessParameters</span><br><span class="line">-&gt;NtCreateThread</span><br><span class="line">-&gt;NtResumeThread</span><br><span class="line">-&gt;执行代码OEP</span><br><span class="line"><span class="comment">//0环</span></span><br><span class="line">ZwCreateProcess/NtCreateProcess</span><br><span class="line">-&gt;PspCreateProcess</span><br></pre></td></tr></table></figure>

<h2 id="三环线程结构体-TEB"><a href="#三环线程结构体-TEB" class="headerlink" title="三环线程结构体_TEB"></a>三环线程结构体_TEB</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _TEB</span><br><span class="line">nt!_TEB</span><br><span class="line">   +<span class="number">0x000</span> NtTib            : _NT_TIB<span class="comment">//_NT_TIB结构体，_KPCR结构体的第一个成员也是_NT_TIB结构体</span></span><br><span class="line">   +<span class="number">0x01c</span> EnvironmentPointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x020</span> ClientId         : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x028</span> ActiveRpcHandle  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x02c</span> ThreadLocalStoragePointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x030</span> ProcessEnvironmentBlock : Ptr32 _PEB</span><br><span class="line">   +<span class="number">0x034</span> LastErrorValue   : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> CountOfOwnedCriticalSections : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> CsrClientThread  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x040</span> Win32ThreadInfo  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x044</span> User32Reserved   : [<span class="number">26</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0ac</span> UserReserved     : [<span class="number">5</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0c0</span> WOW32Reserved    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x0c4</span> CurrentLocale    : Uint4B</span><br><span class="line">   +<span class="number">0x0c8</span> FpSoftwareStatusRegister : Uint4B</span><br><span class="line">   +<span class="number">0x0cc</span> SystemReserved1  : [<span class="number">54</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0x1a4</span> ExceptionCode    : Int4B</span><br><span class="line">   +<span class="number">0x1a8</span> ActivationContextStack : _ACTIVATION_CONTEXT_STACK</span><br><span class="line">   +<span class="number">0x1bc</span> SpareBytes1      : [<span class="number">24</span>] UChar</span><br><span class="line">   +<span class="number">0x1d4</span> GdiTebBatch      : _GDI_TEB_BATCH</span><br><span class="line">   +<span class="number">0x6b4</span> RealClientId     : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x6bc</span> GdiCachedProcessHandle : Ptr32 Void</span><br><span class="line">   +<span class="number">0x6c0</span> GdiClientPID     : Uint4B</span><br><span class="line">   +<span class="number">0x6c4</span> GdiClientTID     : Uint4B</span><br><span class="line">   +<span class="number">0x6c8</span> GdiThreadLocalInfo : Ptr32 Void</span><br><span class="line">   +<span class="number">0x6cc</span> Win32ClientInfo  : [<span class="number">62</span>] Uint4B</span><br><span class="line">   +<span class="number">0x7c4</span> glDispatchTable  : [<span class="number">233</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xb68</span> glReserved1      : [<span class="number">29</span>] Uint4B</span><br><span class="line">   +<span class="number">0xbdc</span> glReserved2      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe0</span> glSectionInfo    : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe4</span> glSection        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe8</span> glTable          : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbec</span> glCurrentRC      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbf0</span> glContext        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbf4</span> LastStatusValue  : Uint4B</span><br><span class="line">   +<span class="number">0xbf8</span> StaticUnicodeString : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0xc00</span> StaticUnicodeBuffer : [<span class="number">261</span>] Uint2B</span><br><span class="line">   +<span class="number">0xe0c</span> DeallocationStack : Ptr32 Void</span><br><span class="line">   +<span class="number">0xe10</span> TlsSlots         : [<span class="number">64</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf10</span> TlsLinks         : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0xf18</span> Vdm              : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf1c</span> ReservedForNtRpc : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf20</span> DbgSsReserved    : [<span class="number">2</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf28</span> HardErrorsAreDisabled : Uint4B</span><br><span class="line">   +<span class="number">0xf2c</span> Instrumentation  : [<span class="number">16</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf6c</span> WinSockData      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf70</span> GdiBatchCount    : Uint4B</span><br><span class="line">   +<span class="number">0xf74</span> InDbgPrint       : UChar</span><br><span class="line">   +<span class="number">0xf75</span> FreeStackOnTermination : UChar</span><br><span class="line">   +<span class="number">0xf76</span> HasFiberData     : UChar</span><br><span class="line">   +<span class="number">0xf77</span> IdealProcessor   : UChar</span><br><span class="line">   +<span class="number">0xf78</span> Spare3           : Uint4B</span><br><span class="line">   +<span class="number">0xf7c</span> ReservedForPerf  : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf80</span> ReservedForOle   : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf84</span> WaitingOnLoaderLock : Uint4B</span><br><span class="line">   +<span class="number">0xf88</span> Wx86Thread       : _Wx86ThreadState</span><br><span class="line">   +<span class="number">0xf94</span> TlsExpansionSlots : Ptr32 Ptr32 Void</span><br><span class="line">   +<span class="number">0xf98</span> ImpersonationLocale : Uint4B</span><br><span class="line">   +<span class="number">0xf9c</span> IsImpersonating  : Uint4B</span><br><span class="line">   +<span class="number">0xfa0</span> NlsCache         : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfa4</span> pShimData        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfa8</span> HeapVirtualAffinity : Uint4B</span><br><span class="line">   +<span class="number">0xfac</span> CurrentTransactionHandle : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfb0</span> ActiveFrame      : Ptr32 _TEB_ACTIVE_FRAME</span><br><span class="line">   +<span class="number">0xfb4</span> SafeThunkCall    : UChar</span><br><span class="line">   +<span class="number">0xfb5</span> BooleanSpare     : [<span class="number">3</span>] UChar</span><br></pre></td></tr></table></figure>

<h1 id="CPU结构体"><a href="#CPU结构体" class="headerlink" title="CPU结构体"></a>CPU结构体</h1><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210831191911557.png" alt="image-20210831191911557"></p>
<h2 id="KPCR结构体"><a href="#KPCR结构体" class="headerlink" title="_KPCR结构体"></a>_KPCR结构体</h2><p>KPCR：CPU控制区(Processor Control Region)</p>
<p>CPU在内核中的结构体</p>
<p>_<strong>KPCR介绍</strong></p>
<ol>
<li>当线程进入0环时，FS:[0]指向KPCR</li>
<li>每个CPU核心都有一个KPCR结构体</li>
<li>KPCR中存储了CPU本身要用的一些重要数据：GDT,IDT以及线程相关的一些信息。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPCR</span><br><span class="line">nt!_KPCR</span><br><span class="line">   +<span class="number">0x000</span> NtTib            : _NT_TIB<span class="comment">//_NT_TIB结构体，_TEB结构体第一项成员也是_NT_TIB结构体</span></span><br><span class="line">   +<span class="number">0x01c</span> SelfPcr          : Ptr32 _KPCR<span class="comment">//指向当前_KPCR结构体的指针</span></span><br><span class="line">   +<span class="number">0x020</span> Prcb             : Ptr32 _KPRCB<span class="comment">//_KPRCB结构体指针(其实就是存了_KPCR中0x120偏移的_KPRCB结构体首地址)</span></span><br><span class="line">   +<span class="number">0x024</span> Irql             : UChar</span><br><span class="line">   +<span class="number">0x028</span> IRR              : Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> IrrActive        : Uint4B</span><br><span class="line">   +<span class="number">0x030</span> IDR              : Uint4B</span><br><span class="line">   +<span class="number">0x034</span> KdVersionBlock   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x038</span> IDT              : Ptr32 _KIDTENTRY<span class="comment">//IDT表基址，每个CPU核一个IDT</span></span><br><span class="line">   +<span class="number">0x03c</span> GDT              : Ptr32 _KGDTENTRY<span class="comment">//GDT表基址，每个CPU核一个GDT</span></span><br><span class="line">   +<span class="number">0x040</span> TSS              : Ptr32 _KTSS<span class="comment">//_KTSS结构体指针，指向TSS，每个CPU核一个TSS</span></span><br><span class="line">   +<span class="number">0x044</span> MajorVersion     : Uint2B</span><br><span class="line">   +<span class="number">0x046</span> MinorVersion     : Uint2B</span><br><span class="line">   +<span class="number">0x048</span> SetMember        : Uint4B</span><br><span class="line">   +<span class="number">0x04c</span> StallScaleFactor : Uint4B</span><br><span class="line">   +<span class="number">0x050</span> DebugActive      : UChar<span class="comment">//调试激活，0表示</span></span><br><span class="line">   +<span class="number">0x051</span> Number           : UChar<span class="comment">//当前CPU的编号，从0开始</span></span><br><span class="line">   +<span class="number">0x052</span> Spare0           : UChar</span><br><span class="line">   +<span class="number">0x053</span> SecondLevelCacheAssociativity : UChar</span><br><span class="line">   +<span class="number">0x054</span> VdmAlert         : Uint4B</span><br><span class="line">   +<span class="number">0x058</span> KernelReserved   : [<span class="number">14</span>] Uint4B</span><br><span class="line">   +<span class="number">0x090</span> SecondLevelCacheSize : Uint4B</span><br><span class="line">   +<span class="number">0x094</span> HalReserved      : [<span class="number">16</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0d4</span> InterruptMode    : Uint4B</span><br><span class="line">   +<span class="number">0x0d8</span> Spare1           : UChar</span><br><span class="line">   +<span class="number">0x0dc</span> KernelReserved2  : [<span class="number">17</span>] Uint4B</span><br><span class="line">   +<span class="number">0x120</span> PrcbData         : _KPRCB<span class="comment">//_KPRCB结构体，拓展结构体</span></span><br></pre></td></tr></table></figure>

<h3 id="NT-TIB结构体"><a href="#NT-TIB结构体" class="headerlink" title="_NT_TIB结构体"></a>_NT_TIB结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nt!_NT_TIB</span><br><span class="line">   +<span class="number">0x000</span> ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD<span class="comment">//当前线程异常链表，KPCR存的是R0的，TEB存的是R3的</span></span><br><span class="line">   +<span class="number">0x004</span> StackBase        : Ptr32 Void<span class="comment">//栈底，KPCR存的是R0的(逆向发现存的是【KTHREAD的InitialStack的值-0x210后的值】)，TEB存的是R3的</span></span><br><span class="line">       <span class="comment">//这个0x210是_FX_SAVE_AREA结构，就是浮点寄存器，再上面部分就是_Ktrap_frame结构体</span></span><br><span class="line">   +<span class="number">0x008</span> StackLimit       : Ptr32 Void<span class="comment">//栈的边界，KPCR存的是R0的，TEB存的是R3的</span></span><br><span class="line">   +<span class="number">0x00c</span> SubSystemTib     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> FiberData        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> Version          : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> ArbitraryUserPointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x018</span> Self             : Ptr32 _NT_TIB<span class="comment">//指向自己(也就是指向KPCR结构或TEB结构首地址)，这样设计的目的是为了查找方便</span></span><br></pre></td></tr></table></figure>

<h3 id="KPRCB结构体"><a href="#KPRCB结构体" class="headerlink" title="_KPRCB结构体"></a>_KPRCB结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPRCB</span><br><span class="line">nt!_KPRCB</span><br><span class="line">   +<span class="number">0x000</span> MinorVersion     : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> MajorVersion     : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> CurrentThread    : Ptr32 _KTHREAD<span class="comment">//当前CPU正在跑的线程，或者空闲线程函数地址？</span></span><br><span class="line">   +<span class="number">0x008</span> NextThread       : Ptr32 _KTHREAD<span class="comment">//要切换的时候，即将切换的下一个线程</span></span><br><span class="line">   +<span class="number">0x00c</span> IdleThread       : Ptr32 _KTHREAD<span class="comment">//空闲线程，如果没有需要切换的就绪线程，要切换的空闲线程</span></span><br><span class="line">   +<span class="number">0x010</span> Number           : Char<span class="comment">//当前CPU的编号，从0开始</span></span><br><span class="line">   +<span class="number">0x011</span> Reserved         : Char</span><br><span class="line">   +<span class="number">0x012</span> BuildType        : Uint2B</span><br><span class="line">   +<span class="number">0x014</span> SetMember        : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> CpuType          : Char</span><br><span class="line">   +<span class="number">0x019</span> CpuID            : Char</span><br><span class="line">   +<span class="number">0x01a</span> CpuStep          : Uint2B</span><br><span class="line">   +<span class="number">0x01c</span> ProcessorState   : _KPROCESSOR_STATE<span class="comment">//里面有上下文信息</span></span><br><span class="line">   +<span class="number">0x33c</span> KernelReserved   : [<span class="number">16</span>] Uint4B</span><br><span class="line">   +<span class="number">0x37c</span> HalReserved      : [<span class="number">16</span>] Uint4B</span><br><span class="line">   +<span class="number">0x3bc</span> PrcbPad0         : [<span class="number">92</span>] UChar</span><br><span class="line">   +<span class="number">0x418</span> LockQueue        : [<span class="number">16</span>] _KSPIN_LOCK_QUEUE</span><br><span class="line">   +<span class="number">0x498</span> PrcbPad1         : [<span class="number">8</span>] UChar</span><br><span class="line">   +<span class="number">0x4a0</span> NpxThread        : Ptr32 _KTHREAD</span><br><span class="line">   +<span class="number">0x4a4</span> InterruptCount   : Uint4B<span class="comment">//中断次数</span></span><br><span class="line">   +<span class="number">0x4a8</span> KernelTime       : Uint4B</span><br><span class="line">   +<span class="number">0x4ac</span> UserTime         : Uint4B</span><br><span class="line">   +<span class="number">0x4b0</span> DpcTime          : Uint4B</span><br><span class="line">   +<span class="number">0x4b4</span> DebugDpcTime     : Uint4B</span><br><span class="line">   +<span class="number">0x4b8</span> InterruptTime    : Uint4B</span><br><span class="line">   +<span class="number">0x4bc</span> AdjustDpcThreshold : Uint4B</span><br><span class="line">   +<span class="number">0x4c0</span> PageColor        : Uint4B</span><br><span class="line">   +<span class="number">0x4c4</span> SkipTick         : Uint4B</span><br><span class="line">   +<span class="number">0x4c8</span> MultiThreadSetBusy : UChar</span><br><span class="line">   +<span class="number">0x4c9</span> Spare2           : [<span class="number">3</span>] UChar</span><br><span class="line">   +<span class="number">0x4cc</span> ParentNode       : Ptr32 _KNODE</span><br><span class="line">   +<span class="number">0x4d0</span> MultiThreadProcessorSet : Uint4B<span class="comment">//是否多核处理器</span></span><br><span class="line">   +<span class="number">0x4d4</span> MultiThreadSetMaster : Ptr32 _KPRCB<span class="comment">//指向别的核的_KPRCB结构</span></span><br><span class="line">   +<span class="number">0x4d8</span> ThreadStartCount : [<span class="number">2</span>] Uint4B</span><br><span class="line">   +<span class="number">0x4e0</span> CcFastReadNoWait : Uint4B</span><br><span class="line">   +<span class="number">0x4e4</span> CcFastReadWait   : Uint4B</span><br><span class="line">   +<span class="number">0x4e8</span> CcFastReadNotPossible : Uint4B</span><br><span class="line">   +<span class="number">0x4ec</span> CcCopyReadNoWait : Uint4B</span><br><span class="line">   +<span class="number">0x4f0</span> CcCopyReadWait   : Uint4B</span><br><span class="line">   +<span class="number">0x4f4</span> CcCopyReadNoWaitMiss : Uint4B</span><br><span class="line">   +<span class="number">0x4f8</span> KeAlignmentFixupCount : Uint4B</span><br><span class="line">   +<span class="number">0x4fc</span> KeContextSwitches : Uint4B</span><br><span class="line">   +<span class="number">0x500</span> KeDcacheFlushCount : Uint4B</span><br><span class="line">   +<span class="number">0x504</span> KeExceptionDispatchCount : Uint4B</span><br><span class="line">   +<span class="number">0x508</span> KeFirstLevelTbFills : Uint4B</span><br><span class="line">   +<span class="number">0x50c</span> KeFloatingEmulationCount : Uint4B</span><br><span class="line">   +<span class="number">0x510</span> KeIcacheFlushCount : Uint4B</span><br><span class="line">   +<span class="number">0x514</span> KeSecondLevelTbFills : Uint4B</span><br><span class="line">   +<span class="number">0x518</span> KeSystemCalls    : Uint4B<span class="comment">//系统调用次数（3环进0环次数）</span></span><br><span class="line">   +<span class="number">0x51c</span> SpareCounter0    : [<span class="number">1</span>] Uint4B</span><br><span class="line">   +<span class="number">0x520</span> PPLookasideList  : [<span class="number">16</span>] _PP_LOOKASIDE_LIST</span><br><span class="line">   +<span class="number">0x5a0</span> PPNPagedLookasideList : [<span class="number">32</span>] _PP_LOOKASIDE_LIST</span><br><span class="line">   +<span class="number">0x6a0</span> PPPagedLookasideList : [<span class="number">32</span>] _PP_LOOKASIDE_LIST</span><br><span class="line">   +<span class="number">0x7a0</span> PacketBarrier    : Uint4B</span><br><span class="line">   +<span class="number">0x7a4</span> ReverseStall     : Uint4B</span><br><span class="line">   +<span class="number">0x7a8</span> IpiFrame         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x7ac</span> PrcbPad2         : [<span class="number">52</span>] UChar</span><br><span class="line">   +<span class="number">0x7e0</span> CurrentPacket    : [<span class="number">3</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0x7ec</span> TargetSet        : Uint4B</span><br><span class="line">   +<span class="number">0x7f0</span> WorkerRoutine    : Ptr32     <span class="type">void</span> </span><br><span class="line">   +<span class="number">0x7f4</span> IpiFrozen        : Uint4B</span><br><span class="line">   +<span class="number">0x7f8</span> PrcbPad3         : [<span class="number">40</span>] UChar</span><br><span class="line">   +<span class="number">0x820</span> RequestSummary   : Uint4B</span><br><span class="line">   +<span class="number">0x824</span> SignalDone       : Ptr32 _KPRCB</span><br><span class="line">   +<span class="number">0x828</span> PrcbPad4         : [<span class="number">56</span>] UChar</span><br><span class="line">   +<span class="number">0x860</span> DpcListHead      : _LIST_ENTRY<span class="comment">//DPC链表</span></span><br><span class="line">   +<span class="number">0x868</span> DpcStack         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x86c</span> DpcCount         : Uint4B</span><br><span class="line">   +<span class="number">0x870</span> DpcQueueDepth    : Uint4B</span><br><span class="line">   +<span class="number">0x874</span> DpcRoutineActive : Uint4B</span><br><span class="line">   +<span class="number">0x878</span> DpcInterruptRequested : Uint4B</span><br><span class="line">   +<span class="number">0x87c</span> DpcLastCount     : Uint4B</span><br><span class="line">   +<span class="number">0x880</span> DpcRequestRate   : Uint4B</span><br><span class="line">   +<span class="number">0x884</span> MaximumDpcQueueDepth : Uint4B</span><br><span class="line">   +<span class="number">0x888</span> MinimumDpcRate   : Uint4B</span><br><span class="line">   +<span class="number">0x88c</span> QuantumEnd       : Uint4B<span class="comment">//标志当前在运行的CPU时间片是否用完，没有用完是0，用完就是个非零的值</span></span><br><span class="line">   +<span class="number">0x890</span> PrcbPad5         : [<span class="number">16</span>] UChar</span><br><span class="line">   +<span class="number">0x8a0</span> DpcLock          : Uint4B</span><br><span class="line">   +<span class="number">0x8a4</span> PrcbPad6         : [<span class="number">28</span>] UChar</span><br><span class="line">   +<span class="number">0x8c0</span> CallDpc          : _KDPC</span><br><span class="line">   +<span class="number">0x8e0</span> ChainedInterruptList : Ptr32 Void</span><br><span class="line">   +<span class="number">0x8e4</span> LookasideIrpFloat : Int4B</span><br><span class="line">   +<span class="number">0x8e8</span> SpareFields0     : [<span class="number">6</span>] Uint4B</span><br><span class="line">   +<span class="number">0x900</span> VendorString     : [<span class="number">13</span>] UChar<span class="comment">//处理器品牌名</span></span><br><span class="line">   +<span class="number">0x90d</span> InitialApicId    : UChar</span><br><span class="line">   +<span class="number">0x90e</span> LogicalProcessorsPerPhysicalProcessor : UChar</span><br><span class="line">   +<span class="number">0x910</span> MHz              : Uint4B</span><br><span class="line">   +<span class="number">0x914</span> FeatureBits      : Uint4B</span><br><span class="line">   +<span class="number">0x918</span> UpdateSignature  : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x920</span> NpxSaveArea      : _FX_SAVE_AREA</span><br><span class="line">   +<span class="number">0xb30</span> PowerState       : _PROCESSOR_POWER_STATE</span><br></pre></td></tr></table></figure>

<h4 id="KiProcessorBlock全局变量-未导出"><a href="#KiProcessorBlock全局变量-未导出" class="headerlink" title="KiProcessorBlock全局变量(未导出)"></a><strong>KiProcessorBlock</strong>全局变量(未导出)</h4><p>PKPRCB	<strong>KiProcessorBlock</strong>[MAXIMUM_PROCESSORS];</p>
<ul>
<li><p><strong>[定 义]</strong> wrk\wrk-v1.2\base\ntos\ke\kernldat.c</p>
</li>
<li><p><strong>[初始化]</strong> wrk\wrk-v1.2\base\ntos\ex\obinit.c [KiSystemStartup ()]</p>
</li>
<li><p><strong>[引 用]</strong></p>
<ul>
<li>KiSwapThread()                  线程调度</li>
<li>KiSetAffinityThread()             设置线程亲和性</li>
</ul>
</li>
<li><p><strong>[描 述]</strong></p>
<p>系统核心数据结构，与线程调度密切相关。<strong>所有KPRCB的指针数组</strong>，往前拨偏移可以得到对应KPCR。MAXIMUM_PROCESSORS定义为32。而实际数组的元素个数由上面KeNumberProcessors决定，每个处理器对应一个KPRCB结构体。</p>
</li>
</ul>
<h2 id="指定进程名找进程结构首地址"><a href="#指定进程名找进程结构首地址" class="headerlink" title="指定进程名找进程结构首地址"></a>指定进程名找进程结构首地址</h2><p>通过cpu结构，线程结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ULONG <span class="title function_">findProcess</span><span class="params">(<span class="type">char</span>* name)</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG curProcess;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov eax, dword ptr fs : [<span class="number">0x124</span>] ;<span class="comment">//KPCR中找当前线程结构体地址</span></span><br><span class="line">		mov ecx, [eax + <span class="number">0x44</span>];<span class="comment">//获取线程结构体中存储的线程所属的进程结构体地址</span></span><br><span class="line">		mov curProcess, ecx;<span class="comment">//即获取到当前进程结构体地址</span></span><br><span class="line">	&#125;<span class="comment">//上面三行作用等于API函数：PsGetCurrentProcess()</span></span><br><span class="line"></span><br><span class="line">	PLIST_ENTRY plistProcess = (PLIST_ENTRY)(curProcess + <span class="number">0x88</span>);<span class="comment">//活动进程双向链表</span></span><br><span class="line">	BOOLEAN isFlags = FALSE;</span><br><span class="line">	<span class="comment">//遍历活动进程双向链表，通过进程名字找对应进程</span></span><br><span class="line">	<span class="keyword">while</span> (plistProcess-&gt;Flink != (PLIST_ENTRY)(curProcess + <span class="number">0x88</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		ULONG nextProcess = ((ULONG)(plistProcess)) - <span class="number">0x88</span>;</span><br><span class="line">		plistProcess = plistProcess-&gt;Flink;</span><br><span class="line">		<span class="comment">//KdPrint((&quot;%s\n&quot;, (PCHAR)(nextProcess + 0x174)));</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, (PCHAR)(nextProcess + <span class="number">0x174</span>)) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			curProcess = nextProcess;</span><br><span class="line">			isFlags = TRUE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!isFlags)</span><br><span class="line">	&#123;</span><br><span class="line">		curProcess = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> curProcess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="对象头结构体"><a href="#对象头结构体" class="headerlink" title="对象头结构体"></a>对象头结构体</h1><p><strong>每个内核对象都有对象头结构体。</strong></p>
<p>windbg查看一个进程下的线程，用如下命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!process 要找的_EPROCESS结构体首地址</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912105201611.png" alt="image-20210912105201611"></p>
<h2 id="OBJECT-HEADER"><a href="#OBJECT-HEADER" class="headerlink" title="_OBJECT_HEADER"></a>_OBJECT_HEADER</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _OBJECT_HEADER</span><br><span class="line">nt!_OBJECT_HEADER</span><br><span class="line">   +<span class="number">0x000</span> PointerCount     : Int4B</span><br><span class="line">   +<span class="number">0x004</span> HandleCount      : Int4B</span><br><span class="line">   +<span class="number">0x004</span> NextToFree       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x008</span> Type             : Ptr32 _OBJECT_TYPE<span class="comment">//_OBJECT_TYPE结构体</span></span><br><span class="line">   +<span class="number">0x00c</span> NameInfoOffset   : UChar</span><br><span class="line">   +<span class="number">0x00d</span> HandleInfoOffset : UChar</span><br><span class="line">   +<span class="number">0x00e</span> QuotaInfoOffset  : UChar</span><br><span class="line">   +<span class="number">0x00f</span> Flags            : UChar</span><br><span class="line">   +<span class="number">0x010</span> ObjectCreateInfo : Ptr32 _OBJECT_CREATE_INFORMATION</span><br><span class="line">   +<span class="number">0x010</span> QuotaBlockCharged : Ptr32 Void</span><br><span class="line">   +<span class="number">0x014</span> SecurityDescriptor : Ptr32 Void</span><br><span class="line">   +<span class="number">0x018</span> Body             : _QUAD<span class="comment">//内嵌真正的对象结构</span></span><br></pre></td></tr></table></figure>

<h3 id="OBJECT-TYPE"><a href="#OBJECT-TYPE" class="headerlink" title="_OBJECT_TYPE"></a>_OBJECT_TYPE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _OBJECT_TYPE</span><br><span class="line">ntdll!_OBJECT_TYPE</span><br><span class="line">   +<span class="number">0x000</span> Mutex            : _ERESOURCE</span><br><span class="line">   +<span class="number">0x038</span> TypeList         : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x040</span> Name             : _UNICODE_STRING<span class="comment">//对象类型名，如Process，Thread</span></span><br><span class="line">   +<span class="number">0x048</span> DefaultObject    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x04c</span> Index            : Uint4B</span><br><span class="line">   +<span class="number">0x050</span> TotalNumberOfObjects : Uint4B</span><br><span class="line">   +<span class="number">0x054</span> TotalNumberOfHandles : Uint4B</span><br><span class="line">   +<span class="number">0x058</span> HighWaterNumberOfObjects : Uint4B</span><br><span class="line">   +<span class="number">0x05c</span> HighWaterNumberOfHandles : Uint4B</span><br><span class="line">   +<span class="number">0x060</span> TypeInfo         : _OBJECT_TYPE_INITIALIZER<span class="comment">//内含对象的回调函数</span></span><br><span class="line">   +<span class="number">0x0ac</span> Key              : Uint4B</span><br><span class="line">   +<span class="number">0x0b0</span> ObjectLocks      : [<span class="number">4</span>] _ERESOURCE</span><br></pre></td></tr></table></figure>

<p>实例如下</p>
<p>进程对象头：</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912105028347.png" alt="image-20210912105028347"></p>
<p>线程对象头：</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912105300055.png" alt="image-20210912105300055"></p>
<h1 id="等待链表-调度链表"><a href="#等待链表-调度链表" class="headerlink" title="等待链表_调度链表"></a>等待链表_调度链表</h1><p>进程结构体EPROCESS（0x50和0x190）是2个链表，里面圈着当前进程所有的线程。</p>
<p>对进程断链，程序可以正常运行，原因是CPU执行与调度是基于线程的，进程断链只是影响一些遍历系统进程的API，并不会影响程序执行。</p>
<p>对线程断链也是一样的，断链后再Windbg或OD中无法看到被断掉的线程，但并不影响执行（仍然在跑）</p>
<p>CPU到哪里去找线程？</p>
<h2 id="等待链表"><a href="#等待链表" class="headerlink" title="等待链表"></a>等待链表</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd KiWaitListHead</span><br></pre></td></tr></table></figure>

<p>KiWaitListHead储存着等待线程双向链表的<strong>全局变量</strong>，存了两个指针，分别指向的是前一个和后一个_ETHREAD结构体中的_KTHREAD结构体0x60偏移的WaitListEntry成员</p>
<p>线程调用了Sleep()或WaitForSingleObject()等函数时，就挂到这个链表中。</p>
<p><strong>线程有三种状态</strong></p>
<ol>
<li>就绪</li>
<li>等待</li>
<li>运行</li>
</ol>
<p>正在运行中的线程存储在KPCR中，就绪和等待的线程全在另外的33个链表中。一个等待链表，32个就绪链表：</p>
<p>这些链表都使用了_KTHREAD(0x60)这个位置，也就是说，<strong>线程在某一时刻，只能属于其中一个圈</strong></p>
<h2 id="调度链表-就绪链表"><a href="#调度链表-就绪链表" class="headerlink" title="调度链表(就绪链表)"></a>调度链表(就绪链表)</h2><p>既然有32个就绪链表，就要有32个链表头。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kd&gt;dd KiDispatcherReadyListHead L70</span><br></pre></td></tr></table></figure>

<p>KiDispatcherReadyListHead储存着32个就绪线程双向链表的<strong>全局变量</strong>，32个8字节的数组，每个链表占8字节。</p>
<p>这个地址存储了32个链表头，分别对应32个优先级的调度链表，地址越高，优先级越高。如果FLink 等于 BLink 等于地址，说明此时链表为空；如果FLink等于BLink不等于地址，说明此时链表中只有一个线程。比如现在我 dd 打印，这时操作系统挂起，所有线程都处于等待状态，全部调度链表都是空的（因为windbg调试的时候，所有线程都会被挂起）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd KiDispatcherReadyListHead</span><br><span class="line">8055bc20  8055bc20 8055bc20 8055bc28 8055bc28</span><br><span class="line">8055bc30  8055bc30 8055bc30 8055bc38 8055bc38</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913143736703.png" alt="image-20210913143736703"></p>
<p>全局变量<strong>KiReadySummary</strong>，32位，如果哪个存在就绪链表，其该位被置1。其从低位到高位就绪链表优先级依次升高，因此需要找从左边数第一个为1的位数，该位作为位数从KiDispatchReadListHead数组中寻找。</p>
<p>null</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/1827556-20200422144013785-765135328.png" alt="1827556-20200422144013785-765135328"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41875267/article/details/109740362">调度链表讲解</a></p>
<h3 id="版本差异"><a href="#版本差异" class="headerlink" title="版本差异"></a>版本差异</h3><ul>
<li>XP只有32个调度链表,整个系统(包括多核)只有32个</li>
<li>64位系统有64个调度链表,整个系统(包括多核)只有64个</li>
</ul>
<p>服务器版本又有不同</p>
<p>KiWaitListHead整个系统只有一个，但KiDispatcherReadyListHead这个数组有几个CPU就有几组。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>正在运行的线程在KPCR中</li>
<li>准备运行的线程在32个调度链表中(0~31级)，<strong>KiDispatcherReadyListHead</strong>是个存储了这32个链表头的数组。</li>
<li>等待状态的线程存储在等待链表中，<strong>KiWaitListHead</strong>存储链表头。</li>
<li>这些圈都挂一个相同的位置：_KTHREAD(0x60)</li>
</ul>
<h1 id="线程切换"><a href="#线程切换" class="headerlink" title="线程切换"></a>线程切换</h1><h2 id="逆向线程主动切换"><a href="#逆向线程主动切换" class="headerlink" title="逆向线程主动切换"></a>逆向线程主动切换</h2><p>Windows的线程切换比较复杂，</p>
<p>为了更好的学习，先了解一份代码：逆向ThreadSwitch</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210910191936188.png" alt="image-20210910191936188"></p>
<ol>
<li><p>四个参数，  ebx：_KPCR	esi：新线程 _KTHREAD	edi：旧线程 _KTHREAD  ecx：WaitIrql</p>
</li>
<li><p>换esp的瞬间就是线程切换的真正本质</p>
</li>
<li><p>不一定切换CR3，仅在跨进程线程切换时才切换CR3</p>
</li>
<li><p>TSS中存储的一定是当前线程的，因为每次线程切换，都会更新TSS中的对应值</p>
</li>
<li><p>线程切换时FS虽然不变，但是fs的段选择子对应的段描述符的baseAddress会被修改为当前线程对应的TEB内存</p>
</li>
<li><p>push的方式将老线程的异常链表(_KPCR.ExceptionList)存到老线程堆栈，改变esp后(即修改线程后)，通过pop的方式取出新线程堆栈中的异常链表存到_KPCR.ExceptionList中</p>
</li>
<li><p>空闲线程的_KTHREAD,当KiFindReadyThread找KPCR中的nextThread为空，并且也找不到就绪链表中有线程的时候，就把线程交换给空闲线程。</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917174204289.png" alt="image-20210917174204289"></p>
<p>如图可知，IdleThread的线程开始入口并非放在_ETHREAD中，而是另有地方存</p>
<p>​	如何找到IdleThread跑的函数：_KPCR._KPRCB.IdleThread.KernelStack，我们知道交换到IdleThread是经过SwapContext线程切换过去的。SwapContext将线程的KernelStack放入esp后的堆栈操作有这些，pop ecx(取出异常链表地址),popf(取出eflags寄存器)，retn(取出要执行的地址跳转)。如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917175257328.png" alt="image-20210917175257328"></p>
<p>windbg当前断下的就是IdleThread线程。</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917174430574.png" alt="image-20210917174430574"><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917174644671.png" alt="image-20210917174644671"></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917174728430.png" alt="image-20210917174728430"></p>
<p>因此可知：IdleThread线程入口是KiIdleLoop函数</p>
</li>
<li><p>KiFindReadyThread，先找KPCR中nextThread是否有值，若为空去找调度线程链表找到最高优先级的就绪线程</p>
</li>
<li><p>很多细节没考究</p>
</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210911111900026.png" alt="image-20210911111900026"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">。。。(上图函数)</span><br><span class="line">    -&gt;KiSwapThread</span><br><span class="line">    -&gt;KiSwapContext</span><br><span class="line">    -&gt;SwapContext</span><br></pre></td></tr></table></figure>

<h3 id="KiSwapThread"><a href="#KiSwapThread" class="headerlink" title="KiSwapThread"></a>KiSwapThread</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">004050B</span>F ; _DWORD __cdecl <span class="title function_">KiSwapThread</span><span class="params">()</span><span class="comment">//无参</span></span><br><span class="line">.text:004050BF @KiSwapThread@0 proc near               ; CODE XREF: KeDelayExecutionThread(x,x,x):loc_405017↑p</span><br><span class="line">.text:<span class="number">004050B</span>F                                         ; KeWaitForSingleObject(x,x,x,x,x):loc_40513E↓p ...</span><br><span class="line">.text:<span class="number">004050B</span>F</span><br><span class="line">.text:<span class="number">004050B</span>F ; FUNCTION CHUNK AT .text:<span class="number">0040</span>EA85 SIZE <span class="number">00000015</span> BYTES</span><br><span class="line">.text:<span class="number">004050B</span>F ; FUNCTION CHUNK AT .text:<span class="number">004109</span>AF SIZE <span class="number">00000009</span> BYTES</span><br><span class="line">.text:<span class="number">004050B</span>F</span><br><span class="line">.text:<span class="number">004050B</span>F                 mov     edi, edi</span><br><span class="line">.text:<span class="number">004050</span>C1                 push    esi</span><br><span class="line">.text:<span class="number">004050</span>C2                 push    edi</span><br><span class="line">.text:<span class="number">004050</span>C3                 db      <span class="number">3</span>Eh</span><br><span class="line">.text:<span class="number">004050</span>C3                 mov     eax, ds:<span class="number">0F</span>FDFF020h<span class="comment">//eax取_KPRCB结构体首地址</span></span><br><span class="line">.text:<span class="number">004050</span>C9                 mov     esi, eax<span class="comment">//esi为_KPRCB结构体首地址</span></span><br><span class="line">.text:<span class="number">004050</span>CB                 mov     eax, [esi+<span class="number">8</span>]<span class="comment">//eax取下一个线程结构体地址</span></span><br><span class="line">.text:<span class="number">004050</span>CE                 test    eax, eax<span class="comment">//判断eax是否为0</span></span><br><span class="line">.text:<span class="number">004050</span>D0                 mov     edi, [esi+<span class="number">4</span>]<span class="comment">//edi取当前CPU正在跑的线程结构体地址</span></span><br><span class="line">.text:<span class="number">004050</span>D3                 jnz     loc_4109AF<span class="comment">//下一个线程结构体不为0则跳转</span></span><br><span class="line">.text:<span class="number">004050</span>D9                 push    ebx</span><br><span class="line">.text:<span class="number">004050</span>DA                 movsx   ebx, byte ptr [esi+<span class="number">10</span>h]<span class="comment">//ebx取kpcr的CPU核心编号</span></span><br><span class="line">.text:<span class="number">004050</span>DE                 xor     edx, edx</span><br><span class="line">.text:<span class="number">004050E0</span>                 mov     ecx, ebx</span><br><span class="line">.text:<span class="number">004050E2</span>                 call    @KiFindReadyThread@<span class="number">8</span> ; KiFindReadyThread(x,x)<span class="comment">//没有下一个线程结构体的情况下调该函数寻找准备好的线程</span></span><br><span class="line">.text:<span class="number">004050E7</span>                 test    eax, eax<span class="comment">//判断是否找到</span></span><br><span class="line">.text:<span class="number">004050E9</span>                 jz      loc_40EA85<span class="comment">//未找到则跳转</span></span><br><span class="line">.text:<span class="number">004050</span>EF</span><br><span class="line">.text:<span class="number">004050</span>EF loc_4050EF:                             ; CODE XREF: KiSwapThread()+<span class="number">99</span>D6↓j</span><br><span class="line">.text:<span class="number">004050</span>EF                 pop     ebx</span><br><span class="line">.text:<span class="number">004050F</span>0</span><br><span class="line">.text:<span class="number">004050F</span>0 loc_4050F0:                             ; CODE XREF: KiSwapThread()+B8F4↓j<span class="comment">//开始线程切换</span></span><br><span class="line">.text:<span class="number">004050F</span>0                 mov     ecx, eax<span class="comment">//ecx取下一个线程或空闲结构体地址</span></span><br><span class="line">.text:<span class="number">004050F</span>2                 call    @KiSwapContext@<span class="number">4</span> ; KiSwapContext(x)<span class="comment">//开始切换线程上下文</span></span><br><span class="line">.text:<span class="number">004050F</span>7                 test    al, al</span><br><span class="line">.text:<span class="number">004050F</span>9                 mov     cl, [edi+<span class="number">58</span>h]   ; NewIrql</span><br><span class="line">.text:<span class="number">004050F</span>C                 mov     edi, [edi+<span class="number">54</span>h]</span><br><span class="line">.text:<span class="number">004050F</span>F                 mov     esi, ds:__imp_@KfLowerIrql@<span class="number">4</span> ; KfLowerIrql(x)</span><br><span class="line">.text:<span class="number">00405105</span>                 jnz     loc_415ADB</span><br><span class="line">.text:<span class="number">0040510B</span></span><br><span class="line">.text:<span class="number">0040510B</span> loc_40510B:                             ; CODE XREF: IopCompleteRequest(x,x,x,x,x)+<span class="number">24</span>A↓j</span><br><span class="line">.text:<span class="number">0040510B</span>                 call    esi ; KfLowerIrql(x) ; KfLowerIrql(x)</span><br><span class="line">.text:<span class="number">0040510</span>D                 mov     eax, edi</span><br><span class="line">.text:<span class="number">0040510F</span>                 pop     edi</span><br><span class="line">.text:<span class="number">00405110</span>                 pop     esi</span><br><span class="line">.text:<span class="number">00405111</span>                 retn</span><br><span class="line">.text:<span class="number">00405111</span> @KiSwapThread@<span class="number">0</span> endp</span><br><span class="line">    </span><br><span class="line">.text:<span class="number">0040</span>EA85 ; START OF FUNCTION CHUNK FOR @KiSwapThread@<span class="number">0</span></span><br><span class="line">.text:<span class="number">0040</span>EA85</span><br><span class="line">.text:<span class="number">0040</span>EA85 loc_40EA85:                             ; CODE XREF: KiSwapThread()+<span class="number">2</span>A↑j<span class="comment">//没取到下一个就绪线程的话，走此处</span></span><br><span class="line">.text:<span class="number">0040</span>EA85                 mov     eax, [esi+<span class="number">0</span>Ch]<span class="comment">//eax取KPCR中的IdleThread，即返回值取闲置线程</span></span><br><span class="line">.text:<span class="number">0040</span>EA88                 xor     edx, edx<span class="comment">//edx清0</span></span><br><span class="line">.text:<span class="number">0040</span>EA8A                 inc     edx<span class="comment">//edx=1</span></span><br><span class="line">.text:<span class="number">0040</span>EA8B                 mov     ecx, ebx<span class="comment">//ecx取kpcr的CPU核心编号=0</span></span><br><span class="line">.text:<span class="number">0040</span>EA8D                 shl     edx, cl<span class="comment">//edx左移0，edx=1</span></span><br><span class="line">.text:<span class="number">0040</span>EA8F                 or      ds:_KiIdleSummary, edx<span class="comment">//_KiIdleSummary第0位置1</span></span><br><span class="line">.text:<span class="number">0040</span>EA95                 jmp     loc_4050EF</span><br><span class="line">.text:<span class="number">0040</span>EA95 ; END OF FUNCTION CHUNK FOR @KiSwapThread@<span class="number">0</span></span><br><span class="line">    </span><br><span class="line">.text:<span class="number">004109</span>AF ; START OF FUNCTION CHUNK FOR @KiSwapThread@<span class="number">0</span></span><br><span class="line">.text:<span class="number">004109</span>AF</span><br><span class="line">.text:<span class="number">004109</span>AF loc_4109AF:                             ; CODE XREF: KiSwapThread()+<span class="number">14</span>↑j<span class="comment">//下一个线程结构体已准备就绪的情况下：</span></span><br><span class="line">.text:<span class="number">004109</span>AF                 and     dword ptr [esi+<span class="number">8</span>], <span class="number">0</span><span class="comment">//_KPRCB结构体中下一个线程结构体位置清空</span></span><br><span class="line">.text:<span class="number">004109B</span>3                 jmp     loc_4050F0</span><br><span class="line">.text:<span class="number">004109B</span>3 ; END OF FUNCTION CHUNK FOR @KiSwapThread@<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="KiFindReadyThread"><a href="#KiFindReadyThread" class="headerlink" title="KiFindReadyThread"></a>KiFindReadyThread</h4><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210911143508984.png" alt="image-20210911143508984"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//两个参数，分别是ecx为kpcr的CPU核心编号(单核模式下这个参数是没有用的)，edx为0,表示要求的最低优先级，此处是函数开始位置</span></span><br><span class="line">.text:<span class="number">00405052</span> ; __fastcall <span class="title function_">KiFindReadyThread</span><span class="params">(x, x)</span></span><br><span class="line">.text:00405052 @KiFindReadyThread@8 proc near          ; CODE XREF: KiSwapThread()+<span class="number">23</span>↓p</span><br><span class="line">.text:<span class="number">00405052</span>                                         ; KiAdjustQuantumThread(x)+<span class="number">10</span>C4↓p ...</span><br><span class="line">.text:<span class="number">00405052</span></span><br><span class="line">.text:<span class="number">00405052</span> ; FUNCTION CHUNK AT .text:<span class="number">00401</span>EEC SIZE <span class="number">00000011</span> BYTES</span><br><span class="line">.text:<span class="number">00405052</span> ; FUNCTION CHUNK AT .text:<span class="number">0040503F</span> SIZE <span class="number">0000000</span>E BYTES</span><br><span class="line">.text:<span class="number">00405052</span></span><br><span class="line">.text:<span class="number">00405052</span>                 xor     eax, eax<span class="comment">//eax清零</span></span><br><span class="line">.text:<span class="number">00405054</span>                 inc     eax<span class="comment">//eax=1</span></span><br><span class="line">.text:<span class="number">00405055</span>                 mov     ecx, edx<span class="comment">//ecx清零</span></span><br><span class="line">.text:<span class="number">00405057</span>                 shl     eax, cl<span class="comment">//eax左移0位</span></span><br><span class="line">.text:<span class="number">00405059</span>                 push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0040505B</span>                 pop     ecx<span class="comment">//ecx=10</span></span><br><span class="line">.text:<span class="number">0040505</span>C                 dec     eax<span class="comment">//eax=0</span></span><br><span class="line">.text:<span class="number">0040505</span>D                 not     eax<span class="comment">//eax=0xFFFFFFFF</span></span><br><span class="line">.text:<span class="number">0040505F</span>                 and     eax, ds:_KiReadySummary<span class="comment">//_KiReadySummary为3500，eax=_KiReadySummary</span></span><br><span class="line">.text:<span class="number">00405065</span>                 mov     edx, eax<span class="comment">//edx=_KiReadySummary</span></span><br><span class="line">.text:<span class="number">00405067</span>                 shr     edx, <span class="number">10</span>h<span class="comment">//edx=_KiReadySummary&gt;&gt;0x10=0</span></span><br><span class="line">.text:<span class="number">0040506</span>A                 jnz     <span class="type">short</span> loc_405070<span class="comment">//目前情况不跳转，但其实取决于_KiReadySummary</span></span><br><span class="line">.text:<span class="number">0040506</span>C                 xor     ecx, ecx<span class="comment">//ecx=0</span></span><br><span class="line">.text:<span class="number">0040506</span>E                 mov     edx, eax<span class="comment">//edx=0</span></span><br><span class="line">.text:<span class="number">00405070</span></span><br><span class="line">.text:<span class="number">00405070</span> loc_405070:                             ; CODE XREF: KiFindReadyThread(x,x)+<span class="number">18</span>↑j</span><br><span class="line">.text:<span class="number">00405070</span>                 test    edx, <span class="number">0F</span>FFFFF00h</span><br><span class="line">.text:<span class="number">00405076</span>                 jz      <span class="type">short</span> loc_40507B<span class="comment">//目前情况不跳转，取决于ReadySummary</span></span><br><span class="line">.text:<span class="number">00405078</span>                 add     ecx, <span class="number">8</span><span class="comment">//目前情况ecx=8</span></span><br><span class="line">.text:<span class="number">0040507B</span></span><br><span class="line">.text:<span class="number">0040507B</span> loc_40507B:                             ; CODE XREF: KiFindReadyThread(x,x)+<span class="number">24</span>↑j</span><br><span class="line">.text:<span class="number">0040507B</span>                 mov     edx, eax<span class="comment">//edx=_KiReadySummary=0x3500</span></span><br><span class="line">.text:<span class="number">0040507</span>D                 shr     edx, cl<span class="comment">//edx=_KiReadySummary&gt;&gt;8=0x35</span></span><br><span class="line">.text:<span class="number">0040507F</span>                 push    esi</span><br><span class="line">.text:<span class="number">00405080</span>                 push    <span class="number">1F</span>h</span><br><span class="line">.text:<span class="number">00405082</span>                 movsx   edx, ds:_KiFindFirstSetLeft[edx]<span class="comment">//此代码ida有问题，实际上取的是byte而不是dword，前面针对edx的种种操作都是为了确定该下标，动态调试0x35下标的是0x05，edx=0x05</span></span><br><span class="line">.text:<span class="number">00405089</span>                 add     edx, ecx<span class="comment">//edx=5+8=0xD</span></span><br><span class="line">.text:<span class="number">0040508B</span>                 pop     ecx<span class="comment">//ECX=0x1F</span></span><br><span class="line">.text:<span class="number">0040508</span>C                 sub     ecx, edx<span class="comment">//ecx=0x1F-0xD=0x12</span></span><br><span class="line">.text:<span class="number">0040508</span>E                 shl     eax, cl<span class="comment">//_KiReadySummar0x3500左移0x12位，eax=0xD4000000</span></span><br><span class="line">.text:<span class="number">00405090</span>                 lea     esi, _KiDispatcherReadyListHead[edx*<span class="number">8</span>]<span class="comment">//对应优先级的调度链表中取链表首地址</span></span><br><span class="line">.text:<span class="number">00405097</span>                 test    eax, eax</span><br><span class="line">.text:<span class="number">00405099</span>                 jz      <span class="type">short</span> loc_40503F<span class="comment">//eax是0就跳</span></span><br><span class="line">.text:<span class="number">0040509B</span></span><br><span class="line">.text:<span class="number">0040509B</span> loc_40509B:                             ; CODE XREF: KiFindReadyThread(x,x)<span class="number">-7</span>↑j</span><br><span class="line">.text:<span class="number">0040509B</span>                 test    eax, eax</span><br><span class="line">.text:<span class="number">0040509</span>D                 jge     <span class="type">short</span> loc_405043<span class="comment">//eax大于等于0就跳，跳过去也是处理完再跳回来</span></span><br><span class="line">.text:<span class="number">0040509F</span>                 mov     eax, [esi]<span class="comment">//eax取得线调度链表中的第一个线程结构体的0x60偏移</span></span><br><span class="line">.text:<span class="number">004050</span>A1                 mov     ecx, [eax]<span class="comment">//ecx取调度链表中线程结构体等待链表中的第一个</span></span><br><span class="line">.text:<span class="number">004050</span>A3                 sub     eax, <span class="number">60</span>h<span class="comment">//eax减了60后是线程结构体首地址</span></span><br><span class="line">.text:<span class="number">004050</span>A6                 push    edi</span><br><span class="line">.text:<span class="number">004050</span>A7                 mov     edi, [eax+<span class="number">64</span>h]<span class="comment">//edi取调度链表中线程结构体等待链表中的下一个</span></span><br><span class="line">.text:<span class="number">004050</span>AA                 mov     [edi], ecx</span><br><span class="line">.text:<span class="number">004050</span>AC                 mov     [ecx+<span class="number">4</span>], edi</span><br><span class="line">.text:<span class="number">004050</span>AF                 cmp     [esi], esi<span class="comment">//当前链表是否为空</span></span><br><span class="line">.text:<span class="number">004050B</span>1                 pop     edi</span><br><span class="line">.text:<span class="number">004050B</span>2                 jz      loc_401EEC</span><br><span class="line">.text:<span class="number">004050B</span>8</span><br><span class="line">.text:<span class="number">004050B</span>8 loc_4050B8:                             ; CODE XREF: KiFindReadyThread(x,x)<span class="number">-11</span>↑j</span><br><span class="line">.text:<span class="number">004050B</span>8                 pop     esi</span><br><span class="line">.text:<span class="number">004050B</span>9                 retn</span><br><span class="line">.text:<span class="number">004050B</span>9 @KiFindReadyThread@<span class="number">8</span> endp</span><br></pre></td></tr></table></figure>

<p>分析感觉不是很准确</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/onetrainee/p/12752183.html">网上对KiFindReadyThread更详尽的分析参考</a></p>
<p><em>该函数做了三件事：</em></p>
<ol>
<li>解析KiReadySummary，找到从左起第一个为1的位数；</li>
<li>用该位获取从KiDispatchReadListHead中的第一个_KTHREAD线程，将其从链表中摘除；</li>
<li>如果摘除后该链表为空，则找到相应的KiReadySummary位将其置0。</li>
</ol>
<h3 id="KiSwapContext"><a href="#KiSwapContext" class="headerlink" title="KiSwapContext"></a>KiSwapContext</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//KiSwapContext只有一个参数，通过ecx传参，[[0FFDFF020h]+8]:_KPRCB中+8偏移的NextThread，即将切换的下一个线程结构体_KTHREAD</span></span><br><span class="line">.text:<span class="number">00404828</span> ; __fastcall <span class="title function_">KiSwapContext</span><span class="params">(x)</span></span><br><span class="line">.text:00404828 @KiSwapContext@4 proc near              ; CODE XREF: KiSwapThread()+<span class="number">33</span>↓p</span><br><span class="line">.text:<span class="number">00404828</span></span><br><span class="line">.text:<span class="number">00404828</span> var_10          = dword ptr <span class="number">-10</span>h</span><br><span class="line">.text:<span class="number">00404828</span> var_C           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">00404828</span> var_8           = dword ptr <span class="number">-8</span></span><br><span class="line">.text:<span class="number">00404828</span> var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">00404828</span></span><br><span class="line">.text:<span class="number">00404828</span>                 sub     esp, <span class="number">10</span>h<span class="comment">//升栈</span></span><br><span class="line">    <span class="comment">//保存当前线程寄存器的现场</span></span><br><span class="line">.text:<span class="number">0040482B</span>                 mov     [esp+<span class="number">10</span>h+var_4], ebx<span class="comment">//保存原线程寄存器ebx</span></span><br><span class="line">.text:<span class="number">0040482F</span>                 mov     [esp+<span class="number">10</span>h+var_8], esi<span class="comment">//保存原线程寄存器esi</span></span><br><span class="line">.text:<span class="number">00404833</span>                 mov     [esp+<span class="number">10</span>h+var_C], edi<span class="comment">//保存原线程寄存器edi</span></span><br><span class="line">.text:<span class="number">00404837</span>                 mov     [esp+<span class="number">10</span>h+var_10], ebp<span class="comment">//保存原线程寄存器ebp</span></span><br><span class="line">.text:<span class="number">0040483</span>A                 mov     ebx, ds:<span class="number">0F</span>FDFF01Ch<span class="comment">//ebx取KPCR结构体首地址</span></span><br><span class="line">.text:<span class="number">00404840</span>                 mov     esi, ecx<span class="comment">//esi取即将切换的下一个线程结构体_KTHREAD地址</span></span><br><span class="line">.text:<span class="number">00404842</span>                 mov     edi, [ebx+<span class="number">124</span>h]<span class="comment">//edi取当前CPU正在跑的线程结构体_KTHREAD地址</span></span><br><span class="line">.text:<span class="number">00404848</span>                 mov     [ebx+<span class="number">124</span>h], esi<span class="comment">//将【即将切换的下一个线程结构体_KTHREAD地址】放入【当前CPU正在跑的线程结构体_KTHREAD地址位置】</span></span><br><span class="line">.text:<span class="number">0040484</span>E                 mov     cl, [edi+<span class="number">58</span>h]<span class="comment">//cl取WaitIrql</span></span><br><span class="line">.text:<span class="number">00404851</span>                 call    SwapContext</span><br><span class="line">.text:<span class="number">00404856</span>                 mov     ebp, [esp+<span class="number">10</span>h+var_10]<span class="comment">//取到新线程的寄存器ebp</span></span><br><span class="line">.text:<span class="number">00404859</span>                 mov     edi, [esp+<span class="number">10</span>h+var_C]<span class="comment">//取到新线程的寄存器edi</span></span><br><span class="line">.text:<span class="number">0040485</span>D                 mov     esi, [esp+<span class="number">10</span>h+var_8]<span class="comment">//取到新线程的寄存器esi</span></span><br><span class="line">.text:<span class="number">00404861</span>                 mov     ebx, [esp+<span class="number">10</span>h+var_4]<span class="comment">//取到新线程的寄存器ebx</span></span><br><span class="line">.text:<span class="number">00404865</span>                 add     esp, <span class="number">10</span>h<span class="comment">//平栈</span></span><br><span class="line">.text:<span class="number">00404868</span>                 retn</span><br><span class="line">.text:<span class="number">00404868</span> @KiSwapContext@<span class="number">4</span> endp</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912143605531.png" alt="image-20210912143605531"></p>
<h3 id="SwapContext"><a href="#SwapContext" class="headerlink" title="SwapContext"></a>SwapContext</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//四个参数 ebx: _KPCR   esi: 新线程 _KTHREAD  edi: 旧线程 _KTHREAD  ecx：旧的WaitIrql</span></span><br><span class="line">.text:<span class="number">00404924</span> SwapContext     proc near               ; CODE XREF: KiUnlockDispatcherDatabase(x)+<span class="number">72</span>↑p</span><br><span class="line">.text:<span class="number">00404924</span>                                         ; KiSwapContext(x)+<span class="number">29</span>↑p ...</span><br><span class="line">.text:<span class="number">00404924</span>                 or      cl, cl</span><br><span class="line">.text:<span class="number">00404926</span>                 mov     byte ptr es:[esi+<span class="number">2</span>Dh], <span class="number">2</span><span class="comment">//设置即将切换的下一个线程结构体的状态State为2		状态如下： 1 就绪; 2 运行; 5 等待</span></span><br><span class="line">.text:<span class="number">0040492B</span>                 pushf</span><br><span class="line">.text:<span class="number">0040492</span>C</span><br><span class="line">.text:<span class="number">0040492</span>C loc_40492C:                             ; CODE XREF: KiIdleLoop()+<span class="number">5</span>A↓j</span><br><span class="line">.text:<span class="number">0040492</span>C                 mov     ecx, [ebx]<span class="comment">//ecx取当前线程异常链表</span></span><br><span class="line">.text:<span class="number">0040492</span>E                 cmp     dword ptr [ebx+<span class="number">994</span>h], <span class="number">0</span><span class="comment">//比较DpcRoutineActive位是否为0</span></span><br><span class="line">.text:<span class="number">00404935</span>                 push    ecx<span class="comment">//当前线程异常链表压栈</span></span><br><span class="line">.text:<span class="number">00404936</span>                 jnz     loc_404A70<span class="comment">//若DpcRoutineActive位不为0则跳转</span></span><br><span class="line">.text:<span class="number">0040493</span>C                 cmp     ds:_PPerfGlobalGroupMask, <span class="number">0</span><span class="comment">//比较_PPerfGlobalGroupMask全局变量是否为0</span></span><br><span class="line">.text:<span class="number">00404943</span>                 jnz     loc_404A47<span class="comment">//_PPerfGlobalGroupMask全局变量不为0则跳转，跳转处理后依然跳回loc_404949</span></span><br><span class="line"></span><br><span class="line">.text:<span class="number">00404949</span></span><br><span class="line">.text:<span class="number">00404949</span> loc_404949:                             ; CODE XREF: SwapContext+<span class="number">12B</span>↓j</span><br><span class="line">.text:<span class="number">00404949</span>                                         ; SwapContext+<span class="number">13</span>C↓j ...</span><br><span class="line">.text:<span class="number">00404949</span>                 mov     ebp, cr0<span class="comment">//ebp为cr0</span></span><br><span class="line">.text:<span class="number">0040494</span>C                 mov     edx, ebp<span class="comment">//edx取cr0</span></span><br><span class="line">.text:<span class="number">0040494</span>E                 mov     cl, [esi+<span class="number">2</span>Ch]<span class="comment">//cl取即将切换的下一个线程的DebugActive</span></span><br><span class="line">.text:<span class="number">00404951</span>                 mov     [ebx+<span class="number">50</span>h], cl<span class="comment">//KPCR结构体中DebugActive设置为【即将切换的下一个线程的DebugActive的值】</span></span><br><span class="line">.text:<span class="number">00404954</span>                 cli<span class="comment">//禁止中断发生</span></span><br><span class="line">.text:<span class="number">00404955</span>                 mov     [edi+<span class="number">28</span>h], esp<span class="comment">//将当前esp放入【当前CPU正在跑的线程的KernelStack位置】</span></span><br><span class="line">.text:<span class="number">00404958</span>                 mov     eax, [esi+<span class="number">18</span>h]<span class="comment">//eax取即将切换的下一个线程的三环堆栈顶esp3</span></span><br><span class="line">.text:<span class="number">0040495B</span>                 mov     ecx, [esi+<span class="number">1</span>Ch]<span class="comment">//ecx取即将切换的下一个线程的三环堆栈大小</span></span><br><span class="line">.text:<span class="number">0040495</span>E                 sub     eax, <span class="number">210</span>h<span class="comment">//线程堆栈的前 0x210 字节是浮点寄存器，此时 eax 指向 _KTRAP_FRAME.V86Gs</span></span><br><span class="line">.text:<span class="number">00404963</span>                 mov     [ebx+<span class="number">8</span>], ecx<span class="comment">//KPCR中记录的栈大小设置为即将切换的下一个线程的三环堆栈大小</span></span><br><span class="line">.text:<span class="number">00404966</span>                 mov     [ebx+<span class="number">4</span>], eax<span class="comment">//KPCR中记录的栈底设置为即将切换的下一个线程的三环堆栈顶esp3-0x210</span></span><br><span class="line">.text:<span class="number">00404969</span>                 xor     ecx, ecx<span class="comment">//ecx清零</span></span><br><span class="line">.text:<span class="number">0040496B</span>                 mov     cl, [esi+<span class="number">31</span>h]<span class="comment">//cl取【即将切换的下一个线程的NpxState】</span></span><br><span class="line">.text:<span class="number">0040496</span>E                 and     edx, <span class="number">0F</span>FFFFFF1h<span class="comment">//cr0的1,2,3位清0，分别是cr0中的TS,EM,MP位</span></span><br><span class="line">.text:<span class="number">00404971</span>                 or      ecx, edx</span><br><span class="line">.text:<span class="number">00404973</span>                 or      ecx, [eax+<span class="number">20</span>Ch]<span class="comment">//ecx或上_FX_SAVE_AREA.Cr0NpxState</span></span><br><span class="line">.text:<span class="number">00404979</span>                 cmp     ebp, ecx</span><br><span class="line">.text:<span class="number">0040497B</span>                 jnz     loc_404A3F<span class="comment">//相等就不跳转，不相等就跳转，跳转后只做mov cr0，ecx再跳回loc_404983</span></span><br><span class="line">.text:<span class="number">00404981</span>                 lea     ecx, [ecx]<span class="comment">//取自己无用</span></span><br><span class="line">.text:<span class="number">00404983</span></span><br><span class="line">.text:<span class="number">00404983</span> loc_404983:                             ; CODE XREF: SwapContext+<span class="number">11</span>E↓j</span><br><span class="line">.text:<span class="number">00404983</span>                 test    dword ptr [eax<span class="number">-1</span>Ch], <span class="number">20000</span>h<span class="comment">//判断[eax-1Ch]，即_Ktrap_frame中的eflags第17位VM位是否1</span></span><br><span class="line">.text:<span class="number">0040498</span>A                 jnz     <span class="type">short</span> loc_40498F<span class="comment">//如果是虚拟8086模式则跳转</span></span><br><span class="line">.text:<span class="number">0040498</span>C                 sub     eax, <span class="number">10</span>h<span class="comment">//eax此时是_Ktrap_frame中HardwareSegSs地址，减掉10是为了跳过陷阱帧中虚拟8086才会用到的16字节部分</span></span><br><span class="line">.text:<span class="number">0040498F</span></span><br><span class="line">.text:<span class="number">0040498F</span> loc_40498F:                             ; CODE XREF: SwapContext+<span class="number">66</span>↑j</span><br><span class="line">.text:<span class="number">0040498F</span>                 mov     ecx, [ebx+<span class="number">40</span>h]<span class="comment">//ecx取KPCR中的TSS</span></span><br><span class="line">.text:<span class="number">00404992</span>                 mov     [ecx+<span class="number">4</span>], eax<span class="comment">//把此时的_Ktrap_frame中HardwareSegSs+4的地址的esp放入TSS中的esp0中</span></span><br><span class="line">    					<span class="comment">//！！！！！！esp切换！！！！！！！！！</span></span><br><span class="line">.text:<span class="number">00404995</span>                 mov     esp, [esi+<span class="number">28</span>h]<span class="comment">//新线程结构体_KTHREAD中的KernelStack放入esp中</span></span><br><span class="line">.text:<span class="number">00404998</span>                 mov     eax, [esi+<span class="number">20</span>h]<span class="comment">//eax取新线程_KTHREAD中的TEB</span></span><br><span class="line">.text:<span class="number">0040499B</span>                 mov     [ebx+<span class="number">18</span>h], eax<span class="comment">//新线程_KTHREAD中的TEB挂到KPCR结构中的NtTib结构中的Self上</span></span><br><span class="line">.text:<span class="number">0040499</span>E                 sti<span class="comment">//允许中断</span></span><br><span class="line">.text:<span class="number">0040499F</span>                 mov     eax, [edi+<span class="number">44</span>h]<span class="comment">//eax取老线程_KTHREAD.ApcState.Process</span></span><br><span class="line">.text:<span class="number">004049</span>A2                 cmp     eax, [esi+<span class="number">44</span>h]<span class="comment">//比较新老线程的_KTHREAD.ApcState.Process，判断线程切换是否同一个进程中的线程切换</span></span><br><span class="line">.text:<span class="number">004049</span>A5                 mov     byte ptr [edi+<span class="number">50</span>h], <span class="number">0</span><span class="comment">//老线程的_KTHREAD的IdleSwapBlock清0，没有必要换出</span></span><br><span class="line">.text:<span class="number">004049</span>A9                 jz      <span class="type">short</span> loc_4049D7<span class="comment">//同一个进程就跳转</span></span><br><span class="line">.text:<span class="number">004049</span>AB                 mov     edi, [esi+<span class="number">44</span>h]<span class="comment">//edi取新线程的进程结构体pcState.Process</span></span><br><span class="line">.text:<span class="number">004049</span>AE                 test    word ptr [edi+<span class="number">20</span>h], <span class="number">0F</span>FFFh<span class="comment">//老进程的TEB中LdtDescriptor。。。16位系统相关</span></span><br><span class="line">.text:<span class="number">004049B</span>4                 jnz     <span class="type">short</span> loc_404A11<span class="comment">//是DOS系统跳转</span></span><br><span class="line">.text:<span class="number">004049B</span>6                 xor     eax, eax<span class="comment">//eax清零</span></span><br><span class="line">.text:<span class="number">004049B</span>8</span><br><span class="line">.text:<span class="number">004049B</span>8 loc_4049B8:                             ; CODE XREF: SwapContext+<span class="number">116</span>↓j</span><br><span class="line">.text:<span class="number">004049B</span>8                 lldt    ax<span class="comment">//ldt加载一个0</span></span><br><span class="line">.text:<span class="number">004049B</span>B                 xor     eax, eax<span class="comment">//eax清0</span></span><br><span class="line">.text:<span class="number">004049B</span>D                 mov     gs, eax<span class="comment">//gs段寄存器加载0，因此windows并未使用gs段寄存器</span></span><br><span class="line">.text:<span class="number">004049B</span>F                 assume gs:GAP</span><br><span class="line">.text:<span class="number">004049B</span>F                 mov     eax, [edi+<span class="number">18</span>h]<span class="comment">//eax取新线程的进程结构体中的页目录表基址，_EPROCESS.Pcb.DirectoryTableBase</span></span><br><span class="line">.text:<span class="number">004049</span>C2                 mov     ebp, [ebx+<span class="number">40</span>h]<span class="comment">//ebp取KPCR中的TSS</span></span><br><span class="line">.text:<span class="number">004049</span>C5                 mov     ecx, [edi+<span class="number">30</span>h]<span class="comment">//ecx取KPCR中的IDR</span></span><br><span class="line">.text:<span class="number">004049</span>C8                 mov     [ebp+<span class="number">1</span>Ch], eax<span class="comment">//新线程的进程结构体中的页目录表基址放入tss中的CR3位置</span></span><br><span class="line">.text:<span class="number">004049</span>CB                 mov     cr3, eax<span class="comment">//新线程的进程结构体中的页目录表基址加载进CR3</span></span><br><span class="line">.text:<span class="number">004049</span>CE                 mov     [ebp+<span class="number">66</span>h], cx<span class="comment">//KPCR中的IDR的低16位放入TSS中的IoMapBase位置，windows2000以后已经不使用了，所以没有意义</span></span><br><span class="line">.text:<span class="number">004049</span>D2                 jmp     <span class="type">short</span> loc_4049D7</span><br><span class="line">.text:<span class="number">004049</span>D2 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">004049</span>D4                 db <span class="number">8</span>Dh, <span class="number">49</span>h, <span class="number">0</span></span><br><span class="line">.text:<span class="number">004049</span>D7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">004049</span>D7<span class="comment">//进程一样的话</span></span><br><span class="line">.text:<span class="number">004049</span>D7 loc_4049D7:                             ; CODE XREF: SwapContext+<span class="number">85</span>↑j</span><br><span class="line">.text:<span class="number">004049</span>D7                                         ; SwapContext+AE↑j</span><br><span class="line">.text:<span class="number">004049</span>D7                 mov     eax, [ebx+<span class="number">18</span>h]<span class="comment">//eax取_KPCR.NtTib.Self</span></span><br><span class="line">.text:<span class="number">004049</span>DA                 mov     ecx, [ebx+<span class="number">3</span>Ch]<span class="comment">//ecx取_KPCR.GDT</span></span><br><span class="line">        <span class="comment">//下面4步修改fs在GDT中的baseAddr为新线程KPCR结构地址或TEB地址</span></span><br><span class="line">.text:<span class="number">004049</span>DD                 mov     [ecx+<span class="number">3</span>Ah], ax<span class="comment">//ecx+38是段描述符3B对应的gdt中的地址，所以3A的位置正是段描述符低32位中的高16位的BaseAddress的位置</span></span><br><span class="line">.text:<span class="number">004049E1</span>                 shr     eax, <span class="number">10</span>h<span class="comment">//得到剩下的高16位</span></span><br><span class="line">.text:<span class="number">004049E4</span>                 mov     [ecx+<span class="number">3</span>Ch], al</span><br><span class="line">.text:<span class="number">004049E7</span>                 mov     [ecx+<span class="number">3F</span>h], ah</span><br><span class="line">.text:<span class="number">004049</span>EA                 inc     dword ptr [esi+<span class="number">4</span>Ch]<span class="comment">//_ETHREAD.Tcb.ContextSwitches次数+1(当前线程被切换的次数+1）</span></span><br><span class="line">.text:<span class="number">004049</span>ED                 inc     dword ptr [ebx+<span class="number">61</span>Ch]<span class="comment">//_KPCR.PrcbData.KeContextSwitches次数+1（总的线程切换次数+1）</span></span><br><span class="line">.text:<span class="number">004049F</span>3                 pop     ecx<span class="comment">//取出异常链表</span></span><br><span class="line">.text:<span class="number">004049F</span>4                 mov     [ebx], ecx<span class="comment">//存入异常链表</span></span><br><span class="line">.text:<span class="number">004049F</span>6                 cmp     byte ptr [esi+<span class="number">49</span>h], <span class="number">0</span><span class="comment">//APC相关判断</span></span><br><span class="line">.text:<span class="number">004049F</span>A                 jnz     <span class="type">short</span> loc_404A00</span><br><span class="line">.text:<span class="number">004049F</span>C                 popf</span><br><span class="line">.text:<span class="number">004049F</span>D                 xor     eax, eax</span><br><span class="line">.text:<span class="number">004049F</span>F                 retn<span class="comment">//跳转到线程执行入口(由于esp已经跳转了，因此这个ret并不是返回到【call进SwapContext的指令地址的下一个地址】)，但当切换过去再切换回来的时候，这个位置依然存的是【call进SwapContext的指令地址的下一个地址】，因此依然会继续正常返回。只有IdleThread比较特殊，这个栈位置存的直接是IdleThread线程入口地址。因为IdleThread线程入口对应的函数KiIdleLoop并未调用SwapContext切换线程，而是靠手动更换esp更换线程，在更换esp前给这个位置留的是IdleThread的线程函数入口地址（即KiIdleLoop）</span></span><br><span class="line">.text:<span class="number">00404</span>A00 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00404</span>A00</span><br><span class="line">.text:<span class="number">00404</span>A00 loc_404A00:                             ; CODE XREF: SwapContext+D6↑j</span><br><span class="line">.text:<span class="number">00404</span>A00                 popf</span><br><span class="line">.text:<span class="number">00404</span>A01                 jnz     <span class="type">short</span> loc_404A06</span><br><span class="line">.text:<span class="number">00404</span>A03                 mov     al, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00404</span>A05                 retn</span><br><span class="line">.text:<span class="number">00404</span>A06 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00404</span>A06</span><br><span class="line">.text:<span class="number">00404</span>A06 loc_404A06:                             ; CODE XREF: SwapContext+DD↑j</span><br><span class="line">.text:<span class="number">00404</span>A06                 mov     cl, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00404</span>A08                 call    ds:__imp_@HalRequestSoftwareInterrupt@<span class="number">4</span> ; HalRequestSoftwareInterrupt(x)</span><br><span class="line">.text:<span class="number">00404</span>A0E                 xor     eax, eax</span><br><span class="line">.text:<span class="number">00404</span>A10                 retn</span><br><span class="line">.text:<span class="number">00404</span>A11 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00404</span>A11</span><br><span class="line">.text:<span class="number">00404</span>A11 loc_404A11:                             ; CODE XREF: SwapContext+<span class="number">90</span>↑j</span><br><span class="line">.text:<span class="number">00404</span>A11                 mov     ebp, [ebx+<span class="number">3</span>Ch]</span><br><span class="line">.text:<span class="number">00404</span>A14                 mov     eax, [edi+<span class="number">20</span>h]</span><br><span class="line">.text:<span class="number">00404</span>A17                 mov     [ebp+<span class="number">48</span>h], eax</span><br><span class="line">.text:<span class="number">00404</span>A1A                 mov     eax, [edi+<span class="number">24</span>h]</span><br><span class="line">.text:<span class="number">00404</span>A1D                 mov     [ebp+<span class="number">4</span>Ch], eax</span><br><span class="line">.text:<span class="number">00404</span>A20                 mov     eax, <span class="number">48</span>h</span><br><span class="line">.text:<span class="number">00404</span>A25                 mov     ebp, [ebx+<span class="number">38</span>h]</span><br><span class="line">.text:<span class="number">00404</span>A28                 mov     ecx, [edi+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">00404</span>A2B                 mov     [ebp+<span class="number">108</span>h], ecx</span><br><span class="line">.text:<span class="number">00404</span>A31                 mov     ecx, [edi+<span class="number">2</span>Ch]</span><br><span class="line">.text:<span class="number">00404</span>A34                 mov     [ebp+<span class="number">10</span>Ch], ecx</span><br><span class="line">.text:<span class="number">00404</span>A3A                 jmp     loc_4049B8</span><br><span class="line">.text:<span class="number">00404</span>A3F ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00404</span>A3F</span><br><span class="line">.text:<span class="number">00404</span>A3F loc_404A3F:                             ; CODE XREF: SwapContext+<span class="number">57</span>↑j</span><br><span class="line">.text:<span class="number">00404</span>A3F                 mov     cr0, ecx</span><br><span class="line">.text:<span class="number">00404</span>A42                 jmp     loc_404983</span><br><span class="line">.text:<span class="number">00404</span>A47 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00404</span>A47</span><br><span class="line">.text:<span class="number">00404</span>A47 loc_404A47:                             ; CODE XREF: SwapContext+<span class="number">1F</span>↑j</span><br><span class="line">.text:<span class="number">00404</span>A47                 mov     eax, ds:_PPerfGlobalGroupMask</span><br><span class="line">.text:<span class="number">00404</span>A4C                 cmp     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">00404</span>A4F                 jz      loc_404949</span><br><span class="line">.text:<span class="number">00404</span>A55                 mov     edx, esi</span><br><span class="line">.text:<span class="number">00404</span>A57                 mov     ecx, edi</span><br><span class="line">.text:<span class="number">00404</span>A59                 test    dword ptr [eax+<span class="number">4</span>], <span class="number">4</span></span><br><span class="line">.text:<span class="number">00404</span>A60                 jz      loc_404949</span><br><span class="line">.text:<span class="number">00404</span>A66                 call    @WmiTraceContextSwap@<span class="number">8</span> ; WmiTraceContextSwap(x,x)</span><br><span class="line">.text:<span class="number">00404</span>A6B                 jmp     loc_404949</span><br><span class="line">.text:<span class="number">00404</span>A70 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00404</span>A70</span><br><span class="line">.text:<span class="number">00404</span>A70 loc_404A70:                             ; CODE XREF: SwapContext+<span class="number">12</span>↑j</span><br><span class="line">.text:<span class="number">00404</span>A70                 push    <span class="number">0B</span>8h            ; BugCheckCode</span><br><span class="line">.text:<span class="number">00404</span>A75                 call    _KeBugCheck@<span class="number">4</span>   ; KeBugCheck(x)<span class="comment">//该函数内部几层后有蓝屏</span></span><br><span class="line">.text:<span class="number">00404</span>A75 SwapContext     endp</span><br></pre></td></tr></table></figure>

<p>SwapContext这个函数是Windows线程切换的核心，无论是主动切换还是系统时钟导致的线程切换，最终都会调用这个函数。</p>
<p><strong>KiIdleLoop</strong>函数流程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210917180706498.png" alt="image-20210917180706498"></p>
<h4 id="内核堆栈的结构"><a href="#内核堆栈的结构" class="headerlink" title="内核堆栈的结构"></a>内核堆栈的结构</h4><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913123031866.png" alt="image-20210913123031866"><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913123046400.png" alt="image-20210913123046400"></p>
<h5 id="Trap-Frame结构"><a href="#Trap-Frame结构" class="headerlink" title="_Trap_Frame结构"></a>_Trap_Frame结构</h5><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913123224608.png" alt="image-20210913123224608"></p>
<h4 id="调用API进0环TSS细节"><a href="#调用API进0环TSS细节" class="headerlink" title="调用API进0环TSS细节"></a>调用API进0环TSS细节</h4><ul>
<li>普通调用：<strong>通过TSS.ESP0得到0环堆栈</strong></li>
<li>快速调用：从<strong>MSR得到一个临时0环栈</strong>，代码执行后<strong>仍然通过TSS.ESP0得到当前线程的0环堆栈</strong></li>
</ul>
<p>Intel设计TSS的目的是为了任务切换(线程切换)，但Windows与Linux并没有使用。而是采用堆栈来保存线程的各种寄存器。</p>
<p>上文逆向线程主动切换部分有SwapContext的具体代码逆向。</p>
<h4 id="调用API进0环FS细节"><a href="#调用API进0环FS细节" class="headerlink" title="调用API进0环FS细节"></a>调用API进0环FS细节</h4><p>FS:[0]寄存器在3环时指向TEB，进入0环后FS:[0]指向KPCR</p>
<p>系统中同时存在很多个线程，这就意味着FS:[0]在3环时指向的TEB要有多个（每个线程一份）。</p>
<p>但在实际使用中我们发现，当我们在3环查看不同线程的FS寄存器时，FS的端选择子都是相同的，那是如何实现通过一个FS寄存器指向多个TEB呢？</p>
<h2 id="模拟线程切换"><a href="#模拟线程切换" class="headerlink" title="模拟线程切换"></a>模拟线程切换</h2><p>模拟windows的线程切换机制实现用一个线程当n个线程使用</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913122330491.png" alt="image-20210913122330491" style="zoom: 50%;" /><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913122350154.png" alt="image-20210913122350154" style="zoom:50%;" /><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913122429778.png" alt="image-20210913122429778" style="zoom: 50%;" /></p>
<h3 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h3><h4 id="ThreadCore-h"><a href="#ThreadCore-h" class="headerlink" title="ThreadCore.h"></a>ThreadCore.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GMTHREADSTACKSIZE 0x10000<span class="comment">//堆栈大小，之前设定为0x1000，总是莫名其妙的报错，原来是调用某些函数爆堆栈了，一个物理页根本不够用的。</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXGMTHREAD 99<span class="comment">//最大允许同时有99个线程</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//线程结构体(仿ETHREAD)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *name;			<span class="comment">//线程名 相当于线程TID</span></span><br><span class="line">	<span class="type">int</span> Flags;			<span class="comment">//线程状态</span></span><br><span class="line">	<span class="type">int</span> SleepMillisecondDot;		<span class="comment">//休眠时间</span></span><br><span class="line">	<span class="type">int</span> suspendNum;<span class="comment">//挂起计数（自己添加的挂起计数，未逆向windows这部分，不一定正确）</span></span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *InitialStack;			<span class="comment">//线程堆栈起始位置</span></span><br><span class="line">	<span class="type">void</span> *StackLimit;			<span class="comment">//线程堆栈界限</span></span><br><span class="line">	<span class="type">void</span> *KernelStack;		<span class="comment">//线程堆栈当前位置,也就是ESP</span></span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *lpParameter;		<span class="comment">//线程函数的参数</span></span><br><span class="line">	<span class="built_in">void</span>(*func)(<span class="type">void</span> *lpParameter);	<span class="comment">//线程函数</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125; GMThread_t;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建线程</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RegisterGMThread</span><span class="params">(<span class="type">char</span>* name, <span class="type">void</span>(*func)(<span class="type">void</span>*lpParameter), <span class="type">void</span>* lpParameter)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IdleGMThread</span><span class="params">(<span class="type">void</span> *lpParameter)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//push函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PushStack</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> **Stackpp, <span class="type">unsigned</span> <span class="type">int</span> v)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程函数启动函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GMThreadStartup</span><span class="params">(GMThread_t *GMThreadp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化线程</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initGMThread</span><span class="params">(GMThread_t *GMThreadp, <span class="type">char</span> *name, <span class="type">void</span>(*func)(<span class="type">void</span> *lpParameter), <span class="type">void</span> *lpParameter)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调度线程函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Scheduling</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//子线程休眠函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GMSleep</span><span class="params">(<span class="type">int</span> Milliseconds)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//交换线程上下文</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SwitchContext</span><span class="params">(GMThread_t *SrcGMThreadp, GMThread_t *DstGMThreadp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程挂起（自己添加的线程挂起，未逆向windows这部分，不一定正确）</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">suspendThread</span><span class="params">(<span class="type">char</span>* name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//挂起线程恢复（自己添加的线程挂起恢复，未逆向windows这部分，不一定正确）</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">resumeThread</span><span class="params">(<span class="type">char</span>* name)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="ThreadCore-cpp"><a href="#ThreadCore-cpp" class="headerlink" title="ThreadCore.cpp"></a>ThreadCore.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ThreadCore.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> CurrentThreadindex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程结构体数组</span></span><br><span class="line"><span class="comment">//实际的线程是挂在调度链表和等待链表中，此处仿真为了简单，把所有状态的线程都存到下面定义的数组中，数组零标的位置存main线程本身。</span></span><br><span class="line"><span class="comment">//仿真中所谓创建线程，就是创建一个结构体，并且挂到这个数组中，此时的线程状态为：创建</span></span><br><span class="line">GMThread_t GMThreadList[MAXGMTHREAD] = &#123; <span class="literal">NULL</span>, <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程状态</span></span><br><span class="line"><span class="comment">//线程状态的标志</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">FLAGS</span></span><br><span class="line">&#123;</span><br><span class="line">	GMTHREAD_CREATE = <span class="number">0x1</span>,</span><br><span class="line">	GMTHREAD_READY = <span class="number">0x2</span>,</span><br><span class="line">	GMTHREAD_SLEEP = <span class="number">0x4</span>,</span><br><span class="line">	GMTHREAD_EXIT = <span class="number">0x8</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RegisterGMThread</span><span class="params">(<span class="type">char</span> * name, <span class="type">void</span>(*func)(<span class="type">void</span> *lpParameter), <span class="type">void</span> * lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">1</span>; GMThreadList[i].name; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="number">0</span> == _stricmp(GMThreadList[i].name, name))<span class="comment">//防止线程唯一标识重复</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">initGMThread</span>(&amp;GMThreadList[i], name, func, lpParameter);</span><br><span class="line">	<span class="keyword">return</span> (i | <span class="number">0x55AA0000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IdleGMThread</span><span class="params">(<span class="type">void</span>*lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;IdleGMThread---------\r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Scheduling</span>();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//子线程休眠函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GMSleep</span><span class="params">(<span class="type">int</span> Milliseconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GMThread_t *GMThreadp;</span><br><span class="line">	GMThreadp = &amp;GMThreadList[CurrentThreadindex];</span><br><span class="line">	<span class="keyword">if</span> ((GMThreadp-&gt;Flags)!=<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		GMThreadp-&gt;SleepMillisecondDot = <span class="built_in">GetTickCount</span>() + Milliseconds;</span><br><span class="line">		GMThreadp-&gt;Flags = GMTHREAD_SLEEP;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Scheduling</span>();<span class="comment">//线程在休眠的时候主动让出线程执行权</span></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PushStack</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> **Stackpp,<span class="type">unsigned</span> <span class="type">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	*Stackpp -= <span class="number">1</span>;</span><br><span class="line">	**Stackpp = v;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GMThreadStartup</span><span class="params">(GMThread_t *GMThreadp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GMThreadp-&gt;<span class="built_in">func</span>(GMThreadp-&gt;lpParameter);</span><br><span class="line">	GMThreadp-&gt;Flags = GMTHREAD_EXIT;<span class="comment">//线程函数执行完毕后设置状态为退出</span></span><br><span class="line">	<span class="built_in">Scheduling</span>();<span class="comment">//调度新线程</span></span><br><span class="line">	<span class="keyword">return</span>;<span class="comment">//只在Scheduling没找到目标线程时才能释放。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initGMThread</span><span class="params">(GMThread_t * GMThreadp, <span class="type">char</span> * name, <span class="type">void</span>(*func)(<span class="type">void</span> *lpParameter), <span class="type">void</span> * lpParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *StackPages;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> *StackDWORDParam;</span><br><span class="line">	<span class="comment">//结构初始化赋值</span></span><br><span class="line">	GMThreadp-&gt;Flags = GMTHREAD_CREATE;</span><br><span class="line">	GMThreadp-&gt;name = name;</span><br><span class="line">	GMThreadp-&gt;func = func;</span><br><span class="line">	GMThreadp-&gt;suspendNum = <span class="number">0</span>;</span><br><span class="line">	GMThreadp-&gt;lpParameter = lpParameter;</span><br><span class="line">	<span class="comment">//申请空间</span></span><br><span class="line">	StackPages = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, GMTHREADSTACKSIZE, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">	<span class="comment">//清零</span></span><br><span class="line">	<span class="built_in">ZeroMemory</span>(StackPages, GMTHREADSTACKSIZE);</span><br><span class="line">	<span class="comment">//堆栈初始化地址</span></span><br><span class="line">	GMThreadp-&gt;InitialStack = StackPages + GMTHREADSTACKSIZE;</span><br><span class="line">	<span class="comment">//堆栈限制</span></span><br><span class="line">	GMThreadp-&gt;StackLimit = StackPages;</span><br><span class="line">	<span class="comment">//堆栈地址esp</span></span><br><span class="line">	StackDWORDParam = (<span class="type">unsigned</span> <span class="type">int</span>*)GMThreadp-&gt;InitialStack;</span><br><span class="line">	<span class="comment">//入栈</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)GMThreadp);</span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">9</span>);<span class="comment">//平衡堆栈</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)GMThreadStartup);<span class="comment">//线程入口函数</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">5</span>);<span class="comment">//push ebp</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">7</span>);<span class="comment">//push edi</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">6</span>);<span class="comment">//push esi</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">3</span>);<span class="comment">//push ebx</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">2</span>);<span class="comment">//push edx</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">1</span>);<span class="comment">//push edx</span></span><br><span class="line">	<span class="built_in">PushStack</span>(&amp;StackDWORDParam, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">0</span>);<span class="comment">//push eax</span></span><br><span class="line">	GMThreadp-&gt;KernelStack = StackDWORDParam;<span class="comment">//填入对应的KernelStack</span></span><br><span class="line">	GMThreadp-&gt;Flags = GMTHREAD_READY;<span class="comment">//创建的线程设置为准备状态</span></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Scheduling</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">int</span> TickCount;</span><br><span class="line">	GMThread_t *SrcGMThreadp;</span><br><span class="line">	GMThread_t *DstGMThreadp;</span><br><span class="line">	TickCount = <span class="built_in">GetTickCount</span>();</span><br><span class="line">	SrcGMThreadp = &amp;GMThreadList[CurrentThreadindex];</span><br><span class="line">	DstGMThreadp = &amp;GMThreadList[<span class="number">0</span>];</span><br><span class="line">	<span class="comment">//遍历数组找到第一个处于GMTHREAD_READY状态的线程</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">1</span>; GMThreadList[i].name; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((GMThreadList[i].Flags&amp;GMTHREAD_SLEEP)&amp;&amp; GMThreadList[i].suspendNum==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (TickCount&gt;GMThreadList[i].SleepMillisecondDot)</span><br><span class="line">			&#123;</span><br><span class="line">				GMThreadList[i].Flags = GMTHREAD_READY;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (GMThreadList[i].Flags&amp;GMTHREAD_READY)</span><br><span class="line">		&#123;</span><br><span class="line">			DstGMThreadp = &amp;GMThreadList[i];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	CurrentThreadindex = DstGMThreadp - GMThreadList;</span><br><span class="line">	<span class="built_in">SwitchContext</span>(SrcGMThreadp, DstGMThreadp);</span><br><span class="line">	<span class="keyword">return</span>;<span class="comment">//只在Scheduling没找到目标线程时才能释放。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程上下文切换</span></span><br><span class="line">__declspec(naked) <span class="function"><span class="type">void</span> <span class="title">SwitchContext</span><span class="params">(GMThread_t *SrcGMThreadp, GMThread_t *DstGMThreadp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm </span><br><span class="line">	&#123;</span><br><span class="line">		push ebp;</span><br><span class="line">		mov ebp, esp;</span><br><span class="line">		push edi;</span><br><span class="line">		push esi;</span><br><span class="line">		push ebx;</span><br><span class="line">		push ecx;</span><br><span class="line">		push edx;</span><br><span class="line">		push eax;</span><br><span class="line">		mov esi, SrcGMThreadp;</span><br><span class="line">		mov edi, DstGMThreadp;</span><br><span class="line">		mov[esi + GMThread_t.KernelStack], esp;</span><br><span class="line">		<span class="comment">//=======经典堆栈切换，另一个线程复活===========</span></span><br><span class="line">		mov esp, [edi + GMThread_t.KernelStack];</span><br><span class="line">		pop eax;</span><br><span class="line">		pop edx;</span><br><span class="line">		pop ecx;</span><br><span class="line">		pop ebx;</span><br><span class="line">		pop esi;</span><br><span class="line">		pop edi;</span><br><span class="line">		pop ebp;</span><br><span class="line">		ret;<span class="comment">//线程函数地址正好弹到了eip中</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">suspendThread</span><span class="params">(<span class="type">char</span> * name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; GMThreadList[i].name; i++)<span class="comment">//遍历线程数组找到对应名称</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="number">0</span> == _stricmp(GMThreadList[i].name, name))</span><br><span class="line">		&#123;</span><br><span class="line">			GMThreadList[i].Flags = GMTHREAD_SLEEP;</span><br><span class="line">			GMThreadList[i].suspendNum += <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">resumeThread</span><span class="params">(<span class="type">char</span> * name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; GMThreadList[i].name; i++)<span class="comment">//遍历线程数组找到对应名称</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="number">0</span> == _stricmp(GMThreadList[i].name, name))</span><br><span class="line">		&#123;</span><br><span class="line">			GMThreadList[i].Flags = GMTHREAD_READY;</span><br><span class="line">			GMThreadList[i].suspendNum -= GMThreadList[i].suspendNum &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ThreadCore.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//对应创建线程的线程函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> CurrentThreadindex;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXGMTHREAD 99<span class="comment">//最大允许同时有99个线程</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> GMThread_t GMThreadList[MAXGMTHREAD];</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程回调函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread1</span><span class="params">(<span class="type">void</span>* a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;线程1--&quot;</span>&lt;&lt;*(<span class="type">int</span>*)a &lt;&lt; endl;</span><br><span class="line">		<span class="built_in">GMSleep</span>(<span class="number">1000</span>);<span class="comment">//绝大部分winAPI都会涉及到线程切换，这个GMSleep象征所有winAPI</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread2</span><span class="params">(<span class="type">void</span>* a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;线程2--&quot;</span> &lt;&lt; *(<span class="type">int</span>*)a &lt;&lt; endl;</span><br><span class="line">		<span class="built_in">GMSleep</span>(<span class="number">800</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread3</span><span class="params">(<span class="type">void</span>* a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;线程3--&quot;</span> &lt;&lt; *(<span class="type">int</span>*)a &lt;&lt; endl;</span><br><span class="line">		<span class="built_in">GMSleep</span>(<span class="number">2000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread4</span><span class="params">(<span class="type">void</span>* a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;线程4--&quot;</span> &lt;&lt; *(<span class="type">int</span>*)a &lt;&lt; endl;</span><br><span class="line">		<span class="built_in">GMSleep</span>(<span class="number">1500</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//参数</span></span><br><span class="line">	<span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> b = <span class="number">2</span>;</span><br><span class="line">	<span class="type">int</span> c = <span class="number">3</span>;</span><br><span class="line">	<span class="type">int</span> d = <span class="number">4</span>;</span><br><span class="line">	<span class="built_in">RegisterGMThread</span>(<span class="string">&quot;Thread1&quot;</span>, Thread1, &amp;a);</span><br><span class="line">	<span class="built_in">RegisterGMThread</span>(<span class="string">&quot;Thread2&quot;</span>, Thread2, &amp;b);</span><br><span class="line">	<span class="built_in">RegisterGMThread</span>(<span class="string">&quot;Thread3&quot;</span>, Thread3, &amp;c);</span><br><span class="line">	<span class="built_in">RegisterGMThread</span>(<span class="string">&quot;Thread4&quot;</span>, Thread4, &amp;d);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//仿Windows线程切换</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Sleep</span>(<span class="number">20</span>);</span><br><span class="line">		<span class="built_in">Scheduling</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="效果如下"><a href="#效果如下" class="headerlink" title="效果如下"></a>效果如下</h4><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210912205808625.png" alt="image-20210912205808625"></p>
<h3 id="模拟线程切换总结"><a href="#模拟线程切换总结" class="headerlink" title="模拟线程切换总结"></a>模拟线程切换总结</h3><p>模拟线程切换总结：</p>
<ol>
<li>线程不是被动切换的，而是<strong>主动让出CPU</strong>.</li>
<li>线程切换并没有使用TSS来保存寄存器，而是<strong>使用堆栈.</strong></li>
<li><strong>线程切换的过程就是堆栈切换的过程</strong>.</li>
</ol>
<h2 id="时钟中断线程切换"><a href="#时钟中断线程切换" class="headerlink" title="时钟中断线程切换"></a>时钟中断线程切换</h2><p>绝大部分系统内核函数都会调用SwapContext函数来进行线程的切换，这种切换是线程主动调用的。</p>
<ul>
<li>Q：那么如果当前的线程不去调用系统API，操作系统如何实现线程切换呢？</li>
<li>A：那就是时钟切换</li>
</ul>
<p>中断一个正在执行的程序有两种办法</p>
<ol>
<li>异常，比如缺页，或者INT N指令</li>
<li>中断，比如时钟中断</li>
</ol>
<h3 id="系统时钟中断"><a href="#系统时钟中断" class="headerlink" title="系统时钟中断"></a><strong>系统时钟中断</strong></h3><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913113450583.png" alt="image-20210913113450583"></p>
<p>Windows系统操作系统每隔10~20毫秒触发一次时钟中断。</p>
<p>可使用如下Win32 API，获取当前的时钟中断间隔值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetSystemTimeAdjustment</span><br></pre></td></tr></table></figure>

<h3 id="时钟中断的执行流程"><a href="#时钟中断的执行流程" class="headerlink" title="时钟中断的执行流程"></a>时钟中断的执行流程</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">KiStartUnexpectedRange<span class="comment">//实际上在windbg下断点根本不断下来</span></span><br><span class="line">-&gt;KiEndUnexpectedRange</span><br><span class="line">-&gt;KiUnexpectedInterruptTail</span><br><span class="line">-&gt;HalBeginSystemInterrupt(HAL)</span><br><span class="line">    </span><br><span class="line">HalEndSystemInterrupt</span><br><span class="line">-&gt;KiDispatchInterrupt(KiReadyProcess)</span><br><span class="line">-&gt;SwapContext</span><br><span class="line">    </span><br><span class="line"><span class="comment">//KeUpdateRunTime来自下面？</span></span><br><span class="line">HalInitSystem</span><br><span class="line">    </span><br><span class="line"><span class="comment">/*KiReadyProcess做了什么：</span></span><br><span class="line"><span class="comment">  1. 根据你的当前老线程，亲核，你最喜欢的哪个核softAffinity，闲置核，去计算当前老的线程要挂在哪一个KPCR中的nextThread上</span></span><br><span class="line"><span class="comment">  2. 如果affinity，softAffinity，闲置核计算，没有找到，那么就会找下一个KPCR，挂上。如果KPCR中有下一个了，那么就对比优先级，看是挂还是用KPCR以前的。</span></span><br><span class="line"><span class="comment">  3. 如果都挂不上，就挂在WaitList中。</span></span><br><span class="line"><span class="comment">  	如果，当前老线程的优先级大于KPCR中当前线程优先级，那么在WAITLIST就挂在当前优先级链表第一个位置</span></span><br><span class="line"><span class="comment">  	否则是当前优先级链表的最后一个</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>

<p>HalpClockInterrup函数是时钟中断跳转到的位置</p>
<h3 id="如何避免线程切换"><a href="#如何避免线程切换" class="headerlink" title="如何避免线程切换"></a>如何避免线程切换</h3><p>线程切换有几种情况</p>
<ul>
<li>主动调用API函数</li>
<li>时钟中断</li>
<li>异常处理</li>
</ul>
<p><strong>如果一个线程不调用API，在代码中屏蔽中断(CLI指令)，并且不会出现异常，那么当前线程将永久占有CPU</strong>，单核占有率100%，2核也就是50%</p>
<p>硬件时钟中断是没办法屏蔽的</p>
<h3 id="时钟线程切换流程"><a href="#时钟线程切换流程" class="headerlink" title="时钟线程切换流程"></a>时钟线程切换流程</h3><p>时钟中断并不一定会导致线程切换，只有<strong>两种情况会导致线程切换</strong></p>
<ol>
<li>当前的线程CPU时间片到期</li>
<li>有备用线程(KPCR.PrcbData.NextThread)</li>
</ol>
<h4 id="CPU时间片到期线程切换"><a href="#CPU时间片到期线程切换" class="headerlink" title="CPU时间片到期线程切换"></a>CPU时间片到期线程切换</h4><p>当前的线程CPU时间片到期的切换</p>
<ul>
<li>当一个新的线程开始执行时，初始化程序会在<strong>_KTHREAD.Quantum</strong>赋初始值，该值的大小由<strong>_KPROCESS.ThreadQuantum</strong>决定</li>
<li><strong>有个KeUpdateRunTime函数</strong>，该函数每次将当前线程Quantum减少3个单位，如果减到0，则将KPCR.PrcbData.QuantumEnd的值设置为非0</li>
<li>KiDispatchInterrupt函数判断时间片到期：调用KiQuantumEnd重新设置时间片，内部调用KiFindReadyThread找到要运行的线程</li>
</ul>
<h4 id="存在备用线程的线程切换"><a href="#存在备用线程的线程切换" class="headerlink" title="存在备用线程的线程切换"></a>存在备用线程的线程切换</h4><p><strong>KPCR.PrcbData.NextThread</strong>被设置时，即使当前线程的CPU时间片没有到期，仍然会被切换。</p>
<h3 id="线程切换情况总结"><a href="#线程切换情况总结" class="headerlink" title="线程切换情况总结"></a>线程切换情况总结</h3><ol>
<li><p>当前线程主动调用API：</p>
<p>​	API函数-&gt;KiSwapThread-&gt;KiSwapContext-&gt;<strong>SwapContext</strong></p>
</li>
<li><p>当前线程时间片到期：</p>
<p>​	KiDispatchInterrupt-&gt;KiQuantumEnd-&gt;KiSwapContext-&gt;<strong>SwapContext</strong></p>
</li>
<li><p>有备份线程(KPCR.Prcb.NextThread)</p>
<p>​	KiDispatchInterrupt-&gt;<strong>SwapContext</strong></p>
</li>
</ol>
<h3 id="线程优先级-KiFindReadyThread详解"><a href="#线程优先级-KiFindReadyThread详解" class="headerlink" title="线程优先级(KiFindReadyThread详解)"></a>线程优先级(KiFindReadyThread详解)</h3><p>在KiSwapThread与KiQuantumEnd函数中都是通过<strong>KiFindReadyThread</strong>来找下一个要切换的线程。</p>
<p>32个调度链表</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913143736703.png" alt="image-20210913143736703"></p>
<p>KiFindReadyThread查找方式：按照优先级别进行查找：31…30…29…28…</p>
<p>在查找中，如果级别31的链表里面有线程，那么就不会查找级别为30的链表</p>
<h4 id="高效查询优化"><a href="#高效查询优化" class="headerlink" title="高效查询优化"></a>高效查询优化</h4><p>调度链表有32个，每次都从头开始查找效率太低，所以windows通过一个<strong>DWORD类型变量_kiReadySummary</strong>来记录：</p>
<p><strong>当向调度链表(32个)中挂入或者摘除某个线程时，会判断当前级别的链表是否为空，为空将_kiReadySummary对应的位清零，否则置1</strong></p>
<p><strong>_kiReadySummary结构</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913144629239.png" alt="image-20210913144629239"></p>
<p>_kiReadySummary中的每一位分别对应调度链表每一个链表中是否有线程，第0位对应的就是KiDispatcherReadyListHead中最低级优先级的调度链表</p>
<p>如果KiDispatcherReadyListHead一个就绪线程也没了，那么切换为空闲线程<strong>IdleThread</strong></p>
<p>多CPU会随机寻找KiDispatcherReadyListHead指向的数组中的线程。线程可以绑定某个cpu(使用API：setThreadAffinityMask)</p>
<h1 id="进程挂靠"><a href="#进程挂靠" class="headerlink" title="进程挂靠"></a>进程挂靠</h1><p><strong>进程与线程的关系：</strong></p>
<ul>
<li>一个进程可以包含多个线程</li>
<li>一个进程至少要有一个线程</li>
</ul>
<p>进程为线程提供资源，也就是提供Cr3的值，Cr3中存储的是页目录表基址，<strong>Cr3确定了，线程能访问的内存也就确定了</strong>。</p>
<p>线程代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov eax,dword ptr ds:[0x12345678]</span><br></pre></td></tr></table></figure>

<p>CPU如何解析0x12345678这个地址呢？</p>
<ol>
<li>CPU解析线性地址时要通过页目录表来找对应的物理页，页目录表基址存在Cr3寄存器中</li>
<li>当前的Cr3的值来源于当前的进程(_KPROCESS.DiectoryTableBase(+0x018))</li>
</ol>
<p>线程找进程：(线程结构中有两个成员指向了其进程结构体)</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913170303489.png" alt="image-20210913170303489"></p>
<p>虽然有两个指向进程的结构体，但是他们两个的含义不同。</p>
<p>参考SwapContext的汇编会发现：线程切换的时候，会比较新老线程_KTHREAD结构体0x044处指定的_EPROCESS是否为同一个，如果不是同一个，会将_EPROCESS的DirectoryTableBase的值取出，赋值给Cr3</p>
<p><strong>所以线程需要的Cr3的值来源于线程结构体0x44偏移指向的_EPROCESS。</strong></p>
<h2 id="区别总结"><a href="#区别总结" class="headerlink" title="区别总结"></a>区别总结</h2><ul>
<li>0x220 亲身父母：这个线程是哪个进程创建的</li>
<li>0x44   养父母：创建后的线程是属于哪个进程的(谁在为这个线程提供资源，也就是提供Cr3)</li>
</ul>
<p>一般情况下，0x220和0x44指向的是同一个进程。(远线程创建就是这两个值不一样)</p>
<h2 id="进程挂靠-1"><a href="#进程挂靠-1" class="headerlink" title="进程挂靠"></a>进程挂靠</h2><p>正常情况下，Cr3的值是由养父母提供的，但Cr3的值也可以改成和当前线程毫不相干的其他进程的DirectoryTableBase。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov cr3,A.DirectoryTableBase;</span><br><span class="line">mov eax,dword ptr ds:[0x12345678];eax为A进程的0x12345678内存</span><br><span class="line">mov cr3,B.DirectoryTableBase;</span><br><span class="line">mov eax,dword ptr ds:[0x12345678];eax为B进程的0x12345678内存</span><br><span class="line">mov cr3,C.DirectoryTableBase;</span><br><span class="line">mov eax,dword ptr ds:[0x12345678];eax为C进程的0x12345678内存</span><br></pre></td></tr></table></figure>

<p>将当前Cr3的值改为其他进程，称为<strong>“进程挂靠”</strong></p>
<h2 id="分析NtReadVirtualMemory函数"><a href="#分析NtReadVirtualMemory函数" class="headerlink" title="分析NtReadVirtualMemory函数"></a>分析NtReadVirtualMemory函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NtReadVirtualMemory</span><br><span class="line">-&gt;KiAttachProcess</span><br><span class="line">-&gt;修改养父母(<span class="number">0x44</span>偏移的进程进程结构体基址)</span><br><span class="line">-&gt;修改Cr3</span><br></pre></td></tr></table></figure>

<h3 id="NtReadVirtualMemory逆向"><a href="#NtReadVirtualMemory逆向" class="headerlink" title="NtReadVirtualMemory逆向"></a>NtReadVirtualMemory逆向</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">PAGE:004A72CE ; NTSTATUS __stdcall NtReadVirtualMemory(HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, SIZE_T NumberOfBytesToRead, PSIZE_T NumberOfBytesRead)</span><br><span class="line">PAGE:004A72CE _NtReadVirtualMemory@20 proc near       ; DATA XREF: .text:0040B990↑o</span><br><span class="line">PAGE:004A72CE</span><br><span class="line">PAGE:004A72CE var_2C          = dword ptr -2Ch</span><br><span class="line">PAGE:004A72CE var_28          = dword ptr -28h</span><br><span class="line">PAGE:004A72CE Object          = dword ptr -24h</span><br><span class="line">PAGE:004A72CE AccessMode      = byte ptr -20h</span><br><span class="line">PAGE:004A72CE var_1C          = dword ptr -1Ch</span><br><span class="line">PAGE:004A72CE ms_exc          = CPPEH_RECORD ptr -18h</span><br><span class="line">PAGE:004A72CE ProcessHandle   = dword ptr  8</span><br><span class="line">PAGE:004A72CE BaseAddress     = dword ptr  0Ch</span><br><span class="line">PAGE:004A72CE Buffer          = dword ptr  10h</span><br><span class="line">PAGE:004A72CE NumberOfBytesToRead= dword ptr  14h</span><br><span class="line">PAGE:004A72CE NumberOfBytesRead= dword ptr  18h</span><br><span class="line">PAGE:004A72CE</span><br><span class="line">PAGE:004A72CE ; FUNCTION CHUNK AT PAGE:0051B87E SIZE 0000000B BYTES</span><br><span class="line">PAGE:004A72CE ; FUNCTION CHUNK AT PAGE:0051B88E SIZE 0000000E BYTES</span><br><span class="line">PAGE:004A72CE ; FUNCTION CHUNK AT PAGE:0051B8A1 SIZE 0000000F BYTES</span><br><span class="line">PAGE:004A72CE ; FUNCTION CHUNK AT PAGE:0051B8B5 SIZE 00000004 BYTES</span><br><span class="line">PAGE:004A72CE ; FUNCTION CHUNK AT PAGE:0051B8BE SIZE 00000008 BYTES</span><br><span class="line">PAGE:004A72CE</span><br><span class="line">PAGE:004A72CE ; __unwind &#123; // __SEH_prolog</span><br><span class="line">PAGE:004A72CE                 push    1Ch</span><br><span class="line">PAGE:004A72D0                 push    offset stru_420E18</span><br><span class="line">PAGE:004A72D5                 call    __SEH_prolog</span><br><span class="line">PAGE:004A72DA                 mov     eax, large fs:124h</span><br><span class="line">PAGE:004A72E0                 mov     edi, eax</span><br><span class="line">PAGE:004A72E2                 mov     al, [edi+140h]</span><br><span class="line">PAGE:004A72E8                 mov     [ebp+AccessMode], al</span><br><span class="line">PAGE:004A72EB                 mov     esi, [ebp+NumberOfBytesToRead]</span><br><span class="line">PAGE:004A72EE                 test    al, al</span><br><span class="line">PAGE:004A72F0                 jz      loc_4A73BC</span><br><span class="line">PAGE:004A72F6                 mov     eax, [ebp+BaseAddress]</span><br><span class="line">PAGE:004A72F9                 lea     edx, [esi+eax]</span><br><span class="line">PAGE:004A72FC                 cmp     edx, eax</span><br><span class="line">PAGE:004A72FE                 jb      loc_4A73B5</span><br><span class="line">PAGE:004A7304                 mov     eax, [ebp+Buffer]</span><br><span class="line">PAGE:004A7307                 lea     ecx, [esi+eax]</span><br><span class="line">PAGE:004A730A                 cmp     ecx, eax</span><br><span class="line">PAGE:004A730C                 jb      loc_4A73B5</span><br><span class="line">PAGE:004A7312                 mov     eax, _MmHighestUserAddress</span><br><span class="line">PAGE:004A7317                 cmp     edx, eax</span><br><span class="line">PAGE:004A7319                 ja      loc_4A73B5</span><br><span class="line">PAGE:004A731F                 cmp     ecx, eax</span><br><span class="line">PAGE:004A7321                 ja      loc_4A73B5</span><br><span class="line">PAGE:004A7327                 mov     ebx, [ebp+NumberOfBytesRead]</span><br><span class="line">PAGE:004A732A                 test    ebx, ebx</span><br><span class="line">PAGE:004A732C                 jz      short loc_4A7347</span><br><span class="line">PAGE:004A732E ;   __try &#123; // __except at loc_51B8A1</span><br><span class="line">PAGE:004A732E                 and     [ebp+ms_exc.registration.TryLevel], 0</span><br><span class="line">PAGE:004A7332                 mov     eax, _MmUserProbeAddress</span><br><span class="line">PAGE:004A7337                 cmp     ebx, eax</span><br><span class="line">PAGE:004A7339                 jnb     loc_51B87E</span><br><span class="line">PAGE:004A733F</span><br><span class="line">PAGE:004A733F loc_4A733F:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+745B6↓j</span><br><span class="line">PAGE:004A733F                 mov     eax, [ebx]</span><br><span class="line">PAGE:004A7341                 mov     [ebx], eax</span><br><span class="line">PAGE:004A7341 ;   &#125; // starts at 4A732E</span><br><span class="line">PAGE:004A7343                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh</span><br><span class="line">PAGE:004A7347</span><br><span class="line">PAGE:004A7347 loc_4A7347:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+5E↑j</span><br><span class="line">PAGE:004A7347                                         ; NtReadVirtualMemory(x,x,x,x,x)+F1↓j</span><br><span class="line">PAGE:004A7347                 xor     eax, eax</span><br><span class="line">PAGE:004A7349                 mov     [ebp+var_28], eax</span><br><span class="line">PAGE:004A734C                 mov     [ebp+var_1C], eax</span><br><span class="line">PAGE:004A734F                 cmp     esi, eax</span><br><span class="line">PAGE:004A7351                 jz      short loc_4A7396</span><br><span class="line">PAGE:004A7353                 push    eax             ; HandleInformation</span><br><span class="line">PAGE:004A7354                 lea     eax, [ebp+Object]</span><br><span class="line">PAGE:004A7357                 push    eax             ; Object</span><br><span class="line">PAGE:004A7358                 push    dword ptr [ebp+AccessMode] ; AccessMode</span><br><span class="line">PAGE:004A735B                 push    _PsProcessType  ; ObjectType</span><br><span class="line">PAGE:004A7361                 push    10h             ; DesiredAccess</span><br><span class="line">PAGE:004A7363                 push    [ebp+ProcessHandle] ; Handle</span><br><span class="line">PAGE:004A7366                 call    _ObReferenceObjectByHandle@24 ; ObReferenceObjectByHandle(x,x,x,x,x,x)</span><br><span class="line">PAGE:004A736B                 mov     [ebp+var_1C], eax</span><br><span class="line">PAGE:004A736E                 test    eax, eax</span><br><span class="line">PAGE:004A7370                 jnz     short loc_4A7396</span><br><span class="line">PAGE:004A7372                 lea     eax, [ebp+var_28]</span><br><span class="line">PAGE:004A7375                 push    eax</span><br><span class="line">PAGE:004A7376                 push    dword ptr [ebp+AccessMode]</span><br><span class="line">PAGE:004A7379                 push    esi</span><br><span class="line">PAGE:004A737A                 push    [ebp+Buffer]</span><br><span class="line">PAGE:004A737D                 push    dword ptr [edi+44h]</span><br><span class="line">PAGE:004A7380                 push    [ebp+BaseAddress]</span><br><span class="line">PAGE:004A7383                 push    [ebp+Object]</span><br><span class="line">PAGE:004A7386                 call    _MmCopyVirtualMemory@28 ; MmCopyVirtualMemory(x,x,x,x,x,x,x)//核心代码</span><br><span class="line">PAGE:004A738B                 mov     [ebp+var_1C], eax</span><br><span class="line">PAGE:004A738E                 mov     ecx, [ebp+Object] ; Object</span><br><span class="line">PAGE:004A7391                 call    @ObfDereferenceObject@4 ; ObfDereferenceObject(x)</span><br><span class="line">PAGE:004A7396</span><br><span class="line">PAGE:004A7396 loc_4A7396:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+83↑j</span><br><span class="line">PAGE:004A7396                                         ; NtReadVirtualMemory(x,x,x,x,x)+A2↑j</span><br><span class="line">PAGE:004A7396                 test    ebx, ebx</span><br><span class="line">PAGE:004A7398                 jz      short loc_4A73AA</span><br><span class="line">PAGE:004A739A ;   __try &#123; // __except at loc_51B8BE</span><br><span class="line">PAGE:004A739A                 mov     [ebp+ms_exc.registration.TryLevel], 1</span><br><span class="line">PAGE:004A73A1                 mov     eax, [ebp+var_28]</span><br><span class="line">PAGE:004A73A4                 mov     [ebx], eax</span><br><span class="line">PAGE:004A73A4 ;   &#125; // starts at 4A739A</span><br><span class="line">PAGE:004A73A6</span><br><span class="line">PAGE:004A73A6 loc_4A73A6:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+745F3↓j</span><br><span class="line">PAGE:004A73A6                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh</span><br><span class="line">PAGE:004A73AA</span><br><span class="line">PAGE:004A73AA loc_4A73AA:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+CA↑j</span><br><span class="line">PAGE:004A73AA                 mov     eax, [ebp+var_1C]</span><br><span class="line">PAGE:004A73AD</span><br><span class="line">PAGE:004A73AD loc_4A73AD:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+EC↓j</span><br><span class="line">PAGE:004A73AD                                         ; NtReadVirtualMemory(x,x,x,x,x)+745DD↓j</span><br><span class="line">PAGE:004A73AD                 call    __SEH_epilog</span><br><span class="line">PAGE:004A73B2                 retn    14h</span><br><span class="line">PAGE:004A73B5 ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:004A73B5</span><br><span class="line">PAGE:004A73B5 loc_4A73B5:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+30↑j</span><br><span class="line">PAGE:004A73B5                                         ; NtReadVirtualMemory(x,x,x,x,x)+3E↑j ...</span><br><span class="line">PAGE:004A73B5                 mov     eax, 0C0000005h</span><br><span class="line">PAGE:004A73BA                 jmp     short loc_4A73AD</span><br><span class="line">PAGE:004A73BC ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:004A73BC</span><br><span class="line">PAGE:004A73BC loc_4A73BC:                             ; CODE XREF: NtReadVirtualMemory(x,x,x,x,x)+22↑j</span><br><span class="line">PAGE:004A73BC                 mov     ebx, [ebp+NumberOfBytesRead]</span><br><span class="line">PAGE:004A73BF                 jmp     short loc_4A7347</span><br><span class="line">PAGE:004A73BF ; &#125; // starts at 4A72CE</span><br><span class="line">PAGE:004A73BF _NtReadVirtualMemory@20 endp</span><br></pre></td></tr></table></figure>

<h4 id="MmCopyVirtualMemory"><a href="#MmCopyVirtualMemory" class="headerlink" title="MmCopyVirtualMemory"></a>MmCopyVirtualMemory</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">PAGE:004A1634 ; __stdcall MmCopyVirtualMemory(x, x, x, x, x, x, x)</span><br><span class="line">PAGE:004A1634 _MmCopyVirtualMemory@28 proc near       ; CODE XREF: IopCheckHardErrorsDisabled(x)+7D↑p</span><br><span class="line">PAGE:004A1634                                         ; NtReadVirtualMemory(x,x,x,x,x)+B8↓p ...</span><br><span class="line">PAGE:004A1634</span><br><span class="line">PAGE:004A1634 BugCheckParameter1= dword ptr  8</span><br><span class="line">PAGE:004A1634 arg_4           = dword ptr  0Ch</span><br><span class="line">PAGE:004A1634 arg_8           = dword ptr  10h</span><br><span class="line">PAGE:004A1634 Address         = dword ptr  14h</span><br><span class="line">PAGE:004A1634 Length          = dword ptr  18h</span><br><span class="line">PAGE:004A1634 AccessMode      = byte ptr  1Ch</span><br><span class="line">PAGE:004A1634 arg_18          = dword ptr  20h</span><br><span class="line">PAGE:004A1634</span><br><span class="line">PAGE:004A1634 ; FUNCTION CHUNK AT PAGE:004A5AF4 SIZE 00000029 BYTES</span><br><span class="line">PAGE:004A1634 ; FUNCTION CHUNK AT PAGE:0051B865 SIZE 00000019 BYTES</span><br><span class="line">PAGE:004A1634</span><br><span class="line">PAGE:004A1634                 mov     edi, edi</span><br><span class="line">PAGE:004A1636                 push    ebp</span><br><span class="line">PAGE:004A1637                 mov     ebp, esp</span><br><span class="line">PAGE:004A1639                 cmp     [ebp+Length], 0</span><br><span class="line">PAGE:004A163D                 jz      loc_51B865</span><br><span class="line">PAGE:004A1643                 push    ebx</span><br><span class="line">PAGE:004A1644                 mov     ebx, [ebp+BugCheckParameter1]</span><br><span class="line">PAGE:004A1647                 mov     ecx, ebx</span><br><span class="line">PAGE:004A1649                 mov     eax, large fs:124h</span><br><span class="line">PAGE:004A164F                 cmp     ebx, [eax+44h]</span><br><span class="line">PAGE:004A1652                 jnz     short loc_4A1657</span><br><span class="line">PAGE:004A1654                 mov     ecx, [ebp+arg_8]</span><br><span class="line">PAGE:004A1657</span><br><span class="line">PAGE:004A1657 loc_4A1657:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+1E↑j</span><br><span class="line">PAGE:004A1657                 add     ecx, 80h</span><br><span class="line">PAGE:004A165D                 mov     [ebp+BugCheckParameter1], ecx</span><br><span class="line">PAGE:004A1660                 call    @ExAcquireRundownProtection@4 ; ExAcquireRundownProtection(x)</span><br><span class="line">PAGE:004A1665                 test    al, al</span><br><span class="line">PAGE:004A1667                 jz      loc_51B86C</span><br><span class="line">PAGE:004A166D                 cmp     [ebp+Length], 1FFh</span><br><span class="line">PAGE:004A1674                 push    esi</span><br><span class="line">PAGE:004A1675                 push    edi</span><br><span class="line">PAGE:004A1676                 mov     edi, [ebp+arg_18]</span><br><span class="line">PAGE:004A1679                 ja      loc_4A5AF4</span><br><span class="line">PAGE:004A167F</span><br><span class="line">PAGE:004A167F loc_4A167F:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+7A245↓j</span><br><span class="line">PAGE:004A167F                 push    edi             ; int</span><br><span class="line">PAGE:004A1680                 push    dword ptr [ebp+AccessMode] ; char</span><br><span class="line">PAGE:004A1683                 push    [ebp+Length]    ; Length</span><br><span class="line">PAGE:004A1686                 push    [ebp+Address]   ; Address</span><br><span class="line">PAGE:004A1689                 push    [ebp+arg_8]     ; ULONG_PTR</span><br><span class="line">PAGE:004A168C                 push    [ebp+arg_4]     ; int</span><br><span class="line">PAGE:004A168F                 push    ebx             ; BugCheckParameter1</span><br><span class="line">PAGE:004A1690                 call    _MiDoPoolCopy@28 ; MiDoPoolCopy(x,x,x,x,x,x,x)//真正的copy函数</span><br><span class="line">PAGE:004A1695                 mov     esi, eax</span><br><span class="line">PAGE:004A1697</span><br><span class="line">PAGE:004A1697 loc_4A1697:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+44DE↓j</span><br><span class="line">PAGE:004A1697                 mov     ecx, [ebp+BugCheckParameter1]</span><br><span class="line">PAGE:004A169A                 call    @ExReleaseRundownProtection@4 ; ExReleaseRundownProtection(x)</span><br><span class="line">PAGE:004A169F                 pop     edi</span><br><span class="line">PAGE:004A16A0                 mov     eax, esi</span><br><span class="line">PAGE:004A16A2                 pop     esi</span><br><span class="line">PAGE:004A16A3</span><br><span class="line">PAGE:004A16A3 loc_4A16A3:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+7A23D↓j</span><br><span class="line">PAGE:004A16A3                 pop     ebx</span><br><span class="line">PAGE:004A16A4</span><br><span class="line">PAGE:004A16A4 loc_4A16A4:                             ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+7A233↓j</span><br><span class="line">PAGE:004A16A4                 pop     ebp</span><br><span class="line">PAGE:004A16A5                 retn    1Ch</span><br><span class="line">PAGE:004A16A5 _MmCopyVirtualMemory@28 endp</span><br></pre></td></tr></table></figure>

<h4 id="MiDoPoolCopy"><a href="#MiDoPoolCopy" class="headerlink" title="MiDoPoolCopy"></a>MiDoPoolCopy</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">PAGE:004A180D ; int __stdcall MiDoPoolCopy(ULONG_PTR BugCheckParameter1, int, ULONG_PTR, PVOID Address, SIZE_T Length, char, int)</span><br><span class="line">PAGE:004A180D _MiDoPoolCopy@28 proc near              ; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+5C↑p</span><br><span class="line">PAGE:004A180D</span><br><span class="line">PAGE:004A180D var_258         = byte ptr -258h</span><br><span class="line">PAGE:004A180D var_58          = dword ptr -58h</span><br><span class="line">PAGE:004A180D var_40          = dword ptr -40h</span><br><span class="line">PAGE:004A180D var_3C          = dword ptr -3Ch</span><br><span class="line">PAGE:004A180D var_38          = dword ptr -38h</span><br><span class="line">PAGE:004A180D var_34          = dword ptr -34h</span><br><span class="line">PAGE:004A180D var_30          = dword ptr -30h</span><br><span class="line">PAGE:004A180D var_2C          = dword ptr -2Ch</span><br><span class="line">PAGE:004A180D var_28          = dword ptr -28h</span><br><span class="line">PAGE:004A180D var_24          = dword ptr -24h</span><br><span class="line">PAGE:004A180D var_20          = dword ptr -20h</span><br><span class="line">PAGE:004A180D P               = dword ptr -1Ch</span><br><span class="line">PAGE:004A180D ms_exc          = CPPEH_RECORD ptr -18h</span><br><span class="line">PAGE:004A180D BugCheckParameter1= dword ptr  8</span><br><span class="line">PAGE:004A180D arg_4           = dword ptr  0Ch</span><br><span class="line">PAGE:004A180D arg_8           = dword ptr  10h</span><br><span class="line">PAGE:004A180D Address         = dword ptr  14h</span><br><span class="line">PAGE:004A180D Length          = dword ptr  18h</span><br><span class="line">PAGE:004A180D arg_14          = byte ptr  1Ch</span><br><span class="line">PAGE:004A180D arg_18          = dword ptr  20h</span><br><span class="line">PAGE:004A180D</span><br><span class="line">PAGE:004A180D ; FUNCTION CHUNK AT PAGE:004E783C SIZE 0000000D BYTES</span><br><span class="line">PAGE:004A180D ; FUNCTION CHUNK AT PAGE:0051B7A5 SIZE 00000034 BYTES</span><br><span class="line">PAGE:004A180D ; FUNCTION CHUNK AT PAGE:0051B7DE SIZE 00000019 BYTES</span><br><span class="line">PAGE:004A180D ; FUNCTION CHUNK AT PAGE:0051B7FC SIZE 00000069 BYTES</span><br><span class="line">PAGE:004A180D</span><br><span class="line">PAGE:004A180D ; __unwind &#123; // __SEH_prolog</span><br><span class="line">PAGE:004A180D                 push    248h</span><br><span class="line">PAGE:004A1812                 push    offset stru_41A608</span><br><span class="line">PAGE:004A1817                 call    __SEH_prolog</span><br><span class="line">PAGE:004A181C                 mov     eax, large fs:124h</span><br><span class="line">PAGE:004A1822                 mov     eax, [ebp+arg_4]</span><br><span class="line">PAGE:004A1825                 mov     [ebp+var_24], eax</span><br><span class="line">PAGE:004A1828                 mov     eax, [ebp+Address]</span><br><span class="line">PAGE:004A182B                 mov     [ebp+var_30], eax</span><br><span class="line">PAGE:004A182E                 mov     eax, 10000h</span><br><span class="line">PAGE:004A1833                 mov     edi, eax</span><br><span class="line">PAGE:004A1835                 cmp     [ebp+Length], eax</span><br><span class="line">PAGE:004A1838                 ja      short loc_4A183D</span><br><span class="line">PAGE:004A183A                 mov     edi, [ebp+Length]</span><br><span class="line">PAGE:004A183D</span><br><span class="line">PAGE:004A183D loc_4A183D:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+2B↑j</span><br><span class="line">PAGE:004A183D                 and     [ebp+var_2C], 0</span><br><span class="line">PAGE:004A1841                 mov     esi, 200h</span><br><span class="line">PAGE:004A1846                 cmp     [ebp+Length], esi</span><br><span class="line">PAGE:004A1849                 ja      loc_51B7A5</span><br><span class="line">PAGE:004A184F</span><br><span class="line">PAGE:004A184F loc_4A184F:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+79FB0↓j</span><br><span class="line">PAGE:004A184F                 lea     eax, [ebp+var_258]</span><br><span class="line">PAGE:004A1855                 mov     [ebp+P], eax</span><br><span class="line">PAGE:004A1858</span><br><span class="line">PAGE:004A1858 loc_4A1858:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+79FC7↓j</span><br><span class="line">PAGE:004A1858                 xor     eax, eax</span><br><span class="line">PAGE:004A185A                 mov     [ebp+var_34], eax</span><br><span class="line">PAGE:004A185D                 mov     [ebp+var_38], eax</span><br><span class="line">PAGE:004A1860                 mov     ecx, [ebp+Length]</span><br><span class="line">PAGE:004A1863                 mov     [ebp+var_20], ecx</span><br><span class="line">PAGE:004A1866                 mov     ebx, edi</span><br><span class="line">PAGE:004A1868                 mov     [ebp+var_28], eax</span><br><span class="line">PAGE:004A186B</span><br><span class="line">PAGE:004A186B loc_4A186B:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+141↓j</span><br><span class="line">PAGE:004A186B                 xor     eax, eax</span><br><span class="line">PAGE:004A186D                 cmp     [ebp+var_20], eax</span><br><span class="line">PAGE:004A1870                 jbe     loc_4A1953</span><br><span class="line">PAGE:004A1876                 cmp     [ebp+var_20], ebx</span><br><span class="line">PAGE:004A1879                 jb      loc_51B7C5</span><br><span class="line">PAGE:004A187F</span><br><span class="line">PAGE:004A187F loc_4A187F:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+79FBB↓j</span><br><span class="line">PAGE:004A187F                 lea     eax, [ebp+var_58]</span><br><span class="line">PAGE:004A1882                 push    eax             ; int</span><br><span class="line">PAGE:004A1883                 push    [ebp+BugCheckParameter1] ; BugCheckParameter1</span><br><span class="line">PAGE:004A1886                 call    _KeStackAttachProcess@8 ; KeStackAttachProcess(x,x)//开始挂靠目标进程函数</span><br><span class="line">PAGE:004A188B                 xor     esi, esi</span><br><span class="line">PAGE:004A188D                 mov     [ebp+var_3C], esi</span><br><span class="line">PAGE:004A1890 ;   __try &#123; // __except at loc_51B7FC</span><br><span class="line">PAGE:004A1890                 mov     [ebp+ms_exc.registration.TryLevel], esi</span><br><span class="line">PAGE:004A1893                 mov     ecx, [ebp+arg_4]</span><br><span class="line">PAGE:004A1896                 cmp     [ebp+var_24], ecx</span><br><span class="line">PAGE:004A1899                 jnz     short loc_4A18C8</span><br><span class="line">PAGE:004A189B                 cmp     [ebp+arg_14], 0</span><br><span class="line">PAGE:004A189F                 jz      short loc_4A18C8</span><br><span class="line">PAGE:004A18A1                 mov     [ebp+var_28], 1</span><br><span class="line">PAGE:004A18A8                 mov     eax, [ebp+Length]</span><br><span class="line">PAGE:004A18AB                 cmp     eax, esi</span><br><span class="line">PAGE:004A18AD                 jz      short loc_4A18C5</span><br><span class="line">PAGE:004A18AF                 add     eax, ecx</span><br><span class="line">PAGE:004A18B1                 cmp     eax, ecx</span><br><span class="line">PAGE:004A18B3                 jb      loc_4E7844</span><br><span class="line">PAGE:004A18B9                 cmp     eax, _MmUserProbeAddress</span><br><span class="line">PAGE:004A18BF                 ja      loc_4E7844</span><br><span class="line">PAGE:004A18C5</span><br><span class="line">PAGE:004A18C5 loc_4A18C5:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+A0↑j</span><br><span class="line">PAGE:004A18C5                                         ; PAGE:004E7849↓j</span><br><span class="line">PAGE:004A18C5                 mov     [ebp+var_28], esi</span><br><span class="line">PAGE:004A18C8</span><br><span class="line">PAGE:004A18C8 loc_4A18C8:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+8C↑j</span><br><span class="line">PAGE:004A18C8                                         ; MiDoPoolCopy(x,x,x,x,x,x,x)+92↑j</span><br><span class="line">PAGE:004A18C8                 mov     ecx, ebx</span><br><span class="line">PAGE:004A18CA                 mov     esi, [ebp+var_24]</span><br><span class="line">PAGE:004A18CD                 mov     edi, [ebp+P]</span><br><span class="line">PAGE:004A18D0                 mov     eax, ecx</span><br><span class="line">PAGE:004A18D2                 shr     ecx, 2</span><br><span class="line">PAGE:004A18D5                 rep movsd//开始复制</span><br><span class="line">PAGE:004A18D7                 mov     ecx, eax</span><br><span class="line">PAGE:004A18D9                 and     ecx, 3</span><br><span class="line">PAGE:004A18DC                 rep movsb</span><br><span class="line">PAGE:004A18DE                 lea     eax, [ebp+var_58]</span><br><span class="line">PAGE:004A18E1                 push    eax</span><br><span class="line">PAGE:004A18E2                 call    _KeUnstackDetachProcess@4 ; KeUnstackDetachProcess(x)</span><br><span class="line">PAGE:004A18E7                 lea     eax, [ebp+var_58]</span><br><span class="line">PAGE:004A18EA                 push    eax             ; int</span><br><span class="line">PAGE:004A18EB                 push    [ebp+arg_8]     ; BugCheckParameter1</span><br><span class="line">PAGE:004A18EE                 call    _KeStackAttachProcess@8 ; KeStackAttachProcess(x,x)</span><br><span class="line">PAGE:004A18F3                 mov     eax, [ebp+arg_4]</span><br><span class="line">PAGE:004A18F6                 cmp     [ebp+var_24], eax</span><br><span class="line">PAGE:004A18F9                 jnz     loc_4E783C</span><br><span class="line">PAGE:004A18FF                 cmp     [ebp+arg_14], 0</span><br><span class="line">PAGE:004A1903                 jz      loc_4E783C</span><br><span class="line">PAGE:004A1909                 xor     esi, esi</span><br><span class="line">PAGE:004A190B                 inc     esi</span><br><span class="line">PAGE:004A190C                 mov     [ebp+var_28], esi</span><br><span class="line">PAGE:004A190F                 push    esi             ; Alignment</span><br><span class="line">PAGE:004A1910                 push    [ebp+Length]    ; Length</span><br><span class="line">PAGE:004A1913                 push    [ebp+Address]   ; Address</span><br><span class="line">PAGE:004A1916                 call    _ProbeForWrite@12 ; ProbeForWrite(x,x,x)</span><br><span class="line">PAGE:004A191B                 and     [ebp+var_28], 0</span><br><span class="line">PAGE:004A191F</span><br><span class="line">PAGE:004A191F loc_4A191F:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+46032↓j</span><br><span class="line">PAGE:004A191F                 mov     [ebp+var_3C], esi</span><br><span class="line">PAGE:004A1922                 mov     ecx, ebx</span><br><span class="line">PAGE:004A1924                 mov     esi, [ebp+P]</span><br><span class="line">PAGE:004A1927                 mov     edi, [ebp+var_30]</span><br><span class="line">PAGE:004A192A                 mov     eax, ecx</span><br><span class="line">PAGE:004A192C                 shr     ecx, 2</span><br><span class="line">PAGE:004A192F                 rep movsd</span><br><span class="line">PAGE:004A1931                 mov     ecx, eax</span><br><span class="line">PAGE:004A1933                 and     ecx, 3</span><br><span class="line">PAGE:004A1936                 rep movsb</span><br><span class="line">PAGE:004A1936 ;   &#125; // starts at 4A1890</span><br><span class="line">PAGE:004A1938                 or      [ebp+ms_exc.registration.TryLevel], 0FFFFFFFFh</span><br><span class="line">PAGE:004A193C                 lea     eax, [ebp+var_58]</span><br><span class="line">PAGE:004A193F                 push    eax</span><br><span class="line">PAGE:004A1940                 call    _KeUnstackDetachProcess@4 ; KeUnstackDetachProcess(x)</span><br><span class="line">PAGE:004A1945                 sub     [ebp+var_20], ebx</span><br><span class="line">PAGE:004A1948                 add     [ebp+var_24], ebx</span><br><span class="line">PAGE:004A194B                 add     [ebp+var_30], ebx</span><br><span class="line">PAGE:004A194E                 jmp     loc_4A186B</span><br><span class="line">PAGE:004A1953 ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:004A1953</span><br><span class="line">PAGE:004A1953 loc_4A1953:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+63↑j</span><br><span class="line">PAGE:004A1953                 cmp     [ebp+var_2C], eax</span><br><span class="line">PAGE:004A1956                 jnz     loc_51B857</span><br><span class="line">PAGE:004A195C</span><br><span class="line">PAGE:004A195C loc_4A195C:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+7A053↓j</span><br><span class="line">PAGE:004A195C                 mov     eax, [ebp+arg_18]</span><br><span class="line">PAGE:004A195F                 mov     ecx, [ebp+Length]</span><br><span class="line">PAGE:004A1962                 mov     [eax], ecx</span><br><span class="line">PAGE:004A1964                 xor     eax, eax</span><br><span class="line">PAGE:004A1966</span><br><span class="line">PAGE:004A1966 loc_4A1966:                             ; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+7A018↓j</span><br><span class="line">PAGE:004A1966                                         ; MiDoPoolCopy(x,x,x,x,x,x,x)+7A045↓j</span><br><span class="line">PAGE:004A1966                 call    __SEH_epilog</span><br><span class="line">PAGE:004A196B                 retn    1Ch</span><br><span class="line">PAGE:004A196B ; &#125; // starts at 4A180D</span><br><span class="line">PAGE:004A196B _MiDoPoolCopy@28 endp</span><br></pre></td></tr></table></figure>

<h4 id="KeStackAttachProcess"><a href="#KeStackAttachProcess" class="headerlink" title="KeStackAttachProcess"></a>KeStackAttachProcess</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">.text:0041A5A3 ; int __stdcall KeStackAttachProcess(ULONG_PTR BugCheckParameter1, int)</span><br><span class="line">.text:0041A5A3                 public _KeStackAttachProcess@8</span><br><span class="line">.text:0041A5A3 _KeStackAttachProcess@8 proc near       ; CODE XREF: MmAttachSession(x,x)+58↓p</span><br><span class="line">.text:0041A5A3                                         ; MiAttachToSecureProcessInSession(x)+43↓p ...</span><br><span class="line">.text:0041A5A3</span><br><span class="line">.text:0041A5A3 BugCheckParameter1= dword ptr  8</span><br><span class="line">.text:0041A5A3 arg_4           = dword ptr  0Ch</span><br><span class="line">.text:0041A5A3</span><br><span class="line">.text:0041A5A3 ; FUNCTION CHUNK AT .text:00445FAF SIZE 0000002E BYTES</span><br><span class="line">.text:0041A5A3</span><br><span class="line">.text:0041A5A3                 mov     edi, edi</span><br><span class="line">.text:0041A5A5                 push    ebp</span><br><span class="line">.text:0041A5A6                 mov     ebp, esp</span><br><span class="line">.text:0041A5A8                 push    esi</span><br><span class="line">.text:0041A5A9                 push    edi</span><br><span class="line">.text:0041A5AA                 mov     eax, large fs:124h</span><br><span class="line">.text:0041A5B0                 mov     esi, eax</span><br><span class="line">.text:0041A5B2                 mov     eax, large fs:994h</span><br><span class="line">.text:0041A5B8                 test    eax, eax</span><br><span class="line">.text:0041A5BA                 jnz     loc_445FAF</span><br><span class="line">.text:0041A5C0                 mov     edi, [ebp+BugCheckParameter1]</span><br><span class="line">.text:0041A5C3                 cmp     [esi+44h], edi</span><br><span class="line">.text:0041A5C6                 jz      short loc_41A5FC</span><br><span class="line">.text:0041A5C8                 call    ds:__imp__KeRaiseIrqlToDpcLevel@0 ; KeRaiseIrqlToDpcLevel()</span><br><span class="line">.text:0041A5CE                 cmp     byte ptr [esi+165h], 0</span><br><span class="line">.text:0041A5D5                 mov     byte ptr [ebp+BugCheckParameter1], al</span><br><span class="line">.text:0041A5D8                 jnz     loc_445FCB</span><br><span class="line">.text:0041A5DE                 lea     eax, [esi+14Ch]</span><br><span class="line">.text:0041A5E4                 push    eax</span><br><span class="line">.text:0041A5E5                 push    [ebp+BugCheckParameter1]</span><br><span class="line">.text:0041A5E8                 push    edi</span><br><span class="line">.text:0041A5E9                 push    esi</span><br><span class="line">.text:0041A5EA                 call    _KiAttachProcess@16 ; KiAttachProcess(x,x,x,x)//挂靠进程函数</span><br><span class="line">.text:0041A5EF                 mov     eax, [ebp+arg_4]</span><br><span class="line">.text:0041A5F2                 and     dword ptr [eax+10h], 0</span><br><span class="line">.text:0041A5F6</span><br><span class="line">.text:0041A5F6 loc_41A5F6:                             ; CODE XREF: KeStackAttachProcess(x,x)+63↓j</span><br><span class="line">.text:0041A5F6                                         ; KeStackAttachProcess(x,x)+2BA35↓j</span><br><span class="line">.text:0041A5F6                 pop     edi</span><br><span class="line">.text:0041A5F7                 pop     esi</span><br><span class="line">.text:0041A5F8                 pop     ebp</span><br><span class="line">.text:0041A5F9                 retn    8</span><br><span class="line">.text:0041A5FC ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0041A5FC</span><br><span class="line">.text:0041A5FC loc_41A5FC:                             ; CODE XREF: KeStackAttachProcess(x,x)+23↑j</span><br><span class="line">.text:0041A5FC                 mov     eax, [ebp+arg_4]</span><br><span class="line">.text:0041A5FF                 mov     dword ptr [eax+10h], 1</span><br><span class="line">.text:0041A606                 jmp     short loc_41A5F6</span><br><span class="line">.text:0041A606 _KeStackAttachProcess@8 endp</span><br></pre></td></tr></table></figure>

<h4 id="KiAttachProcess"><a href="#KiAttachProcess" class="headerlink" title="KiAttachProcess"></a>KiAttachProcess</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">.text:00413166 ; __stdcall KiAttachProcess(x, x, x, x)</span><br><span class="line">.text:00413166 _KiAttachProcess@16 proc near           ; CODE XREF: KeAttachProcess(x)+47↓p</span><br><span class="line">.text:00413166                                         ; KeStackAttachProcess(x,x)+47↓p ...</span><br><span class="line">.text:00413166</span><br><span class="line">.text:00413166 arg_0           = dword ptr  8</span><br><span class="line">.text:00413166 arg_4           = dword ptr  0Ch</span><br><span class="line">.text:00413166 arg_8           = byte ptr  10h</span><br><span class="line">.text:00413166 arg_C           = dword ptr  14h</span><br><span class="line">.text:00413166</span><br><span class="line">.text:00413166 ; FUNCTION CHUNK AT .text:00445F0D SIZE 0000001E BYTES</span><br><span class="line">.text:00413166 ; FUNCTION CHUNK AT .text:00445F30 SIZE 00000064 BYTES</span><br><span class="line">.text:00413166</span><br><span class="line">.text:00413166                 mov     edi, edi</span><br><span class="line">.text:00413168                 push    ebp</span><br><span class="line">.text:00413169                 mov     ebp, esp</span><br><span class="line">.text:0041316B                 push    ebx</span><br><span class="line">.text:0041316C                 mov     ebx, [ebp+arg_4]</span><br><span class="line">.text:0041316F                 inc     word ptr [ebx+60h]</span><br><span class="line">.text:00413173                 push    esi</span><br><span class="line">.text:00413174                 mov     esi, [ebp+arg_0]</span><br><span class="line">.text:00413177                 push    edi</span><br><span class="line">.text:00413178                 push    [ebp+arg_C]</span><br><span class="line">.text:0041317B                 lea     edi, [esi+34h]</span><br><span class="line">.text:0041317E                 push    edi</span><br><span class="line">.text:0041317F                 call    _KiMoveApcState@8 ; KiMoveApcState(x,x)</span><br><span class="line">.text:00413184                 mov     [edi+4], edi</span><br><span class="line">.text:00413187                 mov     [edi], edi</span><br><span class="line">.text:00413189                 lea     eax, [esi+3Ch]</span><br><span class="line">.text:0041318C                 mov     [eax+4], eax</span><br><span class="line">.text:0041318F                 mov     [eax], eax</span><br><span class="line">.text:00413191                 lea     eax, [esi+14Ch]</span><br><span class="line">.text:00413197                 cmp     [ebp+arg_C], eax</span><br><span class="line">.text:0041319A                 mov     [esi+44h], ebx;将该线程的KTHREAD.ApcState.Process改为要读取的进程的_KPROCESS</span><br><span class="line">.text:0041319D                 mov     byte ptr [esi+48h], 0</span><br><span class="line">.text:004131A1                 mov     byte ptr [esi+49h], 0</span><br><span class="line">.text:004131A5                 mov     byte ptr [esi+4Ah], 0</span><br><span class="line">.text:004131A9                 jnz     short loc_4131BE</span><br><span class="line">.text:004131AB                 mov     [esi+138h], eax</span><br><span class="line">.text:004131B1                 mov     [esi+13Ch], edi</span><br><span class="line">.text:004131B7                 mov     byte ptr [esi+165h], 1</span><br><span class="line">.text:004131BE</span><br><span class="line">.text:004131BE loc_4131BE:                             ; CODE XREF: KiAttachProcess(x,x,x,x)+43↑j</span><br><span class="line">.text:004131BE                 cmp     byte ptr [ebx+65h], 0</span><br><span class="line">.text:004131C2                 jnz     loc_445F30</span><br><span class="line">.text:004131C8                 lea     esi, [ebx+40h]</span><br><span class="line">.text:004131CB</span><br><span class="line">.text:004131CB loc_4131CB:                             ; CODE XREF: KiAttachProcess(x,x,x,x)+32DC0↓j</span><br><span class="line">.text:004131CB                 mov     eax, [esi]</span><br><span class="line">.text:004131CD                 cmp     eax, esi</span><br><span class="line">.text:004131CF                 jnz     loc_445F0D</span><br><span class="line">.text:004131D5                 mov     eax, [ebp+arg_C]</span><br><span class="line">.text:004131D8                 push    dword ptr [eax+10h]</span><br><span class="line">.text:004131DB                 push    ebx</span><br><span class="line">.text:004131DC                 call    _KiSwapProcess@8 ; KiSwapProcess(x,x)//真正挂靠进程的函数</span><br><span class="line">.text:004131E1                 mov     cl, [ebp+arg_8]</span><br><span class="line">.text:004131E4                 call    @KiUnlockDispatcherDatabase@4 ; KiUnlockDispatcherDatabase(x)</span><br><span class="line">.text:004131E9</span><br><span class="line">.text:004131E9 loc_4131E9:                             ; CODE XREF: .text:00445F2B↓j</span><br><span class="line">.text:004131E9                                         ; KiAttachProcess(x,x,x,x)+32E29↓j</span><br><span class="line">.text:004131E9                 pop     edi</span><br><span class="line">.text:004131EA                 pop     esi</span><br><span class="line">.text:004131EB                 pop     ebx</span><br><span class="line">.text:004131EC                 pop     ebp</span><br><span class="line">.text:004131ED                 retn    10h</span><br><span class="line">.text:004131ED _KiAttachProcess@16 endp</span><br></pre></td></tr></table></figure>

<h4 id="KiSwapProcess"><a href="#KiSwapProcess" class="headerlink" title="KiSwapProcess"></a>KiSwapProcess</h4><p>真正挂靠进程的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">.text:00404AC4 ; __stdcall KiSwapProcess(x, x)</span><br><span class="line">.text:00404AC4 _KiSwapProcess@8 proc near              ; CODE XREF: KiAttachProcess(x,x,x,x)+76↓p</span><br><span class="line">.text:00404AC4                                         ; KeDetachProcess()+73↓p ...</span><br><span class="line">.text:00404AC4</span><br><span class="line">.text:00404AC4 arg_0           = dword ptr  4</span><br><span class="line">.text:00404AC4</span><br><span class="line">.text:00404AC4                 mov     edx, [esp+arg_0]</span><br><span class="line">.text:00404AC8                 xor     eax, eax</span><br><span class="line">.text:00404ACA                 cmp     [edx+20h], ax</span><br><span class="line">.text:00404ACE                 jz      short loc_404AFF</span><br><span class="line">.text:00404AD0                 mov     ecx, ds:0FFDFF03Ch</span><br><span class="line">.text:00404AD6                 mov     eax, [edx+20h]</span><br><span class="line">.text:00404AD9                 mov     [ecx+48h], eax</span><br><span class="line">.text:00404ADC                 mov     eax, [edx+24h]</span><br><span class="line">.text:00404ADF                 mov     [ecx+4Ch], eax</span><br><span class="line">.text:00404AE2                 mov     ecx, ds:0FFDFF038h</span><br><span class="line">.text:00404AE8                 mov     eax, [edx+28h]</span><br><span class="line">.text:00404AEB                 mov     [ecx+108h], eax</span><br><span class="line">.text:00404AF1                 mov     eax, [edx+2Ch]</span><br><span class="line">.text:00404AF4                 mov     [ecx+10Ch], eax</span><br><span class="line">.text:00404AFA                 mov     eax, 48h</span><br><span class="line">.text:00404AFF</span><br><span class="line">.text:00404AFF loc_404AFF:                             ; CODE XREF: KiSwapProcess(x,x)+A↑j</span><br><span class="line">.text:00404AFF                 lldt    ax</span><br><span class="line">.text:00404B02                 mov     ecx, ds:0FFDFF040h</span><br><span class="line">.text:00404B08                 mov     edx, [esp+arg_0]</span><br><span class="line">.text:00404B0C                 xor     eax, eax</span><br><span class="line">.text:00404B0E                 mov     gs, eax</span><br><span class="line">.text:00404B10                 mov     eax, [edx+18h];eax取要读取进程的页目录表基址</span><br><span class="line">.text:00404B13                 mov     [ecx+1Ch], eax</span><br><span class="line">.text:00404B16                 mov     cr3, eax;修改当前Cr3为要读取进程的Cr3</span><br><span class="line">.text:00404B19                 mov     ax, [edx+30h]</span><br><span class="line">.text:00404B1D                 mov     [ecx+66h], ax</span><br><span class="line">.text:00404B21                 retn    8</span><br><span class="line">.text:00404B21 _KiSwapProcess@8 endp</span><br></pre></td></tr></table></figure>

<h3 id="进程挂靠总结"><a href="#进程挂靠总结" class="headerlink" title="进程挂靠总结"></a>进程挂靠总结</h3><p>可不可以只修改Cr3而不修改养父母？不可以，如果不修改养父母的值，一旦产生线程切换，再切回来的时候，就会变成自己读自己！<code>(因为线程切换就是去0x44取值放入Cr3中，但0x44并未修改，因此线程切换回自己的时候又会把自己的Cr3再取回来)</code></p>
<p>如果我们自己写代码，<strong>在切换Cr3后关闭中断</strong>，并且<strong>不调用会导致线程切换的API</strong>，就可以不用修改养父母的值。</p>
<h3 id="跨进程读写内存"><a href="#跨进程读写内存" class="headerlink" title="跨进程读写内存"></a>跨进程读写内存</h3><p>跨进程的本质是“进程挂靠”，正常情况下，A进程的线程只能访问A进程的地址空间，如果A进程的线程想访问B进程的地址空间，就要修改当前的Cr3的值为B进程的页目录表基址（KPROCESS.DirectoryTableBase）</p>
<h4 id="NtReadVirtualMemory流程解析："><a href="#NtReadVirtualMemory流程解析：" class="headerlink" title="NtReadVirtualMemory流程解析："></a>NtReadVirtualMemory流程解析：</h4><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913175616484.png" alt="image-20210913175616484"></p>
<ol>
<li>切换Cr3</li>
<li>读取数据复制到高2G</li>
<li>切换Cr3</li>
<li>从高2G复制到目标位置</li>
</ol>
<h4 id="NtWriteVirtualMemory流程解析："><a href="#NtWriteVirtualMemory流程解析：" class="headerlink" title="NtWriteVirtualMemory流程解析："></a>NtWriteVirtualMemory流程解析：</h4><p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210913180101685.png" alt="image-20210913180101685"></p>
<ol>
<li>将数据从目标位置复制到高2G地址</li>
<li>切换Cr3</li>
<li>从高2G复制到目标位置</li>
<li>切换Cr3</li>
</ol>
<p><strong>跨进程读内存实验：</strong></p>
<p><strong>跨进程写内存实验：</strong></p>
<h1 id="驱动另类通信实验"><a href="#驱动另类通信实验" class="headerlink" title="驱动另类通信实验"></a>驱动另类通信实验</h1><p>另类通信，诸如内存映射，门调用等等非常多方法。</p>
<p>inlineHOOK SSDT某一个有输入，有输出的函数，来实现驱动另类通信 </p>
<p>内核改PE文件思路？只读不能改？运行不能改？<a target="_blank" rel="noopener" href="https://www.codeproject.com/Articles/47708/Modify-Update-resources-of-an-Exe-DLL-on-the-fly">似乎有办法</a></p>
<h1 id="DPC-延迟过程调用"><a href="#DPC-延迟过程调用" class="headerlink" title="DPC 延迟过程调用"></a>DPC 延迟过程调用</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/maomao171314/article/details/22916951">DPC调用过程参考</a></p>
<blockquote>
<p>DPC是“<strong>Deferred Procedure Call</strong>”的缩写，意为<strong>推迟了的过程（函数）调用</strong>。这是因为，逻辑上应该放在中断服务程序中完成的操作并非都是那么紧迫，其中有一部分可能相对而言不那么紧迫，而又比较费时间，实际上可以放在开中断的条件下执行。如果把这些操作都放在中断服务程序中，就会使关闭中断的时间太长而引起中断请求的丢失，因为整个中断服务程序通常都是在关中断的条件下执行的。为此，把中断服务程序中不那么紧迫却比较费时，而又不必在关中断条件下执行的操作分割出来，放在另一个函数中，在开中断的条件下加以执行，就可以缩短关中断的时间。这样的函数就是DPC函数。一般而言，中断服务前期的操作是比较紧迫的，并且是必须关中断的，此时可以很快地对外部设备进行操作。此后，剩下的那部分操作便可以稍后在开中断的条件下执行。所以有人曾经把这部分操作称为中断服务的“后半（Bottom Half）”，也有人把这两半分别称为“硬中断”和“软中断”。之所以要把中断服务分成前后两半，是因为一次中断服务的后半不如另一次中断的前半那么紧迫。</p>
<p>为此，内核中要有个DPC请求队列，中断服务程序执行完它的“前半”之后就把一个DPC请求挂入这个队列，要求内核调用相应的DPC函数，然后（形式上）就从中断返回了。接着，<strong>如果没有别的中断请求，内核就会扫描这个DPC请求队列，依次在开中断的条件下执行这些DPC函数，直至又发生中断或执行完队列中的所有DPC函数</strong>。至于当前线程所要执行的程序，则只有在DPC请求队列为空的时候才会继续得到执行。显然，这里所体现的是“急事急办”的原则，<strong>中断是最急的，DPC函数其次，最后才是当前线程</strong>。Windows内核的IRQL（即运行级别）就反映了这些活动的轻重缓急，DPC函数是在DISPATCH_LEVEL级别上执行的。</p>
<p>与DPC函数的执行有关的另一个问题是堆栈的使用。我们知道，中断服务程序所使用的堆栈就是当前线程的系统空间堆栈。中断服务程序一般都是比较轻小的，占用一下当前线程的堆栈不至于会有问题；但是DPC函数就不同了，DPC函数有可能是比较大的，如果仍旧占用当前线程的堆栈，在最坏的情况下有可能造成堆栈溢出，所以最好是为<strong>DPC函数的执行另外配备一个堆栈</strong>。</p>
</blockquote>
<p>ISR 中断处理，简单，指令少</p>
<p>重要的部分中断处理</p>
<p>不那么重要的部分，操作系统封装成KDPC里面,等下再执行。</p>
<p>_KPRCB结构体中0x860的DpcListHead就是dpc链表</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210915203346309.png" alt="image-20210915203346309"></p>
<p>DPC一定比APC先执行</p>
<h2 id="KDPC结构"><a href="#KDPC结构" class="headerlink" title="_KDPC结构"></a>_KDPC结构</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KDPC</span><br><span class="line">nt!_KDPC</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B<span class="comment">//类型</span></span><br><span class="line">   +<span class="number">0x002</span> Number           : UChar<span class="comment">//属于哪个核的，即属于哪个KPCR</span></span><br><span class="line">   +<span class="number">0x003</span> Importance       : UChar<span class="comment">//三档优先级，0,1,2优先级依次降低</span></span><br><span class="line">   +<span class="number">0x004</span> DpcListEntry     : _LIST_ENTRY<span class="comment">//DPC链表，挂在腰上</span></span><br><span class="line">   +<span class="number">0x00c</span> DeferredRoutine  : Ptr32     <span class="type">void</span> <span class="comment">//回调函数</span></span><br><span class="line">   +<span class="number">0x010</span> DeferredContext  : Ptr32 Void<span class="comment">//回调函数的上下文</span></span><br><span class="line">   +<span class="number">0x014</span> SystemArgument1  : Ptr32 Void<span class="comment">//回调函数的参数1</span></span><br><span class="line">   +<span class="number">0x018</span> SystemArgument2  : Ptr32 Void<span class="comment">//回调函数的参数2</span></span><br><span class="line">   +<span class="number">0x01c</span> Lock             : Ptr32 Uint4B<span class="comment">//DPC的锁</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化函数KeInitializeDpc"><a href="#初始化函数KeInitializeDpc" class="headerlink" title="初始化函数KeInitializeDpc"></a>初始化函数KeInitializeDpc</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">;参数分别是_KDPC结构体指针，DPC回调函数，DPC上下文</span><br><span class="line">.text:0040EA12 ; void __stdcall KeInitializeDpc(PRKDPC Dpc, PKDEFERRED_ROUTINE DeferredRoutine, PVOID DeferredContext)</span><br><span class="line">.text:0040EA12                 public _KeInitializeDpc@12</span><br><span class="line">.text:0040EA12 _KeInitializeDpc@12 proc near           ; CODE XREF: IopInitializeIrpStackProfiler()+29↓p</span><br><span class="line">.text:0040EA12                                         ; VdmpDelayInterrupt(x)+26D↓p ...</span><br><span class="line">.text:0040EA12</span><br><span class="line">.text:0040EA12 Dpc             = dword ptr  8</span><br><span class="line">.text:0040EA12 DeferredRoutine = dword ptr  0Ch</span><br><span class="line">.text:0040EA12 DeferredContext = dword ptr  10h</span><br><span class="line">.text:0040EA12</span><br><span class="line">.text:0040EA12                 mov     edi, edi</span><br><span class="line">.text:0040EA14                 push    ebp</span><br><span class="line">.text:0040EA15                 mov     ebp, esp</span><br><span class="line">.text:0040EA17                 mov     eax, [ebp+Dpc];eax取_KDPC结构体</span><br><span class="line">.text:0040EA1A                 mov     ecx, [ebp+DeferredRoutine];ecx取回调函数</span><br><span class="line">.text:0040EA1D                 and     dword ptr [eax+1Ch], 0;_KDPC中Lock清零</span><br><span class="line">.text:0040EA21                 mov     [eax+0Ch], ecx;_KDPC中回调函数设为参数传入的回调函数</span><br><span class="line">.text:0040EA24                 mov     ecx, [ebp+DeferredContext];ecx取参数dpc上下文</span><br><span class="line">.text:0040EA27                 mov     word ptr [eax], 13h;_KDPC中TYPE初始设置0x13</span><br><span class="line">.text:0040EA2C                 mov     byte ptr [eax+2], 0;_KDPC只有一个核，所以number设为0</span><br><span class="line">.text:0040EA30                 mov     byte ptr [eax+3], 1;_KDPC中Importance初始设为中等优先级</span><br><span class="line">.text:0040EA34                 mov     [eax+10h], ecx;参数上下文放到_KDPC中DeferredContext</span><br><span class="line">.text:0040EA37                 pop     ebp</span><br><span class="line">.text:0040EA38                 retn    0Ch;三个参数,平栈0xC</span><br><span class="line">.text:0040EA38 _KeInitializeDpc@12 endp</span><br></pre></td></tr></table></figure>

<h2 id="插入DPC链表函数KeInsertQueueDpc"><a href="#插入DPC链表函数KeInsertQueueDpc" class="headerlink" title="插入DPC链表函数KeInsertQueueDpc"></a>插入DPC链表函数KeInsertQueueDpc</h2><p>IRQL中断执行的优先级</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210915222903975.png" alt="image-20210915222903975"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">.text:0040C8A2 ; BOOLEAN __stdcall KeInsertQueueDpc(PRKDPC Dpc, PVOID SystemArgument1, PVOID SystemArgument2)</span><br><span class="line">.text:0040C8A2                 public _KeInsertQueueDpc@12</span><br><span class="line">.text:0040C8A2 _KeInsertQueueDpc@12 proc near          ; CODE XREF: KeSetTimerEx(x,x,x,x,x)+25224↓p</span><br><span class="line">.text:0040C8A2                                         ; KiCalibrateTimeAdjustment(x)+58↓p ...</span><br><span class="line">.text:0040C8A2</span><br><span class="line">.text:0040C8A2 var_8           = dword ptr -8</span><br><span class="line">.text:0040C8A2 NewIrql         = byte ptr -1;(实际上该局部变量名称不是很合理，应该是老的Irql)</span><br><span class="line">.text:0040C8A2 Dpc             = dword ptr  8</span><br><span class="line">.text:0040C8A2 SystemArgument1 = dword ptr  0Ch</span><br><span class="line">.text:0040C8A2 SystemArgument2 = dword ptr  10h</span><br><span class="line">.text:0040C8A2</span><br><span class="line">.text:0040C8A2 ; FUNCTION CHUNK AT .text:00446240 SIZE 00000028 BYTES</span><br><span class="line">.text:0040C8A2</span><br><span class="line">.text:0040C8A2                 mov     edi, edi</span><br><span class="line">.text:0040C8A4                 push    ebp</span><br><span class="line">.text:0040C8A5                 mov     ebp, esp</span><br><span class="line">.text:0040C8A7                 push    ecx</span><br><span class="line">.text:0040C8A8                 push    ecx</span><br><span class="line">.text:0040C8A9                 push    esi</span><br><span class="line">.text:0040C8AA                 push    edi</span><br><span class="line">.text:0040C8AB                 mov     cl, 1Fh         ; NewIrql设置为最高31</span><br><span class="line">.text:0040C8AD                 call    ds:__imp_@KfRaiseIrql@4 ; KfRaiseIrql(x) 提升IRQL函数</span><br><span class="line">.text:0040C8B3                 mov     [ebp+NewIrql], al;al返回原来的等级，存入NewIrql局部变量中</span><br><span class="line">.text:0040C8B6                 db      3Eh</span><br><span class="line">.text:0040C8B6                 mov     eax, ds:0FFDFF020h;eax取_KPRCB结构</span><br><span class="line">.text:0040C8BC                 mov     edi, [ebp+Dpc];edi取参数的_KDPC结构</span><br><span class="line">.text:0040C8BF                 mov     esi, eax;esi取_KPRCB结构</span><br><span class="line">.text:0040C8C1                 lea     eax, [esi+8A0h];eax取_KPRCB结构中的DPCLock地址</span><br><span class="line">.text:0040C8C7                 mov     [ebp+var_8], eax;局部变量var_8存_KPRCB结构中的DPCLock地址</span><br><span class="line">.text:0040C8CA                 lea     eax, [edi+1Ch];eax取_KDPC.Lock地址</span><br><span class="line">.text:0040C8CD                 mov     [ebp+Dpc], eax;参数Dpc空间存放_KDPC.Lock地址</span><br><span class="line">.text:0040C8D0                 mov     eax, 0;eax清零</span><br><span class="line">.text:0040C8D5                 mov     ecx, [ebp+Dpc];ecx取_KDPC.Lock地址</span><br><span class="line">.text:0040C8D8                 mov     edx, [ebp+var_8];edx取_KPRCB结构中的DPCLock地址</span><br><span class="line">.text:0040C8DB                 cmpxchg [ecx], edx;将累加器AL/AX/EAX/RAX中的值与首操作数（目的操作数）比较，如果相等，第2操作数（源操作数）的值装载到首操作数，zf置1。如果不等， 首操作数的值装载到AL/AX/EAX/RAX并将zf清0。_KDPC.Lock是否等于零，等于零的话,eax取_KPRCB结构中的DPCLock地址；_KDPC.Lock不等于零的话，直接返回不插入了。</span><br><span class="line">.text:0040C8DE                 test    eax, eax;_KPRCB结构中的DPCLock地址是否为零或者_KDPC.Lock是否为零</span><br><span class="line">.text:0040C8E0                 mov     [ebp+Dpc], eax;eax存入参数空间Dpc</span><br><span class="line">.text:0040C8E3                 jnz     short loc_40C95A;_KDPC.Lock不等于零就跳转就直接降低IQRL并返回了，不插入了；_KDPC.Lock等于零就不跳，之后eax就是_KPRCB结构中的DPCLock地址</span><br><span class="line">.text:0040C8E5                 inc     dword ptr [esi+86Ch];_KPRCB.DpcCount+1</span><br><span class="line">.text:0040C8EB                 add     dword ptr [esi+870h], 1;_KPRCB.DpcQueueDepth+1  dpc队列的深度+1</span><br><span class="line">.text:0040C8F2                 cmp     byte ptr [edi+3], 2;判断_KDPC.Importance优先级是否最高，即2</span><br><span class="line">.text:0040C8F6                 mov     eax, [ebp+SystemArgument1];</span><br><span class="line">.text:0040C8F9                 mov     [edi+14h], eax;将该函数参数放入_KDPC.SystemArgument1</span><br><span class="line">.text:0040C8FC                 mov     eax, [ebp+SystemArgument2];</span><br><span class="line">.text:0040C8FF                 mov     [edi+18h], eax;将该函数参数放入_KDPC.SystemArgument2</span><br><span class="line">.text:0040C902                 lea     ecx, [esi+860h];ecx取_KPRCB.DpcListHead地址</span><br><span class="line">.text:0040C908                 lea     eax, [edi+4];eax取_KDPC.DpcListEntry地址</span><br><span class="line">.text:0040C90B                 jz      loc_446240;_KDPC.Importance优先级为2(最高)的话跳转</span><br><span class="line">			;下面5步将kdpc插入_KPRCB.DpcListHead双向链表中的最末位</span><br><span class="line">.text:0040C911                 mov     edx, [ecx+4]</span><br><span class="line">.text:0040C914                 mov     [eax], ecx;</span><br><span class="line">.text:0040C916                 mov     [eax+4], edx;</span><br><span class="line">.text:0040C919                 mov     [edx], eax;</span><br><span class="line">.text:0040C91B                 mov     [ecx+4], eax;</span><br><span class="line">.text:0040C91E</span><br><span class="line">.text:0040C91E loc_40C91E:                             ; CODE XREF: KeInsertQueueDpc(x,x,x)+399AA↓j</span><br><span class="line">.text:0040C91E                 cmp     dword ptr [esi+874h], 0;</span><br><span class="line">.text:0040C925                 jnz     short loc_40C95A;_KPRCB.DpcRoutineActive不等于0跳转</span><br><span class="line">.text:0040C927                 cmp     dword ptr [esi+878h], 0</span><br><span class="line">.text:0040C92E                 jnz     short loc_40C95A;_KPRCB.DpcInterruptRequested不等于0则跳转</span><br><span class="line">.text:0040C930                 cmp     byte ptr [edi+3], 0;判断_KDPC.Importance优先级是否最低，即0</span><br><span class="line">.text:0040C934                 jnz     short loc_40C948;优先级不是最低的话，跳转</span><br><span class="line">.text:0040C936                 mov     eax, [esi+870h];eax取_KPRCB.DpcQueueDepth</span><br><span class="line">.text:0040C93C                 cmp     eax, [esi+884h];比较_KPRCB.DpcQueueDepth与_KPRCB.MaximumDpcQueueDepth</span><br><span class="line">.text:0040C942                 jb      loc_446251;_KPRCB.DpcQueueDepth小于_KPRCB.MaximumDpcQueueDepth就跳转，也是马上执行dpc</span><br><span class="line">.text:0040C948</span><br><span class="line">.text:0040C948 loc_40C948:                             ; CODE XREF: KeInsertQueueDpc(x,x,x)+92↑j</span><br><span class="line">.text:0040C948                                         ; KeInsertQueueDpc(x,x,x)+399C1↓j</span><br><span class="line">.text:0040C948                 mov     cl, 2</span><br><span class="line">.text:0040C94A                 mov     dword ptr [esi+878h], 1;_KPRCB.DpcInterruptRequested置1</span><br><span class="line">.text:0040C954                 call    ds:__imp_@HalRequestSoftwareInterrupt@4 ; HalRequestSoftwareInterrupt(x);  软中断执行dpc</span><br><span class="line">.text:0040C95A</span><br><span class="line">.text:0040C95A loc_40C95A:                             ; CODE XREF: KeInsertQueueDpc(x,x,x)+41↑j	降低IRQL并返回</span><br><span class="line">.text:0040C95A                                         ; KeInsertQueueDpc(x,x,x)+83↑j ...</span><br><span class="line">.text:0040C95A                 mov     cl, [ebp+NewIrql] ; NewIrql</span><br><span class="line">.text:0040C95D                 call    ds:__imp_@KfLowerIrql@4 ; KfLowerIrql(x)降低IRQL等级</span><br><span class="line">.text:0040C963                 xor     eax, eax</span><br><span class="line">.text:0040C965                 cmp     [ebp+Dpc], eax</span><br><span class="line">.text:0040C968                 pop     edi</span><br><span class="line">.text:0040C969                 setz    al</span><br><span class="line">.text:0040C96C                 pop     esi</span><br><span class="line">.text:0040C96D                 leave</span><br><span class="line">.text:0040C96E                 retn    0Ch;结束</span><br><span class="line">.text:0040C96E _KeInsertQueueDpc@12 endp</span><br><span class="line"></span><br><span class="line">.text:00446240 ; START OF FUNCTION CHUNK FOR _KeInsertQueueDpc@12</span><br><span class="line">.text:00446240</span><br><span class="line">.text:00446240 loc_446240:                             ; CODE XREF: KeInsertQueueDpc(x,x,x)+69↑j  将kdpc插入_KPRCB.DpcListHead双向链表中的首位</span><br><span class="line">.text:00446240                 mov     edx, [ecx];</span><br><span class="line">.text:00446242                 mov     [eax], edx;【_KPRCB.DpcListHead._List_Entry.Flink】存入【_KDPC.DpcListEntry._List_Entry.Flink】</span><br><span class="line">.text:00446244                 mov     [eax+4], ecx;【_KPRCB.DpcListHead】存入【_KDPC.DpcListEntry._List_Entry.Blink】</span><br><span class="line">.text:00446247                 mov     [edx+4], eax;【_KDPC.DpcListEntry】存入【_KPRCB.DpcListHead._List_Entry.Flink.Blink】</span><br><span class="line">.text:0044624A                 mov     [ecx], eax;【_KDPC.DpcListEntry】存入【_KPRCB.DpcListHead._List_Entry.Flink】</span><br><span class="line">.text:0044624C                 jmp     loc_40C91E</span><br><span class="line">.text:00446251 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00446251</span><br><span class="line">.text:00446251 loc_446251:                             ; CODE XREF: KeInsertQueueDpc(x,x,x)+A0↑j</span><br><span class="line">.text:00446251                 mov     eax, [esi+880h];eax取_KPRCB.DpcRequestRate</span><br><span class="line">.text:00446257                 cmp     eax, [esi+888h];比较_KPRCB.DpcRequestRate和_KPRCB.MinimumDpcRate</span><br><span class="line">.text:0044625D                 jnb     loc_40C95A;</span><br><span class="line">.text:00446263                 jmp     loc_40C948;</span><br><span class="line">.text:00446263 ; END OF FUNCTION CHUNK FOR _KeInsertQueueDpc@12</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-28461677-id-4293119.html">软中断理解参考</a></p>
<p>上面的loc_446240画图展示操作</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210915232306154.png" alt="image-20210915232306154"></p>
<p><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_5d29455e0101l562.html">中断和异常是使处理转向的系统事件总结</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012640985/article/details/24592525/">DPC更详尽的参考</a></p>
<h2 id="DPC定时器实验"><a href="#DPC定时器实验" class="headerlink" title="DPC定时器实验"></a>DPC定时器实验</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//放到全局变量是防止放到栈中，被释放掉了</span></span><br><span class="line">KDPC dpc = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">KTIMER timer = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">LARGE_INTEGER dueTimer = &#123; <span class="number">0</span> &#125;;<span class="comment">//存时间间隔</span></span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">dpcCall</span><span class="params">(</span></span><br><span class="line"><span class="params">	_In_ <span class="keyword">struct</span> _KDPC* Dpc,</span></span><br><span class="line"><span class="params">	_In_opt_ PVOID DeferredContext,</span></span><br><span class="line"><span class="params">	_In_opt_ PVOID SystemArgument1,</span></span><br><span class="line"><span class="params">	_In_opt_ PVOID SystemArgument2</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;dpcCall调用\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//卸载函数</span></span><br><span class="line">VOID <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT driver)</span></span><br><span class="line">&#123;</span><br><span class="line">	KeCancelTimer(&amp;timer);<span class="comment">//取消定时器</span></span><br><span class="line">	DbgPrint(<span class="string">&quot;停止运行了\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//入口函数，相当于main函数</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pdriver, PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//设置一个卸载函数，用于退出</span></span><br><span class="line">	pdriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	KeInitializeDpc(&amp;dpc, dpcCall, <span class="literal">NULL</span>);<span class="comment">//初始化dpc</span></span><br><span class="line">	KeInitializeTimer(&amp;timer);<span class="comment">//初始化计时器</span></span><br><span class="line">	dueTimer.QuadPart = <span class="number">-100</span> * <span class="number">1000</span> * <span class="number">1000</span>;<span class="comment">//负数表示时间间隔，这里是10秒</span></span><br><span class="line">	KeSetTimer(&amp;timer, dueTimer,&amp;dpc);<span class="comment">//绑定定时器和dpc，使间隔定时器执行dpc</span></span><br><span class="line">	<span class="comment">//KeInsertQueueDpc(&amp;dpc, NULL, NULL);//直接把dpc插入队列准备执行。</span></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>十秒后打印如下结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/che77a38/blogImage/image-20210916200240912.png" alt="image-20210916200240912"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/%E5%86%85%E6%A0%B8%E7%9B%B8%E5%85%B3/" rel="tag"># 内核相关</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/692eb761/" rel="prev" title="驱动开发">
      <i class="fa fa-chevron-left"></i> 驱动开发
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/353f17/" rel="next" title="待解决问题汇总">
      待解决问题汇总 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.</span> <span class="nav-text">进程结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93-EPROCESS"><span class="nav-number">1.1.</span> <span class="nav-text">进程结构体_EPROCESS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PEB"><span class="nav-number">1.1.1.</span> <span class="nav-text">PEB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KRPOCESS%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.1.2.</span> <span class="nav-text">_KRPOCESS结构体</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C"><span class="nav-number">1.2.</span> <span class="nav-text">实验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%96%AD%E9%93%BE%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8%E9%9A%90%E8%97%8F"><span class="nav-number">1.2.1.</span> <span class="nav-text">进程断链实现任务管理器隐藏</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">2.</span> <span class="nav-text">线程结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93-ETHREAD"><span class="nav-number">2.1.</span> <span class="nav-text">线程结构体_ETHREAD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#KTHREAD%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">2.1.1.</span> <span class="nav-text">_KTHREAD结构体</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%80%83"><span class="nav-number">2.2.</span> <span class="nav-text">思考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E7%8E%AF%E7%BA%BF%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93-TEB"><span class="nav-number">2.3.</span> <span class="nav-text">三环线程结构体_TEB</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CPU%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">3.</span> <span class="nav-text">CPU结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#KPCR%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">3.1.</span> <span class="nav-text">_KPCR结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NT-TIB%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">3.1.1.</span> <span class="nav-text">_NT_TIB结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KPRCB%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">3.1.2.</span> <span class="nav-text">_KPRCB结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KiProcessorBlock%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F-%E6%9C%AA%E5%AF%BC%E5%87%BA"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">KiProcessorBlock全局变量(未导出)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B%E5%90%8D%E6%89%BE%E8%BF%9B%E7%A8%8B%E7%BB%93%E6%9E%84%E9%A6%96%E5%9C%B0%E5%9D%80"><span class="nav-number">3.2.</span> <span class="nav-text">指定进程名找进程结构首地址</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%B4%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">4.</span> <span class="nav-text">对象头结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OBJECT-HEADER"><span class="nav-number">4.1.</span> <span class="nav-text">_OBJECT_HEADER</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OBJECT-TYPE"><span class="nav-number">4.1.1.</span> <span class="nav-text">_OBJECT_TYPE</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AD%89%E5%BE%85%E9%93%BE%E8%A1%A8-%E8%B0%83%E5%BA%A6%E9%93%BE%E8%A1%A8"><span class="nav-number">5.</span> <span class="nav-text">等待链表_调度链表</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AD%89%E5%BE%85%E9%93%BE%E8%A1%A8"><span class="nav-number">5.1.</span> <span class="nav-text">等待链表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E9%93%BE%E8%A1%A8-%E5%B0%B1%E7%BB%AA%E9%93%BE%E8%A1%A8"><span class="nav-number">5.2.</span> <span class="nav-text">调度链表(就绪链表)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E5%B7%AE%E5%BC%82"><span class="nav-number">5.2.1.</span> <span class="nav-text">版本差异</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">5.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2"><span class="nav-number">6.</span> <span class="nav-text">线程切换</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%86%E5%90%91%E7%BA%BF%E7%A8%8B%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2"><span class="nav-number">6.1.</span> <span class="nav-text">逆向线程主动切换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#KiSwapThread"><span class="nav-number">6.1.1.</span> <span class="nav-text">KiSwapThread</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KiFindReadyThread"><span class="nav-number">6.1.1.1.</span> <span class="nav-text">KiFindReadyThread</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KiSwapContext"><span class="nav-number">6.1.2.</span> <span class="nav-text">KiSwapContext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SwapContext"><span class="nav-number">6.1.3.</span> <span class="nav-text">SwapContext</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%A0%86%E6%A0%88%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">6.1.3.1.</span> <span class="nav-text">内核堆栈的结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Trap-Frame%E7%BB%93%E6%9E%84"><span class="nav-number">6.1.3.1.1.</span> <span class="nav-text">_Trap_Frame结构</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8API%E8%BF%9B0%E7%8E%AFTSS%E7%BB%86%E8%8A%82"><span class="nav-number">6.1.3.2.</span> <span class="nav-text">调用API进0环TSS细节</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8API%E8%BF%9B0%E7%8E%AFFS%E7%BB%86%E8%8A%82"><span class="nav-number">6.1.3.3.</span> <span class="nav-text">调用API进0环FS细节</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2"><span class="nav-number">6.2.</span> <span class="nav-text">模拟线程切换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81"><span class="nav-number">6.2.1.</span> <span class="nav-text">实验代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ThreadCore-h"><span class="nav-number">6.2.1.1.</span> <span class="nav-text">ThreadCore.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ThreadCore-cpp"><span class="nav-number">6.2.1.2.</span> <span class="nav-text">ThreadCore.cpp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#main-cpp"><span class="nav-number">6.2.1.3.</span> <span class="nav-text">main.cpp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C%E5%A6%82%E4%B8%8B"><span class="nav-number">6.2.1.4.</span> <span class="nav-text">效果如下</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E6%80%BB%E7%BB%93"><span class="nav-number">6.2.2.</span> <span class="nav-text">模拟线程切换总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%B6%E9%92%9F%E4%B8%AD%E6%96%AD%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2"><span class="nav-number">6.3.</span> <span class="nav-text">时钟中断线程切换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%92%9F%E4%B8%AD%E6%96%AD"><span class="nav-number">6.3.1.</span> <span class="nav-text">系统时钟中断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%92%9F%E4%B8%AD%E6%96%AD%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">6.3.2.</span> <span class="nav-text">时钟中断的执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2"><span class="nav-number">6.3.3.</span> <span class="nav-text">如何避免线程切换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%92%9F%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E6%B5%81%E7%A8%8B"><span class="nav-number">6.3.4.</span> <span class="nav-text">时钟线程切换流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CPU%E6%97%B6%E9%97%B4%E7%89%87%E5%88%B0%E6%9C%9F%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2"><span class="nav-number">6.3.4.1.</span> <span class="nav-text">CPU时间片到期线程切换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%98%E5%9C%A8%E5%A4%87%E7%94%A8%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2"><span class="nav-number">6.3.4.2.</span> <span class="nav-text">存在备用线程的线程切换</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E6%83%85%E5%86%B5%E6%80%BB%E7%BB%93"><span class="nav-number">6.3.5.</span> <span class="nav-text">线程切换情况总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7-KiFindReadyThread%E8%AF%A6%E8%A7%A3"><span class="nav-number">6.3.6.</span> <span class="nav-text">线程优先级(KiFindReadyThread详解)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AB%98%E6%95%88%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-number">6.3.6.1.</span> <span class="nav-text">高效查询优化</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%8C%82%E9%9D%A0"><span class="nav-number">7.</span> <span class="nav-text">进程挂靠</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%BA%E5%88%AB%E6%80%BB%E7%BB%93"><span class="nav-number">7.1.</span> <span class="nav-text">区别总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%8C%82%E9%9D%A0-1"><span class="nav-number">7.2.</span> <span class="nav-text">进程挂靠</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90NtReadVirtualMemory%E5%87%BD%E6%95%B0"><span class="nav-number">7.3.</span> <span class="nav-text">分析NtReadVirtualMemory函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NtReadVirtualMemory%E9%80%86%E5%90%91"><span class="nav-number">7.3.1.</span> <span class="nav-text">NtReadVirtualMemory逆向</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MmCopyVirtualMemory"><span class="nav-number">7.3.1.1.</span> <span class="nav-text">MmCopyVirtualMemory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MiDoPoolCopy"><span class="nav-number">7.3.1.2.</span> <span class="nav-text">MiDoPoolCopy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KeStackAttachProcess"><span class="nav-number">7.3.1.3.</span> <span class="nav-text">KeStackAttachProcess</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KiAttachProcess"><span class="nav-number">7.3.1.4.</span> <span class="nav-text">KiAttachProcess</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KiSwapProcess"><span class="nav-number">7.3.1.5.</span> <span class="nav-text">KiSwapProcess</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%8C%82%E9%9D%A0%E6%80%BB%E7%BB%93"><span class="nav-number">7.3.2.</span> <span class="nav-text">进程挂靠总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%A8%E8%BF%9B%E7%A8%8B%E8%AF%BB%E5%86%99%E5%86%85%E5%AD%98"><span class="nav-number">7.3.3.</span> <span class="nav-text">跨进程读写内存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NtReadVirtualMemory%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90%EF%BC%9A"><span class="nav-number">7.3.3.1.</span> <span class="nav-text">NtReadVirtualMemory流程解析：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NtWriteVirtualMemory%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90%EF%BC%9A"><span class="nav-number">7.3.3.2.</span> <span class="nav-text">NtWriteVirtualMemory流程解析：</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A9%B1%E5%8A%A8%E5%8F%A6%E7%B1%BB%E9%80%9A%E4%BF%A1%E5%AE%9E%E9%AA%8C"><span class="nav-number">8.</span> <span class="nav-text">驱动另类通信实验</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DPC-%E5%BB%B6%E8%BF%9F%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="nav-number">9.</span> <span class="nav-text">DPC 延迟过程调用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#KDPC%E7%BB%93%E6%9E%84"><span class="nav-number">9.1.</span> <span class="nav-text">_KDPC结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B0KeInitializeDpc"><span class="nav-number">9.2.</span> <span class="nav-text">初始化函数KeInitializeDpc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E5%85%A5DPC%E9%93%BE%E8%A1%A8%E5%87%BD%E6%95%B0KeInsertQueueDpc"><span class="nav-number">9.3.</span> <span class="nav-text">插入DPC链表函数KeInsertQueueDpc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DPC%E5%AE%9A%E6%97%B6%E5%99%A8%E5%AE%9E%E9%AA%8C"><span class="nav-number">9.4.</span> <span class="nav-text">DPC定时器实验</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZEROKO14</p>
  <div class="site-description" itemprop="description">你好，欢迎来到ZEROKO14的个人博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZEROKO14</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>


  <script defer src="/blog/lib/three/three.min.js"></script>
    <script defer src="/blog/lib/three/three-waves.min.js"></script>


  




  
<script src="/blog/js/local-search.js"></script>













  

  

  

</body>
</html>
